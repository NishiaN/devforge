# CAP-002: フロントエンド基盤・BaaS・ドキュメント整合性の是正処置計画

> DevForge v9 — Corrective Action Plan  
> 作成日: 2026-02-09  
> ✅ **全Phase完了** (Round 24)  
> トリガー: 外部AIレビュー（Vite SPA + Supabase + Netlify シナリオ）  
> 分類: ジェネレータ文脈認識 / テンプレートハードコード残存

---

## 1. レビュー指摘 照査結果

### レビュー指摘 vs 実態の仕分け

| # | レビュー指摘 | 分類 | DevForge側の実態 | 判定 |
|---|---|---|---|---|
| P0-1 | scope_out「AI機能」vs プロジェクト名「AIエージェント」 | 入力矛盾 | ユーザーの入力矛盾。compat-rulesで検出可能 | △ ルール追加 |
| P0-2 | 「API公開スコープ外」vs /api/v1 CRUD生成 | **ジェネレータ** | docs/05 API設計が BaaS無視でREST生成。Playbook も同様 | ❌ **要修正** |
| P0-3 | Vite SPAなのにNext.js前提記述混入 | **ジェネレータ** | .env=NEXT_PUBLIC_, .gitignore=.next/, perf=next/image, monitor=Vercel Analytics | ❌ **要修正** |
| P0-4 | 認証「server-side」前提だがVite SPAはサーバ無し | **ジェネレータ** | resolveAuth()がBaaS時もserver-sideと記載 | ❌ **要修正** |
| P0-5 | ルーティングURL不正・認証要否矛盾 | **ジェネレータ** | genRoutes()が日本語URL生成、ランディング=🔒 | ❌ **要修正** |
| P0-6 | ER図 Comment→Category 不自然、user_id欠落 | **ジェネレータ** | docs ERが単純隣接ペア接続、FK未生成 | ❌ **要修正** |
| P0-7 | DevContainer forwardPorts 54323欠落 | **ジェネレータ** | p2-devcontainer.js に54323未登録 | ❌ **要修正** |
| P1-8 | Stripe設計不足 | ジェネレータ | payment選択時のWebhook/状態DB/ペイウォール未生成 | ⚠️ 新規追加 |
| P1-9 | 管理者ロール/権限設計なし | ジェネレータ | target「管理者」検出→role設計未反映 | ⚠️ 新規追加 |
| P1-10 | テストツール Vitest/Jest 混在 | **ジェネレータ** | verification.md にJest残存 | ❌ **要修正** |
| P1-11 | 監視 Vercel Analytics だが deploy=Netlify | **ジェネレータ** | docs/17が deploy先無視でVercel固定 | ❌ **要修正** (= P0-3) |
| P1-12 | Mobile bare vs Expo混在 | ジェネレータ | roadmap MOBILE_GUIDE が常にExpo前提 | ⚠️ 要確認 |
| P2-13 | エンティティが教育ドメインと不整合 | 入力品質 | B5 inferERで既にWARN出力済み | ✅ 対処済 |
| P2-14 | 成功指標とMVP機能の未連結 | 入力品質 | ユーザー入力の問題。compat-rule追加可能 | △ ルール追加 |
| P2-15 | CI/CD GitHub Actions雛形なし | ジェネレータ | 方針のみで実ファイル未生成 | ⚠️ 新規追加 |

### 根本原因分析

**CAP-001で解決済み**: Auth SoT統一、Architecture分岐、DevContainer BaaS対応、package.json実依存
**CAP-001で見落とし**: docs.js/common.js内のハードコードテンプレートがフロントエンド種別・デプロイ先を認識していない

```
               CAP-001 修正範囲（SDD 5文書 + DevContainer + CLAUDE.md + MCP）
                        ↓ 修正済み
[p1-sdd.js] [p2-devcontainer.js] [p4-airules.js] [p3-mcp.js]
                        ↓ 未修正（CAP-002対象）
[common.js: .env / .gitignore] [docs.js: 05_api/06_screen/04_er/17_monitor/19_perf/22_playbook]
[genRoutes(): URL正規化] [resolveAuth(): SPA境界]
```

---

## 2. 是正処置一覧

### Phase D: フロントエンド基盤認識（.env / .gitignore / perf / monitor）

| ID | 対象 | 修正内容 | 影響ファイル |
|---|---|---|---|
| D1 | .env.example | FE種別で接頭辞切替: Next→NEXT_PUBLIC_, Vite→VITE_, その他→REACT_APP_ | common.js |
| D2 | .gitignore | FE種別で切替: Next→.next/, Vite→dist/, 共通→node_modules/ | common.js |
| D3 | docs/19_performance | next/image → FE別最適化手段（Vite: vite-imagetools, 一般: sharp） | docs.js |
| D4 | docs/17_monitoring | deploy先別ツール: Vercel→Vercel Analytics, Netlify→Netlify Analytics, 汎用→PostHog | docs.js |

### Phase E: BaaS API設計一貫性

| ID | 対象 | 修正内容 | 影響ファイル |
|---|---|---|---|
| E1 | docs/05_api_design | BaaS時→SDK呼び出しパターン生成（REST /api/v1 廃止） | docs.js |
| E2 | docs/22_playbook | BaaS時→"Supabase Client でCRUD" に切替 | docs.js |
| E3 | verification.md | "Vitest / Jest" → "Vitest" に統一 | p1-sdd.js |

### Phase F: ルーティング・画面設計正規化

| ID | 対象 | 修正内容 | 影響ファイル |
|---|---|---|---|
| F1 | genRoutes() | 日本語→ローマ字変換、不正文字除去、重複排除強化 | common.js |
| F2 | genRoutes() | ランディング/LP/トップ → `/` に統一（重複防止） | common.js |
| F3 | docs/06_screen | ランディング・LP系→認証不要に修正 | docs.js |

### Phase G: ER図・データモデル品質

| ID | 対象 | 修正内容 | 影響ファイル |
|---|---|---|---|
| G1 | docs/04_er_diagram | 隣接ペア接続→inferER()のrelationships使用 | docs.js |
| G2 | docs/04_er_diagram | FK列(user_id, post_id等)をリレーションから自動生成 | docs.js |

### Phase H: 小修正群

| ID | 対象 | 修正内容 | 影響ファイル |
|---|---|---|---|
| H1 | DevContainer ports | Supabase Studio 54323追加 | p2-devcontainer.js |
| H2 | resolveAuth() | SPA時 "server-side" → "client-side (supabase.auth.getUser())" | common.js |
| H3 | buildDeps() | BaaS時にorm入力を無視（Prisma dep排除） | common.js |
| H4 | package.json | BaaS時 db:push/db:studio スクリプト除外 | common.js |

---

## 3. 実装計画

### Round 24: Phase D + E + F + G + H（一括実装）

全て docs.js / common.js / p1-sdd.js / p2-devcontainer.js の修正のみ。
新モジュール追加なし。テスト追加: ~30件。

**優先順**: H (小修正) → D (FE認識) → F (ルーティング) → G (ER) → E (API設計) → テスト
