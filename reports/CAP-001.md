# CAP-001: 生成文書の意味的整合性に関する是正処置計画

> DevForge v9 — Corrective Action Plan  
> 作成日: 2026-02-09  
> ✅ **全Phase完了** (Round 21-23)
> 分類: 設計品質 / 生成ロジック

---

## 1. 根本原因分析 (Root Cause Analysis)

### 問題の構造

```
ユーザー入力 → [相性チェック] → [各ジェネレータ独立実行] → 32ファイル出力
                    ↑                      ↑
               ここは機能している      ここが壊れている
          （20ルール・入力ペア検証）  （文書間の意味的整合なし）
```

**現行の相性チェック（compat-rules.js）が検証するもの:**
- Expo → React必須 ✅
- Prisma → Node.js必須 ✅
- Java → Vercel非推奨 ✅
- 計20ルール（ERROR×5, WARN×15）

**検証していないもの（= 今回のP0-P2の原因）:**
- scope_out（スコープ外）の記述 vs 他の回答の矛盾
- デプロイ先 vs バックエンドの具体的な配置戦略
- DB選択 vs DevContainer構成の整合
- 認証選択 → 各文書での認証記述の一貫性
- purpose（ドメイン） vs data_entities の意味的妥当性
- 生成文書間のスケジュール・URL・NFRの統一

### 技術的原因

各ジェネレータ（p1-sdd.js, p2-devcontainer.js, p7-roadmap.js）が**独立して**テンプレートを埋めるだけで、**相互参照・整合チェック・コンテキスト推論**を行っていない。

| ジェネレータ | 担当ファイル数 | 問題 |
|---|---|---|
| p1-sdd.js | 5 | API GatewayをBE問わず挿入、NFR固定値、auth不整合 |
| p2-devcontainer.js | 4 | Supabase/Firebase無視でraw postgres固定 |
| p7-roadmap.js | 9 | スケジュールがSDDと非連動、始点なし |

---

## 2. 是正処置一覧

### Phase A: compat-rules 拡張（入力段階での矛盾検出）

新規ルールを追加し、**ユーザーが矛盾した入力をした時点で警告**する。

| ID | 分類 | ルール | 対応P0 | 重要度 |
|---|---|---|---|---|
| A1 | scope↔mobile | scope_outに「ネイティブ/native/アプリ」含む && mobile≠none | P0-1 | ERROR |
| A2 | scope↔payment | scope_outに「決済/EC/payment」含む && payment≠none | P0-5 | WARN |
| A3 | scope↔entities | scope_outに「EC」含む && entities に Product/Order 含む | P0-5 | WARN |
| A4 | deploy↔backend | deploy=Vercel && backend=Express/Fastify/NestJS | P0-2 | WARN |
| A5 | backend↔auth | backend=Supabase && auth に NextAuth 含む | P0-4 | WARN |
| A6 | backend↔auth | backend≠Supabase && auth に Supabase Auth 含む | P0-4 | WARN |
| A7 | purpose↔entities | purpose=教育系 && entities に Product/Order | P0-5 | INFO |
| A8 | mobile↔scope | mobile=Expo && mvp_features に「ストア配布」含む | P0-1 | WARN |

**実装箇所:** `src/data/compat-rules.js` に8ルール追加  
**工数:** 小（1セッション）

---

### Phase B: ジェネレータのコンテキスト認識化

#### B1. アーキテクチャ図のスタック適応（P0-2 対応）

**現状（p1-sdd.js L88）:**
```
[Client] → [${fe}] → [API Gateway] → [${be}] → [${db}]
```
API Gatewayが常に出力され、BE=Supabase/Firebaseでも表示される。

**修正:**
```javascript
// backend種別に応じたアーキテクチャパターン分岐
const isBaaS = /Supabase|Firebase|Convex/.test(be);
const isServerless = /Vercel/.test(deploy) && /Express|Fastify/.test(be);

if (isBaaS) {
  // [Client] → [FE] → [BaaS (Auth + DB + Functions)]
} else if (isServerless) {
  // [Client] → [FE + API Routes] → [DB]
  // ※ Express不要の旨を注記
} else {
  // [Client] → [FE] → [BE Server] → [DB]
}
```

**実装箇所:** `src/generators/p1-sdd.js` L85-90  
**工数:** 中

#### B2. DevContainerのBaaS対応（P0-3 対応）

**現状（p2-devcontainer.js）:**
- backend=Supabase でも `postgres:16` を docker-compose に配置
- Prisma を Node.js なら常に前提

**修正:**
```javascript
const isBaaS = /Supabase|Firebase|Convex/.test(be);

if (be.includes('Supabase')) {
  // Supabase CLI (npx supabase init/start) をpost-createに
  // docker-compose に supabase/supabase ではなく CLI利用を案内
  // ORM不要（Supabase client直接）or Prisma直接接続を選択肢化
} else if (be.includes('Firebase')) {
  // firebase emulators をpost-createに
} else {
  // 現行通り postgres:16 / mongo / mysql
}
```

**実装箇所:** `src/generators/p2-devcontainer.js` 全体  
**工数:** 中

#### B3. 認証SoT（Source of Truth）の自動決定（P0-4 対応）

**現状:** auth 回答をそのまま挿入、API節に「Bearer Token (JWT)」固定。

**修正ロジック:**
```javascript
function resolveAuthSoT(auth, backend, frontend) {
  // 優先順位ルール:
  // 1. backend=Supabase → Supabase Auth がSoT
  // 2. backend=Firebase → Firebase Auth がSoT
  // 3. frontend=Next.js → Auth.js/NextAuth 推奨
  // 4. それ以外 → auth回答をそのまま使用
  
  // JWT発行元・検証方法も自動決定
  // API節の認証方式を auth SoT に合わせて生成
}
```

**影響ファイル:** constitution.md, specification.md, technical-plan.md, .ai-rules  
**実装箇所:** `src/generators/common.js` に `resolveAuthSoT()` 追加、各ジェネレータから参照  
**工数:** 中

#### B4. scope_out ↔ 全回答の整合性反映（P0-1, P0-5 対応）

**現状:** scope_out はユーザーのチップ選択をカンマ区切りでそのまま挿入。

**修正:**
```javascript
function validateScopeConsistency(answers) {
  const warnings = [];
  const scope = (answers.scope_out || '').toLowerCase();
  
  // scope_outに含まれるのに他の回答で有効になっている項目を検出
  if (scope.includes('ネイティブ') && answers.mobile !== 'none') {
    warnings.push({
      field: 'scope_out',
      msg: 'スコープ外「ネイティブアプリ」とモバイル対応が矛盾。constitution.mdのスコープ外定義を調整します。'
    });
    // 自動修正: scope_outの記述を適切に変換
    // 「ネイティブアプリ」→「ストア配布用ネイティブビルド（Expo Web UIは対象内）」
  }
  // 同様に EC/決済/多言語 etc.
}
```

**実装箇所:** `src/generators/p1-sdd.js` 生成前バリデーション  
**工数:** 小〜中

#### B5. Entity↔Purpose のドメイン妥当性（P0-5, P1-7 対応）

**現状:** data_entities をそのまま展開、ER関係は生成しない。

**修正:**
```javascript
// ドメイン別の推奨エンティティマッピング
const DOMAIN_ENTITIES = {
  education: {core: ['User','Course','Lesson','Progress','Quiz'], 
              exclude: ['Product','Order','Cart']},
  ecommerce: {core: ['User','Product','Order','Cart','Payment'],
              exclude: ['Course','Lesson']},
  // ...
};

function inferER(entities, purpose) {
  // 1. purposeからドメイン判定
  // 2. domain外のエンティティに注記（「将来拡張」or 削除推奨）
  // 3. 基本リレーション自動推論（User 1-N Resource, Resource N-M Tag etc.）
}
```

**実装箇所:** `src/generators/p1-sdd.js` specification.md のER節  
**工数:** 大

#### B6. NFRのスキルレベル連動（P1-11 対応）

**現状（p1-sdd.js L61-63）:**
```
- レスポンスタイム: < 200ms (p95)
- 可用性: 99.9%
- 同時接続: 1000+
```
固定値でMVPに過剰。

**修正:**
```javascript
const nfr = {
  beginner: { latency:'< 1000ms (p95)', avail:'ベストエフォート', concurrent:'〜50' },
  intermediate: { latency:'< 500ms (p95)', avail:'99%', concurrent:'〜200' },
  pro: { latency:'< 200ms (p95)', avail:'99.9%', concurrent:'1000+' },
};
```

**実装箇所:** `src/generators/p1-sdd.js` L61-63  
**工数:** 小

#### B7. スケジュール単一ソース化（P1-9 対応）

**現状:**
- p1-sdd.js: Sprint 0-4 (Week 1-6)
- p7-roadmap.js: Layer 1-3 (Week 1-2 / Month 1-2)
- ガント開始日: ハードコード `2026-01-01`

**修正:**
```javascript
// common.js にスケジュール計算を集約
function buildSchedule(answers) {
  const startDate = new Date().toISOString().split('T')[0]; // 生成日基準
  const hasMobile = answers.mobile && answers.mobile !== 'none';
  const totalWeeks = hasMobile ? 6 : 4;
  return {
    startDate,
    totalWeeks,
    sprints: [
      { name:'Sprint 0', weeks:[1], focus:'環境構築' },
      { name:'Sprint 1', weeks:[2,3], focus:'コア機能' },
      // ...
    ]
  };
}
```
全ジェネレータがこの関数を参照し、同一のスケジュールを出力。

**実装箇所:** `src/generators/common.js` + 各ジェネレータ  
**工数:** 中

#### B8. package.json 実体生成（P1-10 対応）

**現状:** DevContainer は package.json を前提とするが中身は未生成。

**修正:**
```javascript
// p2-devcontainer.js にpackage.json生成を追加
function genPackageJson(answers) {
  const deps = {};
  const devDeps = {};
  
  // frontend依存
  if (fe.includes('Next.js')) deps['next'] = '^15';
  if (fe.includes('React')) { deps['react'] = '^19'; deps['react-dom'] = '^19'; }
  
  // backend依存
  if (be.includes('Express')) deps['express'] = '^5';
  if (be.includes('Supabase')) deps['@supabase/supabase-js'] = '^2';
  
  // ORM
  if (orm.includes('Prisma')) devDeps['prisma'] = '^6';
  
  // 共通devDeps
  devDeps['typescript'] = '^5.7';
  devDeps['vitest'] = '^3';
  devDeps['@playwright/test'] = '^1.50';
  devDeps['eslint'] = '^9'; devDeps['prettier'] = '^3';
  
  return JSON.stringify({name: projectName, version:'0.1.0', 
    private:true, scripts:{...}, dependencies:deps, devDependencies:devDeps}, null, 2);
}
```

**実装箇所:** `src/generators/p2-devcontainer.js`  
**工数:** 中

#### B9. URL/ルーティング表生成（P1-8 対応）

**現状:** ディレクトリ構造はあるが、画面URLと認証要否が未定義。

**修正:**
```javascript
function genRoutes(answers) {
  const routes = [
    { path:'/', name:'ランディング', auth:false },
    { path:'/login', name:'ログイン', auth:false },
    { path:'/dashboard', name:'ダッシュボード', auth:true },
  ];
  // mvp_features から追加ルート推論
  if (answers.mvp_features?.includes('検索')) routes.push({path:'/search', ...});
  // screens から追加
  // ...
  return routes;
}
```

**実装箇所:** `src/generators/p1-sdd.js` specification.md に追加  
**工数:** 中

---

### Phase C: 生成後の整合性検証（Post-Generation Audit）

生成完了後に自動実行する**セルフチェック**を追加。

```javascript
// src/generators/post-audit.js (新規)
function postGenerationAudit(files, answers) {
  const findings = [];
  
  // C1: constitution の scope_out vs 他ファイルの矛盾
  const constitution = files['.spec/constitution.md'];
  const techPlan = files['.spec/technical-plan.md'];
  
  // C2: auth方式が全文書で一貫しているか
  // C3: スケジュール（Sprint/Week/日付）が全文書で同一か
  // C4: エンティティ名が ER / API / テスト計画で一致するか
  // C5: deploy先とアーキテクチャ図が整合するか
  
  return findings; // [{level:'error'|'warn', msg:'...', files:['...']}]
}
```

結果を生成物の末尾に **⚠️ 整合性チェック結果** として出力。

**実装箇所:** `src/generators/index.js` 生成パイプライン末尾  
**工数:** 大

---

## 3. 実装優先順位

| 順序 | 施策 | 対応P0/P1 | 工数 | 効果 |
|---|---|---|---|---|
| **1** | A1-A8: compat-rules 8ルール追加 | P0-1,2,4,5 | 小 | 入力段階で矛盾を警告 |
| **2** | B6: NFRスキルレベル連動 | P1-11 | 小 | 3行修正で過剰NFR解消 |
| **3** | B3: Auth SoT自動決定 | P0-4 | 中 | 認証三重衝突を解消 |
| **4** | B1: アーキテクチャ図スタック適応 | P0-2 | 中 | API Gateway問題解消 |
| **5** | B2: DevContainer BaaS対応 | P0-3 | 中 | Supabase/素Postgres矛盾解消 |
| **6** | B4: scope_out整合性反映 | P0-1,5 | 小〜中 | スコープ矛盾を自動調整 |
| **7** | B7: スケジュール単一ソース化 | P1-9 | 中 | 全文書のタイムライン統一 |
| **8** | B8: package.json実体生成 | P1-10 | 中 | DevContainerが実際に動く |
| **9** | B9: URL/ルーティング表 | P1-8 | 中 | 画面設計の実体化 |
| **10** | B5: Entity↔Purpose ドメイン妥当性 | P0-5, P1-7 | 大 | ER自動推論 |
| **11** | C: 生成後整合性検証 | 全P0/P1 | 大 | 最終防衛ライン |

---

## 4. テスト戦略

### 既存テスト (91/91) への追加

```
test/compat.test.js     ← A1-A8 の新ルール検証（+16ケース）
test/gen-coherence.test.js ← 新規: 生成文書間の整合性テスト
  - scope_out vs mobile 矛盾検出
  - auth方式の全文書一貫性
  - アーキテクチャ図のBaaS対応
  - NFRのスキルレベル連動
  - スケジュール日付の一貫性
  - package.json依存の妥当性
test/presets.test.js    ← 全26プリセットで生成→整合性チェック
```

### 回帰テスト基準

全26プリセット × 3スキルレベル × 2言語 = **156パターン**の生成を自動テストし、P0級の矛盾が0件であることを確認。

---

## 5. 相性チェックの射程まとめ

```
【現行】入力ペアの技術的互換性        20ルール → 検知OK
         ↓
【Phase A】入力間の意味的矛盾          +8ルール → 入力段階で警告
         ↓
【Phase B】ジェネレータのコンテキスト化  9施策 → 矛盾を生まない生成
         ↓
【Phase C】生成後セルフ検証             +1モジュール → 最終防衛ライン
```

**「全8ペアの相性に問題はありません」が出ても文書が矛盾する**のは、Phase A〜C が存在しなかったため。相性チェックの射程が「技術スタック同士の互換性」に限定されていたことが根本原因。

---

## 6. 当面の進め方

Round 21 で Phase A（compat-rules 8ルール）+ B6（NFR）を即時実装。
Round 22 で Phase B の B1-B4（アーキテクチャ・DevContainer・Auth・Scope）を実装。
Round 23 で Phase B の B7-B9 + Phase C を実装。
B5（ER推論）は設計検討を経てRound 24以降。
