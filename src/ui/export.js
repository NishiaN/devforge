/* â•â•â• EXPORT â•â•â• */
async function _renderMermaidSVG(html){
  if(!html.includes('language-mermaid'))return html;
  await _ensureMermaid();
  if(!_mermaidReady)return html;
  try{mermaid.initialize({startOnLoad:false,theme:'default',securityLevel:'strict'});}catch(e){}
  const re=/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g;
  let result=html;let idx=0;const matches=[];let m;
  while((m=re.exec(html))!==null)matches.push({full:m[0],code:m[1]});
  for(const match of matches){
    const code=match.code.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"');
    try{
      const {svg}=await mermaid.render('_pmm'+(idx++),code);
      result=result.replace(match.full,'<div style="text-align:center;margin:16px 0;page-break-inside:avoid;">'+svg+'</div>');
    }catch(e){}
  }
  try{_initMermaidTheme();}catch(e){}
  return result;
}
async function exportZIP(){
  const _ja=S.lang==='ja';
  if(window._noZip||typeof JSZip==='undefined'){toast(_ja?'âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã¯ZIPã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“':'âš ï¸ ZIP export unavailable offline');return;}
  const zip=new JSZip();
  const root=fileSlug(S.projectName);
  Object.entries(S.files).forEach(([path,content])=>{
    zip.file(root+'/'+path,content);
  });
  const blob=await zip.generateAsync({type:'blob'});
  const url=URL.createObjectURL(blob);
  const link=document.createElement('a');link.href=url;link.download=root+'.zip';link.click();
  URL.revokeObjectURL(url);
  addMsg('bot',_ja?`ğŸ“¦ ${root}.zip (${Object.keys(S.files).length}ãƒ•ã‚¡ã‚¤ãƒ«) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼`:`ğŸ“¦ Downloaded ${root}.zip (${Object.keys(S.files).length} files)!`);
  _lsSet('devforge-last-export',new Date().toISOString());
}

async function exportPDF(){
  const _ja=S.lang==='ja';
  const G=S.genLang==='ja'||(!S.genLang&&_ja);
  let content='';
  for(const [path,text] of Object.entries(S.files)){
    if(path.endsWith('.md')){
      content+=`<h1 style="page-break-before:always;border-bottom:2px solid #3b82f6;padding-bottom:8px;margin-top:40px;">${escHtml(path)}</h1>`;
      const mdHtml=safeMD(text);
      content+=await _renderMermaidSVG(mdHtml);
    }
  }
  const pdfCss='body{font-family:-apple-system,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#1e222d;}'
    +'pre{background:#f5f5f5;padding:16px;border-radius:8px;overflow-x:auto;}'
    +'h1{margin-top:40px;}h1:first-child{page-break-before:avoid;}'
    +'table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#f0f0f0;}'
    +'div[style*="page-break-inside:avoid"] svg{max-width:100%;height:auto;}'
    +'@media print{body{padding:20px;}h1{page-break-before:always;}h1:first-child{page-break-before:avoid;}div[style*="page-break-inside:avoid"]{page-break-inside:avoid;}svg{max-width:100%;}}';
  const _CSP_META='<meta http-equiv="Content-Security-Policy" content="default-src \'none\'; style-src \'unsafe-inline\'; img-src data: blob:;">';
  const html=`<!DOCTYPE html><html><head>${_CSP_META}<title>${escHtml(S.projectName)} - DevForge v9</title><style>${pdfCss}
</style></head><body><div style="text-align:center;margin-bottom:40px;"><h1 style="page-break-before:avoid;border:none;font-size:24px;">${escHtml(S.projectName)}</h1><p style="color:#666;">Generated by DevForge v9 â€” ${new Date().toLocaleDateString(G?'ja-JP':'en-US')}</p><p style="color:#999;font-size:12px;">${G?'Â© 2026 ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã®ã‚¿ãƒåˆ¶ä½œå§”å“¡ä¼š ï½œ ä½œæˆè€…ï¼šã«ã—ã‚ã‚“':'Â© 2026 Engineering no Tane Committee | by ã«ã—ã‚ã‚“'}</p></div>${content}</body></html>`;
  const win=window.open('','_blank');
  if(win){
    win.document.write(html);
    win.document.close();
    addMsg('bot',_ja?'ğŸ“„ PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸã€‚Ctrl+P ã§å°åˆ·/PDFä¿å­˜ã§ãã¾ã™ã€‚':'ğŸ“„ PDF preview opened in new tab. Use Ctrl+P to print/save as PDF.');
  } else {
    // Fallback: download as HTML file
    const blob=new Blob([html],{type:'text/html'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=fileSlug(S.projectName)+'-docs.html';a.click();URL.revokeObjectURL(a.href);
    addMsg('bot',_ja?'ğŸ“„ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãŸã‚ã€HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦Ctrl+Pã§å°åˆ·ã§ãã¾ã™ã€‚':'ğŸ“„ Popup blocked. Downloaded as HTML. Open in browser and use Ctrl+P to print.');
  }
}

function copyAllFiles(){
  const _ja=S.lang==='ja';
  const sep='\n\n'+'='.repeat(60)+'\n';
  const all=Object.entries(S.files).map(([path,content])=>`${sep}ğŸ“„ ${path}${sep}${content}`).join('\n');
  const header=`# ${S.projectName} â€” ${_ja?'å…¨ãƒ•ã‚¡ã‚¤ãƒ«çµåˆ':'All Files Combined'}\n# Generated by DevForge v9\n# Files: ${Object.keys(S.files).length}\n# Date: ${new Date().toISOString().split('T')[0]}`;
  const fullText=header+'\n'+all;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(fullText).then(()=>{
      toast(_ja?`ğŸ“‹ å…¨${Object.keys(S.files).length}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`:`ğŸ“‹ Copied all ${Object.keys(S.files).length} files`);
      addMsg('bot',_ja?`ğŸ“‹ å…¨${Object.keys(S.files).length}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚AIã¸ã®ä¸€æ‹¬æŠ•å…¥ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚`:`ğŸ“‹ Copied all ${Object.keys(S.files).length} files to clipboard.`);
    }).catch(()=>{_fallbackCopy(fullText);toast(_ja?'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ':'ğŸ“‹ Copied');});
  } else {_fallbackCopy(fullText);toast(_ja?'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ':'ğŸ“‹ Copied');}
}

function copyForAI(){
  const _ja=S.lang==='ja';
  const files=Object.entries(S.files);
  const tokens=Math.round(files.reduce((s,[,c])=>s+c.length,0)/4);
  let md=`# ${S.projectName}\n\n`;
  md+=`> ${_ja?'DevForge v9 ã§ç”Ÿæˆ':'Generated by DevForge v9'} | ${files.length} ${_ja?'ãƒ•ã‚¡ã‚¤ãƒ«':'files'} | ~${tokens.toLocaleString()} tokens\n\n`;
  md+='## Table of Contents\n\n';
  files.forEach(([p],i)=>{md+=`${i+1}. \`${p}\`\n`;});
  md+='\n---\n\n';
  files.forEach(([path,content])=>{
    md+=`## ${path}\n\n\`\`\`${path.split('.').pop()}\n${content}\n\`\`\`\n\n`;
  });
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(md).then(()=>{
      toast(_ja?`ğŸ¤– AIå‘ã‘Markdown (${files.length}ãƒ•ã‚¡ã‚¤ãƒ«) ã‚’ã‚³ãƒ”ãƒ¼`:`ğŸ¤– Copied AI Markdown (${files.length} files)`);
    }).catch(()=>{_fallbackCopy(md);toast(_ja?'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ':'ğŸ“‹ Copied');});
  } else {_fallbackCopy(md);toast(_ja?'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ':'ğŸ“‹ Copied');}
}

/* â•â•â• UI HELPERS â•â•â• */

