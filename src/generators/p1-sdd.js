/* â”€â”€ Pillar â‘  SDD Integration (Phase B: Context-Aware) â”€â”€ */
function genPillar1_SDD(a,pn){
  const G=S.genLang==='ja';
  const date=new Date().toISOString().split('T')[0];
  const fe=a.frontend||'React + Next.js';
  const be=a.backend||'Node.js + Express';
  const db=a.database||'PostgreSQL';
  const methods=(a.dev_methods||'TDD').split(', ');
  const auth=resolveAuth(a);
  const arch=resolveArch(a);
  const sched=buildSchedule(a);

  // B4: scope_out auto-adjustment + G3: domain inference
  let scopeOut=a.scope_out || (()=>{
    const domain=detectDomain(a.purpose);
    const defaults={
      education: G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, å‹•ç”»é…ä¿¡ã‚¤ãƒ³ãƒ•ãƒ©, æ±ºæ¸ˆä»¥å¤–ã®é‡‘èæ©Ÿèƒ½':'Native apps, Video streaming infrastructure, Non-payment financial features',
      ec: G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, å®Ÿåº—èˆ—POSé€£æº, ä¼šè¨ˆã‚½ãƒ•ãƒˆé€£æº, ç‰©æµç®¡ç†':'Native apps, POS integration, Accounting software, Logistics management',
      community: G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, å‹•ç”»é…ä¿¡, ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ‡ã‚ªé€šè©±, ãƒ¡ãƒ¼ãƒ«é…ä¿¡':'Native apps, Video streaming, Real-time video calls, Email delivery',
      saas: G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤, ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ«å¯¾å¿œ':'Native apps, On-premise deployment, White-label support',
      content: G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, å‹•ç”»é…ä¿¡, ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ãƒ¡ãƒ¼ãƒ«':'Native apps, Video streaming, Comment notification emails',
      analytics: G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, ETLãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰, ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹':'Native apps, ETL pipeline, Data warehouse',
      booking: G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, æ±ºæ¸ˆä»£è¡Œ, ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ(å¤–éƒ¨API)':'Native apps, Payment processing, Calendar sync (external API)',
      marketplace: G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, ç‰©æµç®¡ç†, ã‚¨ã‚¹ã‚¯ãƒ­ãƒ¼æ±ºæ¸ˆ':'Native apps, Logistics management, Escrow payments',
    };
    return defaults[domain] || (G?'ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª, ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª':'Native apps, Mobile apps');
  })();
  if(a.mobile&&!isNone(a.mobile)&&!String(a.mobile).includes('PWA')){
    scopeOut=scopeOut.replace(/ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒª/g,G?'ã‚¹ãƒˆã‚¢é…å¸ƒç”¨ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ“ãƒ«ãƒ‰ï¼ˆExpo Web UIã¯å¯¾è±¡å†…ï¼‰':'Native app store builds (Expo Web UI is in scope)');
    scopeOut=scopeOut.replace(/native apps?/gi,'Native app store builds (Expo Web UI is in scope)');
  }

  // Auth detail lines
  const authLines=['- '+(G?'èªè¨¼SoTï¼ˆSource of Truthï¼‰':'Auth SoT')+': '+auth.sot,
    '- '+(G?'ãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼':'Token Type')+': '+auth.tokenType,
    '- '+(G?'ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼':'Token Verification')+': '+auth.tokenVerify];
  if(auth.social.length) authLines.push('- '+(G?'ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³':'Social Login')+': '+auth.social.join(', '));
  authLines.push('- '+(G?'HTTPSå¿…é ˆ':'HTTPS required'),'- '+(G?'ç’°å¢ƒå¤‰æ•°ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†':'Secrets via env vars'),'- '+(G?'SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ»XSSå¯¾ç­–':'SQL injection & XSS prevention'));

  // Architecture label
  const archLabel=G?{baas:'BaaSçµ±åˆå‹',bff:'BFFï¼ˆAPI Routesçµ±åˆï¼‰',split:'FE/BEåˆ†é›¢å‹',traditional:'å¾“æ¥å‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ-ã‚µãƒ¼ãƒãƒ¼'}[arch.pattern]:{baas:'BaaS Integration',bff:'BFF (API Routes)',split:'FE/BE Split',traditional:'Traditional Client-Server'}[arch.pattern];

  // â•â•â•â• Constitution â•â•â•â•
  S.files['.spec/constitution.md']=[
    '# '+pn+' â€” '+(G?'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ†²æ³• (Constitution)':'Project Constitution'),
    '> Generated by DevForge v9 â€” '+date,'',
    G?'## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½¿å‘½':'## 1. Mission',a.purpose||(G?'ï¼ˆæœªå®šç¾©ï¼‰':'(Undefined)'),'',
    G?'## 2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼':'## 2. Target Users',a.target||(G?'ï¼ˆæœªå®šç¾©ï¼‰':'(Undefined)'),'',
    G?'## 3. æˆåŠŸæŒ‡æ¨™':'## 3. Success Metrics',
    a.success || (()=>{
      const domain=detectDomain(a.purpose);
      const kpis={
        education: G?'- ã‚³ãƒ¼ã‚¹å®Œäº†ç‡: 70%ä»¥ä¸Š\n- æœˆé–“ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å­¦ç¿’è€…æ•° (MAL): å‰æœˆæ¯”+10%\n- å­¦ç¿’è€…æº€è¶³åº¦ (NPS): 40ä»¥ä¸Š':'- Course completion rate: 70%+\n- Monthly Active Learners (MAL): +10% MoM\n- Learner NPS: 40+',
        ec: G?'- æœˆé–“GMV: å‰æœˆæ¯”+15%\n- è³¼å…¥CVR: 3%ä»¥ä¸Š\n- ã‚«ãƒ¼ãƒˆé›¢è„±ç‡: 70%ä»¥ä¸‹':'- Monthly GMV: +15% MoM\n- Purchase CVR: 3%+\n- Cart abandonment: <70%',
        community: G?'- æœˆé–“ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ (MAU): å‰æœˆæ¯”+10%\n- æŠ•ç¨¿/ã‚³ãƒ¡ãƒ³ãƒˆç‡: DAUå¯¾æ¯”30%ä»¥ä¸Š\n- 7æ—¥ãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³ç‡: 40%ä»¥ä¸Š':'- Monthly Active Users (MAU): +10% MoM\n- Post/comment rate: 30%+ of DAU\n- 7-day retention: 40%+',
        saas: G?'- MRRï¼ˆæœˆæ¬¡çµŒå¸¸åç›Šï¼‰: å‰æœˆæ¯”+10%\n- ãƒãƒ£ãƒ¼ãƒ³ç‡: æœˆ5%ä»¥ä¸‹\n- NPS: 40ä»¥ä¸Š':'- MRR: +10% MoM\n- Monthly churn: <5%\n- NPS: 40+',
        content: G?'- æœˆé–“PV: å‰æœˆæ¯”+20%\n- å¹³å‡æ»åœ¨æ™‚é–“: 3åˆ†ä»¥ä¸Š\n- ãƒªãƒ”ãƒ¼ãƒˆè¨ªå•ç‡: 30%ä»¥ä¸Š':'- Monthly PV: +20% MoM\n- Avg session: 3min+\n- Return visit rate: 30%+',
        analytics: G?'- DAU: å‰æœˆæ¯”+10%\n- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ•°: é€±10ä»¶ä»¥ä¸Š/ãƒ¦ãƒ¼ã‚¶ãƒ¼\n- ãƒ‡ãƒ¼ã‚¿æ›´æ–°é »åº¦: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ (< 1åˆ†)':'- DAU: +10% MoM\n- Reports generated: 10+/week/user\n- Data refresh: real-time (<1min)',
        booking: G?'- äºˆç´„å®Œäº†ç‡: 80%ä»¥ä¸Š\n- æœˆé–“äºˆç´„ä»¶æ•°: å‰æœˆæ¯”+15%\n- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡: 10%ä»¥ä¸‹':'- Booking completion: 80%+\n- Monthly bookings: +15% MoM\n- Cancellation rate: <10%',
        marketplace: G?'- æœˆé–“å–å¼•ä»¶æ•°: å‰æœˆæ¯”+15%\n- å‡ºå“è€…å®šç€ç‡: 60%ä»¥ä¸Š\n- è³¼å…¥è€…CVR: 5%ä»¥ä¸Š':'- Monthly transactions: +15% MoM\n- Seller retention: 60%+\n- Buyer CVR: 5%+',
      };
      return kpis[domain] || (G?'- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 80%ä»¥ä¸Š\n- ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦: NPS 40ä»¥ä¸Š\n- p95ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ : 500msä»¥ä¸‹':'- Test coverage: 80%+\n- User satisfaction: NPS 40+\n- p95 response time: <500ms');
    })(),'',
    G?'## 4. æŠ€è¡“åŸå‰‡':'## 4. Tech Principles',
    '- '+(G?'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰':'Frontend')+': '+fe,
    '- '+(G?'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰':'Backend')+': '+be,
    '- '+(G?'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹':'Database')+': '+db,
    '- '+(G?'ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£':'Architecture')+': '+archLabel,
    '- '+(G?'é§†å‹•é–‹ç™ºæ‰‹æ³•':'Dev Methods')+': '+methods.join(', '),'',
    G?'## 5. å“è³ªåŸºæº–':'## 5. Quality Standards',
    '- '+(G?'ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 80%ä»¥ä¸Š':'Test Coverage: 80%+'),
    '- TypeScript strict mode',
    '- ESLint + Prettier '+(G?'é©ç”¨':'enforced'),
    '- CI/CD '+(G?'ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¿…é ˆ':'pipeline required'),'',
    G?'## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ–¹é‡':'## 6. Security Policy',...authLines,'',
    G?'## 7. ã‚¹ã‚³ãƒ¼ãƒ—å¤–':'## 7. Out of Scope',scopeOut,''
  ].join('\n');

  // B1: Architecture-aware API design
  let apiDesignLines;
  if(arch.isBaaS){
    const bn=be.includes('Supabase')?'Supabase':be.includes('Firebase')?'Firebase':'Convex';
    const rt=be.includes('Supabase')?'Supabase Realtime (WebSocket)':be.includes('Firebase')?'Firestore onSnapshot':'Convex Subscriptions';
    const fn=be.includes('Supabase')?'Supabase Edge Functions (Deno)':be.includes('Firebase')?'Cloud Functions':'Convex Functions';
    apiDesignLines=['- '+(G?'ã‚¢ã‚¯ã‚»ã‚¹æ–¹å¼':'Access')+': '+bn+' Client SDK','- '+(G?'èªè¨¼':'Auth')+': '+auth.tokenType,'- '+(G?'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ':'Realtime')+': '+rt,'- '+(G?'ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯':'Server Logic')+': '+fn];
  } else if(arch.pattern==='bff'){
    apiDesignLines=['- RESTful API (Next.js API Routes / Route Handlers)','- '+(G?'ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°':'Versioning')+': /api/v1/','- '+(G?'èªè¨¼':'Auth')+': '+auth.tokenType,'- '+(G?'ãƒ¬ã‚¹ãƒãƒ³ã‚¹':'Response')+': JSON','- '+(G?'æ³¨æ„':'Note')+': '+(G?'Express ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ Next.js API Routes ã«çµ±åˆã€‚åˆ¥é€” Express ã‚µãƒ¼ãƒãƒ¼ã¯ä¸è¦':'Express logic integrated into Next.js API Routes. No separate Express server needed.')];
  } else {
    apiDesignLines=['- RESTful API (OpenAPI 3.0)','- '+(G?'ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°':'Versioning')+': /api/v1/','- '+(G?'èªè¨¼':'Auth')+': '+auth.tokenType,'- '+(G?'ãƒ¬ã‚¹ãƒãƒ³ã‚¹':'Response')+': JSON'];
  }

  const hasMob=a.mobile&&!isNone(a.mobile);
  const hasPay=a.payment&&!isNone(a.payment);

  // â•â•â•â• Specification â•â•â•â•
  const specLines=[
    '# '+pn+' â€” '+(G?'è¦ä»¶ä»•æ§˜æ›¸ (Specification)':'Specification'),
    '> Generated by DevForge v9 â€” '+date,'',
    G?'## 1. æ©Ÿèƒ½è¦ä»¶':'## 1. Functional Requirements','',
    G?'### 1.1 MVPæ©Ÿèƒ½':'### 1.1 MVP Features',
    ...(a.mvp_features||'').split(', ').flatMap(f=>{
      const fd=getFeatureDetail(f);
      const lines=['#### '+f.trim()];
      if(fd){
        const criteria=G?fd.criteria_ja:fd.criteria_en;
        lines.push((G?'**å—å…¥æ¡ä»¶:**':'**Acceptance Criteria:**'));
        criteria.forEach(c=>{
          const expanded=c.replace(/\{auth\}/g,a.auth||'OAuth');
          lines.push('- [ ] '+expanded);
        });
      } else {
        lines.push('- [ ] '+(G?'CRUDå®Ÿè£…':'CRUD implementation'));
        lines.push('- [ ] '+(G?'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³':'Validation'));
        lines.push('- [ ] '+(G?'æ¨©é™ãƒã‚§ãƒƒã‚¯':'Authorization check'));
      }
      lines.push('');
      return lines;
    }),
    G?'### 1.2 ä¸»è¦ç”»é¢':'### 1.2 Key Screens',
    (a.screens||'').split(', ').map(s=>'- '+s).join('\n'),'',
    G?'### 1.3 ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°':'### 1.3 Routing',
    '| URL | '+(G?'ç”»é¢å':'Screen')+' | '+(G?'èªè¨¼':'Auth')+' |',
    '|-----|------|------|',
    ...genRoutes(a).map(r=>'| `'+r.path+'` | '+r.name+' | '+(r.auth?(G?'ğŸ”’ è¦':'ğŸ”’ Yes'):(G?'ğŸŒ å…¬é–‹':'ğŸŒ Public'))+' |'),
    '',
    G?'### 1.4 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«':'### 1.4 Data Model','```',
    (G?'ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£':'Entities')+': '+(a.data_entities||(G?'ï¼ˆæœªå®šç¾©ï¼‰':'(Undefined)')),'```','',
    G?'## 2. éæ©Ÿèƒ½è¦ä»¶':'## 2. Non-functional Requirements',
    '- '+(G?'ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ':'Response Time')+': '+(S.skill==='pro'?'< 200ms (p95)':S.skill==='intermediate'?'< 500ms (p95)':'< 1000ms (p95)'),
    '- '+(G?'å¯ç”¨æ€§':'Availability')+': '+(S.skill==='pro'?'99.9%':S.skill==='intermediate'?'99%':(G?'ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆï¼ˆPaaSä¾å­˜ï¼‰':'Best effort (PaaS-dependent)')),
    '- '+(G?'åŒæ™‚æ¥ç¶š':'Concurrent Users')+': '+(S.skill==='pro'?'1000+':S.skill==='intermediate'?'ã€œ200':'ã€œ50'),
    '- '+(G?'ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ':'Mobile')+': '+(hasMob?'âœ… '+a.mobile:(G?'ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–Webã®ã¿':'Responsive Web only')),'',
    G?'## 3. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯':'## 3. Tech Stack',
    '| '+(G?'ãƒ¬ã‚¤ãƒ¤ãƒ¼':'Layer')+' | '+(G?'æŠ€è¡“':'Tech')+' |','|---------|------|',
    '| '+(G?'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰':'Frontend')+' | '+fe+' |',
    '| '+(G?'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰':'Backend')+' | '+be+' |',
    '| '+(G?'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹':'Database')+' | '+db+' |',
    '| '+(G?'èªè¨¼SoT':'Auth SoT')+' | '+auth.sot+' |',
    '| '+(G?'ãƒ‡ãƒ—ãƒ­ã‚¤':'Deploy')+' | '+(a.deploy||'Vercel')+' |',
  ];
  if(hasMob) specLines.push('| '+(G?'ãƒ¢ãƒã‚¤ãƒ«':'Mobile')+' | '+a.mobile+' |');
  if(hasPay) specLines.push('| '+(G?'æ±ºæ¸ˆ':'Payment')+' | '+a.payment+' |');
  specLines.push('',G?'## 4. APIè¨­è¨ˆæ–¹é‡':'## 4. API Design',...apiDesignLines,'');

  // Stripe integration design
  if(hasPay&&(a.payment||'').includes('Stripe')){
    const isEdge=arch.isBaaS&&be.includes('Supabase');
    specLines.push(
      G?'## 5. æ±ºæ¸ˆè¨­è¨ˆ (Stripe)':'## 5. Payment Design (Stripe)','',
      G?'### 5.1 ãƒ—ãƒ©ãƒ³è¨­è¨ˆ':'### 5.1 Plan Design',
      '| '+(G?'ãƒ—ãƒ©ãƒ³':'Plan')+' | '+(G?'ä¾¡æ ¼':'Price')+' | '+(G?'åˆ¶é™':'Limits')+' |',
      '|--------|-------|------|',
      '| Free | Â¥0 | '+(G?'åŸºæœ¬æ©Ÿèƒ½ã®ã¿':'Basic features only')+' |',
      '| Pro | Â¥980/'+(G?'æœˆ':'mo')+' | '+(G?'å…¨æ©Ÿèƒ½ãƒ»å„ªå…ˆã‚µãƒãƒ¼ãƒˆ':'All features, priority support')+' |',
      '| Enterprise | Â¥9,800/'+(G?'æœˆ':'mo')+' | '+(G?'å…¨æ©Ÿèƒ½+SLA+å°‚ç”¨ã‚µãƒãƒ¼ãƒˆ':'All features + SLA + dedicated support')+' |','',
      G?'### 5.2 æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼':'### 5.2 Payment Flow',
      '```',
      G?'1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³é¸æŠ':'1. User selects plan',
      G?'2. Stripe Checkout ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ':'2. Create Stripe Checkout session',
      G?'3. Stripeæ±ºæ¸ˆç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ':'3. Redirect to Stripe payment page',
      G?'4. æ±ºæ¸ˆå®Œäº† â†’ success_url ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ':'4. Payment complete â†’ redirect to success_url',
      G?'5. Webhook (invoice.paid) â†’ DBæ›´æ–°':'5. Webhook (invoice.paid) â†’ update DB',
      '```','',
      G?'### 5.3 Webhookã‚¤ãƒ™ãƒ³ãƒˆ':'### 5.3 Webhook Events',
      '| Event | '+(G?'å‡¦ç†':'Action')+' |',
      '|-------|------|',
      '| `checkout.session.completed` | '+(G?'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³é–‹å§‹':'Start subscription')+' |',
      '| `invoice.paid` | '+(G?'æ”¯æ‰•ç¢ºèªãƒ»æœŸé–“æ›´æ–°':'Confirm payment, renew period')+' |',
      '| `customer.subscription.updated` | '+(G?'ãƒ—ãƒ©ãƒ³å¤‰æ›´åæ˜ ':'Apply plan change')+' |',
      '| `customer.subscription.deleted` | '+(G?'è§£ç´„å‡¦ç†':'Cancel subscription')+' |','',
      G?'### 5.4 å®Ÿè£…':'### 5.4 Implementation',
      '- Endpoint: `/api/webhook/stripe`',
      '- '+(G?'ç½²åæ¤œè¨¼':'Signature verification')+': `stripe.webhooks.constructEvent()`',
      '- '+(G?'å†ªç­‰æ€§':'Idempotency')+': event.id '+(G?'ã§DBé‡è¤‡ãƒã‚§ãƒƒã‚¯':'DB dedup check'),
      '- '+(G?'é¡§å®¢ç´ä»˜':'Customer mapping')+': User.stripe_customer_id','',
    );
  }

  // RBAC design
  const hasAdmin=/ç®¡ç†è€…|admin/i.test(a.target||'');
  if(hasAdmin){
    const rbacSectionNum=hasPay&&(a.payment||'').includes('Stripe')?6:5;
    specLines.push(
      (G?'## '+rbacSectionNum+'. ãƒ­ãƒ¼ãƒ«ãƒ»æ¨©é™è¨­è¨ˆ (RBAC)':'## '+rbacSectionNum+'. Role & Permission Design (RBAC)'),'',
      G?'### ãƒ­ãƒ¼ãƒ«å®šç¾©':'### Role Definitions',
      '| '+(G?'ãƒ­ãƒ¼ãƒ«':'Role')+' | '+(G?'èª¬æ˜':'Description')+' | '+(G?'æ¨©é™':'Permissions')+' |',
      '|--------|------|------|',
      '| user | '+(G?'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼':'Regular user')+' | '+(G?'è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®CRUD':'Own data CRUD')+' |',
      '| admin | '+(G?'ç®¡ç†è€…':'Administrator')+' | '+(G?'å…¨ãƒ‡ãƒ¼ã‚¿ã®é–²è¦§ãƒ»ç·¨é›†ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†':'All data view/edit, user management')+' |',
      '| super_admin | '+(G?'ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…':'Super admin')+' | '+(G?'ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒ»ãƒ­ãƒ¼ãƒ«å¤‰æ›´':'System config, role changes')+' |','',
      G?'### æ¨©é™ãƒã‚§ãƒƒã‚¯':'### Permission Check',
      '- profiles.role '+(G?'ã‚«ãƒ©ãƒ ã§ãƒ­ãƒ¼ãƒ«ç®¡ç†':'column for role management'),
      '- '+(G?'ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢':'Middleware')+': '+(arch.isBaaS?'RLS + auth.jwt() role check':(G?'API Middleware ã§ role ãƒã‚§ãƒƒã‚¯':'API middleware role check')),
      '- '+(G?'ç®¡ç†è€…ãƒ«ãƒ¼ãƒˆ':'Admin routes')+': /admin/ â†’ role=admin '+(G?'ä»¥ä¸Š':'or above'),
      '- '+(G?'ç›£æŸ»ãƒ­ã‚°':'Audit log')+': '+(G?'ç®¡ç†è€…æ“ä½œã¯å…¨ä»¶è¨˜éŒ²':'Log all admin actions'),'',
    );
  }

  S.files['.spec/specification.md']=specLines.join('\n');

  // Directory structure adapts to architecture
  const dirLines=[pn+'/',
    'â”œâ”€â”€ src/',
    'â”‚   â”œâ”€â”€ app/          # '+(G?'ãƒšãƒ¼ã‚¸ãƒ»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°':'Pages & routing'),
    'â”‚   â”œâ”€â”€ components/   # '+(G?'UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ':'UI components'),
    'â”‚   â”œâ”€â”€ lib/          # '+(G?'ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£':'Utilities'),
    'â”‚   â”œâ”€â”€ hooks/        # '+(G?'ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯':'Custom hooks'),
    'â”‚   â””â”€â”€ types/        # '+(G?'TypeScriptå‹å®šç¾©':'TypeScript types')];
  if(arch.isBaaS){
    if(be.includes('Supabase')) dirLines.push('â”œâ”€â”€ supabase/         # '+(G?'ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»Edge Functions':'Migrations & Edge Functions'));
    else if(be.includes('Firebase')) dirLines.push('â”œâ”€â”€ functions/        # '+(G?'Cloud Functions':'Cloud Functions'));
  } else {
    if(arch.pattern!=='bff') dirLines.push('â”œâ”€â”€ api/              # '+(G?'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API':'Backend API'));
    const ormN=(a.orm&&a.orm.includes('Drizzle'))?'drizzle':'prisma';
    dirLines.push('â”œâ”€â”€ '+ormN+'/           # '+(G?'ã‚¹ã‚­ãƒ¼ãƒãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³':'Schema & migrations'));
  }
  dirLines.push('â”œâ”€â”€ tests/            # '+(G?'ãƒ†ã‚¹ãƒˆ':'Tests'),
    'â”œâ”€â”€ .spec/            # '+(G?'SDDä»•æ§˜æ›¸':'SDD specs'),
    'â”œâ”€â”€ .devcontainer/    # '+(G?'é–‹ç™ºç’°å¢ƒ':'Dev environment'),
    'â”œâ”€â”€ roadmap/          # '+(G?'å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—':'Learning roadmap'),
    'â””â”€â”€ docs/             # '+(G?'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ':'Documents'));
  const dirNote=arch.pattern==='bff'?'\n> '+(G?'Note: Express ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ src/app/api/ é…ä¸‹ã® Route Handlers ã«çµ±åˆ':'Note: Express logic integrated into src/app/api/ Route Handlers')+'\n':'';

  const entities=(a.data_entities||'users, items').split(/[,ã€]\s*/).map(e=>e.trim()).filter(Boolean);
  const entityLines=entities.map(en=>{
    const cols=getEntityColumns(en,G,entities);
    const lines=['### '+en,'- id: UUID (PK)'];
    cols.forEach(c=>lines.push('- '+c.col+': '+c.type+(c.constraint?' ('+c.constraint+')':'')+(c.desc?' â€” '+c.desc:'')));
    lines.push('- created_at: timestamp','- updated_at: timestamp');
    return lines.join('\n');
  }).join('\n\n');
  // B5: ER inference
  const er=inferER(a);
  const erRelSection=er.relationships.length?'\n'+(G?'### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³':'### Relationships')+'\n```\n'+er.relationships.join('\n')+'\n```':'';
  const erWarnSection=er.warnings.length?'\n'+(G?'### âš ï¸ ãƒ‰ãƒ¡ã‚¤ãƒ³é©åˆæ€§ã®æ³¨è¨˜':'### âš ï¸ Domain Fit Notes')+'\n'+er.warnings.join('\n'):'';
  const supaNote=(arch.isBaaS&&be.includes('Supabase'))?'> '+(G?'Supabase Dashboard ã¾ãŸã¯ supabase/migrations/ ã§ã‚¹ã‚­ãƒ¼ãƒç®¡ç†':'Manage schema via Supabase Dashboard or supabase/migrations/')+'\n\n':'';
  const deployNote=arch.pattern==='split'?' (FE) + Railway/Render ('+be+')':'';

  // Per-table RLS policies
  let rlsSection='';
  if(arch.isBaaS&&be.includes('Supabase')){
    const rlsLines=[G?'### RLSï¼ˆRow Level Securityï¼‰æ–¹é‡':'### RLS (Row Level Security) Policy',
      G?'å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«RLSæœ‰åŠ¹åŒ–ã€‚ãƒãƒªã‚·ãƒ¼ä¾‹:':'Enable RLS on all tables. Policy examples:','','```sql'];
    (a.data_entities||'').split(/[,ã€]\s*/).map(e=>e.trim()).filter(Boolean).forEach(e=>{
      const en=e.trim();const tbl=pluralize(en);
      const cols=getEntityColumns(en,G,entities);
      const hasUserId=cols.some(c=>c.col==='user_id');
      const hasOwnerId=cols.some(c=>c.col==='owner_id'||c.col==='instructor_id'||c.col==='provider_id'||c.col==='sender_id');
      const ownerCol=hasUserId?'user_id':cols.find(c=>c.col==='owner_id'||c.col==='instructor_id'||c.col==='provider_id')?.col;
      if(en.toLowerCase()==='user'){
        rlsLines.push(`-- ${tbl}: ${G?'æœ¬äººã®ã¿èª­å–ãƒ»æ›´æ–°':'Owner read/update only'}`,
          `CREATE POLICY "${tbl}_select" ON ${tbl} FOR SELECT USING (auth.uid() = id);`,
          `CREATE POLICY "${tbl}_update" ON ${tbl} FOR UPDATE USING (auth.uid() = id);`,'');
      } else if(ownerCol){
        rlsLines.push(`-- ${tbl}: ${G?'æœ¬äººã®ãƒ‡ãƒ¼ã‚¿ã®ã¿æ“ä½œå¯':'Owner CRUD only'}`,
          `CREATE POLICY "${tbl}_select" ON ${tbl} FOR SELECT USING (auth.uid() = ${ownerCol});`,
          `CREATE POLICY "${tbl}_insert" ON ${tbl} FOR INSERT WITH CHECK (auth.uid() = ${ownerCol});`,
          `CREATE POLICY "${tbl}_update" ON ${tbl} FOR UPDATE USING (auth.uid() = ${ownerCol});`,
          `CREATE POLICY "${tbl}_delete" ON ${tbl} FOR DELETE USING (auth.uid() = ${ownerCol});`,'');
      } else {
        rlsLines.push(`-- ${tbl}: ${G?'èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª­å–å¯':'Authenticated read'}`,
          `CREATE POLICY "${tbl}_select" ON ${tbl} FOR SELECT USING (auth.role() = 'authenticated');`,'');
      }
    });
    rlsLines.push('```');
    rlsSection='\n'+rlsLines.join('\n');
  }

  // Stripe integration section (uses hasPay/hasStripe from above)
  const hasStripe=hasPay&&(a.payment||'').includes('Stripe');
  let stripeSection='';
  if(hasStripe){
    const fn=arch.isBaaS&&be.includes('Supabase')?'Supabase Edge Function':'API Route';
    stripeSection='\n\n'+(G?'## 7. æ±ºæ¸ˆè¨­è¨ˆ (Stripe)':'## 7. Payment Design (Stripe)')+'\n\n'+
      (G?'### ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«':'### Subscription Model')+'\n'+
      '| '+(G?'ãƒ—ãƒ©ãƒ³':'Plan')+' | '+(G?'ä¾¡æ ¼':'Price')+' | '+(G?'æ©Ÿèƒ½åˆ¶é™':'Limits')+' |\n'+
      '|------|------|------|\n'+
      '| Free | Â¥0 | '+(G?'åŸºæœ¬æ©Ÿèƒ½ã®ã¿':'Basic features only')+' |\n'+
      '| Pro | Â¥980/'+(G?'æœˆ':'mo')+' | '+(G?'å…¨æ©Ÿèƒ½+å„ªå…ˆã‚µãƒãƒ¼ãƒˆ':'All features + priority support')+' |\n'+
      '| Enterprise | Â¥9,800/'+(G?'æœˆ':'mo')+' | '+(G?'å…¨æ©Ÿèƒ½+SLA+å°‚ç”¨ã‚µãƒãƒ¼ãƒˆ':'All features + SLA + dedicated support')+' |\n\n'+
      (G?'### Webhookå‡¦ç†ãƒ•ãƒ­ãƒ¼':'### Webhook Flow')+'\n```\n'+
      'Stripe â†’ POST /api/webhook/stripe â†’ '+(G?'ç½²åæ¤œè¨¼':'Verify signature')+'\n'+
      '  â”œâ”€â”€ invoice.paid â†’ subscription.status = active\n'+
      '  â”œâ”€â”€ invoice.payment_failed â†’ '+(G?'ãƒªãƒˆãƒ©ã‚¤é€šçŸ¥ãƒ¡ãƒ¼ãƒ«':'Retry notification email')+'\n'+
      '  â”œâ”€â”€ customer.subscription.deleted â†’ subscription.status = canceled\n'+
      '  â””â”€â”€ customer.subscription.updated â†’ '+(G?'ãƒ—ãƒ©ãƒ³å¤‰æ›´åæ˜ ':'Update plan info')+'\n```\n\n'+
      (G?'### DBè¨­è¨ˆ':'### DB Design')+'\n'+
      (G?'subscriptions ãƒ†ãƒ¼ãƒ–ãƒ«:':'subscriptions table:')+'\n'+
      '- user_id: UUID (FK â†’ users)\n'+
      '- stripe_subscription_id: TEXT (UNIQUE)\n'+
      '- stripe_customer_id: TEXT\n'+
      '- status: active | canceled | past_due | trialing\n'+
      '- plan: free | pro | enterprise\n'+
      '- current_period_end: TIMESTAMP\n\n'+
      (G?'### å®Ÿè£…å ´æ‰€':'### Implementation')+': '+fn+'\n'+
      '- POST /api/checkout â†’ stripe.checkout.sessions.create()\n'+
      '- POST /api/webhook/stripe â†’ '+(G?'ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†':'Event handling')+'\n'+
      '- GET /api/subscription â†’ '+(G?'ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³å–å¾—':'Get current plan');
  }

  const fullEntitySection=supaNote+entityLines+erRelSection+erWarnSection+rlsSection;

  // â•â•â•â• Technical Plan â•â•â•â•
  S.files['.spec/technical-plan.md']=[
    '# '+pn+' â€” '+(G?'æŠ€è¡“è¨ˆç”»æ›¸ (Technical Plan)':'Technical Plan'),
    '> Generated by DevForge v9 â€” '+date,'',
    G?'## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦':'## 1. Architecture Overview',
    (G?'### ãƒ‘ã‚¿ãƒ¼ãƒ³':'### Pattern')+': '+archLabel,'','```',arch.diagram,'```',
    arch.note?'\n> '+arch.note+'\n':'',
    G?'## 2. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ':'## 2. Directory Structure','```',dirLines.join('\n'),'```',dirNote,'',
    G?'## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ':'## 3. Database Design',fullEntitySection,'',
    G?'## 4. èªè¨¼è¨­è¨ˆ':'## 4. Auth Design',
    '- '+(G?'èªè¨¼SoT':'Auth SoT')+': **'+auth.sot+'**',
    '- '+(G?'ãƒˆãƒ¼ã‚¯ãƒ³':'Token')+': '+auth.tokenType,
    '- '+(G?'æ¤œè¨¼æ–¹æ³•':'Verification')+': '+auth.tokenVerify,
    auth.social.length?'- '+(G?'å¯¾å¿œãƒ—ãƒ­ãƒã‚¤ãƒ€':'Providers')+': '+auth.social.join(', '):'','',
    (()=>{
      var isMultiTenant=/ãƒãƒ«ãƒ|multi|RLS|çµ„ç¹”|org.*hier/i.test((a.org_model||'')+(a.mvp_features||''));
      if(!isMultiTenant) return '';
      return [
        G?'## 4.5 ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£':'## 4.5 Multi-Tenant Architecture',
        G?'### ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢æˆ¦ç•¥: Row-Level Security (RLS)':'### Tenant Isolation: Row-Level Security (RLS)',
        '```mermaid\ngraph LR\n  U[User]-->|auth.uid()|R[RLS Policy]\n  R-->|org_id check|T['+pn+' Data]\n  R-->|blocked|X[Other Org Data]\n  style R fill:#4f46e5,color:#fff\n```',
        '',
        G?'### æ¨©é™ãƒ¢ãƒ‡ãƒ« (4éšå±¤)':'### Permission Model (4-tier)',
        '| Role | '+( G?'æ¨©é™':'Permissions')+' |',
        '|------|-------------|',
        '| owner | '+( G?'å…¨æ¨©é™ (å‰Šé™¤ãƒ»èª²é‡‘å«ã‚€)':'Full access (delete, billing)') +' |',
        '| admin | '+(G?'ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ»è¨­å®šå¤‰æ›´':'Member mgmt, config changes')+' |',
        '| member | '+(G?'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆãƒ»ç·¨é›†':'Create/edit content')+' |',
        '| viewer | '+(G?'èª­ã¿è¾¼ã¿ã®ã¿':'Read only')+' |',
        '',
        G?'### ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æ–¹é‡':'### Data Partitioning',
        '- '+( G?'å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã« `org_id` ã‚«ãƒ©ãƒ å¿…é ˆ':'All tables require `org_id` column'),
        '- '+(G?'ã‚¯ãƒ­ã‚¹ãƒ†ãƒŠãƒ³ãƒˆã‚¯ã‚¨ãƒªé˜²æ­¢: RLSãƒãƒªã‚·ãƒ¼ã§å¼·åˆ¶':'Cross-tenant prevention: enforced by RLS'),
        '- '+(G?'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: `(org_id, id)` è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¨å¥¨':'Index: composite `(org_id, id)` recommended'),
        G?'> è©³ç´°: `docs/73_enterprise_architecture.md`':
          '> Details: `docs/73_enterprise_architecture.md`'
      ].join('\n');
    })(),
    G?'## 5. é–‹ç™ºç’°å¢ƒ':'## 5. Dev Environment',
    '- Docker DevContainer (.devcontainer/)',
    '- '+(arch.isBaaS?be+' CLI (local emulator)':'Node.js LTS + '+db),
    '- '+((a.ai_tools||'Cursor').split(', ')[0])+' + '+(G?'AIæ”¯æ´':'AI-assisted'),'',
    '## 6. CI/CD','- GitHub Actions','- lint â†’ test â†’ build â†’ deploy',
    '- '+(G?'ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ':'Deploy')+': '+(a.deploy||'Vercel')+deployNote,
    stripeSection,''
  ].join('\n');

  // B7: Tasks from single schedule source
  const sprintTasks=(si)=>{
    if(si===0) return ['- [ ] '+(G?'ãƒªãƒã‚¸ãƒˆãƒªä½œæˆãƒ»åˆæœŸè¨­å®š':'Repo init & config'),
      '- [ ] '+(G?'DevContainerè¨­å®š':'DevContainer setup'),
      '- [ ] '+(G?'CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰':'CI/CD pipeline'),
      '- [ ] '+(G?'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©':'Database schema')+((arch.isBaaS&&be.includes('Supabase'))?' + '+(G?'RLSãƒãƒªã‚·ãƒ¼è¨­å®š':'RLS policy setup'):''),
      '- [ ] '+(G?'èªè¨¼åŸºç›¤å®Ÿè£…':'Auth implementation')+' ('+auth.sot+')'].join('\n');
    if(si===1) return (a.mvp_features||(G?'CRUDæ“ä½œ':'CRUD Operations')).split(', ').map(f=>'- [ ] '+f).join('\n');
    if(si===2) return (a.screens||(G?'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰, ãƒ­ã‚°ã‚¤ãƒ³':'Dashboard, Login')).split(', ').map(s=>'- [ ] '+s+' '+(G?'ç”»é¢å®Ÿè£…':'screen')).join('\n');
    if(si===3) return ['- [ ] '+(G?'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ (ã‚«ãƒãƒ¬ãƒƒã‚¸80%+)':'Unit tests (80%+ coverage)'),
      '- [ ] '+(G?'E2Eãƒ†ã‚¹ãƒˆ (ä¸»è¦ãƒ•ãƒ­ãƒ¼)':'E2E tests (key flows)'),
      '- [ ] '+(G?'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–':'Performance optimization'),
      '- [ ] '+(G?'æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤':'Production deploy'),
      '- [ ] '+(G?'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™':'Documentation')].join('\n');
    if(si===4) return ['- [ ] '+a.mobile+' '+(G?'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–':'project init'),
      '- [ ] '+(G?'ç”»é¢å®Ÿè£…ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç‰ˆï¼‰':'Mobile screens'),
      '- [ ] '+(G?'ã‚¹ãƒˆã‚¢ãƒ“ãƒ«ãƒ‰è¨­å®š':'Store build config'),
      '- [ ] '+(G?'ãƒ†ã‚¹ãƒˆ':'Testing')].join('\n');
    return '';
  };

  S.files['.spec/tasks.md']=[
    '# '+pn+' â€” '+(G?'ã‚¿ã‚¹ã‚¯ä¸€è¦§ (Tasks)':'Task List'),
    '> Generated by DevForge v9 â€” '+date,
    '> '+(G?'è¨ˆç”»æœŸé–“':'Timeline')+': '+sched.totalWeeks+' '+(G?'é€±é–“':'weeks')+' ('+sched.startDate+' ã€œ)','',
    ...sched.sprints.map((sp,i)=>'## '+sp.name+': '+(G?sp.focus_ja:sp.focus_en)+' ['+sp.weeks+']\n'+sprintTasks(i)),''
  ].join('\n\n');

  // â•â•â•â• Verification â•â•â•â•
  const mobTest=hasMob?'| '+(G?'ãƒ¢ãƒã‚¤ãƒ«E2E':'Mobile E2E')+' | Maestro / Detox | '+(G?'ä¸»è¦ãƒ•ãƒ­ãƒ¼':'Key flows')+' |':'';
  const rlsTest=(arch.isBaaS&&be.includes('Supabase'))?'- [ ] '+(G?'RLSãƒãƒªã‚·ãƒ¼ãƒ†ã‚¹ãƒˆ (å…¨ãƒ†ãƒ¼ãƒ–ãƒ«)':'RLS policy tests (all tables)'):'';
  const features=(a.mvp_features||'').split(', ').filter(Boolean);

  S.files['.spec/verification.md']=[
    '# '+pn+' â€” '+(G?'æ¤œè¨¼è¨ˆç”»æ›¸ (Verification)':'Verification Plan'),
    '> Generated by DevForge v9 â€” '+date,'',
    G?'## 1. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥':'## 1. Test Strategy',
    '| '+(G?'ãƒ†ã‚¹ãƒˆç¨®åˆ¥':'Test Type')+' | '+(G?'ãƒ„ãƒ¼ãƒ«':'Tool')+' | '+(G?'ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™':'Coverage Goal')+' |',
    '|-----------|--------|-------------|',
    '| '+(G?'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ':'Unit Test')+' | Vitest | 80% |',
    '| '+(G?'çµ±åˆãƒ†ã‚¹ãƒˆ':'Integration')+' | Vitest | '+(G?'ä¸»è¦APIå…¨ã¦':'All major APIs')+' |',
    '| '+(G?'E2Eãƒ†ã‚¹ãƒˆ':'E2E Test')+' | Playwright | '+(G?'ä¸»è¦ãƒ•ãƒ­ãƒ¼':'Key flows')+' |',
    mobTest,'',
    G?'## 2. é§†å‹•é–‹ç™ºæ‰‹æ³•ã«ã‚ˆã‚‹æ¤œè¨¼':'## 2. Dev Method Verification',
    methods.map(m=>'### '+m+'\n- '+(G?'å®Ÿæ–½ã‚¿ã‚¤ãƒŸãƒ³ã‚°: å…¨Sprint':'Timing: All sprints')+'\n- '+(G?'æ¤œè¨¼é …ç›®: ä»•æ§˜ã¨ã®æ•´åˆæ€§':'Verify: Spec alignment')).join('\n\n'),'',
    G?'## 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸºæº–':'## 3. Performance Benchmarks',
    '- Lighthouse Score: 90+','- LCP: < 2.5s','- FID: < 100ms','- CLS: < 0.1','',
    G?'## 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯':'## 4. Security Checklist',
    '- [ ] '+(G?'OWASP Top 10å¯¾ç­–ç¢ºèª':'OWASP Top 10 compliance'),
    '- [ ] '+(G?'ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³':'Dependency vulnerability scan'),
    '- [ ] '+(G?'èªè¨¼ãƒ»èªå¯ãƒ†ã‚¹ãƒˆ':'Auth/authorization tests')+' ('+auth.sot+')',
    '- [ ] '+(G?'ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª':'Data validation check'),
    rlsTest,'',
    // G4: Feature-specific verification checklist
    G?'## 5. æ©Ÿèƒ½åˆ¥æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ':'## 5. Feature Verification Checklist',
    ...features.flatMap(f=>{
      const fd=getFeatureDetail(f);
      if(!fd) return ['### '+f,'- [ ] '+(G?'å®Ÿè£…å®Œäº†':'Implementation done'),'- [ ] '+(G?'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé€šé':'Unit tests passing'),''];
      const criteria=(G?fd.criteria_ja:fd.criteria_en).map(c=>c.replace(/\{auth\}/g,a.auth||'OAuth'));
      return ['### '+f,...criteria.map(c=>'- [ ] '+c),''];
    }),
  ].join('\n');
}

