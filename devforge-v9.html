<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DevForge v9.0 — AI駆動開発 統合プラットフォーム</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" onerror="window._noZip=true"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js" onerror="window._noMarked=true"></script>
<style>
:root{--bg:#0c0e13;--bg-2:#13161d;--bg-3:#1a1e28;--bg-4:#222733;--surface:#282e3c;--border:#2e3446;--border-light:#3a4158;--text:#e8ecf4;--text-2:#a4adc0;--text-3:#6b7590;--accent:#3b82f6;--accent-soft:rgba(59,130,246,0.12);--accent-2:#22d3ee;--success:#34d399;--warn:#fbbf24;--warn-soft:rgba(251,191,36,0.1);--danger:#f87171;--layer-1:#3b82f6;--layer-2:#8b5cf6;--layer-3:#10b981;--layer-3h:#f59e0b;--layer-4:#ef4444;--layer-5:#06b6d4;--layer-6:#f97316;--layer-7:#a855f7;--chip-bg:#1e2230;--chip-border:#2e3446;--radius:10px;--radius-lg:16px;--mono:'IBM Plex Mono',monospace;--sans:'IBM Plex Sans JP',-apple-system,sans-serif}[data-theme="light"]{--bg:#f5f7fa;--bg-2:#fff;--bg-3:#edf0f5;--bg-4:#e2e6ed;--surface:#d8dce5;--border:#cdd2dc;--border-light:#bfc5d2;--text:#1e222d;--text-2:#4a5168;--text-3:#8690a6;--accent:#2563eb;--accent-soft:rgba(37,99,235,0.08);--accent-2:#0891b2;--success:#059669;--warn:#d97706;--warn-soft:rgba(217,119,6,0.06);--danger:#dc2626;--layer-1:#2563eb;--layer-2:#7c3aed;--layer-3:#059669;--layer-3h:#d97706;--layer-4:#dc2626;--layer-5:#0891b2;--layer-6:#ea580c;--layer-7:#9333ea;--chip-bg:#e8ecf4;--chip-border:#d0d5e0}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}.app{max-width:1440px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:50px;border-bottom:1px solid var(--border);background:var(--bg-2);position:sticky;top:0;z-index:100}.topbar-left{display:flex;align-items:center;gap:16px;min-width:0;flex:1}.topbar-brand{display:flex;align-items:center;gap:10px;flex-shrink:0}.topbar-brand svg{width:20px;height:20px}.topbar-brand span{font-weight:700;font-size:14px;letter-spacing:-0.03em}.topbar-brand small{font-size:11px;color:var(--text-3);font-weight:400;margin-left:2px}.topbar-right{display:flex;gap:6px;flex-shrink:0}.pstrip{height:3px;background:var(--bg-3);position:sticky;top:50px;z-index:99}.pstrip-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .6s cubic-bezier(.4,0,.2,1);box-shadow:0 0 12px var(--accent)}.btn{padding:7px 16px;border:none;border-radius:7px;font-weight:600;font-size:12px;cursor:pointer;font-family:var(--sans);transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}.btn-p{background:var(--accent);color:#fff}.btn-p:hover{background:#2563eb;transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,0.3)}.btn-s{background:var(--bg-3);color:var(--text-2);border:1px solid var(--border)}.btn-s:hover{background:var(--bg-4);color:var(--text)}.btn-d{background:var(--success);color:#fff}.btn-d:hover{background:#059669}.btn-g{background:transparent;color:var(--text-3)}.btn-g:hover{color:var(--text)}.btn-sm{padding:5px 12px;font-size:11px}.btn-xs{padding:3px 10px;font-size:10px}.theme-btn{background:none;border:none;font-size:16px;cursor:pointer;padding:4px 8px;border-radius:6px;transition:background .15s;color:var(--text)}.theme-btn:hover{background:var(--bg-3)}.onboard{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;gap:24px;text-align:center}.onboard h1{font-size:28px;font-weight:700;letter-spacing:-0.03em;background:linear-gradient(135deg,var(--accent),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.onboard p{color:var(--text-2);font-size:14px;max-width:560px;line-height:1.7}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;max-width:760px;width:100%}.icard{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:left}.icard h4{font-size:13px;margin-bottom:4px}.icard p{font-size:11px;color:var(--text-3);line-height:1.5}.pillars-badge{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:700px}.pbadge{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;background:var(--bg-3);color:var(--text-2);border:1px solid var(--border)}.start-zone{display:flex;flex-direction:column;gap:12px;align-items:center;width:100%;max-width:560px}.nameIn{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-3);color:var(--text);font-size:14px;font-family:var(--sans);outline:none;transition:border-color .2s}.nameIn:focus{border-color:var(--accent)}.preset-row{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}.prchip{padding:5px 14px;border-radius:20px;font-size:11px;font-weight:600;background:var(--chip-bg);color:var(--text-2);border:1px solid var(--chip-border);cursor:pointer;transition:all .15s}.prchip:hover{border-color:var(--accent);color:var(--accent)}.prchip.on{background:var(--accent-soft);color:var(--accent);border-color:var(--accent)}.prchip-cmp{background:color-mix(in srgb,var(--warn) 10%,transparent)!important;color:var(--warn)!important;border-color:color-mix(in srgb,var(--warn) 30%,transparent)!important}.cmp-selectors{display:flex;align-items:center;gap:8px;margin-bottom:16px}.cmp-selectors select{flex:1;padding:8px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg-1);color:var(--text);font-size:12px}.cmp-vs{font-weight:700;color:var(--warn);font-size:13px}.cmp-table{width:100%;font-size:11px;border-collapse:collapse}.cmp-table th{text-align:left;padding:6px 8px;background:var(--bg-3);font-size:11px}.cmp-table td{padding:5px 8px;border-bottom:1px solid var(--border)}.cmp-label{font-weight:600;color:var(--text-3);min-width:70px}.cmp-diff td:not(.cmp-label){background:color-mix(in srgb,var(--warn) 6%,transparent)}.ws{display:flex;flex:1;overflow:hidden}#ws{flex:1;flex-direction:column;overflow:hidden}.panel-c{flex:1;display:flex;flex-direction:column;border-right:1px solid var(--border);min-width:0;overflow:hidden}.panel-p{width:50%;display:flex;flex-direction:column;min-width:0;overflow:hidden}.badge{font-size:11px;padding:2px 10px;border-radius:10px;background:var(--accent-soft);color:var(--accent);font-weight:600}.cbody{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px}.izone{border-top:1px solid var(--border);background:var(--bg-2);flex-shrink:0}.msg{display:flex;gap:10px;animation:fadeUp .3s ease}@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.prev-head{display:flex;align-items:center;gap:8px;padding:12px 20px;border-bottom:1px solid var(--border);background:var(--bg-2)}.prev-head h3{font-size:14px;font-weight:600;flex:1}.prev-tabs{display:flex;gap:2px;background:var(--bg-3);border-radius:8px;padding:2px}.ptab{padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600;color:var(--text-3);cursor:pointer;transition:all .15s;border:none;background:none;font-family:var(--sans)}.ptab.on{background:var(--bg-2);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,0.1)}.prev-body{flex:1;overflow-y:auto;padding:20px}.prev-body pre{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);padding:16px;font-family:var(--mono);font-size:12px;line-height:1.6;overflow-x:auto;white-space:pre-wrap;word-break:break-word}.file-tree{list-style:none;font-size:12px;font-family:var(--mono)}.ft-search{margin-bottom:8px}.ft-search input{width:100%;padding:6px 10px;font-size:11px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-2);color:var(--text);font-family:var(--sans);outline:none}.ft-search input:focus{border-color:var(--accent)}.file-tree li{padding:3px 0;color:var(--text-2);cursor:pointer}.file-tree li:hover{color:var(--accent)}.file-tree li.folder{color:var(--warn);font-weight:600}.file-tree li.active{color:var(--accent);font-weight:600}.md-rendered{overflow:auto;max-height:calc(100vh - 200px);font-size:12px;line-height:1.6;padding:8px}.md-rendered h1,.md-rendered h2,.md-rendered h3{color:var(--text);margin:16px 0 8px}.md-rendered h1{font-size:16px;border-bottom:1px solid var(--border);padding-bottom:6px}.md-rendered h2{font-size:14px}.md-rendered h3{font-size:13px}.md-rendered p,.md-rendered li{color:var(--text-2);font-size:12px}.md-rendered pre{background:var(--bg-2);padding:10px;border-radius:6px;overflow-x:auto;font-size:11px}.md-rendered code{font-family:var(--mono);font-size:11px;background:var(--bg-2);padding:1px 4px;border-radius:3px}.md-rendered pre code{background:none;padding:0}.md-rendered table{width:100%;border-collapse:collapse;font-size:11px;margin:8px 0}.md-rendered th,.md-rendered td{border:1px solid var(--border);padding:4px 8px;text-align:left}.md-rendered th{background:var(--bg-2);font-weight:600;color:var(--text)}.md-rendered .mermaid{background:var(--bg-2);padding:16px;border-radius:8px;margin:12px 0;text-align:center;overflow-x:auto}.md-rendered .mermaid svg{max-width:100%}.pillar-tabs{display:flex;gap:2px;flex-wrap:wrap;padding:8px 16px;background:var(--bg-2);border-bottom:1px solid var(--border)}.piltab{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:600;color:var(--text-3);cursor:pointer;border:none;background:none;font-family:var(--sans);transition:all .15s}.piltab.on{background:var(--accent-soft);color:var(--accent)}.piltab:hover{color:var(--text)}.ctx-bar{height:6px;background:var(--bg-4);border-radius:3px;margin-top:8px;overflow:hidden}.ctx-bar-fill{height:100%;border-radius:3px;transition:width .6s}.road-week{font-size:10px;color:var(--text-3);font-weight:600;padding:2px 8px;background:var(--bg-4);border-radius:10px;flex-shrink:0}.mobtabs{display:none;border-bottom:1px solid var(--border);background:var(--bg-2)}.mobtab{flex:1;text-align:center;padding:10px;font-size:12px;font-weight:600;color:var(--text-3);cursor:pointer}.mobtab.on{color:var(--accent);border-bottom:2px solid var(--accent)}.export-summary{display:flex;gap:16px;padding:12px 20px;font-size:12px;font-weight:600;color:var(--text-2);border-bottom:1px solid var(--border);flex-wrap:wrap}.export-summary span{display:flex;align-items:center;gap:4px}.qbar{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:6px;padding:8px 12px;background:var(--bg-2);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:90;align-items:center}.qbar-btn{padding:6px 12px;border:none;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;background:var(--bg-3);color:var(--text);transition:all .15s;white-space:nowrap}.qbar-btn:hover{background:var(--accent-soft);color:var(--accent)}.qbar-x{padding:4px 8px;border:none;background:none;color:var(--text-3);cursor:pointer;font-size:12px}.qbar-x:hover{color:var(--danger)}.export-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;padding:20px}.export-card{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);padding:20px;text-align:center;cursor:pointer;transition:all .15s}.export-card-danger{border-color:color-mix(in srgb,var(--danger) 25%,transparent);opacity:0.7}.export-card-danger:hover{border-color:var(--danger);background:color-mix(in srgb,var(--danger) 6%,transparent);opacity:1}.export-card-regen{border-color:var(--accent);border-style:dashed}.export-card:hover{border-color:var(--accent);transform:translateY(-2px)}.export-card .icon{font-size:32px;margin-bottom:8px}.export-card h4{font-size:13px;margin-bottom:4px}.export-card p{font-size:11px;color:var(--text-3)}.help-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;display:none;align-items:center;justify-content:center}.help-overlay.show{display:flex}.help-modal{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);width:90vw;max-width:800px;height:80vh;display:flex;overflow:hidden}.help-nav{width:200px;background:var(--bg-3);border-right:1px solid var(--border);overflow-y:auto;padding:12px 0;flex-shrink:0}.help-nav a{display:block;padding:8px 16px;font-size:12px;color:var(--text-2);text-decoration:none;transition:all .15s}.help-nav a:hover{background:var(--bg-4);color:var(--text)}.help-nav a.on{background:var(--accent-soft);color:var(--accent);font-weight:600}.help-search{width:calc(100% - 16px);margin:8px;padding:6px 10px;font-size:11px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-1,var(--bg));color:var(--text);outline:none}.help-search:focus{border-color:var(--accent)}#helpPopup{position:fixed;z-index:300;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;max-width:340px;box-shadow:0 8px 32px rgba(0,0,0,0.25);font-size:12px;color:var(--text)}#helpPopup h4{font-size:13px;margin-bottom:6px;color:var(--text)}#helpPopup p{font-size:12px;color:var(--text-2);line-height:1.6;margin-bottom:6px}.hp-close{position:absolute;top:6px;right:8px;background:none;border:none;color:var(--text-3);cursor:pointer;font-size:14px;padding:2px 6px;border-radius:4px}.hp-close:hover{background:var(--bg-3);color:var(--text)}.hp-ex{background:var(--bg-3);padding:8px 10px;border-radius:6px;font-size:11px;color:var(--accent);line-height:1.5}.hp-link{display:block;margin-top:8px;font-size:11px;color:var(--accent);text-decoration:none}.hp-link:hover{text-decoration:underline}.help-nav a.dim{opacity:0.3;pointer-events:none}mark{background:var(--accent-soft);color:var(--accent);padding:0 2px;border-radius:2px}.help-body{flex:1;overflow-y:auto;padding:24px}.help-body h2{font-size:18px;margin-bottom:12px}.help-body h3{font-size:14px;margin:16px 0 8px;color:var(--accent)}.help-body p{font-size:13px;line-height:1.7;margin-bottom:10px;color:var(--text-2)}.help-body code{font-family:var(--mono);background:var(--bg-3);padding:2px 6px;border-radius:4px;font-size:12px}.help-body table{width:100%;border-collapse:collapse;margin:10px 0;font-size:12px}.help-body th,.help-body td{padding:8px 12px;border:1px solid var(--border);text-align:left}.help-body th{background:var(--bg-3);font-weight:600}.hg-flow{display:flex;align-items:center;gap:6px;padding:10px;background:var(--bg-3);border-radius:8px;margin:8px 0;overflow-x:auto}.hg-n{padding:6px 8px;border-radius:6px;font-size:10px;text-align:center;font-weight:600;line-height:1.4;white-space:nowrap}.hg-a{color:var(--text-3);font-size:12px;flex-shrink:0}.hg-b{background:var(--accent-soft);color:var(--accent);border:1px solid color-mix(in srgb,var(--accent) 25%,transparent)}.hg-c{background:color-mix(in srgb,var(--accent-2) 10%,transparent);color:var(--accent-2);border:1px solid color-mix(in srgb,var(--accent-2) 25%,transparent)}.hg-p{background:color-mix(in srgb,#a855f7 10%,transparent);color:#a855f7;border:1px solid color-mix(in srgb,#a855f7 25%,transparent)}.hg-g{background:color-mix(in srgb,var(--success) 10%,transparent);color:var(--success);border:1px solid color-mix(in srgb,var(--success) 25%,transparent)}.app-footer{text-align:center;padding:16px;font-size:11px;color:var(--text-3);border-top:1px solid var(--border)}@media(max-width:1024px){.panel-p{width:45%}.panel-c{flex:1}.ctx-summary{grid-template-columns:repeat(2,1fr)}.model-grid{grid-template-columns:repeat(2,1fr)}.exp-compare{grid-template-columns:1fr}.onboard h1{font-size:24px}.info-grid{grid-template-columns:repeat(2,1fr)}}@media(max-width:768px){.topbar{padding:0 12px}.mobtabs{display:flex}.ws{flex-direction:column}.panel-p{width:100%;display:none}.panel-p.show{display:flex}.panel-c.hide{display:none}.help-modal{flex-direction:column;width:95vw;height:90vh}.help-nav{width:100%;height:auto;max-height:120px;border-right:none;border-bottom:1px solid var(--border);display:flex;overflow-x:auto;padding:8px}.help-nav a{white-space:nowrap}.info-grid{grid-template-columns:1fr 1fr}.onboard h1{font-size:22px}.exp-select{flex-direction:column;gap:8px}.exp-select select{width:100%}.exp-ranking{gap:6px}.exp-rank-row{flex-wrap:wrap}.ctx-summary{grid-template-columns:1fr 1fr}.model-grid{grid-template-columns:1fr}.dash-fbar-name{width:70px;font-size:10px}.dg{padding:8px 10px;margin-bottom:4px}.dg-bar{grid-template-columns:55px 1fr 24px;gap:4px}.dg-lbl{font-size:10px}.dg-track{height:12px}.dg-cnt{font-size:10px}.launch-stats{grid-template-columns:1fr 1fr}.launch-folders{gap:4px}.launch-models{grid-template-columns:1fr 1fr}.launch-tpl{padding:8px}.tech-table th:nth-child(3),.tech-table td:nth-child(3){display:none}.tech-filter{flex-direction:column;gap:6px}.tech-filter select,.tech-filter input{width:100%}.diff-header{flex-direction:column;gap:4px}.diff-body{font-size:10px}.kb-modal{width:95vw;padding:16px}.road-layer h3{font-size:12px;padding:6px 10px}.road-task{font-size:11px;padding:6px 8px}.road-progress{padding:12px}.pill-drawer{display:none}}.spin{animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.tech-table{width:100%;border-collapse:collapse;font-size:11px}.tech-table th{position:sticky;top:0;background:var(--bg-2);padding:6px 8px;text-align:left;font-weight:600;border-bottom:2px solid var(--accent);font-size:10px;text-transform:uppercase;letter-spacing:0.05em}.tech-table td{padding:5px 8px;border-bottom:1px solid var(--border)}.tech-table tr:hover{background:var(--bg-3)}.tech-filter{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}.tech-filter select,.tech-filter input{padding:5px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg-3);color:var(--text);font-size:11px;font-family:var(--sans)}.req-badge{display:inline-block;padding:1px 6px;border-radius:8px;font-size:9px;font-weight:700}.ctx-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}.ctx-stat{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);padding:12px;text-align:center}.ctx-stat .num{font-size:24px;font-weight:700;color:var(--accent)}.ctx-stat .lbl{font-size:10px;color:var(--text-3);margin-top:4px}.model-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}.model-card{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);padding:12px}.model-card h4{font-size:12px;margin-bottom:6px}.model-card .fit{font-size:20px;font-weight:700}.fit-high{color:var(--success)}.fit-mid{color:var(--warn)}.fit-low{color:var(--danger)}.dash-head{margin-bottom:12px}.dash-head h3{font-size:14px;margin-bottom:4px}.dash-head p{font-size:11px;color:var(--text-3)}.dash-h4{font-size:12px;margin-bottom:8px}.dash-h4-mt{font-size:12px;margin:16px 0 8px}.dash-model-ctx{font-size:11px;color:var(--text-3);margin-top:4px}.dash-model-pct{font-size:10px;color:var(--text-3);margin-top:2px}.dash-fbar-row{display:flex;align-items:center;gap:8px;margin-bottom:4px}.dash-fbar{flex:1;height:8px;background:var(--bg-4);border-radius:4px;overflow:hidden}.dash-fbar-fill{height:100%;background:var(--accent);border-radius:4px}.dash-fbar-size{font-size:10px;color:var(--text-3);width:60px;text-align:right}.dg{background:var(--bg-2);border-radius:8px;padding:10px 12px;margin-bottom:6px;border:1px solid var(--border)}.dg-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}.dg-nm{font-size:11px;font-weight:600}.dg-sub{font-size:16px;font-weight:700;color:var(--accent)}.dg-bar{display:grid;grid-template-columns:68px 1fr 28px;align-items:center;gap:6px;margin-bottom:3px}.dg-lbl{font-size:11px;color:var(--text-2);text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.dg-track{height:14px;background:var(--bg-4);border-radius:3px;overflow:hidden}.dg-fill{height:100%;border-radius:3px;transition:width 0.4s}.dg-cnt{font-size:11px;font-weight:700;text-align:right}.dg-core .dg-fill{background:linear-gradient(90deg,var(--layer-2),color-mix(in srgb,var(--layer-2) 60%,#fff))}.dg-ai .dg-fill{background:linear-gradient(90deg,var(--accent-2),color-mix(in srgb,var(--accent-2) 60%,#fff))}.dg-infra .dg-fill{background:linear-gradient(90deg,var(--layer-5),color-mix(in srgb,var(--layer-5) 60%,#fff))}.dg-qa .dg-fill{background:linear-gradient(90deg,var(--warn),#fbbf24)}.dg-total{display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding-top:6px;border-top:1px solid var(--border);font-size:11px;color:var(--text-2)}.dg-total strong{font-size:16px;color:var(--text)}.dash-total{font-size:11px;color:var(--text-3);margin-top:6px}.compat-ok{background:var(--bg-2);border:1px solid var(--success);border-radius:var(--radius);padding:10px 12px;font-size:12px;color:var(--success)}.compat-summary{display:flex;gap:12px;margin-bottom:8px;font-size:12px;font-weight:600}.compat-s-ok{color:var(--success)}.compat-s-warn{color:var(--warn)}.compat-s-err{color:var(--danger)}.compat-s-info{color:var(--accent)}.compat-error,.compat-warn,.compat-info{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:var(--radius);font-size:11px;margin-bottom:4px;flex-wrap:wrap}.compat-error{background:color-mix(in srgb,var(--danger) 9%,transparent);border:1px solid color-mix(in srgb,var(--danger) 25%,transparent)}.compat-warn{background:color-mix(in srgb,var(--warn) 9%,transparent);border:1px solid color-mix(in srgb,var(--warn) 25%,transparent)}.compat-info{background:color-mix(in srgb,var(--accent) 9%,transparent);border:1px solid color-mix(in srgb,var(--accent) 25%,transparent)}.compat-icon{font-size:14px;flex-shrink:0}.compat-pair{font-weight:700;font-size:10px;background:var(--bg-3);padding:2px 6px;border-radius:3px;white-space:nowrap}.compat-msg{flex:1;min-width:120px;line-height:1.5}.compat-fix{flex-shrink:0;font-size:10px!important;padding:2px 8px!important}.dash-backup{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 12px;border-radius:var(--radius);font-size:11px;margin-bottom:8px;flex-wrap:wrap}.dash-backup-red{background:color-mix(in srgb,var(--danger) 9%,transparent);border:1px solid color-mix(in srgb,var(--danger) 25%,transparent);color:var(--danger)}.dash-backup-yellow{background:color-mix(in srgb,var(--warn) 9%,transparent);border:1px solid color-mix(in srgb,var(--warn) 25%,transparent);color:var(--warn)}.dash-guide{background:var(--accent-soft);border:1px solid color-mix(in srgb,var(--accent) 25%,transparent);color:var(--accent)}.guide-action-p{margin-top:16px}.dash-info{font-size:12px}.dash-center{margin-top:16px;text-align:center}.dash-center .btn{font-size:11px}.fsize-chart{display:flex;flex-direction:column;gap:6px}.fsize-row{display:flex;align-items:center;gap:8px;font-size:11px}.fsize-lbl{min-width:90px;color:var(--text-3);white-space:nowrap;font-weight:600}.fsize-bar-wrap{flex:1;height:10px;background:var(--bg-3);border-radius:5px;overflow:hidden}.fsize-bar{height:100%;border-radius:5px;transition:width .4s}.fsize-val{min-width:50px;text-align:right;color:var(--text-3);font-size:10px}.dash-back{margin-top:8px;text-align:center}.dash-back .btn{font-size:11px}.dash-tfcount{font-size:11px;color:var(--text-3);align-self:center}.dash-tbl-wrap{max-height:60vh;overflow-y:auto}.dash-price{font-size:9px;color:var(--text-3)}.dash-empty{color:var(--text-3);text-align:center;margin-top:40px}.toast-msg{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--bg-3);color:var(--text);padding:8px 20px;border-radius:20px;font-size:12px;z-index:999;border:1px solid var(--border)}.prev-footer{padding:12px 0;text-align:center;font-size:11px;color:var(--text-3);border-top:1px solid var(--border);margin-top:12px}.dash-total-mt{margin-top:8px}.launch-output{display:none}.tour-title{font-size:14px;margin-bottom:6px}.tour-desc{font-size:12px;color:var(--text-2);line-height:1.6}.tour-acts{display:flex;gap:6px;justify-content:flex-end;margin-top:8px}.gen-spinner{padding:16px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:10px}.gen-spinner-icon{display:inline-block;font-size:24px}.gen-prog-wrap{width:200px}.gen-prog-bar{height:6px;background:var(--bg-3);border-radius:3px;overflow:hidden}.gen-prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--success));border-radius:3px;transition:width .3s;width:0%}.gen-prog-label{font-size:11px;color:var(--text-2);margin-top:6px;font-weight:600}.complexity-label{font-weight:600}.complexity-sub{font-size:13px;margin-top:2px}.btn-start{padding:12px 40px;font-size:14px}.prev-placeholder{color:var(--text-3);font-size:13px;text-align:center;margin-top:40px}.btn-diff{color:var(--warn)}.tree-item{cursor:pointer}.tree-indent{padding-left:16px}.tree-disabled{opacity:0.4}.tree-edited{float:right;font-size:9px;color:var(--warn);margin-right:4px}.tree-gen{float:right;font-size:10px;color:var(--success)}.launch-ok{color:var(--success)}.launch-warn{color:var(--warn)}.road-pct-sub{font-size:12px;font-weight:400;color:var(--text-3)}.road-layer-pct{font-size:10px;font-weight:400;opacity:0.7}.road-actions{margin-top:12px;display:flex;gap:8px;justify-content:center}.road-actions .btn{font-size:11px}.exp-compare{display:grid;grid-template-columns:1fr 1fr;gap:12px}.exp-col{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);padding:16px}.exp-col h3{font-size:14px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}.exp-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px}.exp-row .label{color:var(--text-3)}.exp-row .val{font-weight:600}.exp-verdict{margin-top:12px;padding:12px;background:var(--accent-soft);border:1px solid rgba(59,130,246,0.2);border-radius:var(--radius)}.exp-verdict h4{font-size:12px;color:var(--accent);margin-bottom:4px}.exp-verdict p{font-size:11px;color:var(--text-2)}.exp-select{display:flex;gap:8px;margin-bottom:12px}.exp-select select{flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:7px;background:var(--bg-3);color:var(--text);font-size:12px;font-family:var(--sans)}.road-progress{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:16px}.road-progress h4{font-size:12px;margin-bottom:8px}.road-progress-bar{height:12px;background:var(--bg-4);border-radius:6px;overflow:hidden}.road-progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--success));border-radius:6px;transition:width .6s}.road-pct{font-size:20px;font-weight:700;color:var(--accent);margin-top:4px}.road-layer{margin-bottom:20px}.road-layer h3{font-size:13px;color:var(--accent);margin-bottom:8px;padding:6px 10px;background:var(--accent-soft);border-radius:6px;display:inline-block}.road-task{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px;cursor:pointer;transition:background .1s;border-radius:4px;padding:4px 8px}.road-task:hover{background:var(--bg-4)}.road-task input[type="checkbox"]{accent-color:var(--accent);width:16px;height:16px;cursor:pointer}.road-task.checked{color:var(--text-3);text-decoration:line-through}.road-week-badge{font-size:9px;padding:2px 6px;background:var(--bg-4);border-radius:8px;color:var(--text-3);margin-left:auto;flex-shrink:0}.road-hrs-badge{font-size:9px;padding:2px 6px;background:var(--accent-soft);border-radius:8px;color:var(--accent);flex-shrink:0}.road-time{font-size:11px;color:var(--text-3);margin-top:6px}.road-time strong{color:var(--text)}.road-milestone{margin-top:8px;padding:6px 12px;background:linear-gradient(90deg,var(--accent-soft),transparent);border-radius:6px;font-size:12px;font-weight:600;color:var(--accent);animation:roadFadeIn .5s}@keyframes roadFadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}.road-layer-head{cursor:pointer;user-select:none;display:flex!important;align-items:center;gap:4px;width:100%}.road-collapse-icon{font-size:10px;opacity:0.6;width:12px;text-align:center}.road-layer-hrs{margin-left:auto;font-size:9px;font-weight:400;opacity:0.6}.road-items{transition:max-height .3s ease,opacity .2s;overflow:hidden}.road-collapsed{max-height:0!important;opacity:0;margin:0;padding:0}.road-locked{opacity:0.6}.road-lock-msg{font-size:10px;color:var(--text-3);padding:4px 12px;margin-bottom:8px;font-style:italic}.road-task-locked{pointer-events:none;opacity:0.5}.road-task-locked input{pointer-events:none}.road-res-btn{font-size:12px;text-decoration:none;flex-shrink:0;opacity:0.5;transition:opacity .15s;padding:0 2px}.road-res-btn:hover{opacity:1}.road-badge-anim{animation:roadBadge .6s ease;display:inline-block;margin-left:4px}@keyframes roadBadge{0%{transform:scale(0);opacity:0}50%{transform:scale(1.4)}100%{transform:scale(1);opacity:1}}.hero-anim{position:relative;overflow:hidden;padding:20px;border-radius:var(--radius-lg)}.hero-anim::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,var(--accent-soft),transparent);animation:spin 8s linear infinite;z-index:0}.hero-content{position:relative;z-index:1}.stat-row{display:flex;gap:24px;justify-content:center;flex-wrap:wrap}.stat-item{text-align:center}.stat-item .num{font-size:28px;font-weight:700;color:var(--accent)}.stat-item .lbl{font-size:11px;color:var(--text-3)}.version-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;margin-bottom:12px}.kb-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:250;display:none;align-items:center;justify-content:center}.kb-overlay.show{display:flex}.kb-modal{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;max-width:400px;width:90%}.kb-modal h3{font-size:16px;margin-bottom:16px}.kb-row{display:flex;justify-content:space-between;padding:6px 0;font-size:12px;color:var(--text-2);border-bottom:1px solid var(--border)}.kb-key{font-family:var(--mono);padding:2px 8px;background:var(--bg-3);border:1px solid var(--border);border-radius:4px;font-size:11px}.skill-sel{display:flex;gap:10px;margin-bottom:28px;flex-wrap:wrap;justify-content:center}.skcard{width:185px;padding:18px 14px;border-radius:var(--radius-lg);border:2px solid var(--border);background:var(--bg-2);cursor:pointer;transition:all 0.2s;text-align:left}.skcard:hover{border-color:var(--border-light);background:var(--bg-3)}.skcard.on{border-color:var(--accent);background:var(--accent-soft)}.skcard .em{font-size:26px;margin-bottom:8px}.skcard h4{font-size:13px;font-weight:600;margin-bottom:3px}.skcard p{font-size:11px;color:var(--text-3);line-height:1.5}.szl{font-size:11px;color:var(--text-3);margin-bottom:8px;text-align:center;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}.chip{padding:6px 12px;border-radius:18px;font-size:12px;border:1.5px solid var(--chip-border,var(--border));background:var(--chip-bg,var(--bg-3));cursor:pointer;transition:all 0.12s;color:var(--text-2);user-select:none;display:flex;align-items:center;gap:5px}.chip:hover{border-color:var(--accent);color:var(--text)}.chip.on{border-color:var(--accent);background:var(--accent-soft);color:var(--accent);font-weight:500}.chip .ck{width:13px;height:13px;border-radius:3px;border:1.5px solid var(--text-3);display:flex;align-items:center;justify-content:center;font-size:9px;transition:all 0.12s}.chip.on .ck{border-color:var(--accent);background:var(--accent);color:#fff}.czone{padding:10px 20px}.czlabel{font-size:11px;color:var(--text-3);margin-bottom:8px;font-weight:500}.cgrid{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}.cfoot{padding:6px 20px 12px;display:flex;gap:6px;align-items:center}.cfoot input.cadd{flex:1;padding:8px 14px;border-radius:20px;border:1.5px solid var(--border);background:var(--bg-3);color:var(--text);font-size:12px;outline:none}.cfoot input.cadd:focus{border-color:var(--accent)}.ocards{padding:10px 20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}.ocard{padding:14px;border-radius:var(--radius);border:1.5px solid var(--border);background:var(--bg-3);cursor:pointer;transition:all 0.15s}.ocard:hover{border-color:var(--accent);background:var(--accent-soft)}.ocard h5{font-size:13px;font-weight:600;margin-bottom:3px}.ocard p{font-size:11px;color:var(--text-3);line-height:1.4}.m-edit{position:absolute;top:4px;right:4px;background:none;border:none;color:var(--text-3);cursor:pointer;font-size:13px;padding:2px 5px;border-radius:4px;opacity:0;transition:0.15s}.msg:hover .m-edit{opacity:1}.m-edit:hover{color:var(--warn);background:var(--warn-soft)}.q-help{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--accent-soft);color:var(--accent);font-size:10px;font-weight:700;cursor:pointer;margin-left:6px;transition:0.15s}.q-help:hover{background:var(--accent);color:#fff}.voice-btn{background:none;border:1px solid var(--border);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--text-3);transition:0.15s;flex-shrink:0}.voice-btn:hover{border-color:var(--accent);color:var(--accent)}.voice-btn.recording{border-color:var(--danger);color:var(--danger);animation:pulse 1s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}.skip-btn{background:none;border:none;color:var(--text-3);font-size:11px;cursor:pointer;padding:4px 10px;border-radius:12px;transition:0.15s}.skip-btn:hover{background:var(--bg-3);color:var(--text-2)}.dnd-list{list-style:none;padding:0;margin:0 0 8px}.dnd-item{display:flex;align-items:center;gap:8px;padding:8px 12px;margin:3px 0;border-radius:7px;border:1.5px solid var(--border);background:var(--bg-3);cursor:grab;transition:all 0.12s;user-select:none;font-size:12px;color:var(--text)}.dnd-item:active{cursor:grabbing;background:var(--bg-4);border-color:var(--accent);box-shadow:0 4px 12px rgba(0,0,0,0.3)}.dnd-grip{color:var(--text-3);font-size:14px;cursor:grab}.dnd-label{flex:1}.dnd-priority{font-size:10px;font-weight:600;padding:2px 8px;border-radius:10px}.dnd-priority.p0{background:rgba(239,68,68,0.15);color:var(--danger)}.dnd-priority.p1{background:rgba(234,179,8,0.15);color:var(--warn)}.dnd-priority.p2{background:rgba(100,116,139,0.15);color:var(--text-3)}.drag-over{border-color:var(--accent);background:var(--accent-soft)}.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:350;display:none;align-items:center;justify-content:center;animation:fadeIn 0.2s}.confirm-modal{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;max-width:420px;width:90%}.confirm-modal h4{font-size:14px;font-weight:600;margin-bottom:12px}.confirm-modal .cm-val{background:var(--bg-4);padding:10px 14px;border-radius:var(--radius);font-size:12px;color:var(--text);margin-bottom:16px;max-height:120px;overflow-y:auto;line-height:1.6}.confirm-modal .cm-acts{display:flex;gap:8px;justify-content:flex-end}.complexity-card{margin:12px 0;padding:16px;border-radius:var(--radius-lg);background:var(--bg-3);border:1px solid var(--border);animation:fadeIn 0.3s}.complexity-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}.complexity-score{font-size:32px;font-weight:700}.complexity-score.low{color:var(--success)}.complexity-score.mid{color:var(--warn)}.complexity-score.high{color:var(--danger)}.complexity-bar{height:6px;border-radius:3px;background:var(--bg-4);margin-bottom:12px;overflow:hidden}.complexity-fill{height:100%;border-radius:3px;transition:width 0.6s ease}.complexity-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}.complexity-item{display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)}.pm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:350;display:none;align-items:center;justify-content:center;animation:fadeIn 0.2s}.pm-modal{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}.pm-modal h3{font-size:16px;font-weight:700;margin-bottom:16px}.pm-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:var(--radius);border:1px solid var(--border);margin-bottom:6px;cursor:pointer;transition:0.15s}.pm-item:hover{border-color:var(--accent);background:var(--accent-soft)}.pm-item.current{border-color:var(--accent);background:var(--accent-soft)}.pm-item-name{font-size:13px;font-weight:500}.pm-item-meta{font-size:10px;color:var(--text-3)}.pm-item-acts{display:flex;gap:4px}.pm-item-acts button{background:none;border:none;cursor:pointer;font-size:12px;padding:2px 4px}.pm-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}.toc-panel{display:none;padding:6px 8px;overflow-x:auto;white-space:nowrap;border-bottom:1px solid var(--border);background:var(--bg-2)}.toc-item{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px;color:var(--text-3);transition:0.15s;margin-right:2px}.toc-item:hover{background:var(--accent-soft);color:var(--accent)}.toc-item.done{color:var(--success)}.toc-item.active{color:var(--accent);font-weight:600}.toc-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;background:var(--border-light)}.toc-item.done .toc-dot{background:var(--success)}.toc-item.active .toc-dot{background:var(--accent)}.edit-banner{padding:8px 20px;background:var(--warn-soft,rgba(234,179,8,0.1));color:var(--warn);font-size:11px;font-weight:600;display:flex;align-items:center;justify-content:space-between}.skipped-banner{padding:8px 20px;background:var(--accent-soft);color:var(--accent);font-size:11px;font-weight:600}.tour-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:400;max-width:440px;width:92%}.tour-card{background:var(--bg-2);border:2px solid var(--accent);border-radius:var(--radius-lg);padding:20px;box-shadow:0 8px 30px rgba(0,0,0,0.4)}.tour-dots{display:flex;gap:6px;justify-content:center;margin:10px 0}.tour-dot{width:8px;height:8px;border-radius:50%;background:var(--border)}.tour-dot.on{background:var(--accent)}[data-theme="light"] .skcard{background:var(--bg-2);border-color:var(--border)}[data-theme="light"] .m-bot{background:var(--bg-3);border-color:var(--border)}[data-theme="light"] .m-usr{background:rgba(59,130,246,0.08);border-color:rgba(59,130,246,0.2)}[data-theme="light"] .m-tip{color:var(--text-3)}[data-theme="light"] .skcard:hover{background:var(--bg-3);border-color:var(--text-3)}[data-theme="light"] .skcard.on{background:rgba(59,130,246,0.06);border-color:var(--accent)}[data-theme="light"] .complexity-card{background:var(--bg-3);border-color:var(--border)}[data-theme="light"] .dnd-item{background:var(--bg-2);border-color:var(--border)}[data-theme="light"] .confirm-modal,[data-theme="light"] .pm-modal,[data-theme="light"] .tour-card{background:var(--bg-2);border-color:var(--border)}[data-theme="light"] .voice-btn{border-color:var(--border);color:var(--text-3)}[data-theme="light"] .pm-item{border-color:var(--border)}[data-theme="light"] .pm-item:hover{background:rgba(59,130,246,0.04)}@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}.msg{margin-bottom:12px;animation:fadeIn 0.25s ease}.m-bot{background:var(--bg-3);padding:12px 14px;border-radius:3px var(--radius) var(--radius) var(--radius);border-left:3px solid var(--accent)}.m-usr{background:var(--surface,var(--bg-4));padding:12px 14px;border-radius:var(--radius) 3px var(--radius) var(--radius);margin-left:32px;border-right:3px solid var(--accent-2,#8b5cf6);position:relative}.m-tip{background:var(--warn-soft,rgba(234,179,8,0.1));padding:8px 12px;border-radius:var(--radius);border-left:3px solid var(--warn);font-size:12px;color:var(--warn)}.m-lbl{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:5px;color:var(--text-3);display:flex;align-items:center;gap:4px}.m-body{font-size:13px;line-height:1.7}.pill-drawer{position:fixed;left:0;top:50%;transform:translateY(-50%);z-index:900;display:flex;align-items:center}.pill-drawer-tab{width:16px;min-height:80px;background:var(--accent);border-radius:0 8px 8px 0;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0.6;transition:all 0.3s;writing-mode:vertical-rl;font-size:9px;color:#fff;font-weight:700;letter-spacing:1px;padding:8px 2px}.pill-drawer-tab:hover{opacity:1;width:20px}.pill-drawer-body{position:absolute;left:0;top:50%;transform:translateY(-50%);background:var(--bg-2);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:0 12px 12px 0;padding:12px 14px;min-width:220px;max-height:80vh;overflow-y:auto;box-shadow:0 4px 24px rgba(0,0,0,0.15);opacity:0;pointer-events:none;transition:all 0.25s ease}.pill-drawer:hover .pill-drawer-body{opacity:1;pointer-events:auto;left:16px}.pill-drawer:hover .pill-drawer-tab{opacity:0;pointer-events:none}.pd-title{font-size:10px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}.pd-phase{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;margin-bottom:4px;cursor:pointer;transition:all 0.15s;font-size:12px;font-weight:600;color:var(--text-2)}.pd-phase:hover{background:var(--accent-soft)}.pd-phase.active{background:var(--accent-soft);color:var(--accent)}.pd-phase.done{color:var(--success)}.pd-dot{width:8px;height:8px;border-radius:50%;background:var(--border-light);flex-shrink:0;transition:0.2s}.pd-phase.active .pd-dot{background:var(--accent);box-shadow:0 0 6px var(--accent)}.pd-phase.done .pd-dot{background:var(--success)}.pd-progress{margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:10px;color:var(--text-3);display:flex;align-items:center;gap:6px}.pd-bar{flex:1;height:4px;background:var(--bg-3);border-radius:2px;overflow:hidden}.pd-bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 0.3s}.pd-gen{margin-top:10px;width:100%;font-size:11px;padding:6px 0}.pd-qlist{margin:0;padding:0 0 0 16px;list-style:none}.pd-q{padding:3px 4px;font-size:10px;color:var(--text-3);cursor:pointer;border-radius:4px;transition:all .15s;display:flex;align-items:center;gap:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.pd-q:hover{background:var(--bg-3);color:var(--text)}.pd-q.current{color:var(--accent);font-weight:600}.pd-q .pd-qmark{width:6px;height:6px;border-radius:50%;flex-shrink:0}.pd-q.answered .pd-qmark{background:var(--success)}.pd-q:not(.answered) .pd-qmark{background:var(--border-light)}.pd-q.current .pd-qmark{background:var(--accent);box-shadow:0 0 4px var(--accent)}.pd-q.q-na{opacity:0.3;pointer-events:none;text-decoration:line-through}.gen-lang-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1100;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s}.gen-lang-modal{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;max-width:360px;width:90%;text-align:center}.gen-lang-modal h3{margin-bottom:8px;font-size:16px}.gen-lang-modal p{font-size:12px;color:var(--text-3);margin-bottom:16px}.gen-lang-btns{display:flex;gap:10px;justify-content:center}.gen-lang-btn{flex:1;padding:14px 12px;border-radius:var(--radius);border:2px solid var(--border);background:var(--bg-3);cursor:pointer;transition:all .15s;font-size:13px;font-weight:600;color:var(--text)}.gen-lang-btn:hover{border-color:var(--accent);background:var(--accent-soft)}.gen-lang-btn .flag{font-size:24px;display:block;margin-bottom:6px}.flex-end{display:flex;gap:6px;justify-content:flex-end}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.skip-link{position:absolute;top:-40px;left:0;background:var(--accent);color:#fff;padding:8px 16px;z-index:9999;font-size:14px;border-radius:0 0 var(--radius) 0;transition:top .2s}.skip-link:focus{top:0}*:focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:2px}.skcard:focus-visible{outline:2px solid var(--accent);outline-offset:2px}[role="dialog"]:focus{outline:none}.prev-path{font-size:11px;color:var(--text-3)}.prev-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.prev-toolbar-r{display:flex;gap:4px}.empty-preview{color:var(--text-3);font-size:13px;text-align:center;margin-top:40px}.empty-preview-sm{color:var(--text-3);font-size:12px;text-align:center;margin-top:40px}.ft-separator{color:var(--border);font-size:10px;padding:6px 0}.road-summary{margin-top:12px;padding:12px;background:var(--bg-3);border-radius:var(--radius);font-size:12px;text-align:center}.exp-header{margin-bottom:12px}.exp-header h3{font-size:14px;margin-bottom:4px}.exp-header p{font-size:11px;color:var(--text-3)}.exp-ranking{margin:12px 0;padding:12px;background:var(--bg-3);border-radius:var(--radius);border:1px solid var(--border)}.exp-ranking h4{font-size:12px;margin-bottom:10px;color:var(--accent)}.exp-rank-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:4px;cursor:pointer;transition:background .15s}.exp-rank-row:hover{background:var(--bg-2)}.exp-rank-top{background:var(--bg-2);border:1px solid var(--accent);border-radius:6px}.exp-rank-left{display:flex;align-items:center;gap:8px;min-width:200px}.exp-rank-medal{font-size:14px;min-width:28px;text-align:center}.exp-rank-name{font-size:12px;font-weight:500}.exp-rank-right{display:flex;align-items:center;gap:8px;flex:1;max-width:200px}.exp-rank-bar{flex:1;height:6px;background:var(--bg-1);border-radius:3px;overflow:hidden}.exp-rank-bar-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .3s}.exp-rank-score{font-size:11px;font-weight:600;color:var(--accent);min-width:36px;text-align:right}.exp-rank-reasons{display:flex;flex-wrap:wrap;gap:4px;margin:2px 0 6px 36px}.exp-rank-tag{font-size:10px;padding:1px 6px;background:var(--accent);color:#fff;border-radius:10px;opacity:0.8}.exp-metrics-sep{margin-top:10px;border-top:1px solid var(--border);padding-top:8px}.launch-stats{display:flex;gap:12px;margin:12px 0}.launch-stat{flex:1;text-align:center;padding:10px;background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius)}.launch-num{font-size:20px;font-weight:700;color:var(--accent);display:block}.launch-lbl{font-size:10px;color:var(--text-3)}.launch-folders{margin:12px 0;padding:12px;background:var(--bg-3);border-radius:var(--radius);border:1px solid var(--border)}.launch-folders h4{font-size:12px;margin-bottom:8px}.launch-folder-row{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px}.launch-folder-row label{display:flex;align-items:center;gap:4px;min-width:120px}.launch-folder-row span{flex:1;text-align:right;color:var(--text-3);font-size:10px;min-width:140px}.launch-bar{flex:1;height:4px;background:var(--bg-1);border-radius:2px;max-width:80px}.launch-bar-fill{height:100%;background:var(--accent);border-radius:2px}.launch-models{margin:8px 0;padding:10px;background:var(--bg-3);border-radius:var(--radius);border:1px solid var(--border)}.launch-models h4{font-size:12px;margin-bottom:6px}.launch-model-row{font-size:11px;padding:3px 0;display:flex;justify-content:space-between}.launch-model-pct{font-weight:600;font-size:10px}.launch-templates{margin:12px 0}.launch-templates h4{font-size:12px;margin-bottom:8px}.launch-tpl{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px;cursor:pointer;transition:border-color .15s,background .15s}.launch-tpl:hover{border-color:var(--accent);background:var(--bg-2)}.launch-tpl-icon{font-size:22px;min-width:30px;text-align:center}.launch-tpl-info{display:flex;flex-direction:column;gap:2px}.launch-tpl-info strong{font-size:12px}.launch-tpl-info span{font-size:10px;color:var(--text-3)}.launch-output{margin:12px 0;border:1px solid var(--accent);border-radius:var(--radius);overflow:hidden}.launch-output-head{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--accent);color:#fff}.launch-output-head h4{margin:0;font-size:13px}.launch-output-meta{padding:6px 12px;font-size:10px;color:var(--text-3);background:var(--bg-3);border-bottom:1px solid var(--border)}.launch-output-pre{padding:12px;font-size:11px;max-height:300px;overflow:auto;white-space:pre-wrap;word-break:break-word;background:var(--bg-1);margin:0}.diff-header{padding:8px 12px;border-bottom:1px solid var(--border);background:var(--bg-3);display:flex;justify-content:space-between;align-items:center}.diff-title{font-size:12px;font-weight:600}.diff-stats{font-size:11px;color:var(--text-3)}.diff-stats .add{color:var(--success)}.diff-stats .del{color:var(--danger)}.diff-stats .btn{font-size:10px;margin-left:8px}.diff-body{font-family:monospace;font-size:11px;line-height:1.6;padding:8px;overflow-y:auto;max-height:calc(100vh - 200px)}.diff-same{padding:1px 8px;color:var(--text-3)}.diff-add{padding:1px 8px;background:color-mix(in srgb,var(--success) 9%,transparent);color:var(--success)}.diff-del{padding:1px 8px;background:color-mix(in srgb,var(--danger) 9%,transparent);color:var(--danger);text-decoration:line-through}.diff-ln{display:inline-block;width:35px;text-align:right;margin-right:8px}.diff-same .diff-ln{opacity:0.5}.editor-toolbar{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);background:var(--bg-3)}.editor-toolbar .title{font-size:12px;font-weight:600}.editor-toolbar .actions{display:flex;gap:6px}.editor-toolbar .btn{font-size:11px}.editor-area{width:100%;height:calc(100% - 42px);border:none;outline:none;resize:none;background:var(--bg-1);color:var(--text);font-family:'Fira Code',monospace;font-size:12px;line-height:1.6;padding:12px;tab-size:2;box-sizing:border-box}.exp-dim{opacity:0.2}.exp-current{color:var(--accent)}.exp-select h4{margin:0}.exp-win{color:var(--success)}.exp-tie{color:var(--warn)}.guide-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);z-index:250;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s}.guide-modal{background:var(--bg-2);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:520px;width:92%;max-height:85vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,0.35)}.guide-header{display:flex;align-items:center;gap:14px;margin-bottom:16px;position:relative}.guide-em{font-size:36px}.guide-title{font-size:18px;font-weight:800;letter-spacing:-0.02em}.guide-sub{font-size:12px;font-weight:600}div.guide-sub.guide-lv-b{background:none;color:var(--success)}div.guide-sub.guide-lv-i{background:none;color:var(--warn)}div.guide-sub.guide-lv-p{background:none;color:var(--danger)}.guide-close{position:absolute;top:0;right:0;background:none;border:none;color:var(--text-3);font-size:18px;cursor:pointer;padding:4px 8px;border-radius:6px}.guide-close:hover{background:var(--bg-3);color:var(--text)}.guide-badge{font-size:11px;color:var(--accent);background:var(--accent-soft);padding:6px 14px;border-radius:20px;text-align:center;margin-bottom:20px;font-weight:600;letter-spacing:0.02em}.guide-steps{display:flex;flex-direction:column;gap:14px;margin-bottom:20px}.guide-step{display:flex;gap:14px;padding:14px;background:var(--bg-3);border:1px solid var(--border);border-radius:12px}.guide-step-num{width:32px;height:32px;min-width:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px}.guide-step-title{font-size:13px;font-weight:700;margin-bottom:4px}.guide-step-desc{font-size:12px;color:var(--text-2);line-height:1.7}.guide-step-desc code{font-family:var(--mono);font-size:11px;background:var(--bg);padding:1px 5px;border-radius:4px;color:var(--accent-2)}.guide-actions{display:flex;gap:10px;justify-content:flex-end}.guide-prog{display:flex;align-items:center;gap:8px;margin-bottom:14px}.guide-prog-bar{flex:1;height:6px;background:var(--bg-3);border-radius:3px;overflow:hidden}.guide-prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--success));border-radius:3px;transition:width .4s}.guide-prog-txt{font-size:11px;font-weight:700;color:var(--accent);min-width:28px;text-align:right}.guide-ck{display:flex;align-items:center;flex-shrink:0;cursor:pointer}.guide-ck input{display:none}.guide-ckbox{width:20px;height:20px;min-width:20px;border-radius:5px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;transition:all .15s}.guide-step-done .guide-ckbox{background:var(--success);border-color:var(--success)}.guide-step-done .guide-step-title{text-decoration:line-through;opacity:0.6}.guide-step-done .guide-step-desc{opacity:0.5}.guide-lv-b{background:rgba(52,211,153,0.12);color:var(--success)}.guide-lv-i{background:rgba(251,191,36,0.12);color:var(--warn)}.guide-lv-p{background:rgba(251,113,133,0.12);color:var(--danger)}@media print{:root{--bg:#fff;--bg-2:#fff;--bg-3:#f5f5f5;--bg-4:#eee;--text:#111;--text-2:#333;--text-3:#666;--border:#ccc;--accent:#2563eb;--success:#059669;--warn:#d97706;--danger:#dc2626}body{background:#fff;color:#111;font-size:11pt}.topbar,.pstrip,.mobtabs,.pill-drawer,.tour-container,.guide-overlay,.help-overlay,.kb-overlay,.pm-overlay,.confirm-overlay,.toast-msg,.btn,.export-grid,.izone,.toc-panel,.edit-banner,.skipped-banner{display:none!important}.panel-c,.panel-p{width:100%;border:none;overflow:visible}.ws{flex-direction:column;overflow:visible}.prev-body pre{border:1px solid #ccc;background:#f9f9f9;page-break-inside:avoid}.md-rendered h1,.md-rendered h2,.md-rendered h3{page-break-after:avoid}.md-rendered table{page-break-inside:avoid}a{color:#2563eb;text-decoration:underline}.prev-head{background:#fff;border-bottom:2px solid #111}}.audit-results{background:var(--bg-s);border:1px solid var(--bd);border-radius:var(--radius);padding:12px;margin-top:8px}.audit-results h4{margin:0 0 8px;font-size:13px;color:var(--fg)}.audit-summary-err,.audit-summary-warn,.audit-summary-info{display:inline-block;font-size:11px;padding:2px 8px;border-radius:10px;margin-right:6px;margin-bottom:6px}.audit-summary-err{background:color-mix(in srgb,var(--danger) 12%,transparent);color:var(--danger)}.audit-summary-warn{background:color-mix(in srgb,var(--warn) 12%,transparent);color:var(--warn-text,#b45309)}.audit-summary-info{background:color-mix(in srgb,var(--accent) 12%,transparent);color:var(--accent)}
</style>
</head>
<body>
<a href="#cbody" class="skip-link">Skip to content</a>
<div class="app" id="app">
  <!-- Topbar -->
  <header class="topbar" role="banner">
    <div class="topbar-left">
      <div class="topbar-brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
        <span>DevForge <small>v9</small></span>
      </div>

    </div>
    <div class="topbar-right">
      <button class="theme-btn" onclick="toggleLang()" title="EN/JA" aria-label="Toggle language" id="langBtn">🌐</button>
      <button class="theme-btn" onclick="toggleTheme()" title="Theme" aria-label="Toggle theme" id="themeBtn">🌙</button>
      <button class="theme-btn" onclick="showManual()" title="Help" id="helpBtn">❓</button>
      <button class="theme-btn" onclick="showKB()" title="Shortcuts" id="kbBtn">⌨️</button>
      <button class="theme-btn" onclick="showPM()" title="Projects" id="pmBtn">📁</button>
    </div>
  </header>
  <div class="pstrip"><div class="pstrip-fill" id="pbar" style="width:0%"></div></div>

  <!-- Left Hover Navigation Drawer -->
  <nav class="pill-drawer" role="navigation" aria-label="Progress" id="pillDrawer">
    <div class="pill-drawer-tab">PHASE</div>
    <div class="pill-drawer-body">
      <div class="pd-title" id="pdTitle">Progress</div>
      <div id="pills"></div>
      <div class="pd-progress"><div class="pd-bar"><div class="pd-bar-fill" id="pdBar" style="width:0%"></div></div><span id="pdPct">0%</span></div>
      <button class="btn btn-p pd-gen" id="pdGenBtn" onclick="generateAll()">🚀 生成</button>
    </div>
  </nav>


  <!-- Onboarding -->
  <div class="onboard" id="onboard" role="region" aria-label="Onboarding">
    <div class="hero-anim">
      <div class="hero-content">
        <div class="version-badge">v9.0 — 2026 Edition</div>
        <h1 id="heroTitle">DevForge v9</h1>
        <p id="heroDesc">質問に答えるだけで、60+ファイルの開発ドキュメント・環境設定・AIルール・学習ロードマップを自動生成。9つの柱でAI駆動開発をゼロから完全サポート。</p>
      </div>
    </div>
    <div class="stat-row">
      <div class="stat-item"><div class="num" id="statFileNum">60+</div><div class="lbl" id="statFiles">生成ファイル</div></div>
      <div class="stat-item"><div class="num" id="statTechNum"></div><div class="lbl" id="statTech">技術エントリ</div></div>
      <div class="stat-item"><div class="num">9</div><div class="lbl" id="statPillars">柱 (Pillars)</div></div>
      <div class="stat-item"><div class="num">10</div><div class="lbl" id="statAI">AIツール対応</div></div>
    </div>
    <div class="info-grid">
      <div class="icard"><h4>📝 60+ファイル生成</h4><p>SDD仕様書・Docker・MCP・AIルール10種・ロードマップ9種・仕様書23種</p></div>
      <div class="icard"><h4>🧪 9つの柱</h4><p>SDD・DevContainer・MCP・AIルール・並列探索・Dashboard・ロードマップ・AIランチャー・デザインシステム</p></div>
      <div class="icard"><h4>📱 モバイル対応</h4><p>Expo / React Native 開発パス・EAS Build・OTA更新</p></div>
      <div class="icard"><h4>🤖 AI自律開発</h4><p>Vibe Coding・マルチAgent・Claude Code Subagents</p></div>
      <div class="icard"><h4>💳 決済・CMS・EC</h4><p>Stripe・microCMS・Medusa・Shopify Hydrogen</p></div>
      <div class="icard"><h4>📦 フルエクスポート</h4><p>ZIP・PDF・全ファイル結合コピー・URLシェア</p></div>
    </div>
    <div class="pillars-badge">
      <span class="pbadge">①SDD統合</span><span class="pbadge">②DevContainer</span><span class="pbadge">③MCP設定</span>
      <span class="pbadge">④AIエージェント×10</span><span class="pbadge">⑤並列探索</span><span class="pbadge">⑥Context Dashboard</span><span class="pbadge">⑦技術ロードマップ</span><span class="pbadge">⑧AIランチャー</span><span class="pbadge">⑨デザインシステム</span>
    </div>
    <div class="start-zone">
      <div class="szl" id="skillAsk">Select your skill level</div>
      <div class="skill-sel" id="skillSel" role="radiogroup" aria-label="Skill level">
        <div class="skcard" data-lv="beginner" onclick="pickSkill('beginner')" role="radio" aria-checked="false" tabindex="0"><div class="em">🌱</div><h4 class="sk-title">Beginner</h4><p class="sk-desc">初めてのWeb開発。最適な選択肢をガイドします</p></div>
        <div class="skcard on" data-lv="intermediate" onclick="pickSkill('intermediate')" role="radio" aria-checked="true" tabindex="0"><div class="em">⚡</div><h4 class="sk-title">Intermediate</h4><p class="sk-desc">1年以上の経験。Svelte, DDD等の中級オプション解放</p></div>
        <div class="skcard" data-lv="pro" onclick="pickSkill('pro')" role="radio" aria-checked="false" tabindex="0"><div class="em">🔥</div><h4 class="sk-title">Professional</h4><p class="sk-desc">全オプション解放。MDD, RBAC, SSO等＋確認ダイアログ付き</p></div>
      </div>
      <input class="nameIn" id="nameIn" placeholder="" aria-label="Project name">
      <div class="preset-row" id="presetRow"></div>
      <button class="btn btn-g btn-xs" onclick="showPresetCompare()" style="margin-bottom:8px" id="compareBtn">⚔️ <span id="compareLbl">テンプレート比較</span></button>
      <button class="btn btn-p btn-start" onclick="start()" id="startBtn">🚀 開始する</button>
    </div>
    <div class="app-footer">© 2026 エンジニアリングのタネ制作委員会 ｜ 作成者：にしあん</div>
  </div>

  <!-- Workspace -->
  <main id="ws" role="main" aria-label="Workspace" style="display:none;">
    <div class="toc-panel" id="tocPanel" role="navigation" aria-label="Table of contents"></div>
    <div class="mobtabs" role="tablist" aria-label="View switch"><div class="mobtab on" onclick="mobSw('c')" role="tab" aria-selected="true">💬 チャット</div><div class="mobtab" onclick="mobSw('p')" role="tab" aria-selected="false">📄 プレビュー</div></div>
    <div class="ws">
      <div class="panel-c" id="panC">
        <div class="cbody" id="cbody" role="log" aria-live="polite" aria-label="Conversation"></div>
        <div class="izone" id="izone" role="form" aria-label="Answer input"></div>
      </div>
      <div class="panel-p" id="panP" role="complementary" aria-label="Preview panel">
        <div class="prev-head">
          <h3 id="panPTitle">📁 生成ファイル</h3>
          <div class="prev-tabs" id="prevTabs" role="tablist" aria-label="Preview tabs"></div>
        </div>
        <div class="pillar-tabs" id="pillarTabs" role="tablist" aria-label="Pillar tabs"></div>
        <div class="prev-body" id="prevBody" aria-live="polite"><p class="prev-placeholder">質問に回答するとリアルタイムでプレビューが更新されます</p></div>
      </div>
    </div>
  </main>

  <!-- Help Overlay -->
  <div class="help-overlay" id="helpOverlay" role="dialog" aria-modal="true" aria-label="Help manual" onclick="if(event.target===this)closeManual()">
    <div class="help-modal" role="document">
      <div class="help-nav" id="helpNav" role="navigation" aria-label="Help navigation">
        <input id="helpSearch" class="help-search" placeholder="🔍" oninput="filterManual(this.value)" aria-label="Search help">
      </div>
      <div class="help-body" id="helpBody"></div>
    </div>
  </div>

  <!-- Keyboard Shortcut Overlay -->
  <div class="kb-overlay" id="kbOverlay" role="dialog" aria-modal="true" aria-label="Keyboard shortcuts" onclick="if(event.target===this)closeKB()">
    <div class="kb-modal" role="document">
      <h3 id="kbTitle">⌨️ ショートカット</h3>
      <div class="kb-row"><span class="kblbl">ヘルプ・マニュアル</span><span class="kb-key">F1 / Ctrl+H</span></div>
      <div class="kb-row"><span class="kblbl">ショートカット一覧</span><span class="kb-key">Ctrl+K</span></div>
      <div class="kb-row"><span class="kblbl">テーマ切替</span><span class="kb-key">Ctrl+T</span></div>
      <div class="kb-row"><span class="kblbl">言語切替</span><span class="kb-key">Ctrl+L</span></div>
      <div class="kb-row"><span class="kblbl">エクスポート</span><span class="kb-key">Ctrl+E</span></div>
      <div class="kb-row"><span class="kblbl">全ファイルコピー</span><span class="kb-key">Ctrl+Shift+C</span></div>
      <div class="kb-row"><span class="kblbl">プロジェクト管理</span><span class="kb-key">Ctrl+M</span></div>
    </div>
  </div>
  <!-- Help Popup (per-question) -->
  <div id="helpPopup" role="tooltip" aria-live="polite" style="display:none;"></div>
  <!-- Confirm Overlay (Pro mode) -->
  <div class="confirm-overlay" id="confirmOverlay" role="alertdialog" aria-modal="true" aria-label="Confirmation"></div>
  <!-- Project Manager Overlay -->
  <div class="pm-overlay" id="pmOverlay" role="dialog" aria-modal="true" aria-label="Project manager" onclick="if(event.target===this)closePM()"></div>
  <!-- Tour Container -->
  <div class="tour-container" id="tourContainer" role="complementary" aria-label="Guided tour"></div>
</div>
<script>
const $=id=>document.getElementById(id);
const KEY='devforge-v9';
const V=9;
let S={phase:0,step:0,answers:{},projectName:'',skill:'intermediate',preset:'custom',lang:'ja',genLang:'ja',theme:'dark',pillar:0,previewFile:null,files:{},skipped:[],progress:{},editedFiles:{},prevFiles:{},_v:V};
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function sanitize(s,max=500){if(!s||typeof s!=='string')return '';return s.replace(/<[^>]*>/g,'').slice(0,max).trim();}
function sanitizeName(s){if(!s||typeof s!=='string')return '';return s.replace(/[<>"'&\\\/]/g,'').slice(0,100).trim();}
function fileSlug(s){if(!s)return 'devforge-project';const r=s.replace(/[^a-zA-Z0-9\s_-]/g,'').replace(/[\s_]+/g,'-').replace(/-{2,}/g,'-').replace(/^-|-$/g,'').slice(0,80);return r||'devforge-project';}
function toast(m){const t=document.createElement('div');t.className='toast-msg';t.textContent=m;t.setAttribute('role','alert');document.body.appendChild(t);setTimeout(()=>t.remove(),2200);}
function hasDM(m){return (S.answers.dev_methods||'').includes(m);}
let _lsOK=true;try{localStorage.setItem('_t','1');localStorage.removeItem('_t');}catch(e){_lsOK=false;}
function _lsGet(k){if(!_lsOK)return null;try{return localStorage.getItem(k);}catch(e){return null;}}
function _lsSet(k,v){if(!_lsOK)return;try{localStorage.setItem(k,v);}catch(e){}}
function _lsRm(k){if(!_lsOK)return;try{localStorage.removeItem(k);}catch(e){}}
function save(){_lsSet(KEY,JSON.stringify(S));}
function load(){
  let d=_lsGet(KEY);
  if(!d){d=_lsGet('devforge-v8');if(d)_lsRm('devforge-v8');}
  const _legacyTpl=_lsGet('dfv8_templates');if(_legacyTpl){_lsSet('devforge-templates',_legacyTpl);_lsRm('dfv8_templates');}
  try{const ps=JSON.parse(_lsGet('devforge-projects')||'{}');Object.keys(ps).forEach(n=>{const lk='dfv8_road_'+n;const nk='devforge-road-'+n;const v=_lsGet(lk);if(v&&!_lsGet(nk)){_lsSet(nk,v);}_lsRm(lk);});}catch(e){}
  if(!d)return;
  try{
    const o=JSON.parse(d);
    Object.assign(S,o);
    if(!S._v||S._v<V){
      S.genLang=S.genLang||S.lang||'ja';
      S.editedFiles=S.editedFiles||{};
      S.prevFiles=S.prevFiles||{};
      S._v=V;
      save();
    }
  }catch(e){_lsRm(KEY);}
}
let voiceRec=null,voiceBtn=null,_confirmCb=null;
const I18N={
ja:{
p1:'Phase 1',p2:'Phase 2',p3:'Phase 3',
heroTitle:'DevForge v9',
heroDesc:'質問に答えるだけで、69+ファイルの開発ドキュメント・環境設定・AIルール・学習ロードマップを自動生成。10の柱でAI駆動開発をゼロから完全サポート。',
startBtn:'🚀 開始する',
statFiles:'生成ファイル',statTech:'技術エントリ',statPillars:'柱 (Pillars)',statAI:'AIツール対応',
skillAsk:'スキルレベルを選択',
skBeginner:'初心者',skBeginnerDesc:'初めてのWeb開発。最適な選択肢をガイドします',
skIntermediate:'中級者',skIntermediateDesc:'1年以上の経験。Svelte, DDD等の中級オプション解放',
skPro:'上級者',skProDesc:'全オプション解放。MDD, RBAC, SSO等＋確認ダイアログ付き',
send:'送信',confirm:'決定',skip:'スキップ ▸',selectMin:'最低1つ選択してください',
sortLabel:'ドラッグで優先順位を並べ替えてください:',sortConfirm:'この順序で決定',
skipMsg:'⏭️ この質問はスキップしました。後で回答できます。',
skippedTitle:'📋 スキップした質問が ',skippedSuffix:' 件あります。回答しましょう。',
skippedDone:'✅ すべての質問に回答完了！',
skippedBanner:'⏭️ スキップ回答中 — 残り ',skippedBannerSuffix:' 件',
answerConfirm:'回答を確認',edit:'修正',
tourNext:'次へ',tourPrev:'前へ',tourDone:'完了',tourStart:'ツアー開始',
phEnd1:'Phase 1 完了！技術選定に進みます。',
phEnd2:'Phase 2 完了！機能・データ設計に進みます。',
genBtn:'📦 69+ファイル生成',
genDone:'✅ 69+ファイルが生成されました！プレビューパネルで確認してください。',
copyDone:'クリップボードにコピーしました',
pmTitle:'📁 プロジェクト管理',pmNew:'新規プロジェクト',pmEmpty:'保存されたプロジェクトはありません',
helpClose:'閉じる',
kbTitle:'⌨️ ショートカット',
kb:['ヘルプ・マニュアル','ショートカット一覧','テーマ切替','言語切替','エクスポート','全ファイルコピー','プロジェクト管理'],
pillar:['①SDD統合','②DevContainer','③MCP設定','④AIルール','⑤並列探索','⑥Dashboard','⑦ロードマップ','⑧AIランチャー','⑨デザインシステム','⑩リバースEng']
},
en:{
p1:'Phase 1',p2:'Phase 2',p3:'Phase 3',
heroTitle:'DevForge v9',
heroDesc:'Answer questions to auto-generate 69+ development documents, environment configs, AI rules & learning roadmaps. 10 pillars for complete AI-driven development support.',
startBtn:'🚀 Get Started',
statFiles:'Generated Files',statTech:'Tech Entries',statPillars:'Pillars',statAI:'AI Tools',
skillAsk:'Select your skill level',
skBeginner:'Beginner',skBeginnerDesc:'First-time web dev. Curated options to guide you smoothly',
skIntermediate:'Intermediate',skIntermediateDesc:'1+ year experience. Unlocks Svelte, DDD & mid-level options',
skPro:'Professional',skProDesc:'All options unlocked. MDD, RBAC, SSO & full customization with confirmation',
send:'Send',confirm:'Confirm',skip:'Skip ▸',selectMin:'Select at least one',
sortLabel:'Drag to sort by priority:',sortConfirm:'Confirm order',
skipMsg:'⏭️ This question was skipped. You can answer it later.',
skippedTitle:'📋 You have ',skippedSuffix:' skipped questions. Let\'s answer them.',
skippedDone:'✅ All questions answered!',
skippedBanner:'⏭️ Answering skipped — ',skippedBannerSuffix:' remaining',
answerConfirm:'Confirm answer',edit:'Edit',
tourNext:'Next',tourPrev:'Back',tourDone:'Done',tourStart:'Start Tour',
phEnd1:'Phase 1 complete! Moving to tech stack.',
phEnd2:'Phase 2 complete! Moving to feature design.',
genBtn:'📦 Generate 69+ Files',
genDone:'✅ 69+ files generated! Check the preview panel.',
copyDone:'Copied to clipboard',
pmTitle:'📁 Project Manager',pmNew:'New Project',pmEmpty:'No saved projects',
helpClose:'Close',
kbTitle:'⌨️ Shortcuts',
kb:['Help / Manual','Shortcuts','Toggle Theme','Toggle Language','Export','Copy All Files','Project Manager'],
pillar:['①SDD','②DevContainer','③MCP','④AI Rules','⑤Explorer','⑥Dashboard','⑦Roadmap','⑧AI Launcher','⑨Design System','⑩Reverse Eng']
}
};
const t=k=>I18N[S.lang][k]||k;
const _PD={frontend:'React + Next.js',backend:'Supabase',mobile:'none',ai_auto:'none',payment:'none'};
function _mp(p){return Object.assign({},_PD,p);}
const PR={
saas:_mp({name:'SaaSアプリ',nameEn:'SaaS App',icon:'☁️',purpose:'サブスクリプション型Webサービスの構築',purposeEn:'Build a subscription-based web service',target:['スタートアップ','中小企業','フリーランス'],targetEn:['Startups','SMBs','Freelancers'],features:['ユーザー登録・ログイン','ダッシュボード','課金・プラン管理','チーム招待','分析レポート'],featuresEn:['User Registration & Login','Dashboard','Billing & Plan Management','Team Invitations','Analytics Reports'],
entities:'User, Team, Subscription, Invoice, Activity',payment:'stripe'}),
ai_agent:_mp({name:'AIエージェント',nameEn:'AI Agent',icon:'🤖',purpose:'AIを活用したタスク自動化・対話型アシスタント',purposeEn:'AI-powered task automation & conversational assistant',target:['エンジニア','スタートアップ'],targetEn:['Engineers','Startups'],features:['チャットインターフェース','プロンプト管理','履歴・コンテキスト管理','API連携','使用量ダッシュボード'],featuresEn:['Chat Interface','Prompt Management','History & Context Management','API Integration','Usage Dashboard'],
entities:'User, Conversation, Message, Prompt, ApiUsage, Agent, Tool',ai_auto:'マルチAgent協調',payment:'stripe'}),
ai_content:_mp({name:'AIコンテンツ生成',nameEn:'AI Content Gen',icon:'✨',purpose:'AIを活用した文章・画像・動画の自動生成プラットフォーム',purposeEn:'AI-powered text, image & video auto-generation platform',target:['マーケター','ブロガー','クリエイター'],targetEn:['Marketers','Bloggers','Creators'],features:['テンプレート選択','AIコンテンツ生成','編集・リライト','SEO最適化','エクスポート'],featuresEn:['Template Selection','AI Content Generation','Edit & Rewrite','SEO Optimization','Export'],
entities:'User, Template, Generation, Content, Project, CreditUsage',ai_auto:'Vibe Coding入門',payment:'stripe'}),
automation:_mp({name:'ワークフロー自動化',nameEn:'Workflow Automation',icon:'⚙️',purpose:'タスクやプロセスを自動化するiPaaS/ノーコード連携ツール',purposeEn:'iPaaS/no-code tool for automating tasks and processes',target:['中小企業','マーケター','管理者'],targetEn:['SMBs','Marketers','Admins'],frontend:'React (Vite SPA)',backend:'Node.js + Express',features:['ビジュアルフローエディタ','トリガー・アクション設定','API連携','実行ログ','スケジュール実行'],featuresEn:['Visual Flow Editor','Trigger & Action Config','API Integration','Execution Logs','Scheduled Runs'],
entities:'User, Workflow, Trigger, Action, Execution, Connection, Log',payment:'stripe'}),
marketplace:_mp({name:'マーケットプレイス',nameEn:'Marketplace',icon:'🏪',purpose:'売り手と買い手をつなぐ双方向プラットフォーム',purposeEn:'Two-sided platform connecting buyers and sellers',target:['一般消費者','フリーランス','スモールビジネス'],targetEn:['Consumers','Freelancers','Small Businesses'],features:['出品・商品登録','検索・フィルタ','メッセージ機能','決済・エスクロー','レビュー・評価'],featuresEn:['Product Listing','Search & Filter','Messaging','Payment & Escrow','Reviews & Ratings'],
entities:'User, Listing, Category, Order, Transaction, Review, Message',payment:'stripe'}),
ec:_mp({name:'ECサイト',nameEn:'E-Commerce',icon:'🛍️',purpose:'オンラインショップの構築',purposeEn:'Build an online shop',target:['一般消費者','ショップオーナー'],targetEn:['Consumers','Shop Owners'],backend:'Node.js + Express',features:['商品管理','カート・決済','注文管理','在庫管理','レビュー機能'],featuresEn:['Product Management','Cart & Checkout','Order Management','Inventory Management','Reviews'],entities:'Product, Order, User, Category, Cart, Payment',payment:'ec_build'}),
dashboard:_mp({name:'ダッシュボード',nameEn:'Dashboard',icon:'📊',purpose:'データを集約・可視化してインサイトを提供する分析ツール',purposeEn:'Analytics tool to aggregate and visualize data for insights',target:['経営者','マーケター','データアナリスト'],targetEn:['Executives','Marketers','Data Analysts'],features:['KPIウィジェット','グラフ・チャート','データフィルタ','レポート出力','アラート通知'],featuresEn:['KPI Widgets','Charts & Graphs','Data Filters','Report Export','Alert Notifications'],
entities:'User, DataSource, Widget, Dashboard, Report, Alert'}),
chatbot:_mp({name:'チャットボット',nameEn:'Chatbot',icon:'💬',purpose:'AIカスタマーサポート・FAQ自動応答システム',purposeEn:'AI customer support & FAQ auto-response system',target:['中小企業','EC事業者'],targetEn:['SMBs','E-commerce Businesses'],frontend:'React (Vite SPA)',features:['チャットウィジェット','FAQ学習・管理','会話フロー設計','有人エスカレーション','分析レポート'],featuresEn:['Chat Widget','FAQ Learning & Management','Conversation Flow Design','Human Escalation','Analytics Reports'],
entities:'User, Bot, Conversation, Message, Intent, KnowledgeBase, Handoff',ai_auto:'Vibe Coding入門'}),
fintech:_mp({name:'フィンテック',nameEn:'Fintech',icon:'💰',purpose:'決済・家計管理・請求書など金融系Webアプリ',purposeEn:'Financial web app for payments, budgeting & invoicing',target:['フリーランス','中小企業','一般消費者'],targetEn:['Freelancers','SMBs','Consumers'],backend:'Node.js + NestJS',features:['口座連携','収支ダッシュボード','請求書発行','自動カテゴリ分類','レポート出力'],featuresEn:['Account Linking','Income/Expense Dashboard','Invoice Generation','Auto-categorization','Report Export'],
entities:'User, Account, Transaction, Invoice, Category, Budget, Report',mobile:'Expo (React Native)',payment:'stripe'}),
devtool:_mp({name:'開発者ツール',nameEn:'Dev Tool',icon:'🛠️',purpose:'開発者の生産性を向上させるユーティリティ・API',purposeEn:'Developer utility & API to boost productivity',target:['エンジニア','スタートアップ'],backend:'Node.js + Express',features:['APIキー管理','ドキュメント','使用量モニタ','Webhook設定','Playground'],featuresEn:['API Key Management','Documentation','Usage Monitor','Webhook Config','Playground'],
entities:'User, ApiKey, Project, RequestLog, Webhook, Documentation',payment:'stripe'}),
creator:_mp({name:'クリエイターエコノミー',nameEn:'Creator Economy',icon:'🎨',purpose:'コンテンツ販売・ファンコミュニティ・サブスク課金プラットフォーム',purposeEn:'Content sales, fan community & subscription platform',target:['クリエイター','インフルエンサー'],targetEn:['Creators','Influencers'],features:['プロフィール・ポートフォリオ','有料コンテンツ配信','サブスク課金','ファンコメント・投げ銭','アナリティクス'],featuresEn:['Profile & Portfolio','Paid Content Distribution','Subscription Billing','Fan Comments & Tips','Analytics'],
entities:'User, Content, Subscription, Payment, Comment, Tip, Tier',payment:'stripe'}),
newsletter:_mp({name:'ニュースレター/メディア',nameEn:'Newsletter/Media',icon:'📰',purpose:'ニュースレター配信・メディア運営プラットフォーム',purposeEn:'Newsletter distribution & media management platform',target:['ライター','メディア運営者','マーケター'],targetEn:['Writers','Media Operators','Marketers'],features:['記事エディタ','購読者管理','配信スケジュール','開封・クリック分析','有料プラン'],featuresEn:['Article Editor','Subscriber Management','Delivery Schedule','Open & Click Analytics','Paid Plans'],
entities:'User, Post, Subscriber, Campaign, Analytics, Plan',payment:'stripe'}),
pwa:_mp({name:'PWAアプリ',nameEn:'PWA App',icon:'📱',purpose:'ネイティブアプリ体験をWebで提供するモバイルファースト',purposeEn:'Mobile-first web app with native app experience',target:['一般消費者','スタートアップ'],targetEn:['Consumers','Startups'],frontend:'React (Vite SPA)',backend:'Firebase',features:['オフライン対応','プッシュ通知','ホーム画面追加','カメラ・位置情報','データ同期'],featuresEn:['Offline Support','Push Notifications','Add to Home Screen','Camera & Location','Data Sync'],
entities:'User, Content, Notification, SyncQueue, Setting',mobile:'Expo (React Native)'}),
booking:_mp({name:'予約システム',nameEn:'Booking System',icon:'📅',purpose:'サービスやリソースの予約・スケジュールを管理するシステム',purposeEn:'Booking & schedule management system for services',target:['店舗オーナー','フリーランス','一般消費者'],targetEn:['Shop Owners','Freelancers','Consumers'],features:['カレンダー表示','予約作成・変更','リマインダー通知','決済連携','スタッフ管理'],featuresEn:['Calendar View','Create & Modify Bookings','Reminder Notifications','Payment Integration','Staff Management'],
entities:'User, Service, Booking, TimeSlot, Staff, Payment, Reminder',payment:'stripe'}),
event:_mp({name:'イベントプラットフォーム',nameEn:'Event Platform',icon:'🎪',purpose:'オンライン・オフラインイベントの開催・参加管理',purposeEn:'Online/offline event hosting & attendance management',target:['イベント主催者','コミュニティ','企業'],targetEn:['Event Organizers','Communities','Companies'],features:['イベント作成・公開','チケット販売','参加者管理','ライブ配信連携','アンケート'],featuresEn:['Event Creation & Publishing','Ticket Sales','Attendee Management','Live Streaming Integration','Surveys'],
entities:'User, Event, Ticket, Attendee, Venue, Session, Survey',payment:'stripe'}),
health:_mp({name:'ヘルステック',nameEn:'Health Tech',icon:'🏥',purpose:'健康・フィットネス・ウェルネスの記録と改善を支援するアプリ',purposeEn:'Health, fitness & wellness tracking and improvement app',target:['一般消費者','トレーナー'],targetEn:['Consumers','Trainers'],frontend:'React (Vite SPA)',backend:'Firebase',features:['健康データ記録','トレーニング管理','食事ログ','目標・進捗グラフ','リマインダー'],featuresEn:['Health Data Logging','Training Management','Meal Logs','Goals & Progress Graphs','Reminders'],
entities:'User, HealthLog, Workout, Meal, Goal, Progress, Reminder',mobile:'Expo (React Native)'}),
hr:_mp({name:'HR/採用管理',nameEn:'HR/Recruiting',icon:'👥',purpose:'採用プロセスと人事管理を効率化するツール',purposeEn:'Tool to streamline recruiting and HR management',target:['人事担当者','採用担当者','経営者'],targetEn:['HR Staff','Recruiters','Executives'],features:['求人管理','応募者トラッキング','面接スケジュール','評価・スコアカード','オンボーディング'],featuresEn:['Job Management','Applicant Tracking','Interview Scheduling','Evaluation Scorecards','Onboarding'],
entities:'User, JobPosting, Applicant, Interview, Evaluation, Department, Onboarding'}),
linkbio:_mp({name:'Link in Bio',nameEn:'Link in Bio',icon:'🔗',purpose:'SNSプロフィール用のマイクロサイト・リンク集約ツール',purposeEn:'Micro-site & link aggregation tool for social profiles',target:['インフルエンサー','クリエイター','フリーランス'],targetEn:['Influencers','Creators','Freelancers'],features:['カスタムリンクページ','テーマ・デザイン編集','アクセス解析','SNS連携','収益化リンク'],featuresEn:['Custom Link Page','Theme & Design Editor','Access Analytics','Social Integration','Monetization Links'],
entities:'User, Page, Link, Theme, ClickLog, Integration'}),
gamify:_mp({name:'ゲーミフィケーション',nameEn:'Gamification',icon:'🎮',purpose:'ゲーム要素でユーザーエンゲージメントを向上',purposeEn:'Boost user engagement with game elements',target:['教育者','マーケター','コミュニティ管理者'],targetEn:['Educators','Marketers','Community Managers'],frontend:'React (Vite SPA)',backend:'Firebase',features:['ポイント・バッジシステム','リーダーボード','チャレンジ・ミッション','報酬・交換','進捗ダッシュボード'],featuresEn:['Points & Badge System','Leaderboard','Challenges & Missions','Rewards & Redemption','Progress Dashboard'],
entities:'User, Badge, Challenge, Reward, Leaderboard, PointLog, Achievement'}),
collab:_mp({name:'リアルタイムコラボ',nameEn:'Realtime Collab',icon:'🤝',purpose:'チームが同時編集・共同作業できるリアルタイムツール',purposeEn:'Real-time tool for team collaborative editing',target:['リモートチーム','スタートアップ','教育者'],targetEn:['Remote Teams','Startups','Educators'],features:['リアルタイム同時編集','カーソル共有','コメント・メンション','バージョン履歴','権限管理'],featuresEn:['Real-time Co-editing','Cursor Sharing','Comments & Mentions','Version History','Permission Management'],
entities:'User, Document, Workspace, Comment, Version, Permission, Activity',payment:'stripe'}),
iot:_mp({name:'IoTダッシュボード',nameEn:'IoT Dashboard',icon:'📡',purpose:'IoTデバイスのデータ監視・制御・可視化ツール',purposeEn:'IoT device data monitoring, control & visualization',target:['エンジニア','製造業'],targetEn:['Engineers','Manufacturing'],frontend:'React (Vite SPA)',backend:'Node.js + Express',features:['デバイス登録・管理','リアルタイムデータ表示','アラート設定','遠隔制御','履歴データ分析'],featuresEn:['Device Registration & Management','Real-time Data Display','Alert Settings','Remote Control','Historical Data Analysis'],
entities:'User, Device, SensorData, Alert, Command, DeviceGroup, Log'}),
portfolio:_mp({name:'ポートフォリオ',nameEn:'Portfolio',icon:'🖼️',purpose:'スキル・実績を魅力的に紹介するサイト',purposeEn:'Showcase skills and achievements attractively',target:['学生','フリーランス'],targetEn:['Students','Freelancers'],frontend:'Astro',features:['自己紹介','プロジェクト一覧','スキル表示','お問い合わせ'],featuresEn:['About Me','Project Gallery','Skills Display','Contact Form'],entities:'Project, Skill, Contact'}),
cms:_mp({name:'CMS/ブログ',nameEn:'CMS/Blog',icon:'📝',purpose:'コンテンツを投稿・管理・公開できるシステム',purposeEn:'System to create, manage and publish content',target:['ブロガー','編集者'],targetEn:['Bloggers','Editors'],features:['記事作成・編集','カテゴリ管理','画像アップロード','SEO設定','下書き保存'],featuresEn:['Article Editor','Category Management','Image Upload','SEO Settings','Draft Saving'],entities:'User, Post, Category, Tag, Media'}),
lms:_mp({name:'学習プラットフォーム',nameEn:'Learning Platform',icon:'📚',purpose:'体系的に知識を習得できる教育システム',purposeEn:'Structured education system for knowledge acquisition',target:['学生','社会人学習者','教育者'],targetEn:['Students','Working Professionals','Educators'],frontend:'React (Vite SPA)',backend:'Firebase',features:['コース一覧','レッスン視聴','進捗管理','クイズ機能','修了証発行'],featuresEn:['Course Catalog','Lesson Viewing','Progress Tracking','Quiz System','Certificate Issuance'],
entities:'User, Course, Lesson, Progress, Quiz, Certificate',mobile:'Expo (React Native)',payment:'stripe'}),
community:_mp({name:'コミュニティ',nameEn:'Community',icon:'🌐',purpose:'共通の関心を持つ人々が交流できるプラットフォーム',purposeEn:'Platform for people with common interests to interact',target:['コミュニティメンバー','管理者'],targetEn:['Community Members','Admins'],features:['プロフィール','投稿・コメント','グループ','イベント管理','通知'],featuresEn:['Profiles','Posts & Comments','Groups','Event Management','Notifications'],entities:'User, Post, Comment, Group, Event'}),
property_mgmt:_mp({name:'不動産管理',nameEn:'Property Management',icon:'🏢',purpose:'賃貸・売買物件の管理、入居者対応、家賃回収を一元管理',purposeEn:'Centralized rental/sales property management, tenant communication & rent collection',target:['不動産オーナー','管理会社','仲介業者'],targetEn:['Property Owners','Management Companies','Real Estate Agents'],features:['物件登録・管理','入居者情報管理','契約・更新管理','家賃請求・督促','修繕依頼トラッキング','収支レポート'],featuresEn:['Property Registration & Management','Tenant Info Management','Contract & Renewal Management','Rent Billing & Reminders','Repair Request Tracking','Financial Reports'],entities:'Property, Unit, Tenant, Lease, Payment, MaintenanceRequest, Owner, Invoice',payment:'stripe'}),
contract_mgmt:_mp({name:'契約管理',nameEn:'Contract Management',icon:'📜',purpose:'契約書の作成・承認フロー・期限管理・電子署名を統合管理',purposeEn:'Integrated contract creation, approval workflow, deadline tracking & e-signature',target:['法務部','営業部','中小企業','フリーランス'],targetEn:['Legal Dept','Sales Dept','SMBs','Freelancers'],features:['契約書テンプレート','承認ワークフロー','電子署名連携','期限・更新アラート','バージョン管理','検索・タグ付け'],featuresEn:['Contract Templates','Approval Workflow','E-signature Integration','Deadline & Renewal Alerts','Version Control','Search & Tagging'],entities:'Contract, Template, Party, Approval, Signature, Milestone, Alert, Clause',payment:'stripe'}),
helpdesk:_mp({name:'ヘルプデスク',nameEn:'Help Desk',icon:'🎧',purpose:'カスタマーサポートのチケット管理とナレッジベース統合',purposeEn:'Customer support ticket management with integrated knowledge base',target:['サポートチーム','IT部門','SaaS企業'],targetEn:['Support Teams','IT Departments','SaaS Companies'],features:['チケット起票・管理','優先度・ステータス設定','担当者アサイン','ナレッジベース連携','SLA追跡','顧客満足度評価'],featuresEn:['Ticket Creation & Management','Priority & Status Settings','Agent Assignment','Knowledge Base Integration','SLA Tracking','Customer Satisfaction Rating'],entities:'Ticket, User, Agent, Category, Priority, KnowledgeArticle, Response, SLA',ai_auto:'Vibe Coding入門',payment:'stripe'}),
tutoring:_mp({name:'家庭教師マッチング',nameEn:'Tutoring Marketplace',icon:'👨‍🏫',purpose:'講師と生徒をマッチングし、オンライン・対面授業を予約管理',purposeEn:'Match tutors with students, manage online/in-person lesson bookings',target:['学生','保護者','講師','教育事業者'],targetEn:['Students','Parents','Tutors','Education Businesses'],features:['講師プロフィール・検索','科目・スキルフィルタ','レッスン予約','オンライン授業連携','レビュー・評価','決済・手数料管理'],featuresEn:['Tutor Profiles & Search','Subject & Skill Filters','Lesson Booking','Online Class Integration','Reviews & Ratings','Payment & Fee Management'],entities:'Tutor, Student, Subject, Lesson, Booking, Review, Payment, Availability',payment:'stripe'}),
veterinary:_mp({name:'動物病院',nameEn:'Veterinary Clinic',icon:'🐾',purpose:'動物病院のカルテ管理・予約・ワクチン接種記録システム',purposeEn:'Vet clinic medical records, appointments & vaccination tracking',target:['獣医師','動物病院スタッフ','ペットオーナー'],targetEn:['Veterinarians','Clinic Staff','Pet Owners'],features:['ペット情報・カルテ管理','診察予約','ワクチン接種履歴','処方箋管理','会計・請求','リマインダー通知'],featuresEn:['Pet Info & Medical Records','Appointment Scheduling','Vaccination History','Prescription Management','Billing & Invoicing','Reminder Notifications'],entities:'Pet, Owner, Appointment, MedicalRecord, Vaccination, Prescription, Invoice, Veterinarian',payment:'stripe'}),
restaurant:_mp({name:'飲食店管理',nameEn:'Restaurant Management',icon:'🍽️',purpose:'飲食店のPOS・予約・在庫・スタッフ管理を統合',purposeEn:'Integrated POS, reservations, inventory & staff management for restaurants',target:['飲食店オーナー','店長','スタッフ'],targetEn:['Restaurant Owners','Managers','Staff'],frontend:'React (Vite SPA)',features:['テーブル予約管理','POS・注文管理','在庫・発注管理','メニュー編集','売上レポート','スタッフシフト'],featuresEn:['Table Reservation Management','POS & Order Management','Inventory & Ordering','Menu Editor','Sales Reports','Staff Scheduling'],entities:'Table, Reservation, Order, MenuItem, Inventory, Staff, Shift, Payment',payment:'stripe'}),
construction_pay:_mp({name:'建設業決済',nameEn:'Construction Payment',icon:'🏗️',purpose:'建設プロジェクトの支払管理・請求書発行・進捗連動決済',purposeEn:'Construction project payment management, invoicing & milestone-based payments',target:['建設会社','下請け業者','元請け'],targetEn:['Construction Companies','Subcontractors','General Contractors'],features:['プロジェクト管理','マイルストーン設定','進捗報告','請求書発行','支払スケジュール','承認ワークフロー'],featuresEn:['Project Management','Milestone Setup','Progress Reporting','Invoice Generation','Payment Schedule','Approval Workflow'],entities:'Project, Contractor, Milestone, Invoice, Payment, ProgressReport, Approval, Estimate',payment:'stripe'}),
clinic:_mp({name:'クリニック・医院',nameEn:'Medical Clinic',icon:'🏥',purpose:'診療所の電子カルテ・予約・処方箋・会計を統合管理',purposeEn:'Integrated EMR, appointments, prescriptions & billing for clinics',target:['医師','看護師','医療事務','患者'],targetEn:['Doctors','Nurses','Medical Admin','Patients'],features:['電子カルテ','診察予約','処方箋管理','検査結果記録','会計・レセプト','待合状況表示'],featuresEn:['Electronic Medical Records','Appointment Scheduling','Prescription Management','Test Result Logging','Billing & Claims','Waiting Room Status'],entities:'Patient, Appointment, MedicalRecord, Prescription, Examination, Invoice, Doctor, Claim',payment:'stripe'}),
knowledge_base:_mp({name:'ナレッジベース',nameEn:'Knowledge Base',icon:'📖',purpose:'組織の知識・ノウハウを体系化し検索可能にするドキュメントDB',purposeEn:'Systematize and search organizational knowledge & know-how documentation',target:['全社員','カスタマーサポート','教育担当'],targetEn:['All Employees','Customer Support','Training Staff'],features:['記事作成・編集','カテゴリ・タグ管理','全文検索','バージョン履歴','アクセス権限','AI検索提案'],featuresEn:['Article Creation & Editing','Category & Tag Management','Full-text Search','Version History','Access Control','AI Search Suggestions'],entities:'Article, Category, Tag, Version, User, AccessControl, SearchLog, Feedback',ai_auto:'Vibe Coding入門'}),
field_service:_mp({name:'現場サービス',nameEn:'Field Service',icon:'🚚',purpose:'現場作業員の派遣・スケジュール・作業報告を一元管理',purposeEn:'Centralized dispatch, scheduling & work reporting for field workers',target:['サービス企業','技術者','ディスパッチャー'],targetEn:['Service Companies','Technicians','Dispatchers'],features:['作業オーダー管理','スケジューリング','リアルタイム位置追跡','作業報告・写真','在庫管理','請求書発行'],featuresEn:['Work Order Management','Scheduling','Real-time Location Tracking','Work Reports & Photos','Inventory Management','Invoice Generation'],entities:'WorkOrder, Technician, Schedule, Location, Report, Inventory, Customer, Invoice',mobile:'Expo (React Native)',payment:'stripe'}),
custom:{name:'',icon:'⚡'},
};
function _kpiChips(ja,lv){
  const p=(S.answers.purpose||'').toLowerCase();
  const common=ja
    ?['📈 月間1000ユーザー','📈 DAU 100+','😊 NPS 50以上','⚡ レスポンス200ms以内','⚡ 稼働率99.9%+']
    :['📈 1,000 MAU','📈 100+ DAU','😊 NPS 50+','⚡ <200ms response','⚡ 99.9%+ uptime'];
  const pools=ja?{
    saas:['💰 月売上10万円(MRR)','🔄 月間チャーン5%以下','🔄 DAU/MAU比率30%+','💰 LTV5万円','🔄 機能利用率80%+','💰 ARPU500円'],
    ec:['💰 GMV月100万円','💰 CV率3%+','🏪 カート放棄30%以下','🏪 客単価3000円','🏪 取引完了率95%+','😊 レビュー評価4.5★+'],
    marketplace:['💰 GMV月100万円','💰 テイクレート10%','🏪 月500新規出品','🏪 取引完了率95%+','👥 需給バランス比率'],
    education:['📚 コース完了率80%+','📚 クイズ合格率70%+','📚 視聴完了率70%+','📚 月100修了証発行','🔄 7日連続利用率50%+','🔄 セッション時間5分+'],
    community:['👥 日次投稿50件+','👥 メンバー月10%増','👥 UGC率30%+','👥 アクティブグループ70%+','🔄 DAU/MAU比率30%+'],
    content:['📚 月30記事公開','📚 月間5000PV','📚 開封率30%+','📚 CTR 5%+','🔄 セッション時間5分+','💰 購読者月10%増'],
    analytics:['🏢 レポート作成1分以内','🏢 日次100万件処理','😊 CSAT 4.5/5','⚡ エラー率0.1%以下'],
    automation:['🤖 手動作業70%削減','🤖 処理時間50%短縮','⚡ エラー率0.1%以下','⚡ API成功率99.5%+','🏢 タスク完了率90%+'],
    ai:['🤖 AI正答率90%+','🤖 有人対応20%以下','🤖 生成品質スコア4/5','🤖 プロンプト成功率85%+','😊 CSAT 4.5/5'],
    portfolio:['📈 月間5000PV','📚 CTR 5%+','⚡ LCP 2.5秒以内','😊 問合せ率3%+'],
    booking:['🏪 予約転換率60%+','🏪 リソース稼働率80%+','🏪 ノーショー5%以下','😊 CSAT 4.5/5','💰 月間予約500件+'],
    fintech:['💰 月間取引高1000万円','🏢 不正検知率99%+','⚡ 決済成功率99.5%+','😊 CSAT 4.5/5'],
    hr:['🏢 採用日数30日以内','🏢 オファー承諾率80%+','🏢 オンボーディング完了率95%+','😊 従業員満足度4/5'],
    health:['🔄 7日連続利用率50%+','🔄 目標達成率60%+','📚 データ記録率80%+','😊 ユーザー継続率70%+'],
    iot:['⚡ デバイス稼働率95%+','⚡ データ遅延1秒以内','⚡ アラート応答5分以内','🏢 デバイス接続1000台+'],
    event:['🏪 チケット販売率80%+','😊 参加者満足度4.5/5','👥 リピート参加率40%+','💰 イベント収益目標達成'],
    gamify:['🔄 バッジ獲得率60%+','🔄 デイリークエスト完了率50%+','🔄 リーダーボード参加率30%+','📈 エンゲージメント率40%+'],
    collab:['👥 同時編集5人+','👥 編集頻度日次10回+','🔄 機能利用率80%+','😊 NPS 50以上'],
    devtool:['📈 API呼出月10万回','📈 開発者登録月100人+','📚 ドキュメントカバレッジ90%+','⚡ API成功率99.5%+'],
    creator:['💰 ファンLTV1万円','💰 コンテンツ収益化率20%+','👥 ファンエンゲージメント率30%+','📈 購読者月10%増'],
    newsletter:['📚 開封率30%+','📚 CTR 5%+','💰 有料購読者月5%増','📈 購読者月10%増'],
    chatbot:['🤖 自動解決率80%+','🤖 有人対応20%以下','😊 CSAT 4.5/5','⚡ 応答時間2秒以内'],
    pwa:['📈 インストール率10%+','📈 オフライン利用率20%+','🔄 プッシュ通知開封率30%+','⚡ LCP 2.5秒以内'],
    tool:['🏢 タスク完了率90%+','🏢 処理時間50%短縮','😊 CSAT 4.5/5','⚡ 稼働率99.9%+','🔄 機能利用率80%+']
  }:{
    saas:['💰 $1K MRR','🔄 <5% monthly churn','🔄 30%+ DAU/MAU','💰 $500 LTV','🔄 80%+ feature adoption','💰 $5 ARPU'],
    ec:['💰 $10K GMV','💰 3%+ conversion','🏪 <30% cart abandon','🏪 $30 AOV','🏪 95%+ fulfillment','😊 4.5★+ reviews'],
    marketplace:['💰 $10K GMV','💰 10% take rate','🏪 500 listings/mo','🏪 95%+ fulfillment','👥 Supply/demand balance'],
    education:['📚 80%+ completion','📚 70%+ quiz pass','📚 70%+ watch-through','📚 100 certs/month','🔄 50%+ 7-day streak','🔄 5min+ session'],
    community:['👥 50+ posts/day','👥 10%+ member growth/mo','👥 30%+ UGC ratio','👥 70%+ active groups','🔄 30%+ DAU/MAU'],
    content:['📚 30 posts/month','📚 5,000 PV/month','📚 30%+ open rate','📚 5%+ CTR','🔄 5min+ session','💰 10%+ subscriber growth/mo'],
    analytics:['🏢 Reports in <1min','🏢 1M records/day','😊 CSAT 4.5/5','⚡ <0.1% error rate'],
    automation:['🤖 70% manual reduction','🤖 50% time saved','⚡ <0.1% error rate','⚡ 99.5%+ API success','🏢 90%+ task completion'],
    ai:['🤖 90%+ AI accuracy','🤖 <20% human handoff','🤖 4/5 quality score','🤖 85%+ prompt success','😊 CSAT 4.5/5'],
    portfolio:['📈 5,000 PV/month','📚 5%+ CTR','⚡ LCP <2.5s','😊 3%+ inquiry rate'],
    booking:['🏪 60%+ booking conv.','🏪 80%+ utilization','🏪 <5% no-show','😊 CSAT 4.5/5','💰 500+ bookings/mo'],
    fintech:['💰 $100K transactions/mo','🏢 99%+ fraud detection','⚡ 99.5%+ payment success','😊 CSAT 4.5/5'],
    hr:['🏢 <30 days time-to-hire','🏢 80%+ offer acceptance','🏢 95%+ onboarding','😊 4/5 employee satisfaction'],
    health:['🔄 50%+ 7-day streak','🔄 60%+ goal achievement','📚 80%+ data logging','😊 70%+ user retention'],
    iot:['⚡ 95%+ device uptime','⚡ <1s data latency','⚡ <5min alert response','🏢 1,000+ devices'],
    event:['🏪 80%+ sell-through','😊 4.5/5 attendee satisfaction','👥 40%+ repeat attendance','💰 Revenue target met'],
    gamify:['🔄 60%+ badge earn rate','🔄 50%+ daily quest','🔄 30%+ leaderboard participation','📈 40%+ engagement rate'],
    collab:['👥 5+ concurrent editors','👥 10+ daily edits','🔄 80%+ feature adoption','😊 NPS 50+'],
    devtool:['📈 100K API calls/mo','📈 100+ devs/month','📚 90%+ docs coverage','⚡ 99.5%+ API success'],
    creator:['💰 $100 fan LTV','💰 20%+ monetization rate','👥 30%+ fan engagement','📈 10%+ subscriber growth/mo'],
    newsletter:['📚 30%+ open rate','📚 5%+ CTR','💰 5%+ paid subscriber growth/mo','📈 10%+ subscriber growth/mo'],
    chatbot:['🤖 80%+ auto-resolution','🤖 <20% human handoff','😊 CSAT 4.5/5','⚡ <2s response time'],
    pwa:['📈 10%+ install rate','📈 20%+ offline usage','🔄 30%+ push open rate','⚡ LCP <2.5s'],
    tool:['🏢 90%+ task completion','🏢 50% time saved','😊 CSAT 4.5/5','⚡ 99.9%+ uptime','🔄 80%+ feature adoption']
  };
  const detect=[
    [/SaaS|サブスク|subscription/i,'saas'],
    [/EC|Eコマース|E-Commerce|ショップ|shop|commerce/i,'ec'],
    [/マーケットプレイス|marketplace|売り手.*買い手|buyer.*seller/i,'marketplace'],
    [/教育|学習|Education|Learning|LMS|コース|course/i,'education'],
    [/コミュニティ|community|フォーラム|forum|交流/i,'community'],
    [/コンテンツ|content|メディア|media|ブログ|blog|ニュース|news|配信/i,'content'],
    [/IoT|デバイス|device|センサー|sensor|監視|monitor/i,'iot'],
    [/分析|analytics|可視化|visualiz|ダッシュボード|dashboard|データ分析|data.*analy/i,'analytics'],
    [/チャットボット|chatbot|FAQ|カスタマー.*サポート|customer.*support/i,'chatbot'],
    [/AI|人工知能|エージェント|agent|対話型/i,'ai'],
    [/自動化|automat|ワークフロー|workflow|RPA|iPaaS/i,'automation'],
    [/ポートフォリオ|portfolio|実績|showcase/i,'portfolio'],
    [/予約|booking|スケジュール|schedule|予約/i,'booking'],
    [/金融|fintech|決済|payment|家計|budget|請求|invoice/i,'fintech'],
    [/HR|採用|recruit|人事|hiring/i,'hr'],
    [/健康|health|フィットネス|fitness|ウェルネス|wellness/i,'health'],
    [/イベント|event|チケット|ticket|開催/i,'event'],
    [/ゲーミ|gamif|ゲーム|game|ポイント|point|バッジ|badge/i,'gamify'],
    [/コラボ|collab|共同|同時編集|realtime/i,'collab'],
    [/開発者|developer|devtool|API|ユーティリティ|utility/i,'devtool'],
    [/クリエイター|creator|ファン|fan|コンテンツ販売/i,'creator'],
    [/ニュースレター|newsletter|メール配信|mail/i,'newsletter'],
    [/PWA|プログレッシブ|モバイルファースト|mobile.?first/i,'pwa'],
    [/業務|business|効率化|ツール|tool/i,'tool'],
  ];
  let matched=[];
  for(const[rx,key]of detect){if(rx.test(p)&&pools[key]){matched.push(...pools[key]);break;}}
  if(!matched.length){
    const fallback=pools[ja?'saas':'saas'];
    matched.push(...fallback.slice(0,3));
  }
  const seen=new Set();const all=[...common,...matched].filter(c=>{if(seen.has(c))return false;seen.add(c);return true;});
  if(lv==='beginner')return all.slice(0,6);
  if(lv==='pro')return all;
  return all.slice(0,10);
}
function getQ(){
  const lv=S.skill;
  const ja=S.lang==='ja';
  return {
  1:{name:ja?'プロジェクト定義':'Project Definition',questions:[
    {id:'purpose',q:ja?'プロジェクトの目的':'Project Purpose',type:'chip-text',chips:ja?['業務効率化ツール','コンテンツ配信','教育・学習支援','EC・マーケットプレイス','コミュニティ構築','ポートフォリオ','データ分析・可視化','自動化ツール','SaaS']:['Business Tool','Content Delivery','Education','E-Commerce','Community','Portfolio','Data Analytics','Automation','SaaS'],placeholder:ja?'自由入力…':'Type freely...',tip:ja?'「誰が何をできるようになるか」を明確に':'Clarify "who can do what"',help:'purpose'},
    {id:'target',q:ja?'ターゲットユーザー':'Target Users',type:'chip-multi',chips:ja?['学生','フリーランス','スタートアップ','中小企業','エンジニア','デザイナー','教育者','一般消費者','管理者','経営者']:['Students','Freelancers','Startups','SMBs','Engineers','Designers','Educators','Consumers','Admins','Executives'],placeholder:ja?'追加…':'Add...',tip:ja?'具体的なペルソナをイメージしましょう':'Imagine a specific persona',help:'target'},
    {id:'success',q:ja?'成功指標（KPI）':'Success Metrics (KPI)',type:'chip-multi',chips:_kpiChips(ja,lv),placeholder:ja?'追加…':'Add...',tip:ja?'3〜5つに絞りましょう（プロジェクト種別に応じた指標を提案中）':'Pick 3-5 (suggestions based on your project type)',help:'success'},
    {id:'scope_out',q:ja?'スコープ外（やらないこと）':'Out of Scope',type:'chip-multi',chips:ja?['チャット機能','動画配信','決済機能','多言語対応','ネイティブアプリ','AI機能','管理画面','API公開','SNS連携','プッシュ通知']:['Chat','Video streaming','Payments','i18n','Native app','AI features','Admin panel','Public API','Social media','Push notifications'],placeholder:ja?'追加…':'Add...',tip:ja?'スコープを絞ることがMVP完成の鍵':'Scoping down is key to MVP success',help:'scope_out'},
    {id:'deadline',q:ja?'リリース目標':'Release Target',type:'options',options:[{label:ja?'2週間':'2 weeks',desc:ja?'超MVP':'Ultra MVP'},{label:ja?'1ヶ月':'1 month',desc:ja?'基本機能':'Basic features'},{label:ja?'3ヶ月':'3 months',desc:ja?'本格MVP':'Full MVP'},{label:ja?'6ヶ月':'6 months',desc:'v1.0'}],tip:ja?'MVPを優先しましょう':'Prioritize MVP',help:'deadline'},
  ]},
  2:{name:ja?'技術選定':'Tech Stack',questions:[
    {id:'frontend',q:ja?'フロントエンド':'Frontend',type:'options',options:[{label:'React + Next.js',desc:ja?'SSR/SSG/ISR — 求人最多・エコシステム最大':'SSR/SSG/ISR — most jobs & largest ecosystem'},{label:'React (Vite SPA)',desc:ja?'CSR高速 — 管理画面やSaaS向け':'Fast CSR — for admin panels & SaaS'},...(lv!=='beginner'?[{label:'Vue 3 + Nuxt',desc:ja?'学習容易・日本コミュニティ充実':'Easy to learn, strong JP community'},{label:'Svelte + SvelteKit',desc:ja?'最小バンドル・高速':'Smallest bundle, fast'},
{label:'Astro',desc:ja?'コンテンツサイト・静的サイト':'Content & static sites'}]:[]),...(lv==='pro'?[{label:'Angular',desc:ja?'エンタープライズ大規模':'Enterprise scale'},{label:'React Router v7 (Remix)',desc:ja?'Web標準・フレームワーク統合':'Web standards, framework-unified'}]:[])],tip:ja?'知っている技術が最速です':'Pick what you know',help:'frontend'},
    {id:'css_fw',q:ja?'CSSフレームワーク':'CSS Framework',type:'options',help:'css_fw',options:[{label:'Tailwind CSS',desc:ja?'2026年シェア1位 — ユーティリティファースト':'#1 in 2026 — utility-first'},{label:'shadcn/ui + Tailwind',desc:ja?'Radix UI + Tailwind — コピペUI':'Radix UI + Tailwind — copy-paste UI'},{label:'Bootstrap',desc:ja?'レガシー互換・クラス名でスタイル':'Legacy compat, class-based styling'},...(lv!=='beginner'?[{label:'CSS Modules',desc:ja?'スコープ付きCSS':'Scoped CSS'},
{label:'Vanilla CSS',desc:ja?'フレームワーク不使用':'No framework'}]:[])],tip:ja?'Tailwind CSSが2026年のデファクト':'Tailwind CSS is the 2026 standard'},
    {id:'backend',q:ja?'バックエンド/DB':'Backend/DB',type:'options',options:[{label:'Firebase',desc:ja?'Google BaaS — 最速プロトタイプ':'Google BaaS — fastest prototype'},{label:'Supabase',desc:ja?'OSS PostgreSQL BaaS — 急成長中':'OSS PostgreSQL BaaS — rapid growth'},...(lv!=='beginner'?[{label:'Node.js + Express',desc:ja?'実績豊富・エコシステム最大・Express 5.x':'Most proven, largest ecosystem, Express 5.x'},{label:'Node.js + Fastify',desc:ja?'Express 5x高速':'5x faster than Express'},
{label:'Node.js + NestJS',desc:ja?'DI・TypeScript完全対応':'DI, full TypeScript support'}]:[]),...(lv==='pro'?[{label:'Python + FastAPI',desc:ja?'AI/ML連携最適・非同期':'Best for AI/ML, async'},{label:'Python + Django',desc:ja?'フルスタック・管理画面付き':'Full-stack with admin panel'},{label:'Java + Spring Boot',desc:ja?'金融・エンタープライズ':'Finance & enterprise'},{label:'Go + Gin',desc:ja?'高パフォーマンス・マイクロサービス':'High-perf microservices'},
{label:'Hono',desc:ja?'Edge Runtime・超軽量':'Edge Runtime, ultra-light'}]:[]),{label:ja?'なし（静的サイト）':'None (static site)',desc:ja?'バックエンド不要':'No backend needed'}],tip:ja?'BaaSならコード不要で開始可能':'BaaS needs no server code',help:'backend'},
    {id:'database',q:ja?'データベース':'Database',type:'options',help:'database',condition:{backend:v=>!/なし|None|static/i.test(v)},options:[{label:'PostgreSQL',desc:ja?'2026年SQL推奨1位 — 堅牢・拡張性':'#1 SQL in 2026 — robust & extensible'},{label:'Supabase (PostgreSQL)',desc:ja?'BaaS + リアルタイム + Auth付き':'BaaS + realtime + Auth included'},{label:'Firebase Firestore',desc:ja?'NoSQL BaaS — スキーマレス':'NoSQL BaaS — schemaless'},...(lv!=='beginner'?[{label:'MongoDB',desc:ja?'ドキュメントDB — 柔軟スキーマ':'Document DB — flexible schema'},
{label:'MySQL',desc:ja?'実績豊富 — WordPress/Laravel':'Proven track record — WordPress/Laravel'}]:[]),...(lv==='pro'?[{label:'SQLite',desc:ja?'組込み/Edge — Turso互換':'Embedded/Edge — Turso compatible'},{label:'Redis',desc:ja?'キャッシュ/セッション/Pub-Sub':'Cache/Session/Pub-Sub'},{label:'Neon',desc:ja?'サーバーレスPostgreSQL':'Serverless PostgreSQL'}]:[])],tip:ja?'迷ったらPostgreSQL':'When in doubt, PostgreSQL'},
    {id:'orm',q:ja?'ORM':'ORM',type:'options',help:'orm',condition:{backend:v=>!/Firebase|Supabase|Convex|なし|None|static/i.test(v)},options:[{label:'Prisma',desc:ja?'2026年Node.js ORM 1位 — 型安全・Studio付き':'#1 Node.js ORM 2026 — type-safe + Studio'},{label:'Drizzle',desc:ja?'軽量・SQLライク — TypeScript完全対応':'Lightweight SQL-like — full TypeScript'},...(lv!=='beginner'?[{label:'TypeORM',desc:ja?'デコレータベース — NestJS親和':'Decorator-based — NestJS compatible'}]:[]),...(lv==='pro'?[{label:'SQLAlchemy (Python)',desc:ja?'Python標準ORM':'Python standard ORM'},
{label:'Kysely',desc:ja?'SQL型安全ビルダー':'Type-safe SQL builder'}]:[]),{label:ja?'なし / BaaS使用':'None / Using BaaS',desc:ja?'Firebase/Supabase利用時':'When using Firebase/Supabase'}],tip:ja?'PrismaのStudioはDB管理に便利':'Prisma Studio is great for DB management'},
    {id:'mobile',q:ja?'モバイル対応 ★v8':'Mobile Support ★v8',type:'options',help:'mobile',options:[{label:'Expo (React Native)',desc:ja?'推奨 — SDK55・EAS Build/Submit・OTA・React共有80%+':'Recommended — SDK55, EAS Build/Submit, OTA, 80%+ React reuse'},...(lv!=='beginner'?[{label:'Flutter',desc:ja?'Dart製・ピクセルパーフェクトUI・マルチプラットフォーム':'Dart, pixel-perfect UI, multi-platform'},
{label:'React Native (bare)',desc:ja?'ネイティブモジュール完全制御':'Full native module control'}]:[]),...(lv==='pro'?[{label:ja?'Swift/Kotlin (ネイティブ)':'Swift/Kotlin (Native)',desc:ja?'最高パフォーマンス・プラットフォーム固有':'Best performance, platform-specific'}]:[]),{label:'PWA',desc:ja?'Service Worker — インストール可能Web':'Service Worker — installable web'},{label:ja?'なし':'None',desc:ja?'Web専用':'Web only'}],tip:ja?'ExpoならReact知識をそのままモバイルへ':'Expo lets you reuse React skills for mobile'},
    {id:'ai_auto',q:ja?'AI自律開発レベル ★v8':'AI Dev Level ★v8',type:'options',help:'ai_auto',options:[{label:ja?'Vibe Coding入門':'Vibe Coding Intro',desc:ja?'Level 1 — AIペアプログラミング・Tab補完':'Level 1 — AI pair programming, Tab completion'},...(lv!=='beginner'?[{label:ja?'エージェント型開発':'Agentic Dev',desc:ja?'Level 2 — Cursor Agent/Cline/Antigravity マルチファイル編集':'Level 2 — Cursor Agent/Cline/Antigravity multi-file editing'},
{label:ja?'マルチAgent協調':'Multi-Agent',desc:ja?'Level 2-3 — Antigravity Manager View/Sub-Agents並列実行':'Level 2-3 — Antigravity Manager View/Sub-Agents parallel exec'}]:[]),...(lv==='pro'?[{label:ja?'フル自律開発':'Full Autonomous',desc:ja?'Level 3 — Claude Code Subagents/Jules(非同期)/Agent Teams':'Level 3 — Claude Code Subagents/Jules(async)/Agent Teams'},
{label:ja?'オーケストレーター':'Orchestrator',desc:ja?'Agent Architect — CI/CD統合・本番パイプライン':'Agent Architect — CI/CD integration, prod pipeline'}]:[]),{label:ja?'なし':'None',desc:ja?'手動コーディング':'Manual coding'}],tip:ja?'2028年までに新規本番コードの40%がVibe Coding生成 (Gartner)':'40% of new production code via Vibe Coding by 2028 (Gartner)'},
    {id:'payment',q:ja?'決済・CMS・EC ★v8':'Payment/CMS/EC ★v8',type:'chip-multi',chips:ja?['Stripe決済','Stripe Billing (サブスク)',...(lv!=='beginner'?['Paddle (SaaS MoR)','Lemon Squeezy (デジタル商品)','Polar (OSS収益化)']:[]),'microCMS (国産ヘッドレス)',...(lv!=='beginner'?['Strapi (OSS CMS)','Sanity','Contentful']:[]),...(lv==='pro'?['Medusa (OSS EC)','Shopify Hydrogen','Stripe Connect (マーケットプレイス)','Saleor (Python EC)']:[]),'なし']:['Stripe','Stripe Billing (Sub)',...(lv!=='beginner'?['Paddle (SaaS MoR)',
'Lemon Squeezy (Digital)','Polar (OSS Monetize)']:[]),'microCMS (JP Headless)',...(lv!=='beginner'?['Strapi (OSS CMS)','Sanity','Contentful']:[]),...(lv==='pro'?['Medusa (OSS EC)','Shopify Hydrogen','Stripe Connect (Marketplace)','Saleor (Python EC)']:[]),'None'],
placeholder:ja?'追加…':'Add...',tip:ja?'Stripeが最も導入しやすい。MoR=税務処理代行':'Stripe is easiest to integrate. MoR = tax handling',help:'payment'},
    {id:'ai_tools',q:ja?'AIコーディングツール（複数可）':'AI Coding Tools (multi)',type:'chip-multi',condition:{ai_auto:v=>v&&!/none|なし/i.test(v)},chips:['Cursor','Claude Code','GitHub Copilot','Google Antigravity',...(lv!=='beginner'?['Windsurf','Cline/RooCode','Kiro','Gemini CLI','Aider','Amazon Q Developer']:[]),...(lv==='pro'?['Codex (OpenAI)','Augment Code','Bolt.new','Devin','Lovable','Continue.dev','Tabnine']:[])],placeholder:ja?'追加…':'Add...',tip:ja?'Cursor / Antigravity (IDE) + Claude Code (CLI) が最強コンビ':'Cursor / Antigravity (IDE) + Claude Code (CLI) is the strongest combo',help:'ai_tools'},
    {id:'deploy',q:ja?'デプロイ先':'Deployment',type:'options',options:[{label:'Vercel',desc:ja?'Next.js最適・無料枠充実・Edge Functions':'Best for Next.js, generous free tier, Edge Functions'},{label:'Firebase Hosting',desc:ja?'Firebase統合・Google CDN':'Firebase integration, Google CDN'},...(lv!=='beginner'?[{label:'Cloudflare Pages',desc:ja?'エッジ最速・Workers統合':'Fastest edge, Workers integration'},{label:'Railway',desc:ja?'フルスタック簡単デプロイ・PostgreSQL付き':'Easy full-stack deploy with PostgreSQL'},
{label:'Fly.io',desc:ja?'Dockerベース・グローバルエッジ':'Docker-based, global edge'},{label:'Render',desc:ja?'フルスタック簡単デプロイ・無料枠あり':'Easy full-stack deploy, free tier'}]:[]),...(lv==='pro'?[{label:'AWS (EC2/ECS/Lambda)',desc:ja?'フルカスタム・IaC':'Full custom, IaC'},{label:ja?'Docker (自前)':'Docker (self-hosted)',desc:ja?'完全制御・K8s対応':'Full control, K8s ready'}]:[]),{label:'Netlify',desc:ja?'静的/JAMstack — 無料枠充実':'Static/JAMstack — generous free tier'}],tip:ja?'Vercel/Netlify無料枠で十分':'Vercel/Netlify free tiers are plenty',help:'deploy'},
    {id:'dev_methods',q:ja?'駆動開発手法（複数可）':'Dev Methods (multi)',type:'chip-multi',chips:[...(lv==='beginner'?(ja?['TDD（テスト駆動）','BDD（振る舞い駆動）','SDD（仕様駆動）']:['TDD (Test-Driven)','BDD (Behavior-Driven)','SDD (Spec-Driven)']):(ja?['TDD（テスト駆動）','BDD（振る舞い駆動）','SDD（仕様駆動）','DDD（ドメイン駆動）','FDD（機能駆動）',...(lv==='pro'?['MDD（モデル駆動）']:[])]:['TDD (Test-Driven)','BDD (Behavior-Driven)','SDD (Spec-Driven)','DDD (Domain-Driven)','FDD (Feature-Driven)',...(lv==='pro'?['MDD (Model-Driven)']:[])]))],
placeholder:ja?'追加…':'Add...',tip:lv==='beginner'?(ja?'TDD + SDD がAI駆動開発の基本':'TDD + SDD are AI-driven dev basics'):(ja?'SDD→BDD→TDD→DDD の組み合わせが最強':'SDD→BDD→TDD→DDD combo is strongest'),help:'dev_methods'},
  ]},
  3:{name:ja?'機能・データ設計':'Feature & Data Design',questions:[
    {id:'mvp_features',q:ja?'MVP機能（3〜5個推奨）':'MVP Features (3-5 recommended)',type:'chip-multi',sortable:true,chips:ja?['ユーザー登録・ログイン','プロフィール編集','ダッシュボード','一覧表示・検索','詳細ページ','作成・編集・削除','ファイルアップロード','通知機能','お気に入り','コメント機能','シェア機能','設定画面',...(lv!=='beginner'?['API連携','管理画面','エクスポート','多言語','サブスクリプション']:[]),...(lv==='pro'?['リアルタイム同期','Webhook','RBAC','監査ログ','マルチテナント']:[])]
    :['User Auth','Profile Edit','Dashboard','List & Search','Detail Page','CRUD','File Upload','Notifications','Favorites','Comments','Share','Settings',...(lv!=='beginner'?['API Integration','Admin Panel','Export','i18n','Subscription']:[]),...(lv==='pro'?['Realtime Sync','Webhook','RBAC','Audit Log','Multi-tenant']:[])],placeholder:ja?'追加…':'Add...',tip:ja?'3〜5個に絞りましょう':'Keep it to 3-5',help:'mvp_features'},
    {id:'future_features',q:ja?'将来追加機能':'Future Features',type:'chip-multi',chips:ja?['課金・サブスク','チーム機能','カレンダー連携','チャット','分析レポート','AI機能','モバイルアプリ','API公開','外部連携','A/Bテスト']
    :['Billing','Team features','Calendar','Chat','Analytics','AI features','Mobile app','Public API','Integrations','A/B testing'],placeholder:ja?'追加…':'Add...',tip:ja?'Phase 2, 3として計画':'Plan for Phase 2, 3',help:'future_features'},
    {id:'data_entities',q:ja?'データテーブル':'Data Entities',type:'chip-multi',condition:{backend:v=>!/なし|None|static/i.test(v)},chips:['User','Post','Comment','Tag','Category','Product','Order','Task','Project','Message','Notification','File','Setting','Log',...(lv!=='beginner'?['Course','Lesson','Progress','Quiz','Certificate','Event','Group','Review','Invoice','Subscription']:[])],placeholder:ja?'追加…':'Add...',tip:ja?'英語・単数形が標準':'English, singular form is standard',help:'data_entities'},
    {id:'auth',q:ja?'認証方式':'Authentication',type:'chip-multi',condition:{backend:v=>!/なし|None|static/i.test(v)},chips:ja?['メール/パスワード','Google OAuth','GitHub OAuth','Magic Link',...(lv!=='beginner'?['Auth.js/NextAuth','Clerk','Supabase Auth']:[]),...(lv==='pro'?['SSO/SAML','MFA','API Key']:[])]
    :['Email/Password','Google OAuth','GitHub OAuth','Magic Link',...(lv!=='beginner'?['Auth.js/NextAuth','Clerk','Supabase Auth']:[]),...(lv==='pro'?['SSO/SAML','MFA','API Key']:[])],placeholder:'',tip:ja?'OAuth系は実装簡単でUX向上':'OAuth is easy to implement and improves UX',help:'auth'},
    {id:'screens',q:ja?'主要画面':'Key Screens',type:'chip-multi',sortable:true,chips:ja?['ランディングページ','ログイン/登録','ダッシュボード','一覧ページ','詳細ページ','作成/編集フォーム','プロフィール','設定','404エラー','お問い合わせ',...(lv!=='beginner'?['管理画面','分析画面','オンボーディング']:[]),...(lv==='pro'?['APIドキュメント','ステータスページ','利用規約']:[])]
    :['Landing Page','Login/Register','Dashboard','List Page','Detail Page','Create/Edit Form','Profile','Settings','404 Error','Contact',...(lv!=='beginner'?['Admin Panel','Analytics','Onboarding']:[]),...(lv==='pro'?['API Docs','Status Page','Terms of Service']:[])],placeholder:ja?'追加…':'Add...',tip:ja?'ワイヤーフレームを描くとスムーズ':'Wireframing helps a lot',help:'screens'},
    {id:'skill_level',q:ja?'スキルレベル確認':'Confirm Skill Level',type:'options',help:'skill_level',options:[{label:'Beginner',desc:ja?'HTML/CSS学習中 — 初心者向けロードマップ':'Learning HTML/CSS — beginner roadmap'},{label:'Intermediate',desc:ja?'React/Node.js経験あり — 中級者パス':'React/Node.js experience — intermediate path'},{label:'Professional',desc:ja?'フルスタック実務経験 — プロ向け高度パス':'Full-stack production exp — advanced path'}],tip:ja?'ロードマップの難易度に影響します':'Affects roadmap difficulty'},
    {id:'learning_goal',q:ja?'学習目標期間':'Learning Timeline',type:'options',help:'learning_goal',options:[{label:ja?'3ヶ月集中':'3 months intensive',desc:ja?'集中的に学習':'Focused learning'},{label:ja?'6ヶ月標準':'6 months standard',desc:ja?'バランスよく':'Balanced pace'},{label:ja?'12ヶ月じっくり':'12 months thorough',desc:ja?'深く理解':'Deep understanding'}],tip:ja?'ロードマップのペースに影響します':'Affects roadmap pace'},
    {id:'learning_path',q:ja?'学習パターン ★v8':'Learning Pattern ★v8',type:'options',help:'learning_path',options:[{label:ja?'PERN Stack':'PERN Stack',desc:ja?'React+Node.js+PostgreSQL — 最も汎用的':'React+Node.js+PostgreSQL — most versatile'},{label:ja?'React + BaaS':'React + BaaS',desc:ja?'Firebase/Supabase — 最短ルート':'Firebase/Supabase — fastest route'},
...(lv!=='beginner'?[{label:ja?'フルスタック+モバイル':'Fullstack+Mobile',desc:ja?'React+Next.js+Expo — Web+Mobile統合':'React+Next.js+Expo — Web+Mobile unified'}]:[]),...(lv==='pro'?[{label:ja?'AI自律オーケストレーター':'AI Orchestrator',desc:ja?'Claude Code中心 — Agent Architect特化':'Claude Code focused — Agent Architect path'},
{label:ja?'SaaS収益化特化':'SaaS Monetization',desc:ja?'Stripe+microCMS+Next.js — 収益化パス':'Stripe+microCMS+Next.js — monetization path'}]:[])],tip:ja?'ロードマップの学習パスを決定します':'Determines your learning path'},
  ]},
  };
}
const REQ_LABELS={
  ja:{required:'必須',top1:'推奨No.1',top2:'推奨No.2','rec-jp':'推奨(JP)','rec-oss':'推奨(OSS)',recommended:'推奨',optional:'選択'},
  en:{required:'Required',top1:'Top Pick',top2:'2nd Pick','rec-jp':'Rec (JP)','rec-oss':'Rec (OSS)',recommended:'Recommended',optional:'Optional'}
};
const PRICE_LABELS={
  ja:{usage:'従量制',free:'無料','free-oss':'無料(OSS)','free-tier':'無料〜','free-15':'無料〜$15','free-19':'無料〜$19','free-20':'無料〜$20','free-23':'無料〜$23','free-25':'無料〜$25','free-26':'無料〜$26','free-39':'無料〜$39','free-99':'無料〜$99','free-100':'無料〜$100','free-105':'無料〜$105','free-300':'無料〜$300+','free-399':'無料〜$399','free-1295':'無料〜$1,295',paid:'有料','free(preview)':'無料(Preview)','pay-as-you-go':'従量課金','bundled':'IDE付属'},
  en:{usage:'Usage-based',free:'Free','free-oss':'Free (OSS)','free-tier':'Free tier','free-15':'Free–$15','free-19':'Free–$19','free-20':'Free–$20','free-23':'Free–$23','free-25':'Free–$25','free-26':'Free–$26','free-39':'Free–$39','free-99':'Free–$99','free-100':'Free–$100','free-105':'Free–$105','free-300':'Free–$300+','free-399':'Free–$399','free-1295':'Free–$1,295',paid:'Paid','free(preview)':'Free (Preview)','pay-as-you-go':'Pay-as-you-go','bundled':'Bundled'}
};
function priceLabel(code){if(!code)return '';return (PRICE_LABELS[S.lang]||PRICE_LABELS.en)[code]||code;}
function reqLabel(code){return (REQ_LABELS[S.lang]||REQ_LABELS.en)[code]||code;}
const TECH_DB=[
{name:'HTML5',cat:'lang',sub:'markup',req:'required',level:'all',weeks:'2-4'},
{name:'CSS3',cat:'lang',sub:'style',req:'required',level:'all',weeks:'3-6'},
{name:'JavaScript (ES6+)',cat:'lang',sub:'language',req:'required',level:'all',weeks:'4-12'},
{name:'TypeScript',cat:'lang',sub:'language',req:'required',level:'int',weeks:'2-4'},
{name:'SQL',cat:'lang',sub:'query',req:'required',level:'int',weeks:'2-4'},
{name:'Python',cat:'lang',sub:'language',req:'optional',level:'back',weeks:'4-8'},
{name:'Java',cat:'lang',sub:'language',req:'optional',level:'ent',weeks:'8-16'},
{name:'Go',cat:'lang',sub:'language',req:'optional',level:'perf',weeks:'4-8'},
{name:'Rust',cat:'lang',sub:'language',req:'optional',level:'sys',weeks:'8-16'},
{name:'GraphQL SDL',cat:'lang',sub:'query',req:'optional',level:'pro',weeks:'1-2'},
{name:'React',cat:'front',sub:'fw',req:'top1',level:'int'},
{name:'Next.js',cat:'front',sub:'meta-fw',req:'recommended',level:'int'},
{name:'Vue 3',cat:'front',sub:'fw',req:'optional',level:'int'},
{name:'Nuxt',cat:'front',sub:'meta-fw',req:'optional',level:'int'},
{name:'Svelte',cat:'front',sub:'fw',req:'optional',level:'int'},
{name:'SvelteKit',cat:'front',sub:'meta-fw',req:'optional',level:'int'},
{name:'Angular',cat:'front',sub:'fw',req:'optional',level:'ent'},
{name:'Astro',cat:'front',sub:'fw',req:'optional',level:'content'},
{name:'Tailwind CSS',cat:'front',sub:'css-fw',req:'top1',level:'int'},
{name:'shadcn/ui',cat:'front',sub:'ui',req:'recommended',level:'int'},
{name:'React Router',cat:'front',sub:'routing',req:'required',level:'react'},
{name:'React Query',cat:'front',sub:'data',req:'recommended',level:'int'},
{name:'Zustand',cat:'front',sub:'state',req:'recommended',level:'int'},
{name:'Redux Toolkit',cat:'front',sub:'state',req:'optional',level:'large'},
{name:'Vite',cat:'front',sub:'build',req:'top1',level:'int'},
{name:'Vitest',cat:'front',sub:'test',req:'recommended',level:'int'},
{name:'Playwright',cat:'front',sub:'e2e',req:'recommended',level:'int'},
{name:'Storybook',cat:'front',sub:'ui-dev',req:'optional',level:'pro'},
{name:'ESLint',cat:'front',sub:'lint',req:'required',level:'int'},
{name:'Prettier',cat:'front',sub:'format',req:'required',level:'int'},
{name:'React Native',cat:'mobile',sub:'fw',req:'top1',level:'int'},
{name:'Expo',cat:'mobile',sub:'platform',req:'top1',level:'int'},
{name:'Expo Router',cat:'mobile',sub:'routing',req:'recommended',level:'int'},
{name:'Expo SDK',cat:'mobile',sub:'sdk',req:'recommended',level:'int'},
{name:'EAS Build',cat:'mobile',sub:'build',req:'recommended',level:'int'},
{name:'EAS Submit',cat:'mobile',sub:'store',req:'recommended',level:'int'},
{name:'EAS Update (OTA)',cat:'mobile',sub:'update',req:'recommended',level:'int'},
{name:'NativeWind',cat:'mobile',sub:'css',req:'recommended',level:'int'},
{name:'Tamagui',cat:'mobile',sub:'ui',req:'optional',level:'universal'},
{name:'React Native Reanimated',cat:'mobile',sub:'animation',req:'recommended',level:'int'},
{name:'FlashList',cat:'mobile',sub:'list',req:'recommended',level:'perf'},
{name:'Maestro',cat:'mobile',sub:'e2e',req:'recommended',level:'pro'},
{name:'Flutter',cat:'mobile',sub:'alt-fw',req:'optional',level:'dart'},
{name:'Node.js',cat:'back',sub:'runtime',req:'top1',level:'int'},
{name:'Express',cat:'back',sub:'fw',req:'recommended',level:'int'},
{name:'Fastify',cat:'back',sub:'fw',req:'recommended',level:'int'},
{name:'NestJS',cat:'back',sub:'fw',req:'optional',level:'ent'},
{name:'Hono',cat:'back',sub:'fw',req:'optional',level:'edge'},
{name:'Django',cat:'back',sub:'fw',req:'optional',level:'py'},
{name:'FastAPI',cat:'back',sub:'fw',req:'optional',level:'py'},
{name:'Spring Boot',cat:'back',sub:'fw',req:'optional',level:'java'},
{name:'PostgreSQL',cat:'back',sub:'db',req:'top1',level:'int'},
{name:'MongoDB',cat:'back',sub:'db',req:'top2',level:'int'},
{name:'MySQL',cat:'back',sub:'db',req:'optional',level:'int'},
{name:'Redis',cat:'back',sub:'cache',req:'recommended',level:'int'},
{name:'Prisma',cat:'back',sub:'orm',req:'top1',level:'int'},
{name:'Drizzle',cat:'back',sub:'orm',req:'top2',level:'int'},
{name:'NextAuth.js / Auth.js',cat:'back',sub:'auth',req:'recommended',level:'int'},
{name:'JWT',cat:'back',sub:'auth-spec',req:'required',level:'int'},
{name:'OAuth 2.0',cat:'back',sub:'auth-spec',req:'recommended',level:'int'},
{name:'Socket.io',cat:'back',sub:'ws',req:'optional',level:'rt'},
{name:'GraphQL (Apollo)',cat:'back',sub:'api',req:'optional',level:'pro'},
{name:'Swagger/OpenAPI',cat:'back',sub:'doc',req:'recommended',level:'int'},
{name:'Firebase',cat:'baas',sub:'full',req:'recommended',level:'mvp'},
{name:'Supabase',cat:'baas',sub:'full',req:'recommended',level:'sql'},
{name:'Vercel Edge Functions',cat:'baas',sub:'serverless',req:'optional',level:'front'},
{name:'Cloudflare Workers',cat:'baas',sub:'edge',req:'optional',level:'global'},
{name:'Neon',cat:'baas',sub:'db',req:'optional',level:'pg'},
{name:'Stripe',cat:'payment',sub:'payment',req:'top1',level:'int',price:'2.9%+30¢'},
{name:'Stripe Billing',cat:'payment',sub:'subscription',req:'recommended',level:'int',price:'usage'},
{name:'Stripe Connect',cat:'payment',sub:'marketplace',req:'optional',level:'pro',price:'usage'},
{name:'Paddle',cat:'payment',sub:'mor',req:'optional',level:'int',price:'5%+50¢'},
{name:'Lemon Squeezy (Stripe)',cat:'payment',sub:'mor',req:'optional',level:'beg',price:'5%+50¢'},
{name:'Polar',cat:'payment',sub:'mor',req:'optional',level:'int',price:'5%+40¢'},
{name:'PayPal',cat:'payment',sub:'payment',req:'optional',level:'beg',price:'2.9%+30¢'},
{name:'microCMS',cat:'payment',sub:'cms',req:'rec-jp',level:'beg',price:'¥0〜¥4,900'},
{name:'Strapi',cat:'payment',sub:'cms',req:'rec-oss',level:'int',price:'free-15'},
{name:'Sanity',cat:'payment',sub:'cms',req:'optional',level:'int',price:'free-99'},
{name:'Contentful',cat:'payment',sub:'cms',req:'optional',level:'pro',price:'free-300'},
{name:'Payload',cat:'payment',sub:'cms',req:'optional',level:'int',price:'free-oss'},
{name:'Shopify Hydrogen',cat:'payment',sub:'ec',req:'optional',level:'pro',price:'$39〜'},
{name:'Medusa',cat:'payment',sub:'ec',req:'rec-oss',level:'int',price:'free'},
{name:'Saleor',cat:'payment',sub:'ec',req:'optional',level:'pro',price:'free-1295'},
{name:'Clerk',cat:'payment',sub:'auth',req:'optional',level:'int',price:'free-25'},
{name:'Auth0',cat:'payment',sub:'auth',req:'optional',level:'pro',price:'free-23'},
{name:'Git',cat:'devops',sub:'vcs',req:'required',level:'all'},
{name:'GitHub',cat:'devops',sub:'platform',req:'required',level:'all'},
{name:'Docker',cat:'devops',sub:'container',req:'recommended',level:'int'},
{name:'Docker Compose',cat:'devops',sub:'orchestration',req:'recommended',level:'int'},
{name:'GitHub Actions',cat:'devops',sub:'ci',req:'recommended',level:'int'},
{name:'Vercel',cat:'devops',sub:'paas',req:'recommended',level:'int'},
{name:'Railway',cat:'devops',sub:'paas',req:'recommended',level:'int'},
{name:'AWS',cat:'devops',sub:'iaas',req:'optional',level:'pro'},
{name:'Kubernetes',cat:'devops',sub:'k8s',req:'optional',level:'pro'},
{name:'Terraform',cat:'devops',sub:'iac',req:'optional',level:'pro'},
{name:'Nginx',cat:'devops',sub:'web',req:'optional',level:'pro'},
{name:S.lang==='ja'?'Linux基礎':'Linux Basics',cat:'devops',sub:'os',req:'recommended',level:'int'},
{name:'Cursor',cat:'ai',sub:'ide',req:'top1',level:'int',price:'$20'},
{name:'Claude Code',cat:'ai',sub:'cli',req:'recommended',level:'int',price:'$20〜$200'},
{name:'GitHub Copilot',cat:'ai',sub:'ext',req:'recommended',level:'beg',price:'$10〜$39'},
{name:'Windsurf',cat:'ai',sub:'ide',req:'optional',level:'int',price:'free-15'},
{name:'Gemini CLI',cat:'ai',sub:'cli',req:'optional',level:'int',price:'free'},
{name:'Cline / RooCode',cat:'ai',sub:'ext',req:'optional',level:'pro',price:'usage'},
{name:'Kiro',cat:'ai',sub:'ide',req:'optional',level:'int',price:'$20'},
{name:'Codex (OpenAI)',cat:'ai',sub:'cli',req:'optional',level:'pro',price:'$20'},
{name:'CLAUDE.md',cat:'ai',sub:'config',req:'recommended',level:'int'},
{name:'.cursor/rules',cat:'ai',sub:'config',req:'recommended',level:'int'},
{name:'AGENTS.md',cat:'ai',sub:'config',req:'recommended',level:'int'},
{name:'MCP',cat:'ai',sub:'protocol',req:'recommended',level:'int'},
{name:'Spec Kit',cat:'ai',sub:'sdd',req:'recommended',level:'int'},
{name:'Devin',cat:'ai_auto',sub:'autonomous',req:'optional',level:'pro',price:'$20〜$500'},
{name:'Replit Agent',cat:'ai_auto',sub:'browser',req:'optional',level:'beg',price:'$25'},
{name:'Claude Code Subagents',cat:'ai_auto',sub:'parallel',req:'optional',level:'pro'},
{name:'Claude Code Tasks',cat:'ai_auto',sub:'dag',req:'optional',level:'pro'},
{name:'Claude-Flow',cat:'ai_auto',sub:'orchestrator',req:'optional',level:'pro'},
{name:'Lovable',cat:'ai_auto',sub:'generator',req:'optional',level:'beg',price:'$25'},
{name:'Bolt.new',cat:'ai_auto',sub:'generator',req:'optional',level:'beg',price:'free-oss'},
{name:'v0 (Vercel)',cat:'ai_auto',sub:'ui-gen',req:'optional',level:'int',price:'$20'},
{name:'Codex App (OpenAI)',cat:'ai_auto',sub:'agentic',req:'optional',level:'pro',price:'$20'},
{name:'C#',cat:'lang',sub:'language',req:'optional',level:'dotnet',weeks:'6-12'},
{name:'PHP',cat:'lang',sub:'language',req:'optional',level:'wp',weeks:'4-8'},
{name:'Ruby',cat:'lang',sub:'language',req:'optional',level:'rails',weeks:'4-8'},
{name:'Markdown',cat:'lang',sub:'markup',req:'required',level:'all',weeks:'1d'},
{name:'JSON',cat:'lang',sub:'data',req:'required',level:'all',weeks:'1d'},
{name:'YAML',cat:'lang',sub:'config',req:'recommended',level:'int',weeks:'1d'},
{name:'Bootstrap',cat:'front',sub:'css-fw',req:'optional',level:'legacy'},
{name:'Radix UI',cat:'front',sub:'ui',req:'optional',level:'a11y'},
{name:'Framer Motion',cat:'front',sub:'animation',req:'optional',level:'pro'},
{name:'GSAP',cat:'front',sub:'animation',req:'optional',level:'pro'},
{name:'React Testing Library',cat:'front',sub:'test',req:'recommended',level:'int'},
{name:'Figma',cat:'front',sub:'design',req:'recommended',level:'int'},
{name:'Chrome DevTools',cat:'front',sub:'debug',req:'required',level:'all'},
{name:'React DevTools',cat:'front',sub:'debug',req:'required',level:'react'},
{name:'EAS Workflows',cat:'mobile',sub:'ci',req:'recommended',level:'pro'},
{name:'React Native Gesture Handler',cat:'mobile',sub:'gesture',req:'recommended',level:'int'},
{name:'Detox',cat:'mobile',sub:'e2e',req:'optional',level:'pro'},
{name:'React Native DevTools',cat:'mobile',sub:'debug',req:'required',level:'int'},
{name:'Hermes V1',cat:'mobile',sub:'engine',req:'required',level:'all'},
{name:'Expo Modules API',cat:'mobile',sub:'native',req:'optional',level:'pro'},
{name:'Config Plugins',cat:'mobile',sub:'native-config',req:'recommended',level:'int'},
{name:'Swift/Kotlin (Native)',cat:'mobile',sub:'native-dev',req:'optional',level:'pro'},
{name:'Expo Go',cat:'mobile',sub:'dev-tool',req:'recommended',level:'beg'},
{name:'Flask',cat:'back',sub:'fw',req:'optional',level:'py'},
{name:'Gin',cat:'back',sub:'fw',req:'optional',level:'go'},
{name:'SQLite',cat:'back',sub:'db',req:'optional',level:'embed'},
{name:'TypeORM',cat:'back',sub:'orm',req:'optional',level:'int'},
{name:'SQLAlchemy',cat:'back',sub:'orm',req:'recommended',level:'py'},
{name:'Passport.js',cat:'back',sub:'auth',req:'recommended',level:'int'},
{name:'bcrypt / argon2',cat:'back',sub:'crypto',req:'required',level:'int'},
{name:'Bull/BullMQ',cat:'back',sub:'queue',req:'optional',level:'int'},
{name:'Postman',cat:'back',sub:'api-test',req:'recommended',level:'int'},
{name:'Jest / Pytest',cat:'back',sub:'test',req:'recommended',level:'int'},
{name:'AWS Lambda',cat:'baas',sub:'serverless',req:'optional',level:'aws'},
{name:'AWS Amplify',cat:'baas',sub:'full',req:'optional',level:'aws'},
{name:'Convex',cat:'baas',sub:'reactive',req:'optional',level:'rt'},
{name:'Prismic',cat:'payment',sub:'cms',req:'optional',level:'int',price:'free-100'},
{name:'Hygraph',cat:'payment',sub:'cms',req:'optional',level:'pro',price:'free-399'},
{name:'Storyblok',cat:'payment',sub:'cms',req:'optional',level:'int',price:'free-105'},
{name:'Vendure',cat:'payment',sub:'ec',req:'optional',level:'pro',price:'free-oss'},
{name:'WooCommerce',cat:'payment',sub:'ec',req:'optional',level:'beg',price:'free'},
{name:'Fly.io',cat:'devops',sub:'paas',req:'optional',level:'int'},
{name:'Netlify',cat:'devops',sub:'paas',req:'optional',level:'static'},
{name:'GCP (Cloud Run)',cat:'devops',sub:'iaas',req:'optional',level:'pro'},
{name:'PM2',cat:'devops',sub:'process',req:'optional',level:'node'},
{name:'Prometheus',cat:'devops',sub:'monitor',req:'optional',level:'pro'},
{name:'Grafana',cat:'devops',sub:'viz',req:'optional',level:'pro'},
{name:'Let\'s Encrypt',cat:'devops',sub:'ssl',req:'recommended',level:'prod'},
{name:'Cloudflare',cat:'devops',sub:'cdn',req:'optional',level:'pro'},
{name:'Claude (Chat)',cat:'ai',sub:'chat',req:'recommended',level:'all',price:'$20'},
{name:'ChatGPT',cat:'ai',sub:'chat',req:'optional',level:'all',price:'$20'},
{name:'Gemini',cat:'ai',sub:'chat',req:'optional',level:'all',price:'free-20'},
{name:'skills.md',cat:'ai',sub:'config',req:'recommended',level:'int'},
{name:'Hooks',cat:'ai',sub:'automation',req:'optional',level:'pro'},
{name:'Conductor',cat:'ai',sub:'parallel',req:'optional',level:'pro'},
{name:'Vibe Kanban',cat:'ai',sub:'agent-mgmt',req:'optional',level:'pro'},
{name:'Context7',cat:'ai',sub:'mcp-server',req:'recommended',level:'int'},
{name:'Playwright MCP',cat:'ai',sub:'test-mcp',req:'recommended',level:'int'},
{name:'VS Code',cat:'ai',sub:'editor',req:'required',level:'all',price:'free'},
{name:'Zencoder/Zenflow',cat:'ai_auto',sub:'spec-agent',req:'optional',level:'pro',price:'paid'},
{name:'Kilo Code',cat:'ai_auto',sub:'precision',req:'optional',level:'pro',price:'paid'},
{name:'Continue.dev',cat:'ai_auto',sub:'oss',req:'optional',level:'int',price:'free'},
{name:'Claude Code Agent Teams',cat:'ai_auto',sub:'multi-agent',req:'optional',level:'pro'},
{name:'Claude Code Swarms',cat:'ai_auto',sub:'swarm',req:'optional',level:'pro'},
{name:'Claude Code Headless',cat:'ai_auto',sub:'ci-cd',req:'optional',level:'pro'},
{name:'Gas Town',cat:'ai_auto',sub:'k8s-agents',req:'optional',level:'pro'},
{name:'Multiclaude',cat:'ai_auto',sub:'team',req:'optional',level:'pro'},
{name:'CodeGPT',cat:'ai_auto',sub:'fullstack',req:'optional',level:'int',price:'paid'},
{name:'Manus',cat:'ai_auto',sub:'autonomous',req:'optional',level:'pro',price:'paid'},
{name:'Google Antigravity',cat:'ai',sub:'ide',req:'optional',level:'int',price:'free(preview)'},
{name:'OpenRouter',cat:'ai',sub:'router',req:'optional',level:'int',price:'pay-as-you-go'},
{name:'Augment Code',cat:'ai',sub:'ide',req:'optional',level:'pro',price:'$20〜$250'},
{name:'Aider',cat:'ai',sub:'cli',req:'optional',level:'int',price:'free-oss'},
{name:'Jules (Google)',cat:'ai_auto',sub:'async-agent',req:'optional',level:'int',price:'free'},
{name:'Amazon Q Developer',cat:'ai',sub:'ext',req:'optional',level:'int',price:'free-19'},
{name:'Gemini Code Assist',cat:'ai',sub:'ext',req:'optional',level:'int',price:'free-tier'},
{name:'JetBrains Junie',cat:'ai',sub:'ext',req:'optional',level:'int',price:'bundled'},
{name:'Tabnine',cat:'ai',sub:'ext',req:'optional',level:'int',price:'free-39'},
{name:'Qwen3-Coder',cat:'ai_auto',sub:'oss-model',req:'optional',level:'pro',price:'free-oss'},
{name:'DeepSeek V3.2',cat:'ai_auto',sub:'oss-model',req:'optional',level:'pro',price:'free-oss'},
{name:'TDD',cat:'method',sub:'methodology',req:'recommended',level:'int'},
{name:'BDD',cat:'method',sub:'methodology',req:'recommended',level:'int'},
{name:'DDD',cat:'method',sub:'methodology',req:'recommended',level:'pro'},
{name:'FDD',cat:'method',sub:'methodology',req:'optional',level:'int'},
{name:'MDD',cat:'method',sub:'methodology',req:'optional',level:'int'},
{name:'SDD',cat:'method',sub:'methodology',req:'recommended',level:'int'},
{name:'Clean Architecture',cat:'method',sub:'pattern',req:'recommended',level:'pro'},
{name:'Microservices',cat:'method',sub:'pattern',req:'optional',level:'pro'},
{name:'Monorepo (Turborepo)',cat:'method',sub:'structure',req:'optional',level:'pro'},
{name:'Conventional Commits',cat:'method',sub:'convention',req:'recommended',level:'int'},
{name:'Semantic Versioning',cat:'method',sub:'convention',req:'recommended',level:'int'},
{name:'Agile / Scrum',cat:'method',sub:'process',req:'recommended',level:'all'},
{name:'Cypress',cat:'test',sub:'e2e',req:'optional',level:'int'},
{name:'Testing Library',cat:'test',sub:'unit',req:'recommended',level:'int'},
{name:'MSW (Mock Service Worker)',cat:'test',sub:'mock',req:'recommended',level:'int'},
{name:'Faker.js',cat:'test',sub:'data',req:'optional',level:'int'},
{name:'Lighthouse CI',cat:'test',sub:'perf',req:'recommended',level:'int'},
{name:'Sentry',cat:'test',sub:'monitor',req:'recommended',level:'int',price:'free-26'},
{name:'SonarQube',cat:'test',sub:'quality',req:'optional',level:'pro'},
{name:'Codecov',cat:'test',sub:'coverage',req:'optional',level:'int'},
{name:'tRPC',cat:'api',sub:'typesafe',req:'optional',level:'int'},
{name:'Hono',cat:'api',sub:'edge-fw',req:'optional',level:'edge'},
{name:'Zod',cat:'api',sub:'validation',req:'recommended',level:'int'},
{name:'Axios',cat:'api',sub:'http',req:'optional',level:'int'},
{name:'WebSocket',cat:'api',sub:'realtime',req:'optional',level:'int'},
{name:'Server-Sent Events',cat:'api',sub:'realtime',req:'optional',level:'int'},
{name:'Turbopack',cat:'build',sub:'bundler',req:'optional',level:'next'},
{name:'esbuild',cat:'build',sub:'bundler',req:'optional',level:'pro'},
{name:'SWC',cat:'build',sub:'compiler',req:'recommended',level:'int'},
{name:'pnpm',cat:'build',sub:'pkgmgr',req:'recommended',level:'int'},
{name:'Turborepo',cat:'build',sub:'monorepo',req:'optional',level:'pro'},
{name:'Changesets',cat:'build',sub:'versioning',req:'optional',level:'pro'},
{name:'Drizzle Studio',cat:'data',sub:'gui',req:'optional',level:'int'},
{name:'Prisma Studio',cat:'data',sub:'gui',req:'recommended',level:'int'},
{name:'PostHog',cat:'data',sub:'analytics',req:'optional',level:'int',price:'free-tier'},
{name:'Plausible',cat:'data',sub:'analytics',req:'optional',level:'int',price:'$9〜'},
{name:'Vercel Analytics',cat:'data',sub:'analytics',req:'recommended',level:'int',price:'free-tier'},
{name:'OpenTelemetry',cat:'data',sub:'observability',req:'optional',level:'pro'},
{name:'Helmet.js',cat:'security',sub:'headers',req:'recommended',level:'int'},
{name:'CORS',cat:'security',sub:'policy',req:'required',level:'int'},
{name:'CSP',cat:'security',sub:'policy',req:'recommended',level:'int'},
{name:'rate-limiter-flexible',cat:'security',sub:'ratelimit',req:'recommended',level:'int'},
{name:'npm audit',cat:'security',sub:'deps',req:'required',level:'all'},
{name:'Snyk',cat:'security',sub:'scanning',req:'optional',level:'pro',price:'free-tier'},
];
const _TECH_COUNT=TECH_DB.length;
const HELP_DATA={
  purpose:{
    ja:{title:'プロジェクトの目的',desc:'「誰が・何を・なぜ」使うのかを1文で表現しましょう。',example:'例: "フリーランスが見積書を5分で作成できるSaaS"'},
    en:{title:'Project Purpose',desc:'Express "who uses what and why" in one sentence.',example:'e.g. "A SaaS where freelancers create invoices in 5 min"'}
  },
  target:{
    ja:{title:'ターゲットユーザー',desc:'具体的なペルソナを2〜3人イメージすると設計がブレません。',example:'例: "30代エンジニア、副業で受注管理に困っている"'},
    en:{title:'Target Users',desc:'Imagine 2-3 specific personas to keep your design focused.',example:'e.g. "30s engineer struggling with freelance order management"'}
  },
  success:{
    ja:{title:'成功指標（KPI）',desc:'プロジェクト種別に応じた指標を自動提案。📈成長 💰収益 🔄継続 😊満足 ⚡技術 の10カテゴリから3〜5つ選択。',example:'例: EC→"GMV月100万" / 教育→"完了率80%+"'},
    en:{title:'Success Metrics (KPI)',desc:'Auto-suggested by project type. Pick 3-5 from 10 categories: 📈Growth 💰Revenue 🔄Retention 😊Satisfaction ⚡Perf.',example:'e.g. EC→"$10K GMV" / Education→"80%+ completion"'}
  },
  scope_out:{
    ja:{title:'スコープ外',desc:'「やらないこと」を決めるのがMVP成功の鍵。',example:'例: "v1ではモバイルアプリは作らない"'},
    en:{title:'Out of Scope',desc:'Deciding what NOT to do is key to MVP success.',example:'e.g. "No mobile app in v1"'}
  },
  deadline:{
    ja:{title:'リリース目標',desc:'2週間=超MVP、1ヶ月=基本MVP、3ヶ月=本格版。',example:'TIP: 2週間でまずデプロイ、その後改善サイクルが最速'},
    en:{title:'Release Target',desc:'2 weeks = ultra MVP, 1 month = basic MVP, 3 months = full version.',example:'TIP: Deploy in 2 weeks first, then iterate fast'}
  },
  frontend:{
    ja:{title:'フロントエンド',desc:'既に知っている技術を選ぶのが最速。',example:'初心者→React、SSR→Next.js',link:'https://stateofjs.com'},
    en:{title:'Frontend',desc:'Choosing a tech you already know is fastest.',example:'Beginner→React, SSR→Next.js',link:'https://stateofjs.com'}
  },
  backend:{
    ja:{title:'バックエンド/DB',desc:'BaaS(Firebase/Supabase)はサーバーコード不要で最速。',example:'静的サイト→なし、認証あり→Firebase/Supabase'},
    en:{title:'Backend/DB',desc:'BaaS (Firebase/Supabase) needs no server code — fastest path.',example:'Static→None, Auth needed→Firebase/Supabase'}
  },
  ai_tools:{
    ja:{title:'AIツール',desc:'Cursor/Antigravity=AI IDE、Claude Code/Aider=CLI、Copilot/Tabnine=補完拡張、OpenRouter=API統合ハブ。',example:'推奨: Cursor or Antigravity + Claude Code'},
    en:{title:'AI Tools',desc:'Cursor/Antigravity=AI IDE, Claude Code/Aider=CLI, Copilot/Tabnine=completion ext, OpenRouter=API hub.',example:'Recommended: Cursor or Antigravity + Claude Code'}
  },
  deploy:{
    ja:{title:'デプロイ先',desc:'Vercel/Netlify=無料枠で十分。',example:'Next.js→Vercel、静的→Netlify'},
    en:{title:'Deployment',desc:'Vercel/Netlify free tier is enough to start.',example:'Next.js→Vercel, Static→Netlify'}
  },
  dev_methods:{
    ja:{title:'駆動開発手法',desc:'TDD=テスト先行、BDD=振る舞い設計、DDD=ドメインモデル中心。',example:'推奨: TDD（必須）+ BDD'},
    en:{title:'Dev Methodologies',desc:'TDD=test-first, BDD=behavior-driven, DDD=domain-model-centric.',example:'Recommended: TDD (essential) + BDD'}
  },
  mvp_features:{
    ja:{title:'MVP機能',desc:'3〜5個に絞る。「これがないと使えない」機能だけ選択。',example:'最小: 認証 + メイン機能1つ + 設定'},
    en:{title:'MVP Features',desc:'Narrow to 3-5. Only pick features users cannot live without.',example:'Minimum: Auth + 1 core feature + Settings'}
  },
  future_features:{
    ja:{title:'将来追加機能',desc:'Phase 2, 3として計画。MVPリリース後に再評価。',example:'課金→PMF確認後、モバイル→DAU 1000+時'},
    en:{title:'Future Features',desc:'Plan as Phase 2-3. Re-evaluate after MVP launch.',example:'Billing→after PMF, Mobile→at DAU 1000+'}
  },
  data_entities:{
    ja:{title:'データテーブル',desc:'英語・単数形・PascalCaseが標準。',example:'User, Post, Comment（Usersではなく単数形）'},
    en:{title:'Data Tables',desc:'English, singular, PascalCase is standard.',example:'User, Post, Comment (singular, not Users)'}
  },
  auth:{
    ja:{title:'認証方式',desc:'OAuth(Google/GitHub)は実装簡単でUX向上。',example:'最小: メール/PW + Google OAuth'},
    en:{title:'Authentication',desc:'OAuth (Google/GitHub) is easy to implement and improves UX.',example:'Minimum: Email/PW + Google OAuth'}
  },
  screens:{
    ja:{title:'主要画面',desc:'ユーザーフローに沿って画面を洗い出し。',example:'LP → ログイン → ダッシュボード → 詳細'},
    en:{title:'Key Screens',desc:'Map out screens following the user flow.',example:'LP → Login → Dashboard → Detail'}
  },
  payment:{
    ja:{title:'決済・CMS・EC',desc:'Stripe=最も導入しやすい。MoR=税務処理代行。',example:'SaaS→Stripe、グローバル→Paddle'},
    en:{title:'Payment/CMS/EC',desc:'Stripe is easiest to integrate. MoR = Merchant of Record (handles tax).',example:'SaaS→Stripe, Global→Paddle'}
  },
  css_fw:{
    ja:{title:'CSSフレームワーク',desc:'Tailwind CSSが2026年の事実上の標準。ユーティリティファーストで高速開発。',example:'推奨: Tailwind CSS + shadcn/ui'},
    en:{title:'CSS Framework',desc:'Tailwind CSS is the de facto standard in 2026. Utility-first for rapid dev.',example:'Recommended: Tailwind CSS + shadcn/ui'}
  },
  orm:{
    ja:{title:'ORM',desc:'ORMはデータベース操作を型安全に行うためのツール。BaaS使用時は不要。',example:'推奨: Prisma (型安全・Studio付き)'},
    en:{title:'ORM',desc:'ORM enables type-safe database operations. Not needed with BaaS.',example:'Recommended: Prisma (type-safe, Studio included)'}
  },
  learning_path:{
    ja:{title:'学習パターン',desc:'技術スタックの組み合わせに基づいた学習パスを選択。',example:'初心者→BaaS、中級→PERN、上級→AI Orchestrator'},
    en:{title:'Learning Path',desc:'Choose a learning path based on your tech stack combination.',example:'Beginner→BaaS, Intermediate→PERN, Advanced→AI Orchestrator'}
  },
  skill_level:{
    ja:{title:'スキルレベル',desc:'選択により質問の選択肢が動的に変化します。Beginner=基本選択肢のみ、Intermediate=中級選択肢追加、Pro=全選択肢解放。途中変更は非推奨。',example:'迷ったらIntermediate。後から選択肢が足りなければProに変更可能'},
    en:{title:'Skill Level',desc:'Your choice dynamically adjusts available options. Beginner=basic options only, Intermediate=adds mid-level options, Pro=unlocks all. Avoid changing mid-project.',example:'If unsure, pick Intermediate. You can switch to Pro later if needed'}
  },
  database:{
    ja:{title:'データベース',desc:'PostgreSQL=本格的なRDB（Supabase/Neonで無料運用可）、SQLite=ローカル/組込み用途、MongoDB=NoSQL柔軟なスキーマ。BaaS選択時はBaaS側のDBが使われるため不要。',example:'迷ったらPostgreSQL + Prisma。Supabaseなら無料で本番運用可能'},
    en:{title:'Database',desc:'PostgreSQL=production RDB (free via Supabase/Neon), SQLite=local/embedded, MongoDB=NoSQL flexible schema. Not needed if using BaaS (BaaS provides its own DB).',example:'Default: PostgreSQL + Prisma. Supabase offers free production hosting'}
  },
  mobile:{
    ja:{title:'モバイル対応',desc:'PWA=Webベースでインストール不要、Expo=React Native簡易構築（EAS Build対応）、React Native=ネイティブ制御が必要な場合。モバイル不要なら「なし」でOK。',example:'まずPWAで検証、ストア配信が必要になったらExpoに移行が最速ルート'},
    en:{title:'Mobile Support',desc:'PWA=web-based no install needed, Expo=simplified React Native (EAS Build), React Native=when native control needed. Select "None" if mobile is not required.',example:'Start with PWA for validation, migrate to Expo when store distribution is needed'}
  },
  ai_auto:{
    ja:{title:'AI自律開発レベル',desc:'Vibe Coding=AIにざっくり指示してコード生成、Agentic Dev=Cursor Agent/Cline等がマルチファイル自動編集、Multi-Agent=複数Agentが並列作業、Full Autonomous=Claude Code Subagents/Jules等で非同期自律開発。',example:'初心者→Vibe Coding、中級→Agentic Dev、上級→Multi-Agent以上'},
    en:{title:'AI Autonomous Level',desc:'Vibe Coding=rough instructions to AI, Agentic Dev=Cursor Agent/Cline multi-file editing, Multi-Agent=parallel agent work, Full Autonomous=Claude Code Subagents/Jules async development.',example:'Beginner→Vibe Coding, Intermediate→Agentic Dev, Advanced→Multi-Agent+'}
  },
  learning_goal:{
    ja:{title:'学習目標',desc:'このプロジェクトで習得したい技術領域を選択。選択に応じてロードマップの学習パスが最適化されます。',example:'「フルスタック開発」を選ぶとフロントからデプロイまで網羅的なパスが生成されます'},
    en:{title:'Learning Goal',desc:'Select the technical area you want to master through this project. The roadmap learning path optimizes based on your selection.',example:'Choosing "Full-Stack Dev" generates a comprehensive path from frontend to deployment'}
  },
};
const COMPAT_RULES=[
  {id:'fe-mob-expo',p:['frontend','mobile'],lv:'error',
   t:a=>inc(a.mobile,'Expo')&&!inc(a.frontend,'React'),
   ja:'ExpoはReact Native専用です。フロントをReact系に変更してください',
   en:'Expo requires React. Change frontend to a React-based option',
   fix:{f:'frontend',s:'React + Next.js'}},
  {id:'fe-mob-astro',p:['frontend','mobile'],lv:'error',
   t:a=>inc(a.frontend,'Astro')&&inc(a.mobile,'Expo'),
   ja:'AstroはSSG専用でExpoと併用できません。React + Next.jsを推奨',
   en:'Astro is SSG-only and incompatible with Expo. Use React + Next.js',
   fix:{f:'frontend',s:'React + Next.js'}},
  {id:'be-orm-py-prisma',p:['backend','orm'],lv:'error',
   t:a=>isPyBE(a)&&inc(a.orm,'Prisma')||isPyBE(a)&&inc(a.orm,'Drizzle')||isPyBE(a)&&inc(a.orm,'TypeORM'),
   ja:'Prisma/Drizzle/TypeORMはNode.js専用です。SQLAlchemyを選択してください',
   en:'Prisma/Drizzle/TypeORM are Node.js-only. Choose SQLAlchemy',
   fix:{f:'orm',s:'SQLAlchemy (Python)'}},
  {id:'be-orm-java-prisma',p:['backend','orm'],lv:'error',
   t:a=>(inc(a.backend,'Java')||inc(a.backend,'Go'))&&(inc(a.orm,'Prisma')||inc(a.orm,'Drizzle')),
   ja:'Prisma/DrizzleはNode.js/TypeScript専用です',
   en:'Prisma/Drizzle are Node.js/TypeScript-only',
   fix:{f:'orm',s:'None / Using BaaS'}},
  {id:'be-orm-node-sqla',p:['backend','orm'],lv:'error',
   t:a=>isNodeBE(a)&&inc(a.orm,'SQLAlchemy'),
   ja:'SQLAlchemyはPython専用です。Prisma/Drizzleを選択してください',
   en:'SQLAlchemy is Python-only. Choose Prisma or Drizzle',
   fix:{f:'orm',s:'Prisma'}},
  {id:'be-db-fb-notfs',p:['backend','database'],lv:'warn',
   t:a=>inc(a.backend,'Firebase')&&a.database&&!inc(a.database,'Firestore'),
   ja:'Firebase利用時はFirestoreが最適です',
   en:'Firestore is the optimal DB for Firebase'},
  {id:'be-db-supa-notpg',p:['backend','database'],lv:'warn',
   t:a=>inc(a.backend,'Supabase')&&a.database&&!inc(a.database,'Supabase')&&!inc(a.database,'PostgreSQL')&&!inc(a.database,'Neon'),
   ja:'Supabase利用時はSupabase (PostgreSQL)が統合されています',
   en:'Supabase integrates best with Supabase (PostgreSQL)'},
  {id:'be-db-static-db',p:['backend','database'],lv:'warn',
   t:a=>isStaticBE(a)&&a.database&&!inc(a.database,'なし')&&a.database!=='None',
   ja:'静的サイトではDBは通常不要です',
   en:'Static sites typically do not need a database'},
  {id:'be-db-py-fs',p:['backend','database'],lv:'warn',
   t:a=>isPyBE(a)&&inc(a.database,'Firestore'),
   ja:'PythonとFirestoreの相性は中程度。PostgreSQLが推奨です',
   en:'Python + Firestore compatibility is moderate. PostgreSQL recommended'},
  {id:'be-dep-java-vercel',p:['backend','deploy'],lv:'warn',
   t:a=>(inc(a.backend,'Java')||inc(a.backend,'Go'))&&inc(a.deploy,'Vercel'),
   ja:'VercelはNode.js/Python前提です。Railway/AWS/Dockerが必要',
   en:'Vercel supports Node.js/Python. Use Railway/AWS/Docker for Java/Go',
   fix:{f:'deploy',s:'Railway'}},
  {id:'be-dep-fb-notfbh',p:['backend','deploy'],lv:'warn',
   t:a=>inc(a.backend,'Firebase')&&a.deploy&&!inc(a.deploy,'Firebase'),
   ja:'Firebase利用時はFirebase Hostingが最適です',
   en:'Firebase Hosting is optimal when using Firebase backend'},
  {id:'be-dep-supa-fbh',p:['backend','deploy'],lv:'warn',
   t:a=>inc(a.backend,'Supabase')&&inc(a.deploy,'Firebase'),
   ja:'SupabaseにはVercelまたはSupabase Hostingが推奨です',
   en:'Use Vercel or Supabase Hosting with Supabase backend'},
  {id:'be-dep-nest-vercel',p:['backend','deploy'],lv:'warn',
   t:a=>inc(a.backend,'NestJS')&&inc(a.deploy,'Vercel'),
   ja:'NestJSのサーバーレスデプロイは制限があります。Railwayが推奨',
   en:'NestJS serverless deploys have limitations. Railway recommended',
   fix:{f:'deploy',s:'Railway'}},
  {id:'be-dep-django-vercel',p:['backend','deploy'],lv:'warn',
   t:a=>inc(a.backend,'Django')&&inc(a.deploy,'Vercel'),
   ja:'DjangoのVercelデプロイは制限あり。Railway/Fly.ioが推奨',
   en:'Django on Vercel has limitations. Railway/Fly.io recommended',
   fix:{f:'deploy',s:'Railway'}},
  {id:'fe-dep-angular-vercel',p:['frontend','deploy'],lv:'warn',
   t:a=>inc(a.frontend,'Angular')&&inc(a.deploy,'Vercel'),
   ja:'AngularのVercel対応は限定的。Firebase HostingまたはAWSが推奨',
   en:'Angular on Vercel is limited. Use Firebase Hosting or AWS'},
  {id:'fe-dep-nuxt-fbh',p:['frontend','deploy'],lv:'warn',
   t:a=>inc(a.frontend,'Nuxt')&&inc(a.deploy,'Firebase'),
   ja:'Nuxt 3はVercel/Netlifyが最適デプロイ先です',
   en:'Nuxt 3 deploys best on Vercel or Netlify'},
  {id:'ai-sk-auto-beg',p:['ai_auto','skill_level'],lv:'warn',
   t:a=>inc(a.ai_auto,'自律')||inc(a.ai_auto,'Autonomous'),
   ja:'フル自律開発には上級スキルが必要です。段階的に進めましょう',
   en:'Full autonomous dev requires advanced skills. Progress gradually',
   cond:a=>a.skill_level==='Beginner'},
  {id:'ai-sk-orch-notpro',p:['ai_auto','skill_level'],lv:'warn',
   t:a=>(inc(a.ai_auto,'オーケストレーター')||inc(a.ai_auto,'Orchestrator'))&&a.skill_level!=='Professional',
   ja:'オーケストレーターはCI/CD統合の経験が必要です',
   en:'Orchestrator requires CI/CD integration experience'},
  {id:'ai-sk-multi-beg',p:['ai_auto','skill_level'],lv:'warn',
   t:a=>(inc(a.ai_auto,'マルチ')||inc(a.ai_auto,'Multi'))&&a.skill_level==='Beginner',
   ja:'マルチAgent協調は中級以上の経験が推奨です',
   en:'Multi-Agent coordination recommended for intermediate+'},
  {id:'be-pay-static-stripe',p:['backend','payment'],lv:'warn',
   t:a=>isStaticBE(a)&&a.payment&&(inc(a.payment,'Stripe')),
   ja:'Stripe webhookにはサーバーが必要。Supabase Edge Functionsで対応可能',
   en:'Stripe webhooks need a server. Supabase Edge Functions can help'},
  {id:'be-pay-saleor-notpy',p:['backend','payment'],lv:'warn',
   t:a=>a.payment&&inc(a.payment,'Saleor')&&!isPyBE(a),
   ja:'SaleorはPython/Django製です。Python系バックエンドが必要',
   en:'Saleor is built with Python/Django. Python backend required',
   fix:{f:'backend',s:'Python + Django'}},
  {id:'ai-antigravity-windsurf',p:['ai_tools'],lv:'warn',
   t:a=>inc(a.ai_tools,'Antigravity')&&inc(a.ai_tools,'Windsurf'),
   ja:'AntigravityはWindsurf統合版です。どちらか一方で十分です',
   en:'Antigravity integrates Windsurf. One is sufficient',
   fix:{f:'ai_tools',s:'Google Antigravity'}},
  {id:'ai-openrouter-hub',p:['ai_tools'],lv:'info',
   t:a=>inc(a.ai_tools,'OpenRouter'),
   ja:'OpenRouterはBYOKハブです。Aider/Cline等のAPIバックエンドとして活用できます',
   en:'OpenRouter is a BYOK hub. Use as API backend for Aider/Cline etc.'},
  {id:'sem-scope-mobile',p:['scope_out','mobile'],lv:'error',
   t:a=>(inc(a.scope_out,'ネイティブ')||inc(a.scope_out,'native')||inc(a.scope_out,'Native'))&&a.mobile&&a.mobile!=='none'&&!inc(a.mobile,'PWA'),
   ja:'スコープ外に「ネイティブアプリ」がありますが、モバイル対応が有効です。生成文書が矛盾します — どちらかを修正してください',
   en:'Scope excludes "native apps" but mobile support is enabled. Generated docs will conflict — fix one or the other'},
  {id:'sem-scope-payment',p:['scope_out','payment'],lv:'warn',
   t:a=>(inc(a.scope_out,'決済')||inc(a.scope_out,'EC')||inc(a.scope_out,'payment')||inc(a.scope_out,'Payment'))&&a.payment&&!inc(a.payment,'なし')&&!inc(a.payment,'None')&&a.payment!=='none',
   ja:'スコープ外に「決済/EC」がありますが、決済方式が選択されています。仕様書のスコープ定義に矛盾が生じます',
   en:'Scope excludes "payment/EC" but a payment method is selected. Spec scope definition will conflict'},
  {id:'sem-scope-entities',p:['scope_out','data_entities'],lv:'warn',
   t:a=>(inc(a.scope_out,'EC')||inc(a.scope_out,'commerce')||inc(a.scope_out,'Commerce'))&&(inc(a.data_entities,'Product')||inc(a.data_entities,'Order')||inc(a.data_entities,'Cart')),
   ja:'スコープ外に「EC」がありますが、エンティティにProduct/Orderが含まれています。ERとスコープが矛盾します',
   en:'Scope excludes "EC" but entities include Product/Order. ER and scope will conflict'},
  {id:'sem-deploy-express',p:['deploy','backend'],lv:'warn',
   t:a=>inc(a.deploy,'Vercel')&&(inc(a.backend,'Express')||inc(a.backend,'Fastify'))&&!inc(a.frontend,'Next.js'),
   ja:'VercelでExpress/Fastifyを動かすにはServerless Functionsに変換が必要です。Next.js API RoutesまたはRailway/Renderへの分離を検討してください',
   en:'Running Express/Fastify on Vercel requires Serverless Functions. Consider Next.js API Routes or split to Railway/Render',
   fix:{f:'deploy',s:'Railway'}},
  {id:'sem-auth-supa-nextauth',p:['auth','backend'],lv:'warn',
   t:a=>inc(a.backend,'Supabase')&&(inc(a.auth,'NextAuth')||inc(a.auth,'Auth.js')),
   ja:'Supabase利用時はSupabase Authが統合されています。NextAuth/Auth.jsとの併用は認証SoTが二重化します',
   en:'Supabase includes built-in Auth. Using NextAuth/Auth.js creates dual auth sources of truth',
   fix:{f:'auth',s:'Supabase Auth'}},
  {id:'sem-auth-nosupa-supaauth',p:['auth','backend'],lv:'warn',
   t:a=>!inc(a.backend,'Supabase')&&inc(a.auth,'Supabase Auth'),
   ja:'Supabase Authが選択されていますが、バックエンドがSupabaseではありません。認証の接続先が不明確になります',
   en:'Supabase Auth selected but backend is not Supabase. Auth connection target will be unclear',
   fix:{f:'backend',s:'Supabase'}},
  {id:'sem-purpose-entities',p:['purpose','data_entities'],lv:'info',
   t:a=>(inc(a.purpose,'教育')||inc(a.purpose,'学習')||inc(a.purpose,'Education')||inc(a.purpose,'Learning')||inc(a.purpose,'LMS'))&&(inc(a.data_entities,'Product')||inc(a.data_entities,'Order')),
   ja:'教育・学習系のプロジェクトにProduct/Orderエンティティがあります。教材販売が目的でなければCourse/Lessonへの変更を検討してください',
   en:'Education project has Product/Order entities. Consider Course/Lesson unless this is for course sales'},
  {id:'sem-deploy-bff',p:['deploy','backend','frontend'],lv:'info',
   t:a=>inc(a.deploy,'Vercel')&&inc(a.backend,'Express')&&inc(a.frontend,'Next.js'),
   ja:'Next.js + Express + Vercelの構成です。ExpressをNext.js API Routesに統合するか、Expressを別ホスト（Railway等）にする設計判断が必要です。生成文書ではAPI Routes統合を前提とします',
   en:'Next.js + Express + Vercel stack detected. Decide whether to merge Express into Next.js API Routes or host Express separately. Generated docs will assume API Routes integration'},
];
function inc(v,k){return v&&typeof v==='string'&&v.indexOf(k)!==-1;}
function isPyBE(a){return inc(a.backend,'Python')||inc(a.backend,'FastAPI')||inc(a.backend,'Django');}
function isNodeBE(a){return inc(a.backend,'Express')||inc(a.backend,'Fastify')||inc(a.backend,'NestJS')||inc(a.backend,'Hono');}
function isStaticBE(a){return inc(a.backend,'なし')||inc(a.backend,'None')||inc(a.backend,'static');}
function checkCompat(answers){
  if(!answers)return[];
  return COMPAT_RULES.filter(r=>{
    try{
      if(r.cond&&!r.cond(answers))return false;
      const keys=r.p;
      if(keys.some(k=>!answers[k]))return false;
      return r.t(answers);
    }catch(e){return false;}
  }).map(r=>({id:r.id,pair:r.p,level:r.lv,msg:S.lang==='ja'?r.ja:r.en,fix:r.fix||null}));
}
const RESOURCES={
  
  html:{n:'MDN Web Docs',u:'https://developer.mozilla.org/ja/docs/Web'},
  tailwind:{n:'Tailwind Docs',u:'https://tailwindcss.com/docs'},
  js:{n:'javascript.info',u:'https://ja.javascript.info/'},
  
  react:{n:'React Docs',u:'https://react.dev/learn'},
  nextjs:{n:'Next.js Docs',u:'https://nextjs.org/docs'},
  vue:{n:'Vue.js Guide',u:'https://ja.vuejs.org/guide/introduction'},
  svelte:{n:'Svelte Tutorial',u:'https://svelte.dev/tutorial'},
  astro:{n:'Astro Docs',u:'https://docs.astro.build'},
  angular:{n:'Angular Docs',u:'https://angular.dev/overview'},
  remix:{n:'Remix Docs',u:'https://remix.run/docs/en/main'},
  
  shadcn:{n:'shadcn/ui',u:'https://ui.shadcn.com/docs'},
  
  zustand:{n:'Zustand',u:'https://zustand-demo.pmnd.rs/'},
  rquery:{n:'TanStack Query',u:'https://tanstack.com/query/latest'},
  
  vitest:{n:'Vitest',u:'https://vitest.dev/guide/'},
  
  node:{n:'Node.js Docs',u:'https://nodejs.org/docs/latest/api/'},
  express:{n:'Express.js',u:'https://expressjs.com/'},
  fastify:{n:'Fastify',u:'https://fastify.dev/docs/latest/'},
  nestjs:{n:'NestJS',u:'https://docs.nestjs.com/'},
  fastapi:{n:'FastAPI',u:'https://fastapi.tiangolo.com/'},
  django:{n:'Django',u:'https://docs.djangoproject.com/'},
  spring:{n:'Spring Boot',u:'https://spring.io/guides'},
  go:{n:'Go Gin',u:'https://gin-gonic.com/docs/'},
  hono:{n:'Hono',u:'https://hono.dev/docs/'},
  
  prisma:{n:'Prisma Docs',u:'https://www.prisma.io/docs'},
  drizzle:{n:'Drizzle ORM',u:'https://orm.drizzle.team/docs/overview'},
  typeorm:{n:'TypeORM',u:'https://typeorm.io/'},
  sqlalchemy:{n:'SQLAlchemy',u:'https://docs.sqlalchemy.org/'},
  kysely:{n:'Kysely',u:'https://kysely.dev/docs/intro'},
  
  firebase:{n:'Firebase Docs',u:'https://firebase.google.com/docs'},
  supabase:{n:'Supabase Docs',u:'https://supabase.com/docs'},
  postgres:{n:'PostgreSQL Docs',u:'https://www.postgresql.org/docs/'},
  mongo:{n:'MongoDB Manual',u:'https://www.mongodb.com/docs/manual/'},
  mysql:{n:'MySQL Docs',u:'https://dev.mysql.com/doc/'},
  redis:{n:'Redis Docs',u:'https://redis.io/docs/'},
  neon:{n:'Neon Docs',u:'https://neon.tech/docs'},
  
  nextauth:{n:'Auth.js',u:'https://authjs.dev/'},
  clerk:{n:'Clerk Docs',u:'https://clerk.com/docs'},
  
  expo:{n:'Expo Docs',u:'https://docs.expo.dev/'},
  flutter:{n:'Flutter Docs',u:'https://docs.flutter.dev/'},
  rn:{n:'React Native',u:'https://reactnative.dev/docs/getting-started'},
  
  docker:{n:'Docker Docs',u:'https://docs.docker.com/'},
  ghactions:{n:'GitHub Actions',u:'https://docs.github.com/actions'},
  
  vercel:{n:'Vercel Docs',u:'https://vercel.com/docs'},
  cloudflare:{n:'CF Pages',u:'https://developers.cloudflare.com/pages/'},
  railway:{n:'Railway Docs',u:'https://docs.railway.com/'},
  
  cursor:{n:'Cursor Docs',u:'https://docs.cursor.com/'},
  claudecode:{n:'Claude Code',u:'https://docs.anthropic.com/en/docs/claude-code'},
  mcp:{n:'MCP Spec',u:'https://modelcontextprotocol.io/'},
  copilot:{n:'GitHub Copilot',u:'https://docs.github.com/copilot'},
  windsurf:{n:'Windsurf Docs',u:'https://docs.windsurf.com/'},
  antigravity:{n:'Google Antigravity',u:'https://antigravity.google/'},
  openrouter:{n:'OpenRouter Docs',u:'https://openrouter.ai/docs'},
  augment:{n:'Augment Code',u:'https://www.augmentcode.com/'},
  aider:{n:'Aider Docs',u:'https://aider.chat/docs/'},
  jules:{n:'Jules (Google)',u:'https://jules.google/'},
  amazonq:{n:'Amazon Q Developer',u:'https://aws.amazon.com/q/developer/'},
  geminiassist:{n:'Gemini Code Assist',u:'https://cloud.google.com/gemini/docs/codeassist/overview'},
  junie:{n:'JetBrains Junie',u:'https://www.jetbrains.com/junie/'},
  tabnine:{n:'Tabnine',u:'https://www.tabnine.com/'},
  
  stripe:{n:'Stripe Docs',u:'https://docs.stripe.com/'},
  paddle:{n:'Paddle Docs',u:'https://developer.paddle.com/'},
  
  tdd:{n:'TDD Guide',u:'https://martinfowler.com/bliki/TestDrivenDevelopment.html'},
  bdd:{n:'BDD Intro',u:'https://cucumber.io/docs/bdd/'},
  ddd:{n:'DDD Reference',u:'https://www.domainlanguage.com/ddd/reference/'},
  sdd:{n:'SDD Overview',u:'https://en.wikipedia.org/wiki/Specification-driven_development'},
  fdd:{n:'FDD Guide',u:'https://en.wikipedia.org/wiki/Feature-driven_development'},
};
const GT=(()=>{
const ja={
  none:'なし',
  
  lp_title:'学習ロードマップ',lp_skill:'スキルレベル',lp_target:'目標期間',
  l1:'Web基盤',l2:'フロントエンド',l3:'バックエンド',l3m:'モバイル',
  l4:'DevOps',l5:'AI駆動開発',l6:'収益化',l7:'駆動開発手法',l7span:'全期間',
  html5b:'HTML5 基礎（2-4週）',css3b:'CSS3 基礎（3-6週）',jsb:'JavaScript ES6+（4-12週）',
  tsAdv:'TypeScript deep dive',cssAdv:'最新CSS (Container Queries, :has())',
  setup:'セットアップ・基礎',stMgmt:'状態管理',dataFetch:'データフェッチ',
  testing:'テスト',dbDesign:'データベース設計',auth:'認証・認可',
  mobEnv:'環境構築',mobNav:'ナビゲーション・画面設計',
  mobNative:'ネイティブ機能（カメラ/通知）',mobStore:'ストアビルド・提出',
  deploy:'デプロイ',monitor:'モニタリング基盤',aiUse:'活用',
  mcpCfg:'MCP設定・活用',aiOpt:'AI Agent Rules 最適化',practice:'実践',
  billing:'課金フロー実装',opsScale:'運用・スケール',
  
  ts_title:'技術スタックガイド',ts_selected:'選択された技術スタック',
  cat:'カテゴリ',tech:'技術',rationale:'理由',
  feLabel:'フロントエンド',beLabel:'バックエンド',dbLabel:'データベース',
  deployLabel:'デプロイ',mobileLabel:'モバイル',payLabel:'決済/CMS',
  nextR:'SSR/SSG対応、SEO最適化',vueR:'学習コスト低、柔軟性',feGenR:'高性能、エコシステム充実',
  supaR:'BaaS型、高速MVP開発',expR:'軽量、学習コスト低',nestR:'エンタープライズ対応、DI',beGenR:'スケーラブル',
  pgR:'ACID準拠、JSON対応、Supabase互換',dbGenR:'柔軟なスキーマ',
  vercelR:'Next.js最適化、自動デプロイ',deployGenR:'高い柔軟性',
  expoR:'React知識転用、OTA更新',mobGenR:'クロスプラットフォーム対応',
  payR:'SaaS/EC収益化基盤',
  ts_deps:'技術間の関連性',ts_versions:'推奨バージョン',
  
  mob_title:'モバイル開発ガイド',mob_env:'環境構築',mob_dir:'ディレクトリ構造',
  mob_home:'ホーム画面',mob_explore:'探索画面',mob_profile:'プロフィール',
  mob_root:'ルートレイアウト',mob_eas:'設定',mob_libs:'推奨ライブラリ',
  mob_anim:'アニメーション',mob_list:'高速リスト',mob_img:'画像最適化',
  mob_none:'現在のプロジェクトではモバイル開発は対象外です。\n将来的にExpo (React Native)での対応を推奨します。',
  
  tool_title:'開発ツールセットアップガイド',tool_essential:'必須ツール',
  tool_rec:'推奨',tool_pkgmgr:'パッケージマネージャー',tool_init:'プロジェクト初期化',
  tool_docker:'データベース (Docker使用)',tool_ai:'AIコーディングツール',
  tool_ext:'拡張機能',tool_used:'使用時',tool_vsInst:'VS Code拡張からインストール',
  tool_official:'公式サイトからインストール',tool_env:'環境変数テンプレート',
  
  res_title:'学習リソース集',res_official:'公式ドキュメント',
  res_ai:'AI駆動開発',res_bp:'ベストプラクティス',res_docs:'ドキュメント',
  res_proto:'プロトコル',res_patterns:'パターン',
  res_books:'推奨書籍・コース',res_fullstack:'フルスタックWeb開発入門',
  res_tsPractice:'TypeScript実践ガイド',res_design:'で学ぶ設計原則',
  res_saas:'SaaS開発とStripe決済実装',res_headless:'ヘッドレスアーキテクチャ入門',
  res_beg:'初心者向け',res_int:'中級者向け',
  
  ms_title:'マイルストーン計画',ms_target:'目標期間',
  ms_m:['環境構築・基礎','コア機能実装','UI/UX・テスト','デプロイ・CI/CD','最適化・モニタリング','本番運用・改善','スケール・次フェーズ'],
  ms_criteria:'マイルストーン達成基準を定義',ms_review:'週次レビュー実施',ms_retro:'振り返り・改善',
  
  aiw_title:'AI駆動開発ワークフローガイド',aiw_flow:'AI開発フロー',
  aiw_s1:'.spec/ を読む',aiw_s2:'タスク選択',aiw_s3:'AI実装',aiw_s4:'レビュー',aiw_s5:'テスト',aiw_s6:'コミット',
  aiw_select:'AIツール使い分け',aiw_task:'タスク',aiw_rec:'推奨ツール',
  aiw_newfile:'新規ファイル作成',aiw_bugfix:'バグ修正',aiw_testgen:'テスト生成',aiw_refactor:'リファクタリング',
  aiw_ctx:'コンテキスト理解',aiw_term:'ターミナル直接操作',aiw_inline:'インライン補完',aiw_multi:'マルチファイル編集',
  aiw_mcp:'MCP活用パターン',aiw_mcp1:'最新ライブラリドキュメント参照',aiw_mcp2:'プロジェクト構造の理解',aiw_mcp3:'E2Eテスト自動化',
  aiw_prompt:'プロンプトテンプレート',aiw_addFeature:'新機能追加',
  aiw_promptText:`.spec/tasks.mdの[タスク名]を実装してください。
.spec/specification.mdの要件に従い、
.spec/technical-plan.mdのアーキテクチャに沿って実装してください。
テストも同時に作成してください。`,
  aiw_bugfixPrompt:'バグ修正',
  aiw_bugfixText:`以下のエラーを修正してください:
[エラー内容を貼り付け]
手順:
1. docs/25_error_logs.mdを参照し、既知の問題か確認
2. 根本原因を特定
3. 修正とテストを実装
4. docs/25_error_logs.mdにエラーを記録`,
  aiw_refactorPrompt:'リファクタリング',
  aiw_refactorText:`以下のコードをリファクタリングしてください:
[対象ファイル/コードを貼り付け]
手順:
1. .spec/specification.mdの要件を再確認
2. 問題点を特定 (SOLID原則違反、重複コード等)
3. 段階的に改善 (テストを壊さない)
4. docs/24_progress.mdを更新`,
  
  aia_title:'AI自律開発ガイド',aia_level:'レベル',
  aia_vibe:'Vibe Codingの実践',aia_vibeDesc:'自然言語で意図を伝え、AIが実装する開発スタイル。',
  aia_basic:'基本フロー',
  aia_f1:'意図を明確に伝える',aia_f1ex:'「ユーザー一覧画面を作って」',
  aia_f2:'AIが実装',aia_f2ex:'コード生成・テスト・リファクタリング',
  aia_f3:'レビュー・修正',aia_f3ex:'人間が最終確認',
  aia_f4:'イテレーション',aia_f4ex:'フィードバックを繰り返し',
  aia_tools:'推奨ツール',
  aia_vibe1:'Cursor + Claude: 基本的なVibe Coding',aia_vibe2:'Claude Code: ターミナルベースの自律実装',aia_vibe3:'Antigravity: Agent-first IDE（Editor + Manager View）',
  aia_multi1:'Claude Code Subagents: 並列タスク実行',aia_multi2:'Claude-Flow: マルチAgent協調',aia_multi3:'AGENTS.md: Agent間の役割定義',
  aia_full1:'Devin: 完全自律型AIエンジニア',aia_full2:'Claude Code Tasks: DAGタスク管理',aia_full3:'Gas Town: K8s for AI Agents',aia_async1:'Jules (Google): 非同期コーディングAgent',
  aia_bp:'ベストプラクティス',
  aia_bp1:'.spec/を必ず最初に読ませる',aia_bp2:'小さなタスクに分割する',aia_bp3:'テストを先に書かせる (TDD)',aia_bp4:'コミット前に必ずレビュー',
  aia_none:'現在のプロジェクトではAI自律開発は対象外です。\nまずはAIコーディングツール（',aia_none2:'）の基本活用から始めましょう。',
  
  sc_title:'SaaS・EC収益化ガイド',sc_selected:'選択',
  sc_compare:'決済プラットフォーム比較',sc_platform:'プラットフォーム',sc_rate:'料率',sc_feat:'特徴',
  sc_stripe:'API最強、カスタマイズ自在',sc_paddle:'SaaS特化、税務自動',sc_lemon:'Stripe傘下、個人開発者向け',
  sc_impl:'Stripe実装ガイド',sc_webhook:'Webhook処理',
  sc_paid:'決済完了',sc_renew:'サブスク更新',sc_cancel:'解約',
  sc_cms:'ヘッドレスCMS実装',sc_ec:'ヘッドレスEC',
  sc_prodMgmt:'商品管理',sc_payment:'決済',sc_ship:'配送',sc_fulfill:'カスタムFulfillment',
  sc_none:'現在のプロジェクトでは決済・EC機能は対象外です。\n将来的にStripe決済やヘッドレスCMSの導入を推奨します。',
  
  dRoadDeploy:'デプロイ',dRoadReset:'🔄 リセット',dRoadFiles:'📁 ファイル一覧',dRoadProgress:'📈 全体進捗',
};
const en={
  none:'None',
  lp_title:'Learning Roadmap',lp_skill:'Skill Level',lp_target:'Target',
  l1:'Web Fundamentals',l2:'Frontend',l3:'Backend',l3m:'Mobile',
  l4:'DevOps',l5:'AI-Driven Dev',l6:'Monetization',l7:'Dev Methodologies',l7span:'Entire Duration',
  html5b:'HTML5 Basics (2-4 weeks)',css3b:'CSS3 Basics (3-6 weeks)',jsb:'JavaScript ES6+ (4-12 weeks)',
  tsAdv:'TypeScript deep dive',cssAdv:'Modern CSS (Container Queries, :has())',
  setup:'Setup & Basics',stMgmt:'State Management',dataFetch:'Data Fetching',
  testing:'Testing',dbDesign:'Database Design',auth:'Auth & Authorization',
  mobEnv:'Environment Setup',mobNav:'Navigation & Screen Design',
  mobNative:'Native Features (Camera/Push)',mobStore:'Store Build & Submission',
  deploy:'Deploy',monitor:'Monitoring Setup',aiUse:'Integration',
  mcpCfg:'MCP Configuration',aiOpt:'AI Agent Rules Optimization',practice:'Practice',
  billing:'Billing Flow Implementation',opsScale:'Operations & Scaling',
  ts_title:'Tech Stack Guide',ts_selected:'Selected Tech Stack',
  cat:'Category',tech:'Technology',rationale:'Rationale',
  feLabel:'Frontend',beLabel:'Backend',dbLabel:'Database',
  deployLabel:'Deploy',mobileLabel:'Mobile',payLabel:'Payment/CMS',
  nextR:'SSR/SSG support, SEO optimized',vueR:'Low learning curve, flexible',feGenR:'High performance, rich ecosystem',
  supaR:'BaaS, rapid MVP',expR:'Lightweight, easy to learn',nestR:'Enterprise-grade, DI',beGenR:'Scalable',
  pgR:'ACID compliant, JSON support, Supabase compatible',dbGenR:'Flexible schema',
  vercelR:'Next.js optimized, auto-deploy',deployGenR:'High flexibility',
  expoR:'Reuse React skills, OTA updates',mobGenR:'Cross-platform',
  payR:'SaaS/EC monetization platform',
  ts_deps:'Technology Dependencies',ts_versions:'Recommended Versions',
  mob_title:'Mobile Dev Guide',mob_env:'Environment Setup',mob_dir:'Directory Structure',
  mob_home:'Home screen',mob_explore:'Explore screen',mob_profile:'Profile',
  mob_root:'Root layout',mob_eas:' Config',mob_libs:'Recommended Libraries',
  mob_anim:'Animations',mob_list:'High-perf list',mob_img:'Image optimization',
  mob_none:'Mobile development is not in scope for this project.\nConsider Expo (React Native) for future mobile support.',
  tool_title:'Dev Tools Setup Guide',tool_essential:'Essential Tools',
  tool_rec:'Recommended',tool_pkgmgr:'Package Manager',tool_init:'Project Init',
  tool_docker:'Database (via Docker)',tool_ai:'AI Coding Tools',
  tool_ext:'Extensions',tool_used:'if used',tool_vsInst:'Install from VS Code extensions',
  tool_official:'Install from official site',tool_env:'Environment Variables',
  res_title:'Learning Resources',res_official:'Official Documentation',
  res_ai:'AI-Driven Development',res_bp:'Best Practices',res_docs:'Docs',
  res_proto:'Protocol',res_patterns:'Patterns',
  res_books:'Recommended Books & Courses',res_fullstack:'Full-Stack Web Development',
  res_tsPractice:'TypeScript in Practice',res_design:' Design Principles',
  res_saas:'SaaS Development with Stripe',res_headless:'Headless Architecture Guide',
  res_beg:'Beginner',res_int:'Intermediate',
  ms_title:'Milestone Plan',ms_target:'Target',
  ms_m:['Setup & Foundations','Core Feature Implementation','UI/UX & Testing','Deploy & CI/CD','Optimization & Monitoring','Production & Improvement','Scale & Next Phase'],
  ms_criteria:'Define milestone acceptance criteria',ms_review:'Conduct weekly reviews',ms_retro:'Retrospective & improvement',
  aiw_title:'AI-Driven Dev Workflow Guide',aiw_flow:'AI Dev Flow',
  aiw_s1:'.spec/ review',aiw_s2:'Task selection',aiw_s3:'AI implementation',aiw_s4:'Review',aiw_s5:'Test',aiw_s6:'Commit',
  aiw_select:'AI Tool Selection',aiw_task:'Task',aiw_rec:'Recommended',
  aiw_newfile:'New file creation',aiw_bugfix:'Bug fix',aiw_testgen:'Test generation',aiw_refactor:'Refactoring',
  aiw_ctx:'Context awareness',aiw_term:'Direct terminal access',aiw_inline:'Inline completion',aiw_multi:'Multi-file editing',
  aiw_mcp:'MCP Usage Patterns',aiw_mcp1:'Latest library docs reference',aiw_mcp2:'Project structure comprehension',aiw_mcp3:'E2E test automation',
  aiw_prompt:'Prompt Templates',aiw_addFeature:'Add New Feature',
  aiw_promptText:`Implement [task name] from .spec/tasks.md.
Follow the requirements in .spec/specification.md
and the architecture defined in .spec/technical-plan.md.
Create tests alongside the implementation.`,
  aiw_bugfixPrompt:'Bug Fix',
  aiw_bugfixText:`Fix the following error:
[Paste error here]
Steps:
1. Reference docs/25_error_logs.md to check if it is a known issue
2. Identify root cause
3. Implement fix and tests
4. Log error to docs/25_error_logs.md`,
  aiw_refactorPrompt:'Refactoring',
  aiw_refactorText:`Refactor the following code:
[Paste target file/code here]
Steps:
1. Re-verify requirements in .spec/specification.md
2. Identify issues (SOLID violations, code duplication, etc.)
3. Improve gradually (do not break tests)
4. Update docs/24_progress.md`,
  aia_title:'AI Autonomous Dev Guide',aia_level:'Level',
  aia_vibe:'Vibe Coding in Practice',aia_vibeDesc:'A development style where you express intent in natural language and AI implements it.',
  aia_basic:'Basic Flow',
  aia_f1:'Communicate intent clearly',aia_f1ex:'"Create a user list screen"',
  aia_f2:'AI implements',aia_f2ex:'Code generation, testing, refactoring',
  aia_f3:'Review & fix',aia_f3ex:'Human final review',
  aia_f4:'Iteration',aia_f4ex:'Repeat feedback cycles',
  aia_tools:'Recommended Tools',
  aia_vibe1:'Cursor + Claude: Basic Vibe Coding',aia_vibe2:'Claude Code: Terminal-based autonomous implementation',aia_vibe3:'Antigravity: Agent-first IDE (Editor + Manager View)',
  aia_multi1:'Claude Code Subagents: Parallel task execution',aia_multi2:'Claude-Flow: Multi-Agent coordination',aia_multi3:'AGENTS.md: Agent role definitions',
  aia_full1:'Devin: Fully autonomous AI engineer',aia_full2:'Claude Code Tasks: DAG task management',aia_full3:'Gas Town: K8s for AI Agents',aia_async1:'Jules (Google): Async coding agent',
  aia_bp:'Best Practices',
  aia_bp1:'Always feed .spec/ first',aia_bp2:'Break into small tasks',aia_bp3:'Write tests first (TDD)',aia_bp4:'Always review before committing',
  aia_none:'AI autonomous development is not in scope.\nStart with AI coding tools (',aia_none2:') for the basics.',
  sc_title:'SaaS & E-Commerce Guide',sc_selected:'Selected',
  sc_compare:'Payment Platform Comparison',sc_platform:'Platform',sc_rate:'Rate',sc_feat:'Features',
  sc_stripe:'Best API, highly customizable',sc_paddle:'SaaS-focused, auto tax',sc_lemon:'Stripe-owned, indie-friendly',
  sc_impl:'Stripe Implementation',sc_webhook:'Webhook Handler',
  sc_paid:'Payment completed',sc_renew:'Subscription renewed',sc_cancel:'Cancelled',
  sc_cms:'Headless CMS',sc_ec:'Headless E-Commerce',
  sc_prodMgmt:'Product Management',sc_payment:'Payment',sc_ship:'Shipping',sc_fulfill:'Custom Fulfillment',
  sc_none:'Payment/E-Commerce features are not in scope.\nConsider Stripe payments or Headless CMS for future implementation.',
  dRoadDeploy:'Deploy',dRoadReset:'🔄 Reset',dRoadFiles:'📁 File List',dRoadProgress:'📈 Overall Progress',
};
return {ja,en,t:(key)=>(({ja,en})[S.genLang||S.lang]||en)[key]||en[key]||key};
})();
function initPills(){
  const _ja=S.lang==='ja';
  const c=$('pills');if(!c)return;c.innerHTML='';
  const qs=getQ();
  for(let i=1;i<=3;i++){
    const ph=qs[i];if(!ph)continue;
    const d=document.createElement('div');d.className='pd-phase';d.id='pp'+i;
    d.innerHTML='<span class="pd-dot"></span>'+ph.name;
    d.onclick=()=>{if(S.phase>=i){S.phase=i;S.step=0;save();showQ();updProgress();}};
    c.appendChild(d);
    
    const ul=document.createElement('ul');ul.className='pd-qlist';ul.id='pq'+i;
    ph.questions.forEach((q,si)=>{
      const li=document.createElement('li');li.className='pd-q';
      li.setAttribute('data-qid',q.id);
      const shortQ=q.q.length>18?q.q.slice(0,18)+'…':q.q;
      li.innerHTML='<span class="pd-qmark"></span>'+shortQ;
      li.onclick=(e)=>{e.stopPropagation();if(S.phase>i||(S.phase===i&&S.step>=si)){S.phase=i;S.step=si;save();showQ();updProgress();}};
      ul.appendChild(li);
    });
    c.appendChild(ul);
  }
  const tl=$('pdTitle');if(tl)tl.textContent=_ja?'進捗':'Progress';
  const gb=$('pdGenBtn');if(gb)gb.textContent=_ja?'🚀 生成':'🚀 Generate';
}
function isQActive(q){
  if(!q.condition)return true;
  const[k,fn]=Object.entries(q.condition)[0];
  return fn(S.answers[k]||'');
}
function updProgress(){
  const qs=getQ();let total=0,done=0;
  for(let p=1;p<=3;p++){const ph=qs[p];if(!ph)continue;ph.questions.forEach(q=>{if(!isQActive(q))return;total++;if(S.answers[q.id])done++;});}
  const pct=total?Math.round(done/total*100):0;
  $('pbar').style.width=pct+'%';
  
  const pdBar=$('pdBar');if(pdBar)pdBar.style.width=pct+'%';
  const pdPct=$('pdPct');if(pdPct)pdPct.textContent=done+'/'+total+' ('+pct+'%)';
  for(let i=1;i<=3;i++){
    const el=$('pp'+i);if(el){el.classList.toggle('active',S.phase===i);el.classList.toggle('done',S.phase>i);}
    
    const ph=qs[i];if(!ph)continue;
    ph.questions.forEach((q,si)=>{
      const li=document.querySelector('.pd-q[data-qid="'+q.id+'"]');
      if(!li)return;
      const active=isQActive(q);
      li.classList.toggle('answered',active&&!!S.answers[q.id]);
      li.classList.toggle('current',active&&S.phase===i&&S.step===si);
      li.classList.toggle('q-na',!active);
    });
  }
  updTOC();
}
function addMsg(type,text,tip,qid,helpId){
  const _ja=S.lang==='ja';
  const body=$('cbody'),d=document.createElement('div');d.className='msg';
  const cls=type==='bot'?'m-bot':'m-usr';
  const w=document.createElement('div');w.className=cls;w.style.position='relative';
  const lbl=document.createElement('div');lbl.className='m-lbl';
  lbl.textContent=type==='bot'?(_ja?'AI アシスタント':'AI Assistant'):(_ja?'あなた':'You');
  if(type==='bot'&&helpId&&HELP_DATA[helpId]){
    const hb=document.createElement('span');hb.className='q-help';hb.textContent='?';hb.title=_ja?'ヘルプ':'Help';
    hb.onclick=(e)=>showHelp(helpId,e);
    lbl.appendChild(hb);
  }
  const bd=document.createElement('div');bd.className='m-body';
  text.split('\n').forEach((l,i,a)=>{bd.appendChild(document.createTextNode(l));if(i<a.length-1)bd.appendChild(document.createElement('br'));});
  w.appendChild(lbl);w.appendChild(bd);
  if(type==='user'&&qid){
    const eb=document.createElement('button');
    eb.className='m-edit';eb.textContent='✎';eb.title=_ja?'編集':'Edit';
    eb.onclick=()=>editAnswer(qid,d);
    w.appendChild(eb);
    d.dataset.qid=qid;
  }
  d.appendChild(w);body.appendChild(d);
  if(tip){const tt=document.createElement('div');tt.className='msg';tt.innerHTML='<div class="m-tip">💡 '+esc(tip)+'</div>';body.appendChild(tt);}
  body.scrollTop=body.scrollHeight;
  return d;
}
function showQ(){
  const qs=getQ();
  const ph=qs[S.phase];if(!ph)return;
  while(S.step<ph.questions.length){
    const q=ph.questions[S.step];
    if(!isQActive(q)){S.step++;continue;}
    break;
  }
  if(S.step>=ph.questions.length){phaseEnd();return;}
  const q=ph.questions[S.step];
  $('pdTitle').textContent=ph.name;
  updProgress();
  addMsg('bot',q.q,q.tip,null,q.help);
  renderInputFor(q,(val)=>{
    if(S.skill==='pro'){showConfirm(val,()=>{doSubmit(q.id,val);});}
    else{doSubmit(q.id,val);}
  },true);
}
function doSubmit(qid,val){
  S.answers[qid]=sanitize(val.trim?val.trim():String(val));
  addMsg('user',String(val),null,qid);
  showCompatAlert(S.answers);
  S.step++;save();
  setTimeout(()=>{
    const ph=getQ()[S.phase];
    if(!ph||S.step>=ph.questions.length)phaseEnd();
    else showQ();
  },300);
}
function showCompatAlert(answers){
  const issues=checkCompat(answers).filter(i=>i.level==='error'||i.level==='warn'||i.level==='info');
  if(!issues.length)return;
  const _ja=S.lang==='ja';const body=$('cbody');
  issues.forEach(iss=>{
    const d=document.createElement('div');d.className='msg';
    const icon=iss.level==='error'?'❌':iss.level==='warn'?'⚠️':'ℹ️';
    const cls=iss.level==='error'?'compat-error':iss.level==='warn'?'compat-warn':'compat-info';
    let h=`<div class="${cls}"><span class="compat-icon">${icon}</span><span class="compat-msg">${iss.msg}</span>`;
    if(iss.fix)h+=`<button class="btn btn-xs btn-s compat-fix" onclick="S.answers['${iss.fix.f}']='${iss.fix.s}';save();this.parentNode.innerHTML='✅ ${_ja?'修正済':'Fixed'}: ${iss.fix.f} → ${iss.fix.s}'">${_ja?'修正':'Fix'}</button>`;
    h+='</div>';d.innerHTML=h;body.appendChild(d);
  });
  body.scrollTop=body.scrollHeight;
}
function phaseEnd(){
  if(S.phase<3){
    addMsg('bot',t('phEnd'+S.phase));
    S.phase++;S.step=0;save();
    setTimeout(()=>showQ(),400);
  } else {
    handleSkipped();
  }
}
function skipQ(qid){
  if(!S.skipped.includes(qid))S.skipped.push(qid);
  addMsg('bot',t('skipMsg'));
  S.step++;save();
  setTimeout(()=>{
    const ph=getQ()[S.phase];
    if(!ph||S.step>=ph.questions.length)phaseEnd();
    else showQ();
  },250);
}
function handleSkipped(){
  S.skipped=S.skipped.filter(id=>!S.answers[id]);
  if(S.skipped.length===0){finish();return;}
  addMsg('bot',t('skippedTitle')+S.skipped.length+t('skippedSuffix'));
  askNextSkipped();
}
function askNextSkipped(){
  S.skipped=S.skipped.filter(id=>!S.answers[id]);
  if(S.skipped.length===0){addMsg('bot',t('skippedDone'));finish();return;}
  const qid=S.skipped[0];
  let targetQ=null;
  for(const ph of Object.values(getQ())){for(const q of ph.questions){if(q.id===qid){targetQ=q;break;}}}
  if(!targetQ){S.skipped.shift();askNextSkipped();return;}
  const zone=$('izone');zone.innerHTML='';
  const banner=document.createElement('div');banner.className='skipped-banner';
  banner.innerHTML='<span>'+t('skippedBanner')+S.skipped.length+t('skippedBannerSuffix')+'</span>';
  zone.appendChild(banner);
  addMsg('bot',targetQ.q,targetQ.tip,null,targetQ.help);
  renderInputFor(targetQ,(val)=>{
    S.answers[qid]=sanitize(val.trim?val.trim():String(val));
    addMsg('user',String(val),null,qid);
    S.skipped.shift();
    showCompatAlert(S.answers);save();
    setTimeout(()=>askNextSkipped(),250);
  },false);
}
function finish(){
  showGenerate();
  showComplexity();
}
function showGenerate(){
  const zone=$('izone');zone.innerHTML='';
  const btn=document.createElement('button');btn.className='btn btn-p';btn.style.cssText='padding:14px 40px;font-size:14px;margin:20px;';
  btn.textContent=t('genBtn');
  btn.onclick=()=>{generateAll();};
  zone.appendChild(btn);
}
function findNext(){
  const qs=getQ();
  for(let p=1;p<=3;p++){const ph=qs[p];if(!ph)continue;
    for(let s=0;s<ph.questions.length;s++){
      const q=ph.questions[s];
      if(!isQActive(q))continue;
      if(!S.answers[q.id]){S.phase=p;S.step=s;showQ();return;}
    }
  }
  finish();
}
function renderInputFor(q,onSubmit,allowSkip){
  const zone=$('izone');
  const existingBanner=zone.querySelector('.edit-banner')||zone.querySelector('.skipped-banner');
  if(!existingBanner)zone.innerHTML='';
  if(q.type==='chip-text')renderChips(zone,q,false,onSubmit,true);
  else if(q.type==='chip-multi')renderChips(zone,q,true,onSubmit,true);
  else if(q.type==='options')renderOpts(zone,q,onSubmit);
  if(allowSkip!==false){
    const sk=document.createElement('div');sk.style.cssText='padding:4px 20px 10px;text-align:right;';
    const btn=document.createElement('button');btn.className='skip-btn';btn.textContent=t('skip');
    btn.onclick=()=>skipQ(q.id);
    sk.appendChild(btn);zone.appendChild(sk);
  }
}
function renderChips(zone,q,multi,onSubmit,withVoice){
  const _ja=S.lang==='ja';
  const sel=new Set();
  const cz=document.createElement('div');cz.className='czone';
  const lb=document.createElement('div');lb.className='czlabel';lb.textContent=_ja?(multi?'選択してください（複数可・自由入力併用）':'選択するか下に入力'):(multi?'Select multiple or type below':'Select or type below');
  cz.appendChild(lb);
  const gr=document.createElement('div');gr.className='cgrid';
  (q.chips||[]).forEach(ch=>{
    const c=document.createElement('div');c.className='chip';
    if(multi){const ck=document.createElement('span');ck.className='ck';ck.textContent='✓';c.appendChild(ck);}
    c.appendChild(document.createTextNode(ch));
    c.onclick=()=>{
      if(multi){if(sel.has(ch)){sel.delete(ch);c.classList.remove('on')}else{sel.add(ch);c.classList.add('on')}}
      else{onSubmit(ch);}
    };
    gr.appendChild(c);
  });
  cz.appendChild(gr);zone.appendChild(cz);
  const ft=document.createElement('div');ft.className='cfoot';
  const inp=document.createElement('input');inp.className='cadd';inp.placeholder=q.placeholder||(_ja?'自由入力…':'Type here…');
  if(multi){
    inp.addEventListener('keypress',e=>{
      if(e.key==='Enter'&&inp.value.trim()){
        const v=inp.value.trim();sel.add(v);
        const c=document.createElement('div');c.className='chip on';
        const ck=document.createElement('span');ck.className='ck';ck.textContent='✓';c.appendChild(ck);
        c.appendChild(document.createTextNode(v));c.onclick=()=>{sel.delete(v);c.remove();};
        gr.appendChild(c);inp.value='';
      }
    });
    const btn=document.createElement('button');btn.className='btn btn-p btn-sm';btn.textContent=t('confirm');
    btn.onclick=()=>{if(inp.value.trim())sel.add(inp.value.trim());if(!sel.size){toast(t('selectMin'));return;}
      const items=Array.from(sel);
      if(q.sortable&&items.length>1){renderDnD(zone,items,onSubmit);}
      else{onSubmit(items.join(', '));}
    };
    ft.appendChild(inp);ft.appendChild(btn);
    if(withVoice&&voiceRec){const vb=document.createElement('button');vb.className='voice-btn';vb.textContent='🎙️';vb.title=_ja?'音声入力':'Voice Input';vb.onclick=()=>toggleVoice(vb);ft.appendChild(vb);}
  } else {
    inp.addEventListener('keypress',e=>{if(e.key==='Enter'&&inp.value.trim())onSubmit(inp.value.trim());});
    const btn=document.createElement('button');btn.className='btn btn-p btn-sm';btn.textContent=t('send');
    btn.onclick=()=>{if(inp.value.trim())onSubmit(inp.value.trim());};
    ft.appendChild(inp);ft.appendChild(btn);
    if(withVoice&&voiceRec){const vb=document.createElement('button');vb.className='voice-btn';vb.textContent='🎙️';vb.title=_ja?'音声入力':'Voice Input';vb.onclick=()=>toggleVoice(vb);ft.appendChild(vb);}
  }
  zone.appendChild(ft);
}
function renderOpts(zone,q,onSubmit){
  const cards=document.createElement('div');cards.className='ocards';
  (q.options||[]).forEach(o=>{
    const c=document.createElement('div');c.className='ocard';
    const h=document.createElement('h5');h.textContent=typeof o==='string'?o:o.label;c.appendChild(h);
    if(o.desc){const p=document.createElement('p');p.textContent=o.desc;c.appendChild(p);}
    c.onclick=()=>onSubmit(typeof o==='string'?o:o.label);
    cards.appendChild(c);
  });
  zone.appendChild(cards);
}
function renderDnD(zone,items,onSubmit){
  const _ja=S.lang==='ja';
  zone.innerHTML='';
  const wrap=document.createElement('div');wrap.style.cssText='padding:10px 20px;';
  const lbl=document.createElement('div');lbl.className='czlabel';lbl.textContent=t('sortLabel');
  wrap.appendChild(lbl);
  const list=document.createElement('ul');list.className='dnd-list';
  let dragItem=null;
  items.forEach((item,i)=>{
    const li=document.createElement('li');li.className='dnd-item';li.draggable=true;li.dataset.idx=i;
    const grip=document.createElement('span');grip.className='dnd-grip';grip.textContent='⠿';
    const label=document.createElement('span');label.className='dnd-label';label.textContent=item;
    const pri=document.createElement('span');pri.className='dnd-priority';
    li.appendChild(grip);li.appendChild(label);li.appendChild(pri);
    li.addEventListener('dragstart',e=>{dragItem=li;li.style.opacity='0.4';e.dataTransfer.effectAllowed='move';});
    li.addEventListener('dragend',()=>{dragItem=null;li.style.opacity='1';list.querySelectorAll('.dnd-item').forEach(el=>el.classList.remove('drag-over'));updPri();});
    li.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='move';li.classList.add('drag-over');});
    li.addEventListener('dragleave',()=>li.classList.remove('drag-over'));
    li.addEventListener('drop',e=>{e.preventDefault();li.classList.remove('drag-over');if(dragItem&&dragItem!==li){const rect=li.getBoundingClientRect();const mid=rect.top+rect.height/2;if(e.clientY<mid)list.insertBefore(dragItem,li);else list.insertBefore(dragItem,li.nextSibling);}});
    list.appendChild(li);
  });
  wrap.appendChild(list);
  function updPri(){
  const _ja=S.lang==='ja';
    const els=list.querySelectorAll('.dnd-item');const n=els.length;
    els.forEach((el,i)=>{
      const p=el.querySelector('.dnd-priority');
      if(i<Math.ceil(n*0.3)){p.textContent=_ja?'P0 必須':'P0 Must';p.className='dnd-priority p0';}
      else if(i<Math.ceil(n*0.7)){p.textContent=_ja?'P1 重要':'P1 Important';p.className='dnd-priority p1';}
      else{p.textContent=_ja?'P2 任意':'P2 Optional';p.className='dnd-priority p2';}
    });
  }
  updPri();
  const ft=document.createElement('div');ft.style.cssText='padding:6px 20px 12px;display:flex;gap:6px;justify-content:flex-end;';
  const btn=document.createElement('button');btn.className='btn btn-p btn-sm';btn.textContent=t('sortConfirm');
  btn.onclick=()=>{
    const ordered=Array.from(list.querySelectorAll('.dnd-label')).map(el=>el.textContent);
    const priLabels=Array.from(list.querySelectorAll('.dnd-priority')).map(el=>el.textContent.split(' ')[0]);
    onSubmit(ordered.map((item,i)=>'['+priLabels[i]+'] '+item).join(', '));
  };
  ft.appendChild(btn);wrap.appendChild(ft);zone.appendChild(wrap);
}
function editAnswer(qid,msgEl){
  const _ja=S.lang==='ja';
  let targetQ=null;
  for(const ph of Object.values(getQ())){for(const q of ph.questions){if(q.id===qid){targetQ=q;break;}}}
  if(!targetQ)return;
  const savedPhase=S.phase,savedStep=S.step;
  let isEditing=true;
  msgEl.style.outline='2px solid var(--warn)';msgEl.style.borderRadius='var(--radius)';
  toast(_ja?'回答を編集中…':'Editing answer…');
  const zone=$('izone');zone.innerHTML='';
  const banner=document.createElement('div');banner.className='edit-banner';
  banner.innerHTML='<span>'+(_ja?'✏️ 「'+esc(targetQ.q)+'」を編集中':'✏️ Editing: '+esc(targetQ.q))+'</span>';
  const cancelBtn=document.createElement('button');cancelBtn.className='btn btn-g btn-xs';cancelBtn.textContent=_ja?'キャンセル':'Cancel';
  cancelBtn.onclick=()=>{
    if(!isEditing)return;isEditing=false;
    msgEl.style.outline='';msgEl.style.borderRadius='';zone.innerHTML='';
    S.phase=savedPhase;S.step=savedStep;
    if(Object.keys(S.files).length>0){showExportGrid();}else{findNext();}
  };
  banner.appendChild(cancelBtn);zone.appendChild(banner);
  renderInputFor(targetQ,(newVal)=>{
    if(!isEditing)return;isEditing=false;
    S.answers[qid]=sanitize(newVal.trim?newVal.trim():String(newVal));
    const bd=msgEl.querySelector('.m-body');bd.textContent='';
    String(newVal).split('\n').forEach((l,i,a)=>{bd.appendChild(document.createTextNode(l));if(i<a.length-1)bd.appendChild(document.createElement('br'));});
    msgEl.style.outline='';msgEl.style.borderRadius='';zone.innerHTML='';
    showCompatAlert(S.answers);
    save();toast(_ja?'回答を更新しました':'Answer updated');
    if(Object.keys(S.files).length>0&&S.genLang){
      doGenerate(S.genLang);
    } else {
      S.phase=savedPhase;S.step=savedStep;findNext();
    }
  },false);
}
function showHelp(id,e){
  const _ja=S.lang==='ja';
  const raw=HELP_DATA[id];if(!raw)return;const data=raw[S.lang]||raw.ja;
  const popup=$('helpPopup');
  popup.style.display='block';
  popup.style.top=Math.min(e.clientY+10,window.innerHeight-250)+'px';
  popup.style.left=Math.max(0,Math.min(e.clientX-100,window.innerWidth-380))+'px';
  popup.innerHTML='<button class="hp-close" onclick="closeHelpPopup()" aria-label="'+t('helpClose')+'">✕</button><h4>'+esc(data.title)+'</h4><p>'+esc(data.desc)+'</p>'+(data.example?'<div class="hp-ex">'+esc(data.example)+'</div>':'')+(data.link?'<a class="hp-link" href="'+esc(data.link)+'" target="_blank" rel="noopener">📎 '+(_ja?'参考リンク':'Reference')+'</a>':'');
  setTimeout(()=>{document.addEventListener('click',closeHelpOnClick,{once:true});},100);
}
function closeHelpPopup(){$('helpPopup').style.display='none';}
function closeHelpOnClick(e){if(!$('helpPopup').contains(e.target))closeHelpPopup();}
function showPostGenGuide(force){
  if(!force&&_lsGet('devforge-guide-shown'))return;
  _lsSet('devforge-guide-shown','1');
  const _ja=S.lang==='ja';
  const lv=S.answers.skill_level||'Intermediate';
  const isB=lv.includes('Beginner');const isP=lv.includes('Professional');
  const overlay=document.createElement('div');
  overlay.className='guide-overlay';
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
  const level=isB?{em:'🌱',name:_ja?'Beginner':'Beginner',cls:'guide-lv-b'}:isP?{em:'⚡',name:_ja?'Professional':'Professional',cls:'guide-lv-p'}:{em:'🔥',name:_ja?'Intermediate':'Intermediate',cls:'guide-lv-i'};
  const steps=isB?(_ja?[
    ['ロードマップに従う','ダッシュボード柱⑦のロードマップUIがそのまま学習計画。Layer 1から順にチェック。📖で公式ドキュメントにジャンプ。'],
    ['3ファイルだけ覚える','<code>README.md</code>(GitHub公開用) / <code>.devcontainer/</code>(開発環境一発) / <code>CLAUDE.md</code>(AIに全仕様を理解させる)'],
    ['AIに丸ごと渡す','「全ファイルコピー」(Ctrl+Shift+C)でAIに貼り付け → 仕様を把握した状態で開発スタート。'],
  ]:[
    ['Follow the Roadmap','Dashboard Pillar ⑦ is your learning plan. Check off from Layer 1. Hit 📖 for official docs.'],
    ['Remember 3 Files','<code>README.md</code>(GitHub ready) / <code>.devcontainer/</code>(instant dev env) / <code>CLAUDE.md</code>(AI understands your project)'],
    ['Feed Everything to AI','"Copy All" (Ctrl+Shift+C) → Paste into AI → Start coding with full context.'],
  ]):isP?(_ja?[
    ['Agent Teams並列開発','AGENTS.mdでエージェント役割定義 → Claude Code Subagents / Antigravity Manager Viewで並列実行。'],
    ['SDD仕様駆動','<code>.spec/</code>がSSoT。tasks.mdをタスクキューとしてAIに投入。verification.mdで品質判定。'],
    ['6工程パイプライン','柱⑧のランチャーで📋レビュー→🔨実装→🧪テスト→♻️リファクタ→🔒セキュリティ→📝ドキュメント。'],
  ]:[
    ['Agent Teams Parallel Dev','AGENTS.md defines roles → Run with Claude Code Subagents / Antigravity Manager View.'],
    ['SDD Spec-Driven','<code>.spec/</code> is your SSoT. Feed tasks.md as task queue. Verify with verification.md.'],
    ['6-Stage Pipeline','Pillar ⑧ launcher: 📋Review → 🔨Implement → 🧪Test → ♻️Refactor → 🔒Security → 📝Docs.'],
  ]):(_ja?[
    ['SDD仕様駆動開発','<code>.spec/</code>がSSoT。AIへの指示は「tasks.mdの○○を実装して、specification.mdに従って」で完結。'],
    ['マルチAIツール統一','柱④の10ファイルでCursor/Claude Code/Copilot/Windsurf/Cline/Gemini全対応。フォルダに置くだけ。'],
    ['MCP拡張','mcp-config.jsonをプロジェクトルートに配置 → AIがcontext7/filesystem/playwright等を即利用。'],
  ]:[
    ['SDD Spec-Driven Dev','<code>.spec/</code> is your SSoT. Tell AI: "implement X from tasks.md following specification.md".'],
    ['Multi-AI Tool Unity','Pillar ④ generates 10 files covering Cursor/Claude Code/Copilot/Windsurf/Cline/Gemini. Just drop in.'],
    ['MCP Extension','Place mcp-config.json in root → AI instantly uses context7, filesystem, playwright MCPs.'],
  ]);
  const lvKey=isB?'b':isP?'p':'i';
  const prog=JSON.parse(_lsGet('devforge-guide-prog')||'{}');
  const stepsHtml=steps.map((s,i)=>{
    const done=prog[lvKey+i];
    return `<div class="guide-step${done?' guide-step-done':''}" data-gi="${lvKey}${i}"><label class="guide-ck"><input type="checkbox" ${done?'checked':''} onchange="toggleGuideStep('${lvKey}${i}',this.checked,this.closest('.guide-step'))"><span class="guide-ckbox">${done?'✓':''}</span></label><div class="guide-step-num ${level.cls}">${i+1}</div><div><div class="guide-step-title">${s[0]}</div><div class="guide-step-desc">${s[1]}</div></div></div>`;
  }).join('');
  const doneCount=steps.filter((_,i)=>prog[lvKey+i]).length;
  const progBar=`<div class="guide-prog"><div class="guide-prog-bar"><div class="guide-prog-fill" style="width:${Math.round(doneCount/steps.length*100)}%"></div></div><span class="guide-prog-txt">${doneCount}/${steps.length}</span></div>`;
  overlay.innerHTML=`<div class="guide-modal">
    <div class="guide-header">
      <span class="guide-em">${level.em}</span>
      <div>
        <div class="guide-title">${_ja?'生成完了！次にやること':'Generation Complete! Next Steps'}</div>
        <div class="guide-sub ${level.cls}">${level.name} ${_ja?'向けガイド':'Guide'}</div>
      </div>
      <button class="guide-close" onclick="this.closest('.guide-overlay').remove()">✕</button>
    </div>
    <div class="guide-badge">${_ja?'世界で唯一の仕様駆動AIプロジェクトジェネレーター':'The world\'s only spec-driven AI project generator'}</div>
    ${progBar}
    <div class="guide-steps">${stepsHtml}</div>
    <div class="guide-actions">
      <button class="btn btn-s btn-sm" onclick="this.closest('.guide-overlay').remove();showManual('guide')">${_ja?'📖 詳細ガイドを読む':'📖 Full Guide'}</button>
      <button class="btn btn-p btn-sm" onclick="this.closest('.guide-overlay').remove()">${_ja?'✨ 始める':'✨ Let\'s Go'}</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}
function toggleGuideStep(key,checked,el){
  const prog=JSON.parse(_lsGet('devforge-guide-prog')||'{}');
  if(checked)prog[key]=1;else delete prog[key];
  _lsSet('devforge-guide-prog',JSON.stringify(prog));
  if(el)el.classList.toggle('guide-step-done',checked);
  if(el){const ckbox=el.querySelector('.guide-ckbox');if(ckbox)ckbox.textContent=checked?'✓':'';}
  const overlay=el?.closest('.guide-overlay');
  if(!overlay)return;
  const total=overlay.querySelectorAll('.guide-step').length;
  const done=overlay.querySelectorAll('.guide-step-done').length;
  const fill=overlay.querySelector('.guide-prog-fill');
  const txt=overlay.querySelector('.guide-prog-txt');
  if(fill)fill.style.width=Math.round(done/total*100)+'%';
  if(txt)txt.textContent=done+'/'+total;
}
function showConfirm(val,onOk){
  if(S.skill!=='pro'){onOk();return;}
  _confirmCb=onOk;
  const ov=$('confirmOverlay');ov.style.display='flex';
  pushModal(ov,()=>{ov.style.display='none';_confirmCb=null;});
  ov.innerHTML='<div class="confirm-modal"><h4>'+t('answerConfirm')+'</h4>'
    +'<div class="cm-val">'+esc(String(val))+'</div>'
    +'<div class="cm-acts">'
    +'<button class="btn btn-g btn-sm" onclick="removeModal($(\'confirmOverlay\'));$(\'confirmOverlay\').style.display=\'none\';_confirmCb=null;">'+t('edit')+'</button>'
    +'<button class="btn btn-p btn-sm" onclick="removeModal($(\'confirmOverlay\'));$(\'confirmOverlay\').style.display=\'none\';if(_confirmCb){_confirmCb();_confirmCb=null;}">'+t('confirm')+'</button>'
    +'</div></div>';
}
function getComplexityHTML(){
  const a=S.answers;const _ja=S.lang==='ja';
  const fs=(a.mvp_features||'').split(',').map(s=>s.trim()).filter(Boolean);
  const fCount=fs.length;
  const eCount=((a.data_entities||'').split(',')).filter(Boolean).length;
  const sCount=((a.screens||'').split(',')).filter(Boolean).length;
  const authCount=((a.auth||'').split(',')).filter(Boolean).length;
  const hasTDD=hasDM('TDD')?1:0,hasBDD=hasDM('BDD')?1:0,hasDDD=hasDM('DDD')?1:0;
  const beComplex=(a.backend||'').includes('なし')||(a.backend||'').includes('None')?0:(a.backend||'').includes('Firebase')||(a.backend||'').includes('Supabase')?1:2;
  let score=0;
  score+=Math.min(fCount*8,50);
  score+=Math.min(eCount*3,20);
  score+=Math.min(sCount*2,14);
  score+=authCount*2;
  score+=beComplex*5;
  score+=(hasTDD+hasBDD+hasDDD)*3;
  score=Math.min(score,100);
  const level=score<=30?'low':score<=60?'mid':'high';
  const levelLabel=score<=30?(_ja?'🟢 シンプル':'🟢 Simple'):score<=60?(_ja?'🟡 中規模':'🟡 Medium'):(_ja?'🔴 大規模':'🔴 Large');
  const weeks=score<=30?(_ja?'2-4週':'2-4 wks'):score<=60?(_ja?'1-3ヶ月':'1-3 mo'):(_ja?'3-6ヶ月':'3-6 mo');
  const devs=score<=30?(_ja?'1人':'1'):score<=60?(_ja?'1-2人':'1-2'):(_ja?'2-4人':'2-4');
  const color=score<=30?'var(--success)':score<=60?'var(--warn)':'var(--danger)';
  const _s=_ja?'件':'';
  return `<div class="complexity-card"><div class="complexity-header"><div><div class="dash-total complexity-label">${_ja?'プロジェクト複雑度':'PROJECT COMPLEXITY'}</div><div class="complexity-sub">${levelLabel}</div>
</div><div class="complexity-score ${level}">${score}</div></div><div class="complexity-bar"><div class="complexity-fill" style="width:${score}%;background:${color};"></div></div><div class="complexity-grid"><div class="complexity-item"><span>${_ja?'MVP機能':'MVP Features'}</span>
<span>${fCount}${_s}</span></div><div class="complexity-item"><span>${_ja?'エンティティ':'Entities'}</span><span>${eCount}${_s}</span></div><div class="complexity-item"><span>${_ja?'画面数':'Screens'}</span><span>${sCount}${_s}</span>
</div><div class="complexity-item"><span>${_ja?'認証方式':'Auth Methods'}</span><span>${authCount}${_s}</span></div><div class="complexity-item"><span>${_ja?'推定期間':'Est. Duration'}</span><span>${weeks}</span></div>
<div class="complexity-item"><span>${_ja?'推奨人数':'Team Size'}</span><span>${devs}</span></div></div></div>`;
}
function showComplexity(){
  const body=$('cbody');
  const card=document.createElement('div');
  card.innerHTML=getComplexityHTML();
  body.appendChild(card.firstChild);body.scrollTop=body.scrollHeight;
}
function updTOC(){
  const toc=$('tocPanel');if(!toc||!S.projectName)return;
  toc.style.display='block';
  const qs=getQ();let items=[];
  for(let p=1;p<=3;p++){
    const ph=qs[p];if(!ph)continue;
    for(const q of ph.questions){
      if(q.condition){const[k,fn]=Object.entries(q.condition)[0];if(!fn(S.answers[k]||''))continue;}
      const done=!!S.answers[q.id];
      const active=S.phase===p&&ph.questions.indexOf(q)===S.step;
      items.push('<div class="toc-item'+(done?' done':'')+(active?' active':'')+'" onclick="jumpToQ(\''+q.id+'\')" title="'+esc(q.q)+'"><span class="toc-dot"></span><span>'+esc(q.q)+'</span></div>');
    }
  }
  toc.innerHTML=items.join('');
}
function jumpToQ(qid){
  const el=document.querySelector('[data-qid="'+qid+'"]');
  if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
}
function initVoice(){
  const _ja=S.lang==='ja';
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window))return;
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  voiceRec=new SR();voiceRec.lang=_ja?'ja-JP':'en-US';voiceRec.interimResults=false;voiceRec.maxAlternatives=1;
  voiceRec.onresult=(e)=>{
    const text=e.results[0][0].transcript;
    const inp=document.querySelector('.cadd');
    if(inp){inp.value+=text;inp.focus();}
    if(voiceBtn){voiceBtn.classList.remove('recording');voiceBtn.textContent='🎙️';}
  };
  voiceRec.onend=()=>{if(voiceBtn){voiceBtn.classList.remove('recording');voiceBtn.textContent='🎙️';}};
}
function toggleVoice(btn){
  const _ja=S.lang==='ja';
  if(!voiceRec)return;
  voiceBtn=btn;
  if(btn.classList.contains('recording')){voiceRec.stop();btn.classList.remove('recording');btn.textContent='🎙️';}
  else{voiceRec.lang=_ja?'ja-JP':'en-US';voiceRec.start();btn.classList.add('recording');btn.textContent='⏹️';}
}
function getProjects(){return JSON.parse(_lsGet('devforge-projects')||'{}');}
function saveProject(){
  if(!S.projectName)return;
  const ps=getProjects();
  ps[S.projectName]={state:JSON.parse(JSON.stringify(S)),date:new Date().toISOString()};
  _lsSet('devforge-projects',JSON.stringify(ps));
}
function switchProject(name){
  const ps=getProjects();const p=ps[name];
  if(p&&p.state){Object.assign(S,p.state);save();location.reload();}
}
function deleteProject(name){
  const ps=getProjects();delete ps[name];
  _lsSet('devforge-projects',JSON.stringify(ps));
  if(S.projectName===name){_lsRm(KEY);location.reload();}
  else showPM();
}
function exportProject(){
  const _ja=S.lang==='ja';
  const ps=getProjects();const p=ps[S.projectName];
  if(!p){toast(_ja?'保存されたプロジェクトがありません':'No saved project');return;}
  const blob=new Blob([JSON.stringify(p,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=fileSlug(S.projectName)+'.devforge.json';a.click();
  URL.revokeObjectURL(url);
  toast(_ja?'📁 プロジェクトをエクスポートしました':'📁 Project exported');
  _lsSet('devforge-last-export',new Date().toISOString());
}
function importProject(){
  const _ja=S.lang==='ja';
  const inp=document.createElement('input');inp.type='file';inp.accept='.json,.devforge.json';
  inp.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.state||!data.state.projectName){toast(_ja?'❌ 無効なファイル形式':'❌ Invalid file format');return;}
        data.state.projectName=sanitizeName(data.state.projectName);
        const ps=getProjects();
        ps[data.state.projectName]=data;
        _lsSet('devforge-projects',JSON.stringify(ps));
        Object.assign(S,data.state);save();
        toast(_ja?'✅ インポート完了':'✅ Import complete');
        location.reload();
      }catch(err){toast(_ja?'❌ 読み込みエラー':'❌ Read error');}
    };
    reader.readAsText(f);
  };
  inp.click();
}
function newProject(){
  if(S.projectName)saveProject();
  _lsRm(KEY);location.reload();
}
function showPM(){
  const _ja=S.lang==='ja';
  const ov=$('pmOverlay');ov.style.display='flex';
  pushModal(ov,()=>{ov.style.display='none';releaseFocus(ov);});
  const ps=getProjects();const names=Object.keys(ps);
  let html='<div class="pm-modal"><h3>'+t('pmTitle')+'</h3>';
  if(names.length===0){html+='<p class="dash-empty">'+t('pmEmpty')+'</p>';}
  else{
    names.forEach(name=>{
      const isCurrent=name===S.projectName;
      const meta=ps[name].date?new Date(ps[name].date).toLocaleDateString():'';
      html+='<div class="pm-item'+(isCurrent?' current':'')+'" onclick="switchProject(\''+name.replace(/'/g,"\\'")+'\')"><div><div class="pm-item-name">'+esc(name)+(isCurrent?' ✓':'')+'</div><div class="pm-item-meta">'+meta+'</div></div><div class="pm-item-acts"><button onclick="event.stopPropagation();deleteProject(\''+name.replace(/'/g,"\\'")+'\')">🗑️</button></div></div>';
    });
  }
  html+='<div class="pm-actions"><button class="btn btn-s" onclick="newProject()">➕ '+(_ja?'新規プロジェクト':'New Project')+'</button><button class="btn btn-s" onclick="importProject()">📥 '+(_ja?'インポート':'Import')+'</button>';
  if(S.projectName)html+='<button class="btn btn-s" onclick="exportProject()">📤 '+(_ja?'エクスポート':'Export')+'</button>';
  html+='<button class="btn btn-g btn-sm" onclick="closePM()">'+(_ja?'閉じる':'Close')+'</button></div></div>';
  ov.innerHTML=html;
  trapFocus(ov);
}
function closePM(){$('pmOverlay').style.display='none';releaseFocus($('pmOverlay'));removeModal($('pmOverlay'));}
function pickSkill(lv){S.skill=lv;document.querySelectorAll('.skcard').forEach(c=>c.classList.toggle('on',c.dataset.lv===lv));save();}
function initPresets(){
  const row=$('presetRow');row.innerHTML='';
  const _ja=S.lang==='ja';
  Object.entries(PR).forEach(([k,v])=>{
    if(k==='custom'||!v.name)return;
    const c=document.createElement('span');c.className='prchip';
    c.textContent=(v.icon||'')+(v.icon?' ':'')+(!_ja&&v.nameEn?v.nameEn:v.name);
    c.onclick=(e)=>pickPreset(k,e);
    const _en=!_ja;
    const desc=(_en&&v.purposeEn)?v.purposeEn:v.purpose||'';
    const fe=v.frontend||'-';
    const be=v.backend||'-';
    const fts=(_en&&v.featuresEn?v.featuresEn:v.features)||[];
    const ftStr=Array.isArray(fts)?fts.slice(0,3).join(', ')+(fts.length>3?' …':''):fts;
    c.title=`${desc}\n─────\nFrontend: ${fe}\nBackend: ${be}\nFeatures: ${ftStr}`;
    row.appendChild(c);
  });
  const cb=document.createElement('span');cb.className='prchip prchip-cmp';
  cb.textContent=_ja?'⚔️ 比較':'⚔️ Compare';
  cb.onclick=()=>showPresetCompare();
  row.appendChild(cb);
}
function showPresetCompare(){
  const _ja=S.lang==='ja';const _en=S.lang==='en';
  const keys=Object.keys(PR).filter(k=>k!=='custom'&&PR[k].name);
  const opts=keys.map(k=>{const p=PR[k];return `<option value="${k}">${p.icon||''} ${_en&&p.nameEn?p.nameEn:p.name}</option>`;}).join('');
  const ov=document.createElement('div');ov.className='guide-overlay';ov.id='cmpOv';
  ov.onclick=e=>{if(e.target===ov)ov.remove();};
  ov.innerHTML=`<div class="guide-modal" style="max-width:680px;width:95%;">
    <div class="guide-header"><span class="guide-em">⚔️</span><div><div class="guide-title">${_ja?'テンプレート比較':'Template Comparison'}</div><div class="guide-sub">${_ja?'2つのプリセットを並べて比較':'Compare two presets side by side'}</div></div><button class="guide-close" onclick="$('cmpOv').remove()">✕</button></div>
    <div class="cmp-selectors"><select id="cmpA" onchange="renderCompare()">${opts}</select><span class="cmp-vs">VS</span><select id="cmpB" onchange="renderCompare()">${opts.replace('value="'+keys[0]+'"','value="'+keys[1]+'"')}</select></div>
    <div id="cmpBody"></div>
  </div>`;
  document.body.appendChild(ov);
  $('cmpB').value=keys[1];
  renderCompare();
}
function renderCompare(){
  const _ja=S.lang==='ja';const _en=S.lang==='en';
  const a=PR[$('cmpA').value];const b=PR[$('cmpB').value];
  const n=k=>(_en&&k+'En' in a)?a[k+'En']:a[k];
  const nb=k=>(_en&&k+'En' in b)?b[k+'En']:b[k];
  const ft=v=>{const f=Array.isArray(v)?v:[];return f.length;};
  const rows=[
    [_ja?'目的':'Purpose',n('purpose')||'-',nb('purpose')||'-'],
    ['Frontend',a.frontend||'-',b.frontend||'-'],
    ['Backend',a.backend||'-',b.backend||'-'],
    [_ja?'機能数':'Features',ft(_en?a.featuresEn:a.features),ft(_en?b.featuresEn:b.features)],
    ['Mobile',a.mobile||'none',b.mobile||'none'],
    ['AI',a.ai_auto||'none',b.ai_auto||'none'],
    [_ja?'決済':'Payment',a.payment||'none',b.payment||'none'],
    ['Entities',(a.entities||'').split(',').length,(b.entities||'').split(',').length],
  ];
  let h='<table class="cmp-table"><tr><th></th><th>'+(a.icon||'')+' '+(n('name')||'')+'</th><th>'+(b.icon||'')+' '+(nb('name')||'')+'</th></tr>';
  rows.forEach(r=>{
    const diff=String(r[1])!==String(r[2]);
    h+=`<tr${diff?' class="cmp-diff"':''}><td class="cmp-label">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`;
  });
  h+='</table>';
  $('cmpBody').innerHTML=h;
}
function pickPreset(k,e){
  S.preset=k;
  document.querySelectorAll('.prchip').forEach(c=>c.classList.remove('on'));
  if(e&&e.target)e.target.classList.add('on');
  const p=PR[k];
  if(p&&p.name)$('nameIn').value=(S.lang==='en'&&p.nameEn)?p.nameEn:p.name;
  save();
}
function start(){
  const _ja=S.lang==='ja';
  const name=sanitizeName($('nameIn').value);
  if(!name){toast(_ja?'プロジェクト名を入力してください':'Please enter a project name');return;}
  S.projectName=name;S.phase=1;S.step=0;S.skipped=[];
  const p=PR[S.preset];const _en=S.lang==='en';
  if(p&&p.name){
    if(p.purpose)S.answers.purpose=(_en&&p.purposeEn)?p.purposeEn:p.purpose;
    if(p.target){const t=_en&&p.targetEn?p.targetEn:p.target;S.answers.target=Array.isArray(t)?t.join(', '):t;}
    if(p.frontend)S.answers.frontend=p.frontend;
    if(p.backend)S.answers.backend=p.backend;
    if(p.features){const f=_en&&p.featuresEn?p.featuresEn:p.features;S.answers.mvp_features=Array.isArray(f)?f.join(', '):f;}
    if(p.entities)S.answers.data_entities=p.entities;
    if(p.mobile&&p.mobile!=='none')S.answers.mobile=p.mobile;
    if(p.ai_auto&&p.ai_auto!=='none'){
      if(_en){
        const _aiMap={'Vibe Coding入門':'Vibe Coding Intro','エージェント型開発':'Agentic Dev','マルチAgent協調':'Multi-Agent','フル自律開発':'Full Autonomous','オーケストレーター':'Orchestrator'};
        S.answers.ai_auto=_aiMap[p.ai_auto]||p.ai_auto;
      } else { S.answers.ai_auto=p.ai_auto; }
    }
    if(p.payment&&p.payment!=='none'){
      const _payMap=_en
        ?{stripe:'Stripe',ec_build:'Stripe, Medusa (OSS EC)',stripe_billing:'Stripe Billing (Sub)'}
        :{stripe:'Stripe決済',ec_build:'Stripe決済, Medusa (OSS EC)',stripe_billing:'Stripe Billing (サブスク)'};
      S.answers.payment=_payMap[p.payment]||p.payment;
    }
  }
  const presetName=p&&p.name?(_en&&p.nameEn?p.nameEn:p.name):'';
  const preFilledCount=Object.keys(S.answers).length;
  save();saveProject();
  $('onboard').style.display='none';
  $('ws').style.display='flex';
  initPills();updProgress();showQ();
  if(presetName&&preFilledCount>0){
    toast(_ja?`✅ "${presetName}" を適用 — ${preFilledCount}件の回答を自動入力`:`✅ Applied "${presetName}" — ${preFilledCount} answers pre-filled`);
  }
}
function safeMD(raw){
  if(window._noMarked||typeof marked==='undefined')return '<pre>'+esc(raw)+'</pre>';
  return marked.parse(raw);
}
function diffBtn(path){
  return (S.prevFiles[path]||S.editedFiles[path])?'<button class="btn btn-xs btn-s btn-diff" onclick="showDiff(\''+path+'\')">🔀 Diff</button>':'';
}
function prevToolbar(path,showRaw){
  const _ja=S.lang==='ja';
  const rawBtn=showRaw?`<button class="btn btn-xs btn-s" onclick="toggleMdRaw('${path}')">📝 Raw</button>`:'';
  return `<div class="prev-toolbar"><span class="prev-path">📄 ${path}</span><div class="prev-toolbar-r">${rawBtn}<button class="btn btn-xs btn-s" onclick="openEditor('${path}')">✏️ ${_ja?'編集':'Edit'}</button>${diffBtn(path)}<button class="btn btn-xs btn-s" onclick="copyFileContent('${path}')">📋 ${_ja?'コピー':'Copy'}</button></div></div>`;
}
function initPrevTabs(){
  const _ja=S.lang==='ja';
  const tabs=$('prevTabs');tabs.innerHTML='';
  const ja=_ja;
  [ja?'ツリー':'Tree',ja?'プレビュー':'Preview'].forEach((n,i)=>{
    const b=document.createElement('button');b.className='ptab'+(i===0?' on':'');
    b.textContent=n;b.onclick=()=>{
      document.querySelectorAll('.ptab').forEach(t=>t.classList.remove('on'));b.classList.add('on');
      if(i===0)showFileTree();else showFilePreview();
    };tabs.appendChild(b);
  });
}
function initPillarTabs(){
  const tabs=$('pillarTabs');tabs.innerHTML='';
  const names=t('pillar');
  names.forEach((n,i)=>{
    const b=document.createElement('button');b.className='piltab'+(i===0?' on':'');
    b.textContent=n;b.onclick=()=>{
      S.pillar=i;document.querySelectorAll('.piltab').forEach(t=>t.classList.remove('on'));b.classList.add('on');
      if(i===4) showExplorer();
      else if(i===5) showDashboard();
      else if(i===6&&Object.keys(S.files).length>0) showRoadmapUI();
      else if(i===7) showAILauncher();
      else if(i===8) showFileTree(); // Design System
      else if(i===9) showFileTree(); // Reverse Engineering
      else showFileTree();
    };tabs.appendChild(b);
  });
}
function updatePreview(){
  showFileTree();
}
function showFileTree(){
  const _ja=S.lang==='ja';
  const body=$('prevBody');
  const pillar=S.pillar;
  if(pillar===4){showExplorer();return;}
  if(pillar===5){showDashboard();return;}
  if(pillar===6&&Object.keys(S.files).length>0){showRoadmapUI();return;}
  if(pillar===7){showAILauncher();return;}
  const tree=buildFileTree();
  const hasFiles=Object.keys(S.files).length>0;
  
  let h='<div class="ft-search"><input type="text" id="ftSearch" placeholder="'+(_ja?'🔍 ファイル検索…':'🔍 Search files…')+'" oninput="filterFileTree(this.value)"></div>';
  h+='<ul class="file-tree" id="ftList">';
  tree.forEach(f=>{
    if(!f.name||f.name==='───────────'){h+='<li class="ft-separator">────────────────</li>';return;}
    if(f.folder) h+=`<li class="folder">📁 ${f.name}/</li>`;
    else {
      const isGen=hasFiles&&S.files[f.path];
      const isActive=S.previewFile===f.path;
      const isEdited=S.editedFiles&&S.editedFiles[f.path];
      h+=`<li data-path="${f.path}" onclick="previewFile('${f.path}')" class="tree-item${isActive?' active':''}${f.name.startsWith('  ')?' tree-indent':''}${isGen?'':' tree-disabled'}">
        ${isGen?'📄':'⬜'} ${f.name.trim()}${isEdited?'<span class="tree-edited" title="Edited">●</span>':''}${isGen?'<span class="tree-gen">✓</span>':''}
      </li>`;
    }
  });
  h+='</ul>';
  
  if(hasFiles){
    const count=Object.keys(S.files).length;
    const editCount=S.editedFiles?Object.keys(S.editedFiles).length:0;
    h+=`<div class="prev-footer">
      ${count} ${_ja?'ファイル生成済み':'files generated'}${editCount?` · <span class="tree-edited">${editCount} ${_ja?'編集済み':'edited'}</span>`:''}
    </div>`;
  }
  
  body.innerHTML=h;
}
function buildFileTree(){
  const _ja=S.lang==='ja';
  const files=[];
  const pillar=S.pillar;
  if(pillar===0){ // SDD
    files.push({folder:true,name:'.spec'});
    ['constitution.md','specification.md','technical-plan.md','tasks.md','verification.md'].forEach(f=>
      files.push({name:'  '+f,path:'.spec/'+f}));
  } else if(pillar===1){ // DevContainer
    files.push({folder:true,name:'.devcontainer'});
    ['devcontainer.json','Dockerfile','docker-compose.yml','post-create.sh'].forEach(f=>
      files.push({name:'  '+f,path:'.devcontainer/'+f}));
  } else if(pillar===2){ // MCP
    files.push({folder:true,name:'.mcp'});
    ['project-context.md','tools-manifest.json'].forEach(f=>
      files.push({name:'  '+f,path:'.mcp/'+f}));
    files.push({name:'mcp-config.json',path:'mcp-config.json'});
  } else if(pillar===3){ // AI Rules
    ['.cursor/rules','.github/copilot-instructions.md','.windsurfrules','.clinerules',
     '.kiro/spec.md','CLAUDE.md','AGENTS.md','codex-instructions.md','skills/project.md','skills/catalog.md','skills/pipelines.md','.ai/hooks.yml'
    ].forEach(f=>files.push({name:f,path:f}));
  } else if(pillar===4){ // Explorer
    files.push({name:_ja?'(並列実装探索 — UIのみ)':'(Parallel Explorer — UI only)',path:'_explorer'});
  } else if(pillar===5){ // Dashboard
    files.push({name:_ja?'(Context Dashboard — UIのみ)':'(Context Dashboard — UI only)',path:'_dashboard'});
  } else if(pillar===6){ // Roadmap
    files.push({folder:true,name:'roadmap'});
    ['LEARNING_PATH.md','TECH_STACK_GUIDE.md','MOBILE_GUIDE.md','TOOLS_SETUP.md',
     'RESOURCES.md','MILESTONES.md','AI_WORKFLOW.md','AI_AUTONOMOUS.md','SAAS_COMMERCE_GUIDE.md'
    ].forEach(f=>files.push({name:'  '+f,path:'roadmap/'+f}));
  } else if(pillar===7){ // AI Launcher
    files.push({name:_ja?'(AIランチャー — UIのみ)':'(AI Launcher — UI only)',path:'_launcher'});
  } else if(pillar===8){ // Design System
    files.push({folder:true,name:'docs'});
    ['26_design_system','27_sequence_diagrams'].forEach(f=>
      files.push({name:'  '+f+'.md',path:'docs/'+f+'.md'}));
  } else if(pillar===9){ // Reverse Engineering
    files.push({folder:true,name:'docs'});
    ['29_reverse_engineering','30_goal_decomposition'].forEach(f=>
      files.push({name:'  '+f+'.md',path:'docs/'+f+'.md'}));
  }
  files.push({name:'───────────',path:''});
  files.push({folder:true,name:'docs'});
  ['01_project_overview','02_requirements','03_architecture','04_er_diagram',
   '05_api_design','06_screen_design','07_test_cases','08_security',
   '09_release_checklist','10_gantt','11_wbs','12_driven_dev','13_glossary',
   '14_risk','15_meeting','16_review','17_monitoring',
   '18_data_migration','19_performance','20_a11y','21_changelog',
   '22_prompt_playbook','23_tasks','24_progress','25_error_logs',
   '26_design_system','27_sequence_diagrams','28_qa_strategy','31_industry_playbook'].forEach(f=>
    files.push({name:'  '+f+'.md',path:'docs/'+f+'.md'}));
  files.push({name:'───────────',path:''});
  ['README.md','.gitignore','package.json','LICENSE'].forEach(f=>files.push({name:f,path:f}));
  return files;
}
function previewFile(path){
  const _ja=S.lang==='ja';
  if(!path||path==='')return;
  S.previewFile=path;save();
  document.querySelectorAll('.file-tree li').forEach(li=>{
    li.classList.toggle('active',li.getAttribute('data-path')===path);
  });
  if(S.files[path]){
    const raw=S.files[path];
    if(path.endsWith('.md')&&raw.includes('```mermaid')){
      let html=safeMD(raw);
      html=html.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g,
        (m,code)=>'<div class="mermaid">'+code.replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>')+'</div>');
      $('prevBody').innerHTML=prevToolbar(path,true)+`<div id="mdRendered" class="md-rendered">${html}</div>`;
      loadMermaid(()=>{
        if(_mermaidReady){
          try{
            const nodes=document.querySelectorAll('#mdRendered .mermaid');
            if(nodes.length>0){
              if(mermaid.run) mermaid.run({nodes:nodes});
              else if(mermaid.init) mermaid.init(undefined,nodes);
            }
          }catch(e){console.warn('Mermaid render:',e);}
        }
      });
    } else if(path.endsWith('.md')){
      const html=safeMD(raw);
      $('prevBody').innerHTML=prevToolbar(path,true)+`<div id="mdRendered" class="md-rendered">${html}</div>`;
    } else {
      $('prevBody').innerHTML=prevToolbar(path,false)+`<pre>${escHtml(raw)}</pre>`;
    }
    document.querySelectorAll('.ptab').forEach((t,i)=>{t.classList.toggle('on',i===1);});
  } else {
    $('prevBody').innerHTML=`<p class="empty-preview-sm">${_ja?'ファイルは生成後にプレビュー可能です':'File preview available after generation'}</p>`;
  }
}
let _mdRawMode=false;
function toggleMdRaw(path){
  _mdRawMode=!_mdRawMode;
  if(_mdRawMode){
    const el=$('mdRendered');
    if(el) el.outerHTML=`<pre id="mdRaw">${escHtml(S.files[path])}</pre>`;
  } else { previewFile(path); }
}
function copyFileContent(path){
  if(S.files[path]){
    if(navigator.clipboard&&navigator.clipboard.writeText){
      navigator.clipboard.writeText(S.files[path]).then(()=>toast(t('copyDone'))).catch(()=>{_fallbackCopy(S.files[path]);toast(t('copyDone'));});
    } else {_fallbackCopy(S.files[path]);toast(t('copyDone'));}
  }
}
function _fallbackCopy(text){const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;left:-9999px;';document.body.appendChild(ta);ta.select();try{document.execCommand('copy');}catch(e){}ta.remove();}
function showFilePreview(){
  const _ja=S.lang==='ja';
  if(S.previewFile&&S.files[S.previewFile]){
    previewFile(S.previewFile);
  } else {
    $('prevBody').innerHTML=`<p class="dash-empty">${_ja?'ファイルツリーからファイルを選択してください':'Select a file from the tree'}</p>`;
  }
}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function filterFileTree(q){
  const list=$('ftList');if(!list)return;
  const items=list.querySelectorAll('li');
  const lq=q.toLowerCase();
  items.forEach(li=>{
    if(li.classList.contains('ft-separator')||li.classList.contains('folder')){
      li.style.display=q?'none':'';return;
    }
    const path=li.dataset.path||li.textContent;
    li.style.display=(!q||path.toLowerCase().includes(lq))?'':'none';
  });
}
function generateAll(){
  const _minKeys=['frontend','backend','database'];
  if(_minKeys.some(k=>!S.answers[k])){
    toast(S.lang==='ja'?'⚠️ 基本項目（FE/BE/DB）を先に回答してください':'⚠️ Answer basic items (FE/BE/DB) first');
    return;
  }
  showGenLangChooser();
}
function showGenLangChooser(){
  const _j=S.lang==='ja';
  const ov=document.createElement('div');ov.className='gen-lang-overlay';ov.id='genLangOv';
  ov.innerHTML=`<div class="gen-lang-modal">
    <h3>${_j?'📄 生成ファイルの言語':'📄 File Language'}</h3>
    <p>${_j?'生成するドキュメントの言語を選択してください':'Choose the language for generated documents'}</p>
    <div class="gen-lang-btns">
      <div class="gen-lang-btn" onclick="doGenerate('ja')"><span class="flag">🇯🇵</span>日本語</div>
      <div class="gen-lang-btn" onclick="doGenerate('en')"><span class="flag">🇺🇸</span>English</div>
    </div>
  </div>`;
  document.body.appendChild(ov);
}
function doGenerate(lang){
  const _minKeys=['frontend','backend','database'];
  const _missing=_minKeys.filter(k=>!S.answers[k]);
  if(_missing.length>0){
    toast(S.lang==='ja'?'⚠️ 必須項目が未回答です: '+_missing.join(', '):'⚠️ Required fields unanswered: '+_missing.join(', '));
    return;
  }
  snapshotFiles();
  S.genLang=lang;save();
  const ov=$('genLangOv');if(ov)ov.remove();
  const _cErrs=checkCompat(S.answers).filter(c=>c.level==='error');
  if(_cErrs.length>0){
    const _j=S.lang==='ja';
    const msg=_cErrs.map(e=>'❌ '+e.msg).join('\n');
    if(!confirm((_j?'⚠️ スタック相性エラーが検出されました:\n\n':'⚠️ Stack compatibility errors detected:\n\n')+msg+'\n\n'+(_j?'このまま生成しますか？':'Continue generating?')))return;
  }
  addMsg('bot',S.lang==='ja'?'🔨 ファイルを生成中...':'🔨 Generating files...');
  $('izone').innerHTML='<div class="gen-spinner"><div class="gen-prog-wrap"><div class="gen-prog-bar"><div class="gen-prog-fill" id="genProgFill"></div></div><div class="gen-prog-label" id="genProgLabel"></div></div><div class="spin gen-spinner-icon">⚙️</div></div>';
  
  const a=S.answers;const pn=S.projectName;
  S.files={};const _errs=[];const _j=S.lang==='ja';
  const steps=[
    {fn:()=>genPillar1_SDD(a,pn),lbl:_j?'柱① SDD仕様書':'Pillar ① SDD',err:'P1-SDD'},
    {fn:()=>genPillar2_DevContainer(a,pn),lbl:_j?'柱② DevContainer':'Pillar ② DevContainer',err:'P2-Dev'},
    {fn:()=>genPillar3_MCP(a,pn),lbl:_j?'柱③ MCP':'Pillar ③ MCP',err:'P3-MCP'},
    {fn:()=>genPillar4_AIRules(a,pn),lbl:_j?'柱④ AIルール':'Pillar ④ AI Rules',err:'P4-AI'},
    {fn:()=>genPillar7_Roadmap(a,pn),lbl:_j?'柱⑦ ロードマップ':'Pillar ⑦ Roadmap',err:'P7-Road'},
    {fn:()=>genPillar9_DesignSystem(a,pn),lbl:_j?'柱⑨ デザインシステム':'Pillar ⑨ Design System',err:'P9-DS'},
    {fn:()=>genPillar10_ReverseEngineering(a,pn),lbl:_j?'柱⑩ リバースEng':'Pillar ⑩ Reverse Eng',err:'P10-Rev'},
    {fn:()=>genDocs21(a,pn),lbl:_j?'仕様書23種':'23 Spec Docs',err:'Docs'},
    {fn:()=>genCommonFiles(a,pn),lbl:_j?'共通ファイル':'Common Files',err:'Common'},
  ];
  let si=0;
  function runStep(){
    if(si>=steps.length){finishGen(_errs);return;}
    const s=steps[si];const pct=Math.round((si/steps.length)*100);
    const fill=$('genProgFill');if(fill)fill.style.width=pct+'%';
    const lbl=$('genProgLabel');if(lbl)lbl.textContent=s.lbl;
    setTimeout(()=>{
      try{s.fn();}catch(e){_errs.push(s.err);console.error('❌ '+s.err+' error:',e);}
      si++;runStep();
    },60);
  }
  setTimeout(runStep,300);
}
function finishGen(_errs){
    if(_errs.length){toast('⚠️ '+_errs.length+(S.lang==='ja'?' 件のエラー: ':' errors: ')+_errs.join(', '));}
    const _auditFindings=postGenerationAudit(S.files,S.answers);
    const fill=$('genProgFill');if(fill)fill.style.width='100%';
    const lbl=$('genProgLabel');if(lbl)lbl.textContent=S.lang==='ja'?'✅ 完了':'✅ Done';
    const _fc=Object.keys(S.files).length;
    const _ja=S.lang==='ja';
    addMsg('bot',_ja?`✅ 生成完了！全${_fc}ファイルが準備できました。ファイルツリーからプレビューするか、エクスポートしてください。`:`✅ Generation complete! All ${_fc} files are ready. Preview in the file tree or export.`);
    if(_auditFindings.length>0){
      const _sb=$('cbody');
      const aErrs=_auditFindings.filter(f=>f.level==='error');
      const aWarns=_auditFindings.filter(f=>f.level==='warn');
      const aInfos=_auditFindings.filter(f=>f.level==='info');
      let auditHtml='<div class="audit-results"><h4>'+(S.lang==='ja'?'🔍 生成後セルフ検証':'🔍 Post-Generation Audit')+'</h4>';
      if(aErrs.length) auditHtml+='<div class="audit-summary-err">❌ '+aErrs.length+(S.lang==='ja'?' 件の問題':' issues')+'</div>';
      if(aWarns.length) auditHtml+='<div class="audit-summary-warn">⚠️ '+aWarns.length+(S.lang==='ja'?' 件の注意':' warnings')+'</div>';
      if(aInfos.length) auditHtml+='<div class="audit-summary-info">ℹ️ '+aInfos.length+(S.lang==='ja'?' 件の参考':' notes')+'</div>';
      _auditFindings.forEach(f=>{
        const cls=f.level==='error'?'compat-error':f.level==='warn'?'compat-warn':'compat-info';
        const icon=f.level==='error'?'❌':f.level==='warn'?'⚠️':'ℹ️';
        auditHtml+=`<div class="${cls}"><span class="compat-icon">${icon}</span><span class="compat-msg">${f.msg}</span></div>`;
      });
      auditHtml+='</div>';
      const ad=document.createElement('div');ad.className='msg';ad.innerHTML=auditHtml;_sb.appendChild(ad);
    }
    if($('statFileNum'))$('statFileNum').textContent=_fc;
    const _sn=document.createElement('div');_sn.className='msg';
    const _sb2=$('cbody');
    _sn.innerHTML=`<div class="compat-warn"><span class="compat-icon">💾</span><span class="compat-msg">${_ja?'データはブラウザのみに保存されています。<strong>📦 ZIP</strong> と <strong>📤 JSONエクスポート</strong> で必ずローカル保存してください。':'Data is only stored in your browser. Be sure to save locally with <strong>📦 ZIP</strong> and <strong>📤 JSON Export</strong>.'}</span></div>`;
    _sb2.appendChild(_sn);_sb2.scrollTop=_sb2.scrollHeight;
    showExportGrid();
    showFileTree();
    initPrevTabs();initPillarTabs();updProgress();save();
    if(!$('qbar')){
      const qb=document.createElement('div');qb.id='qbar';qb.className='qbar';
      qb.innerHTML=`<button class="qbar-btn" onclick="exportZIP()">📦 ZIP</button><button class="qbar-btn" onclick="copyAllFiles()">📋 ${_ja?'全コピー':'Copy All'}</button><button class="qbar-btn" onclick="S.pillar=5;showFileTree()">📊 Dashboard</button><button class="qbar-btn" onclick="S.pillar=6;showFileTree()">🗺️ Roadmap</button><button class="qbar-x" onclick="this.parentNode.remove()">✕</button>`;
      const ws=$('ws');if(ws)ws.appendChild(qb);
    }
    setTimeout(showPostGenGuide,400);
}
function showExportGrid(){
  const _ja=S.lang==='ja';const fc=Object.keys(S.files).length;
  const totalChars=Object.values(S.files).reduce((s,v)=>s+v.length,0);
  const tokens=Math.round(totalChars/4);
  const sizeKB=Math.round(totalChars/1024);
  const summary=`<div class="export-summary">
    <span>📁 ${fc} ${_ja?'ファイル':'files'}</span>
    <span>📏 ~${sizeKB.toLocaleString()}KB</span>
    <span>🔤 ~${tokens.toLocaleString()} ${_ja?'トークン':'tokens'}</span>
  </div>`;
  $('izone').innerHTML=summary+`<div class="export-grid">
    <div class="export-card" onclick="exportZIP()"><div class="icon">📦</div><h4>${_ja?'ZIP ダウンロード':'ZIP Download'}</h4><p>${_ja?'全'+fc+'ファイルをZIPで保存':'Save all '+fc+' files as ZIP'}</p></div>
    <div class="export-card" onclick="exportPDF()"><div class="icon">📄</div><h4>${_ja?'PDF 印刷':'PDF Print'}</h4><p>${_ja?'仕様書をPDF化':'Export specs as PDF'}</p></div>
    <div class="export-card" onclick="copyAllFiles()"><div class="icon">📋</div><h4>${_ja?'全ファイルコピー':'Copy All Files'}</h4><p>${_ja?'全結合テキストをコピー':'Copy all combined text'}</p></div>
    <div class="export-card" onclick="copyForAI()"><div class="icon">🤖</div><h4>${_ja?'AI向けMarkdown':'AI Markdown'}</h4><p>${_ja?'TOC付きMD形式でコピー':'Copy as MD with TOC for AI'}</p></div>
    <div class="export-card" onclick="saveTemplate()"><div class="icon">💾</div><h4>${_ja?'テンプレート保存':'Save Template'}</h4><p>${_ja?'設定を保存して再利用':'Save settings for reuse'}</p></div>
    <div class="export-card" onclick="shareURL()"><div class="icon">🔗</div><h4>${_ja?'URL共有':'Share URL'}</h4><p>${_ja?'設定をURLで共有':'Share settings via URL'}</p></div>
    <div class="export-card export-card-regen" onclick="generateAll()"><div class="icon">🔄</div><h4>${_ja?'再生成':'Regenerate'}</h4><p>${_ja?'回答から全ファイル再作成':'Rebuild all files from answers'}</p></div>
    <div class="export-card export-card-danger" onclick="clearFiles()"><div class="icon">🗑️</div><h4>${_ja?'生成ファイルをクリア':'Clear Generated Files'}</h4><p>${_ja?fc+'ファイルを削除（回答は保持）':'Delete '+fc+' files (answers kept)'}</p></div>
  </div>`;
}
function clearFiles(){
  const _ja=S.lang==='ja';const fc=Object.keys(S.files).length;
  if(!fc){toast(_ja?'クリアするファイルがありません':'No files to clear');return;}
  const msg=_ja?fc+'ファイルの生成結果をクリアします。\n回答データは保持されます。続行しますか？':'Clear '+fc+' generated files?\nYour answers will be kept.';
  if(!confirm(msg))return;
  S.files={};S.editedFiles={};S.prevFiles={};S.genLang=null;S.previewFile=null;
  save();showFileTree();showExportGrid();
  toast(_ja?'✅ 生成ファイルをクリアしました':'✅ Generated files cleared');
}
function genPillar1_SDD(a,pn){
  const G=S.genLang==='ja';
  const date=new Date().toISOString().split('T')[0];
  const fe=a.frontend||'React + Next.js';
  const be=a.backend||'Node.js + Express';
  const db=a.database||'PostgreSQL';
  const methods=(a.dev_methods||'TDD').split(', ');
  const auth=resolveAuth(a);
  const arch=resolveArch(a);
  const sched=buildSchedule(a);
  let scopeOut=a.scope_out || (()=>{
    const domain=detectDomain(a.purpose);
    const defaults={
      education: G?'ネイティブアプリ, 動画配信インフラ, 決済以外の金融機能':'Native apps, Video streaming infrastructure, Non-payment financial features',
      ec: G?'ネイティブアプリ, 実店舗POS連携, 会計ソフト連携, 物流管理':'Native apps, POS integration, Accounting software, Logistics management',
      community: G?'ネイティブアプリ, 動画配信, リアルタイムビデオ通話, メール配信':'Native apps, Video streaming, Real-time video calls, Email delivery',
      saas: G?'ネイティブアプリ, オンプレミスデプロイ, ホワイトラベル対応':'Native apps, On-premise deployment, White-label support',
      content: G?'ネイティブアプリ, 動画配信, コメント通知メール':'Native apps, Video streaming, Comment notification emails',
      analytics: G?'ネイティブアプリ, ETLパイプライン構築, データウェアハウス':'Native apps, ETL pipeline, Data warehouse',
      booking: G?'ネイティブアプリ, 決済代行, カレンダー同期(外部API)':'Native apps, Payment processing, Calendar sync (external API)',
      marketplace: G?'ネイティブアプリ, 物流管理, エスクロー決済':'Native apps, Logistics management, Escrow payments',
    };
    return defaults[domain] || (G?'ネイティブアプリ, モバイルアプリ':'Native apps, Mobile apps');
  })();
  if(a.mobile&&!isNone(a.mobile)&&!String(a.mobile).includes('PWA')){
    scopeOut=scopeOut.replace(/ネイティブアプリ/g,G?'ストア配布用ネイティブビルド（Expo Web UIは対象内）':'Native app store builds (Expo Web UI is in scope)');
    scopeOut=scopeOut.replace(/native apps?/gi,'Native app store builds (Expo Web UI is in scope)');
  }
  const authLines=['- '+(G?'認証SoT（Source of Truth）':'Auth SoT')+': '+auth.sot,
    '- '+(G?'トークン形式':'Token Type')+': '+auth.tokenType,
    '- '+(G?'トークン検証':'Token Verification')+': '+auth.tokenVerify];
  if(auth.social.length) authLines.push('- '+(G?'ソーシャルログイン':'Social Login')+': '+auth.social.join(', '));
  authLines.push('- '+(G?'HTTPS必須':'HTTPS required'),'- '+(G?'環境変数でシークレット管理':'Secrets via env vars'),'- '+(G?'SQLインジェクション・XSS対策':'SQL injection & XSS prevention'));
  const archLabel=G?{baas:'BaaS統合型',bff:'BFF（API Routes統合）',split:'FE/BE分離型',traditional:'従来型クライアント-サーバー'}[arch.pattern]:{baas:'BaaS Integration',bff:'BFF (API Routes)',split:'FE/BE Split',traditional:'Traditional Client-Server'}[arch.pattern];
  S.files['.spec/constitution.md']=[
    '# '+pn+' — '+(G?'プロジェクト憲法 (Constitution)':'Project Constitution'),
    '> Generated by DevForge v9 — '+date,'',
    G?'## 1. プロジェクトの使命':'## 1. Mission',a.purpose||(G?'（未定義）':'(Undefined)'),'',
    G?'## 2. ターゲットユーザー':'## 2. Target Users',a.target||(G?'（未定義）':'(Undefined)'),'',
    G?'## 3. 成功指標':'## 3. Success Metrics',
    a.success || (()=>{
      const domain=detectDomain(a.purpose);
      const kpis={
        education: G?'- コース完了率: 70%以上\n- 月間アクティブ学習者数 (MAL): 前月比+10%\n- 学習者満足度 (NPS): 40以上':'- Course completion rate: 70%+\n- Monthly Active Learners (MAL): +10% MoM\n- Learner NPS: 40+',
        ec: G?'- 月間GMV: 前月比+15%\n- 購入CVR: 3%以上\n- カート離脱率: 70%以下':'- Monthly GMV: +15% MoM\n- Purchase CVR: 3%+\n- Cart abandonment: <70%',
        community: G?'- 月間アクティブユーザー (MAU): 前月比+10%\n- 投稿/コメント率: DAU対比30%以上\n- 7日リテンション率: 40%以上':'- Monthly Active Users (MAU): +10% MoM\n- Post/comment rate: 30%+ of DAU\n- 7-day retention: 40%+',
        saas: G?'- MRR（月次経常収益）: 前月比+10%\n- チャーン率: 月5%以下\n- NPS: 40以上':'- MRR: +10% MoM\n- Monthly churn: <5%\n- NPS: 40+',
        content: G?'- 月間PV: 前月比+20%\n- 平均滞在時間: 3分以上\n- リピート訪問率: 30%以上':'- Monthly PV: +20% MoM\n- Avg session: 3min+\n- Return visit rate: 30%+',
        analytics: G?'- DAU: 前月比+10%\n- レポート生成数: 週10件以上/ユーザー\n- データ更新頻度: リアルタイム(< 1分)':'- DAU: +10% MoM\n- Reports generated: 10+/week/user\n- Data refresh: real-time (<1min)',
        booking: G?'- 予約完了率: 80%以上\n- 月間予約件数: 前月比+15%\n- キャンセル率: 10%以下':'- Booking completion: 80%+\n- Monthly bookings: +15% MoM\n- Cancellation rate: <10%',
        marketplace: G?'- 月間取引件数: 前月比+15%\n- 出品者定着率: 60%以上\n- 購入者CVR: 5%以上':'- Monthly transactions: +15% MoM\n- Seller retention: 60%+\n- Buyer CVR: 5%+',
      };
      return kpis[domain] || (G?'- テストカバレッジ: 80%以上\n- ユーザー満足度: NPS 40以上\n- p95レスポンスタイム: 500ms以下':'- Test coverage: 80%+\n- User satisfaction: NPS 40+\n- p95 response time: <500ms');
    })(),'',
    G?'## 4. 技術原則':'## 4. Tech Principles',
    '- '+(G?'フロントエンド':'Frontend')+': '+fe,
    '- '+(G?'バックエンド':'Backend')+': '+be,
    '- '+(G?'データベース':'Database')+': '+db,
    '- '+(G?'アーキテクチャ':'Architecture')+': '+archLabel,
    '- '+(G?'駆動開発手法':'Dev Methods')+': '+methods.join(', '),'',
    G?'## 5. 品質基準':'## 5. Quality Standards',
    '- '+(G?'テストカバレッジ: 80%以上':'Test Coverage: 80%+'),
    '- TypeScript strict mode',
    '- ESLint + Prettier '+(G?'適用':'enforced'),
    '- CI/CD '+(G?'パイプライン必須':'pipeline required'),'',
    G?'## 6. セキュリティ方針':'## 6. Security Policy',...authLines,'',
    G?'## 7. スコープ外':'## 7. Out of Scope',scopeOut,''
  ].join('\n');
  let apiDesignLines;
  if(arch.isBaaS){
    const bn=be.includes('Supabase')?'Supabase':be.includes('Firebase')?'Firebase':'Convex';
    const rt=be.includes('Supabase')?'Supabase Realtime (WebSocket)':be.includes('Firebase')?'Firestore onSnapshot':'Convex Subscriptions';
    const fn=be.includes('Supabase')?'Supabase Edge Functions (Deno)':be.includes('Firebase')?'Cloud Functions':'Convex Functions';
    apiDesignLines=['- '+(G?'アクセス方式':'Access')+': '+bn+' Client SDK','- '+(G?'認証':'Auth')+': '+auth.tokenType,'- '+(G?'リアルタイム':'Realtime')+': '+rt,'- '+(G?'サーバーサイドロジック':'Server Logic')+': '+fn];
  } else if(arch.pattern==='bff'){
    apiDesignLines=['- RESTful API (Next.js API Routes / Route Handlers)','- '+(G?'バージョニング':'Versioning')+': /api/v1/','- '+(G?'認証':'Auth')+': '+auth.tokenType,'- '+(G?'レスポンス':'Response')+': JSON','- '+(G?'注意':'Note')+': '+(G?'Express のロジックは Next.js API Routes に統合。別途 Express サーバーは不要':'Express logic integrated into Next.js API Routes. No separate Express server needed.')];
  } else {
    apiDesignLines=['- RESTful API (OpenAPI 3.0)','- '+(G?'バージョニング':'Versioning')+': /api/v1/','- '+(G?'認証':'Auth')+': '+auth.tokenType,'- '+(G?'レスポンス':'Response')+': JSON'];
  }
  const hasMob=a.mobile&&!isNone(a.mobile);
  const hasPay=a.payment&&!isNone(a.payment);
  const specLines=[
    '# '+pn+' — '+(G?'要件仕様書 (Specification)':'Specification'),
    '> Generated by DevForge v9 — '+date,'',
    G?'## 1. 機能要件':'## 1. Functional Requirements','',
    G?'### 1.1 MVP機能':'### 1.1 MVP Features',
    ...(a.mvp_features||'').split(', ').flatMap(f=>{
      const fd=getFeatureDetail(f);
      const lines=['#### '+f.trim()];
      if(fd){
        const criteria=G?fd.criteria_ja:fd.criteria_en;
        lines.push((G?'**受入条件:**':'**Acceptance Criteria:**'));
        criteria.forEach(c=>{
          const expanded=c.replace(/\{auth\}/g,a.auth||'OAuth');
          lines.push('- [ ] '+expanded);
        });
      } else {
        lines.push('- [ ] '+(G?'CRUD実装':'CRUD implementation'));
        lines.push('- [ ] '+(G?'バリデーション':'Validation'));
        lines.push('- [ ] '+(G?'権限チェック':'Authorization check'));
      }
      lines.push('');
      return lines;
    }),
    G?'### 1.2 主要画面':'### 1.2 Key Screens',
    (a.screens||'').split(', ').map(s=>'- '+s).join('\n'),'',
    G?'### 1.3 ルーティング':'### 1.3 Routing',
    '| URL | '+(G?'画面名':'Screen')+' | '+(G?'認証':'Auth')+' |',
    '|-----|------|------|',
    ...genRoutes(a).map(r=>'| `'+r.path+'` | '+r.name+' | '+(r.auth?(G?'🔒 要':'🔒 Yes'):(G?'🌐 公開':'🌐 Public'))+' |'),
    '',
    G?'### 1.4 データモデル':'### 1.4 Data Model','```',
    (G?'エンティティ':'Entities')+': '+(a.data_entities||(G?'（未定義）':'(Undefined)')),'```','',
    G?'## 2. 非機能要件':'## 2. Non-functional Requirements',
    '- '+(G?'レスポンスタイム':'Response Time')+': '+(S.skill==='pro'?'< 200ms (p95)':S.skill==='intermediate'?'< 500ms (p95)':'< 1000ms (p95)'),
    '- '+(G?'可用性':'Availability')+': '+(S.skill==='pro'?'99.9%':S.skill==='intermediate'?'99%':(G?'ベストエフォート（PaaS依存）':'Best effort (PaaS-dependent)')),
    '- '+(G?'同時接続':'Concurrent Users')+': '+(S.skill==='pro'?'1000+':S.skill==='intermediate'?'〜200':'〜50'),
    '- '+(G?'モバイル対応':'Mobile')+': '+(hasMob?'✅ '+a.mobile:(G?'レスポンシブWebのみ':'Responsive Web only')),'',
    G?'## 3. 技術スタック':'## 3. Tech Stack',
    '| '+(G?'レイヤー':'Layer')+' | '+(G?'技術':'Tech')+' |','|---------|------|',
    '| '+(G?'フロントエンド':'Frontend')+' | '+fe+' |',
    '| '+(G?'バックエンド':'Backend')+' | '+be+' |',
    '| '+(G?'データベース':'Database')+' | '+db+' |',
    '| '+(G?'認証SoT':'Auth SoT')+' | '+auth.sot+' |',
    '| '+(G?'デプロイ':'Deploy')+' | '+(a.deploy||'Vercel')+' |',
  ];
  if(hasMob) specLines.push('| '+(G?'モバイル':'Mobile')+' | '+a.mobile+' |');
  if(hasPay) specLines.push('| '+(G?'決済':'Payment')+' | '+a.payment+' |');
  specLines.push('',G?'## 4. API設計方針':'## 4. API Design',...apiDesignLines,'');
  if(hasPay&&(a.payment||'').includes('Stripe')){
    const isEdge=arch.isBaaS&&be.includes('Supabase');
    specLines.push(
      G?'## 5. 決済設計 (Stripe)':'## 5. Payment Design (Stripe)','',
      G?'### 5.1 プラン設計':'### 5.1 Plan Design',
      '| '+(G?'プラン':'Plan')+' | '+(G?'価格':'Price')+' | '+(G?'制限':'Limits')+' |',
      '|--------|-------|------|',
      '| Free | ¥0 | '+(G?'基本機能のみ':'Basic features only')+' |',
      '| Pro | ¥980/'+(G?'月':'mo')+' | '+(G?'全機能・優先サポート':'All features, priority support')+' |',
      '| Enterprise | ¥9,800/'+(G?'月':'mo')+' | '+(G?'全機能+SLA+専用サポート':'All features + SLA + dedicated support')+' |','',
      G?'### 5.2 決済フロー':'### 5.2 Payment Flow',
      '```',
      G?'1. ユーザーがプラン選択':'1. User selects plan',
      G?'2. Stripe Checkout セッション作成':'2. Create Stripe Checkout session',
      G?'3. Stripe決済画面にリダイレクト':'3. Redirect to Stripe payment page',
      G?'4. 決済完了 → success_url にリダイレクト':'4. Payment complete → redirect to success_url',
      G?'5. Webhook (invoice.paid) → DB更新':'5. Webhook (invoice.paid) → update DB',
      '```','',
      G?'### 5.3 Webhookイベント':'### 5.3 Webhook Events',
      '| Event | '+(G?'処理':'Action')+' |',
      '|-------|------|',
      '| `checkout.session.completed` | '+(G?'サブスクリプション開始':'Start subscription')+' |',
      '| `invoice.paid` | '+(G?'支払確認・期間更新':'Confirm payment, renew period')+' |',
      '| `customer.subscription.updated` | '+(G?'プラン変更反映':'Apply plan change')+' |',
      '| `customer.subscription.deleted` | '+(G?'解約処理':'Cancel subscription')+' |','',
      G?'### 5.4 実装':'### 5.4 Implementation',
      '- Endpoint: `/api/webhook/stripe`',
      '- '+(G?'署名検証':'Signature verification')+': `stripe.webhooks.constructEvent()`',
      '- '+(G?'冪等性':'Idempotency')+': event.id '+(G?'でDB重複チェック':'DB dedup check'),
      '- '+(G?'顧客紐付':'Customer mapping')+': User.stripe_customer_id','',
    );
  }
  const hasAdmin=/管理者|admin/i.test(a.target||'');
  if(hasAdmin){
    const rbacSectionNum=hasPay&&(a.payment||'').includes('Stripe')?6:5;
    specLines.push(
      (G?'## '+rbacSectionNum+'. ロール・権限設計 (RBAC)':'## '+rbacSectionNum+'. Role & Permission Design (RBAC)'),'',
      G?'### ロール定義':'### Role Definitions',
      '| '+(G?'ロール':'Role')+' | '+(G?'説明':'Description')+' | '+(G?'権限':'Permissions')+' |',
      '|--------|------|------|',
      '| user | '+(G?'一般ユーザー':'Regular user')+' | '+(G?'自分のデータのCRUD':'Own data CRUD')+' |',
      '| admin | '+(G?'管理者':'Administrator')+' | '+(G?'全データの閲覧・編集・ユーザー管理':'All data view/edit, user management')+' |',
      '| super_admin | '+(G?'スーパー管理者':'Super admin')+' | '+(G?'システム設定・ロール変更':'System config, role changes')+' |','',
      G?'### 権限チェック':'### Permission Check',
      '- profiles.role '+(G?'カラムでロール管理':'column for role management'),
      '- '+(G?'ミドルウェア':'Middleware')+': '+(arch.isBaaS?'RLS + auth.jwt() role check':(G?'API Middleware で role チェック':'API middleware role check')),
      '- '+(G?'管理者ルート':'Admin routes')+': /admin/ → role=admin '+(G?'以上':'or above'),
      '- '+(G?'監査ログ':'Audit log')+': '+(G?'管理者操作は全件記録':'Log all admin actions'),'',
    );
  }
  S.files['.spec/specification.md']=specLines.join('\n');
  const dirLines=[pn+'/',
    '├── src/',
    '│   ├── app/          # '+(G?'ページ・ルーティング':'Pages & routing'),
    '│   ├── components/   # '+(G?'UIコンポーネント':'UI components'),
    '│   ├── lib/          # '+(G?'ユーティリティ':'Utilities'),
    '│   ├── hooks/        # '+(G?'カスタムフック':'Custom hooks'),
    '│   └── types/        # '+(G?'TypeScript型定義':'TypeScript types')];
  if(arch.isBaaS){
    if(be.includes('Supabase')) dirLines.push('├── supabase/         # '+(G?'マイグレーション・Edge Functions':'Migrations & Edge Functions'));
    else if(be.includes('Firebase')) dirLines.push('├── functions/        # '+(G?'Cloud Functions':'Cloud Functions'));
  } else {
    if(arch.pattern!=='bff') dirLines.push('├── api/              # '+(G?'バックエンドAPI':'Backend API'));
    const ormN=(a.orm&&a.orm.includes('Drizzle'))?'drizzle':'prisma';
    dirLines.push('├── '+ormN+'/           # '+(G?'スキーマ・マイグレーション':'Schema & migrations'));
  }
  dirLines.push('├── tests/            # '+(G?'テスト':'Tests'),
    '├── .spec/            # '+(G?'SDD仕様書':'SDD specs'),
    '├── .devcontainer/    # '+(G?'開発環境':'Dev environment'),
    '├── roadmap/          # '+(G?'学習ロードマップ':'Learning roadmap'),
    '└── docs/             # '+(G?'ドキュメント':'Documents'));
  const dirNote=arch.pattern==='bff'?'\n> '+(G?'Note: Express のロジックは src/app/api/ 配下の Route Handlers に統合':'Note: Express logic integrated into src/app/api/ Route Handlers')+'\n':'';
  const entities=(a.data_entities||'users, items').split(/[,、]\s*/).map(e=>e.trim()).filter(Boolean);
  const entityLines=entities.map(en=>{
    const cols=getEntityColumns(en,G,entities);
    const lines=['### '+en,'- id: UUID (PK)'];
    cols.forEach(c=>lines.push('- '+c.col+': '+c.type+(c.constraint?' ('+c.constraint+')':'')+(c.desc?' — '+c.desc:'')));
    lines.push('- created_at: timestamp','- updated_at: timestamp');
    return lines.join('\n');
  }).join('\n\n');
  const er=inferER(a);
  const erRelSection=er.relationships.length?'\n'+(G?'### リレーション':'### Relationships')+'\n```\n'+er.relationships.join('\n')+'\n```':'';
  const erWarnSection=er.warnings.length?'\n'+(G?'### ⚠️ ドメイン適合性の注記':'### ⚠️ Domain Fit Notes')+'\n'+er.warnings.join('\n'):'';
  const supaNote=(arch.isBaaS&&be.includes('Supabase'))?'> '+(G?'Supabase Dashboard または supabase/migrations/ でスキーマ管理':'Manage schema via Supabase Dashboard or supabase/migrations/')+'\n\n':'';
  const deployNote=arch.pattern==='split'?' (FE) + Railway/Render ('+be+')':'';
  let rlsSection='';
  if(arch.isBaaS&&be.includes('Supabase')){
    const rlsLines=[G?'### RLS（Row Level Security）方針':'### RLS (Row Level Security) Policy',
      G?'全テーブルにRLS有効化。ポリシー例:':'Enable RLS on all tables. Policy examples:','','```sql'];
    (a.data_entities||'').split(/[,、]\s*/).map(e=>e.trim()).filter(Boolean).forEach(e=>{
      const en=e.trim();const tbl=pluralize(en);
      const cols=getEntityColumns(en,G,entities);
      const hasUserId=cols.some(c=>c.col==='user_id');
      const hasOwnerId=cols.some(c=>c.col==='owner_id'||c.col==='instructor_id'||c.col==='provider_id'||c.col==='sender_id');
      const ownerCol=hasUserId?'user_id':cols.find(c=>c.col==='owner_id'||c.col==='instructor_id'||c.col==='provider_id')?.col;
      if(en.toLowerCase()==='user'){
        rlsLines.push(`-- ${tbl}: ${G?'本人のみ読取・更新':'Owner read/update only'}`,
          `CREATE POLICY "${tbl}_select" ON ${tbl} FOR SELECT USING (auth.uid() = id);`,
          `CREATE POLICY "${tbl}_update" ON ${tbl} FOR UPDATE USING (auth.uid() = id);`,'');
      } else if(ownerCol){
        rlsLines.push(`-- ${tbl}: ${G?'本人のデータのみ操作可':'Owner CRUD only'}`,
          `CREATE POLICY "${tbl}_select" ON ${tbl} FOR SELECT USING (auth.uid() = ${ownerCol});`,
          `CREATE POLICY "${tbl}_insert" ON ${tbl} FOR INSERT WITH CHECK (auth.uid() = ${ownerCol});`,
          `CREATE POLICY "${tbl}_update" ON ${tbl} FOR UPDATE USING (auth.uid() = ${ownerCol});`,
          `CREATE POLICY "${tbl}_delete" ON ${tbl} FOR DELETE USING (auth.uid() = ${ownerCol});`,'');
      } else {
        rlsLines.push(`-- ${tbl}: ${G?'認証ユーザーは読取可':'Authenticated read'}`,
          `CREATE POLICY "${tbl}_select" ON ${tbl} FOR SELECT USING (auth.role() = 'authenticated');`,'');
      }
    });
    rlsLines.push('```');
    rlsSection='\n'+rlsLines.join('\n');
  }
  const hasStripe=hasPay&&(a.payment||'').includes('Stripe');
  let stripeSection='';
  if(hasStripe){
    const fn=arch.isBaaS&&be.includes('Supabase')?'Supabase Edge Function':'API Route';
    stripeSection='\n\n'+(G?'## 7. 決済設計 (Stripe)':'## 7. Payment Design (Stripe)')+'\n\n'+
      (G?'### サブスクリプションモデル':'### Subscription Model')+'\n'+
      '| '+(G?'プラン':'Plan')+' | '+(G?'価格':'Price')+' | '+(G?'機能制限':'Limits')+' |\n'+
      '|------|------|------|\n'+
      '| Free | ¥0 | '+(G?'基本機能のみ':'Basic features only')+' |\n'+
      '| Pro | ¥980/'+(G?'月':'mo')+' | '+(G?'全機能+優先サポート':'All features + priority support')+' |\n'+
      '| Enterprise | ¥9,800/'+(G?'月':'mo')+' | '+(G?'全機能+SLA+専用サポート':'All features + SLA + dedicated support')+' |\n\n'+
      (G?'### Webhook処理フロー':'### Webhook Flow')+'\n```\n'+
      'Stripe → POST /api/webhook/stripe → '+(G?'署名検証':'Verify signature')+'\n'+
      '  ├── invoice.paid → subscription.status = active\n'+
      '  ├── invoice.payment_failed → '+(G?'リトライ通知メール':'Retry notification email')+'\n'+
      '  ├── customer.subscription.deleted → subscription.status = canceled\n'+
      '  └── customer.subscription.updated → '+(G?'プラン変更反映':'Update plan info')+'\n```\n\n'+
      (G?'### DB設計':'### DB Design')+'\n'+
      (G?'subscriptions テーブル:':'subscriptions table:')+'\n'+
      '- user_id: UUID (FK → users)\n'+
      '- stripe_subscription_id: TEXT (UNIQUE)\n'+
      '- stripe_customer_id: TEXT\n'+
      '- status: active | canceled | past_due | trialing\n'+
      '- plan: free | pro | enterprise\n'+
      '- current_period_end: TIMESTAMP\n\n'+
      (G?'### 実装場所':'### Implementation')+': '+fn+'\n'+
      '- POST /api/checkout → stripe.checkout.sessions.create()\n'+
      '- POST /api/webhook/stripe → '+(G?'イベント処理':'Event handling')+'\n'+
      '- GET /api/subscription → '+(G?'現在のプラン取得':'Get current plan');
  }
  const fullEntitySection=supaNote+entityLines+erRelSection+erWarnSection+rlsSection;
  S.files['.spec/technical-plan.md']=[
    '# '+pn+' — '+(G?'技術計画書 (Technical Plan)':'Technical Plan'),
    '> Generated by DevForge v9 — '+date,'',
    G?'## 1. アーキテクチャ概要':'## 1. Architecture Overview',
    (G?'### パターン':'### Pattern')+': '+archLabel,'','```',arch.diagram,'```',
    arch.note?'\n> '+arch.note+'\n':'',
    G?'## 2. ディレクトリ構造':'## 2. Directory Structure','```',dirLines.join('\n'),'```',dirNote,'',
    G?'## 3. データベース設計':'## 3. Database Design',fullEntitySection,'',
    G?'## 4. 認証設計':'## 4. Auth Design',
    '- '+(G?'認証SoT':'Auth SoT')+': **'+auth.sot+'**',
    '- '+(G?'トークン':'Token')+': '+auth.tokenType,
    '- '+(G?'検証方法':'Verification')+': '+auth.tokenVerify,
    auth.social.length?'- '+(G?'対応プロバイダ':'Providers')+': '+auth.social.join(', '):'','',
    G?'## 5. 開発環境':'## 5. Dev Environment',
    '- Docker DevContainer (.devcontainer/)',
    '- '+(arch.isBaaS?be+' CLI (local emulator)':'Node.js LTS + '+db),
    '- '+((a.ai_tools||'Cursor').split(', ')[0])+' + '+(G?'AI支援':'AI-assisted'),'',
    '## 6. CI/CD','- GitHub Actions','- lint → test → build → deploy',
    '- '+(G?'デプロイ先':'Deploy')+': '+(a.deploy||'Vercel')+deployNote,
    stripeSection,''
  ].join('\n');
  const sprintTasks=(si)=>{
    if(si===0) return ['- [ ] '+(G?'リポジトリ作成・初期設定':'Repo init & config'),
      '- [ ] '+(G?'DevContainer設定':'DevContainer setup'),
      '- [ ] '+(G?'CI/CD パイプライン構築':'CI/CD pipeline'),
      '- [ ] '+(G?'データベーススキーマ定義':'Database schema')+((arch.isBaaS&&be.includes('Supabase'))?' + '+(G?'RLSポリシー設定':'RLS policy setup'):''),
      '- [ ] '+(G?'認証基盤実装':'Auth implementation')+' ('+auth.sot+')'].join('\n');
    if(si===1) return (a.mvp_features||(G?'CRUD操作':'CRUD Operations')).split(', ').map(f=>'- [ ] '+f).join('\n');
    if(si===2) return (a.screens||(G?'ダッシュボード, ログイン':'Dashboard, Login')).split(', ').map(s=>'- [ ] '+s+' '+(G?'画面実装':'screen')).join('\n');
    if(si===3) return ['- [ ] '+(G?'ユニットテスト (カバレッジ80%+)':'Unit tests (80%+ coverage)'),
      '- [ ] '+(G?'E2Eテスト (主要フロー)':'E2E tests (key flows)'),
      '- [ ] '+(G?'パフォーマンス最適化':'Performance optimization'),
      '- [ ] '+(G?'本番デプロイ':'Production deploy'),
      '- [ ] '+(G?'ドキュメント整備':'Documentation')].join('\n');
    if(si===4) return ['- [ ] '+a.mobile+' '+(G?'プロジェクト初期化':'project init'),
      '- [ ] '+(G?'画面実装（モバイル版）':'Mobile screens'),
      '- [ ] '+(G?'ストアビルド設定':'Store build config'),
      '- [ ] '+(G?'テスト':'Testing')].join('\n');
    return '';
  };
  S.files['.spec/tasks.md']=[
    '# '+pn+' — '+(G?'タスク一覧 (Tasks)':'Task List'),
    '> Generated by DevForge v9 — '+date,
    '> '+(G?'計画期間':'Timeline')+': '+sched.totalWeeks+' '+(G?'週間':'weeks')+' ('+sched.startDate+' 〜)','',
    ...sched.sprints.map((sp,i)=>'## '+sp.name+': '+(G?sp.focus_ja:sp.focus_en)+' ['+sp.weeks+']\n'+sprintTasks(i)),''
  ].join('\n\n');
  const mobTest=hasMob?'| '+(G?'モバイルE2E':'Mobile E2E')+' | Maestro / Detox | '+(G?'主要フロー':'Key flows')+' |':'';
  const rlsTest=(arch.isBaaS&&be.includes('Supabase'))?'- [ ] '+(G?'RLSポリシーテスト (全テーブル)':'RLS policy tests (all tables)'):'';
  const features=(a.mvp_features||'').split(', ').filter(Boolean);
  S.files['.spec/verification.md']=[
    '# '+pn+' — '+(G?'検証計画書 (Verification)':'Verification Plan'),
    '> Generated by DevForge v9 — '+date,'',
    G?'## 1. テスト戦略':'## 1. Test Strategy',
    '| '+(G?'テスト種別':'Test Type')+' | '+(G?'ツール':'Tool')+' | '+(G?'カバレッジ目標':'Coverage Goal')+' |',
    '|-----------|--------|-------------|',
    '| '+(G?'ユニットテスト':'Unit Test')+' | Vitest | 80% |',
    '| '+(G?'統合テスト':'Integration')+' | Vitest | '+(G?'主要API全て':'All major APIs')+' |',
    '| '+(G?'E2Eテスト':'E2E Test')+' | Playwright | '+(G?'主要フロー':'Key flows')+' |',
    mobTest,'',
    G?'## 2. 駆動開発手法による検証':'## 2. Dev Method Verification',
    methods.map(m=>'### '+m+'\n- '+(G?'実施タイミング: 全Sprint':'Timing: All sprints')+'\n- '+(G?'検証項目: 仕様との整合性':'Verify: Spec alignment')).join('\n\n'),'',
    G?'## 3. パフォーマンス基準':'## 3. Performance Benchmarks',
    '- Lighthouse Score: 90+','- LCP: < 2.5s','- FID: < 100ms','- CLS: < 0.1','',
    G?'## 4. セキュリティチェック':'## 4. Security Checklist',
    '- [ ] '+(G?'OWASP Top 10対策確認':'OWASP Top 10 compliance'),
    '- [ ] '+(G?'依存パッケージ脆弱性スキャン':'Dependency vulnerability scan'),
    '- [ ] '+(G?'認証・認可テスト':'Auth/authorization tests')+' ('+auth.sot+')',
    '- [ ] '+(G?'データバリデーション確認':'Data validation check'),
    rlsTest,'',
    G?'## 5. 機能別検証チェックリスト':'## 5. Feature Verification Checklist',
    ...features.flatMap(f=>{
      const fd=getFeatureDetail(f);
      if(!fd) return ['### '+f,'- [ ] '+(G?'実装完了':'Implementation done'),'- [ ] '+(G?'ユニットテスト通過':'Unit tests passing'),''];
      const criteria=(G?fd.criteria_ja:fd.criteria_en).map(c=>c.replace(/\{auth\}/g,a.auth||'OAuth'));
      return ['### '+f,...criteria.map(c=>'- [ ] '+c),''];
    }),
  ].join('\n');
}
function genPillar2_DevContainer(a,pn){
  const G=S.genLang==='ja';
  const fe=a.frontend||'React';
  const be=a.backend||'Node.js + Express';
  const db=a.database||'PostgreSQL';
  const orm=a.orm||'';
  const isNode=be.includes('Node')||be.includes('Express')||be.includes('Fastify')||be.includes('Hono')||be.includes('NestJS');
  const isPython=be.includes('Python')||be.includes('Django')||be.includes('FastAPI');
  const isBaaS=/Supabase|Firebase|Convex/.test(be);
  const isSupabase=be.includes('Supabase');
  const isFirebase=be.includes('Firebase');
  const baseImage=isNode||isBaaS?'mcr.microsoft.com/devcontainers/javascript-node:22':isPython?'mcr.microsoft.com/devcontainers/python:3.12':'mcr.microsoft.com/devcontainers/base:ubuntu';
  const dbService=isBaaS?'':db.includes('Postgre')?'postgres':db.includes('Mongo')?'mongo':db.includes('MySQL')?'mysql':'';
  const exts=['dbaeumer.vscode-eslint','esbenp.prettier-vscode','bradlc.vscode-tailwindcss'];
  if(isSupabase) exts.push('supabase.supabase-vscode');
  else if(isNode&&!isBaaS&&(orm.includes('Prisma')||!orm)) exts.push('prisma.prisma');
  else if(isPython) exts.push('ms-python.python');
  exts.push('github.copilot','github.copilot-chat');
  const ports=[3000];
  if(isSupabase) ports.push(54321,54322,54323); // Supabase API + Auth + Studio
  else if(isFirebase) ports.push(4000,9099); // Emulator UI + Auth
  else if(dbService==='postgres') ports.push(5432);
  else if(dbService==='mongo') ports.push(27017);
  else if(isPython) ports.push(8000);
  S.files['.devcontainer/devcontainer.json']=JSON.stringify({
    name:pn+' Dev Environment',
    dockerComposeFile:'docker-compose.yml',
    service:'app',
    workspaceFolder:'/workspace',
    customizations:{vscode:{extensions:exts.filter(Boolean),settings:{'editor.formatOnSave':true,'editor.defaultFormatter':'esbenp.prettier-vscode'}}},
    forwardPorts:ports,
    postCreateCommand:'bash .devcontainer/post-create.sh',
    features:{'ghcr.io/devcontainers/features/docker-in-docker:2':{}}
  },null,2);
  let dockerLines=['FROM '+baseImage];
  if(isNode||isBaaS) dockerLines.push('RUN npm install -g pnpm@latest');
  else if(isPython) dockerLines.push('RUN pip install --upgrade pip');
  if(isSupabase) dockerLines.push('RUN npm install -g supabase@latest');
  if(isFirebase) dockerLines.push('RUN npm install -g firebase-tools@latest');
  dockerLines.push('WORKDIR /workspace');
  if(isNode||isBaaS){dockerLines.push('COPY package*.json ./','RUN npm install');}
  else if(isPython){dockerLines.push('COPY requirements.txt ./','RUN pip install -r requirements.txt');}
  dockerLines.push('COPY . .');
  S.files['.devcontainer/Dockerfile']=dockerLines.join('\n')+'\n';
  let compose='version: \'3.8\'\nservices:\n  app:\n    build:\n      context: ..\n      dockerfile: .devcontainer/Dockerfile\n    volumes:\n      - ..:/workspace:cached\n    command: sleep infinity\n    ports:\n      - "3000:3000"\n';
  if(isSupabase) compose+='      - "54321:54321"\n      - "54322:54322"\n      - "54323:54323"\n';
  else if(isFirebase) compose+='      - "4000:4000"\n      - "9099:9099"\n';
  if(dbService==='postgres') compose+='  db:\n    image: postgres:16\n    environment:\n      POSTGRES_USER: dev\n      POSTGRES_PASSWORD: devpass\n      POSTGRES_DB: '+pn.toLowerCase().replace(/[^a-z0-9]/g,'_')+'\n    ports:\n      - "5432:5432"\n    volumes:\n      - pgdata:/var/lib/postgresql/data\nvolumes:\n  pgdata:\n';
  else if(dbService==='mongo') compose+='  db:\n    image: mongo:7\n    ports:\n      - "27017:27017"\n    volumes:\n      - mongodata:/data/db\nvolumes:\n  mongodata:\n';
  else if(dbService==='mysql') compose+='  db:\n    image: mysql:8\n    environment:\n      MYSQL_ROOT_PASSWORD: devpass\n      MYSQL_DATABASE: '+pn.toLowerCase().replace(/[^a-z0-9]/g,'_')+'\n    ports:\n      - "3306:3306"\n    volumes:\n      - mysqldata:/var/lib/mysql\nvolumes:\n  mysqldata:\n';
  S.files['.devcontainer/docker-compose.yml']=compose;
  const postLines=['#!/bin/bash','echo "🚀 Setting up '+pn+'..."'];
  if(isNode||isBaaS) postLines.push('npm install');
  else if(isPython) postLines.push('pip install -r requirements.txt');
  if(isSupabase){
    postLines.push('','# Supabase local development','npx supabase init --force 2>/dev/null || true','npx supabase start','echo "📦 Supabase Studio: http://localhost:54323"');
  } else if(isFirebase){
    postLines.push('','# Firebase emulators','firebase init emulators --non-interactive 2>/dev/null || true','echo "📦 Start emulators with: firebase emulators:start"');
  } else if(isNode&&dbService==='postgres'){
    if(orm.includes('Drizzle')){
      postLines.push('npx drizzle-kit push','echo "📦 Drizzle Studio: npx drizzle-kit studio"');
    } else {
      postLines.push('npx prisma generate','npx prisma db push');
    }
  }
  postLines.push('','echo "✅ Setup complete! Run \'npm run dev\' to start."');
  S.files['.devcontainer/post-create.sh']=postLines.join('\n')+'\n';
  const envPrefix=fe.includes('Next')?'NEXT_PUBLIC_':fe.includes('Vite')||fe.includes('SPA')?'VITE_':'REACT_APP_';
  const envLines=['# Environment Variables','# Copy to .env.local and fill in values',''];
  if(isSupabase){
    envLines.push('# Supabase',envPrefix+'SUPABASE_URL=http://localhost:54321',envPrefix+'SUPABASE_ANON_KEY=your-anon-key','SUPABASE_SERVICE_ROLE_KEY=your-service-role-key');
  } else if(isFirebase){
    envLines.push('# Firebase',envPrefix+'FIREBASE_API_KEY=',envPrefix+'FIREBASE_AUTH_DOMAIN=',envPrefix+'FIREBASE_PROJECT_ID=');
  } else if(dbService==='postgres'){
    envLines.push('# Database','DATABASE_URL=postgresql://dev:devpass@localhost:5432/'+pn.toLowerCase().replace(/[^a-z0-9]/g,'_'));
  }
  envLines.push('','# Auth','AUTH_SECRET=your-secret-here','');
  const hasPay=a.payment&&!/なし|None|none/.test(a.payment);
  if(hasPay&&a.payment.includes('Stripe')){
    envLines.push('# Stripe','STRIPE_SECRET_KEY=sk_test_xxx','STRIPE_WEBHOOK_SECRET=whsec_xxx',envPrefix+'STRIPE_PUBLISHABLE_KEY=pk_test_xxx','');
  }
  S.files['.env.example']=envLines.join('\n');
}
function genPillar3_MCP(a,pn){
  const G=S.genLang==='ja';
  const tools=(a.ai_tools||'Cursor').split(', ');
  const auth=resolveAuth(a);
  const arch=resolveArch(a);
  const archLabel=G?{baas:'BaaS統合型',bff:'BFF(API Routes)',split:'FE/BE分離',traditional:'従来型'}[arch.pattern]:{baas:'BaaS Integration',bff:'BFF (API Routes)',split:'FE/BE Split',traditional:'Traditional'}[arch.pattern];
  const er=inferER(a);
  S.files['.mcp/project-context.md']=`# ${pn} — MCP Project Context
## Project Overview
- Name: ${pn}
- Purpose: ${a.purpose||'N/A'}
- Stack: ${a.frontend||'React'} + ${a.backend||'Node.js'} + ${a.database||'PostgreSQL'}
- Architecture: ${archLabel}
- Auth SoT: ${auth.sot}
- Deploy: ${a.deploy||'Vercel'}${arch.pattern==='split'?' (FE) + Railway/Render (BE)':''}
${!isNone(a.mobile)?`- Mobile: ${a.mobile}\n`:''}${!isNone(a.payment)?`- Payment: ${a.payment}\n`:''}
## Key Entities
${a.data_entities||'users, items'}
${er.relationships.length?'\n## Relationships\n'+er.relationships.join('\n'):''}
## Dev Methods
${a.dev_methods||'TDD, BDD'}
## AI Tools
${tools.join(', ')}
`;
  const mcpServers={
    filesystem:{command:'npx',args:['-y','@anthropic/mcp-filesystem','/workspace']},
    context7:{command:'npx',args:['-y','@anthropic/mcp-context7']},
    playwright:{command:'npx',args:['-y','@anthropic/mcp-playwright']},
  };
  if(a.backend&&a.backend.includes('Supabase')){
    mcpServers.supabase={command:'npx',args:['-y','@anthropic/mcp-supabase']};
  }
  S.files['.mcp/tools-manifest.json']=JSON.stringify({
    schema:'1.0',project:pn,
    mcpServers:mcpServers,
    recommendations:G?['context7 — 最新ドキュメント参照','playwright — E2Eテスト自動化','filesystem — ファイル操作']:['context7 — Latest docs reference','playwright — E2E test automation','filesystem — File operations']
  },null,2);
  S.files['mcp-config.json']=JSON.stringify({
    mcpServers:{
      filesystem:{command:'npx',args:['-y','@anthropic/mcp-filesystem','.']},
      context7:{command:'npx',args:['-y','@anthropic/mcp-context7']},
    }
  },null,2);
}
function genPillar4_AIRules(a,pn){
  const G=S.genLang==='ja';
  const db=a.database||'PostgreSQL';
  const be=a.backend||'Node.js + Express';
  const auth=resolveAuth(a);
  const arch=resolveArch(a);
  const orm=arch.isBaaS?(be.includes('Supabase')?'Supabase Client SDK':be.includes('Firebase')?'Firebase SDK':'Convex Client'):(a.orm&&a.orm.includes('Drizzle')?'Drizzle ORM':'Prisma ORM');
  const archNote=G?{baas:'BaaS統合パターン（サーバーレス）',bff:'BFF パターン（Next.js API Routes統合）',split:'フロント/バック分離（別ホスト）',traditional:'従来型クライアント-サーバー'}[arch.pattern]:{baas:'BaaS Integration (serverless)',bff:'BFF Pattern (Next.js API Routes)',split:'FE/BE Split (separate hosts)',traditional:'Traditional Client-Server'}[arch.pattern];
  const core=`Project: ${pn}
Stack: ${a.frontend||'React'} + ${be} + ${db}
Architecture: ${archNote}
Auth SoT: ${auth.sot}
Methods: ${a.dev_methods||'TDD'}
Entities: ${a.data_entities||'users'}
Purpose: ${a.purpose||'N/A'}`;
  const coreRules=`1. Always use TypeScript with strict mode
2. Follow ${(a.dev_methods||'TDD').split(', ')[0]} methodology
3. Write tests before implementation
4. Use ${a.frontend||'React'} conventions
5. Database: ${db} with ${orm}
6. Auth: ${auth.sot} — token type: ${auth.tokenType}
7. Architecture: ${archNote}
8. Follow project structure in .spec/technical-plan.md`;
  const forbidden=arch.isBaaS?
    `- No raw SQL in application code (use ${orm} methods)
  - OK: DDL/RLS/migration SQL in supabase/migrations/
- No separate Express/Fastify server (use ${be} functions)
- No manual JWT handling (use ${auth.sot})`:
    arch.pattern==='bff'?
    `- No separate Express server (use Next.js API Routes)
- No \`any\` types
- No console.log in production
- No hardcoded secrets`:
    `- No \`any\` types
- No console.log in production
- No hardcoded secrets
- No raw SQL in application code (use ${orm})
  - OK: DDL/migration SQL in migration files`;
  const cursorRules=`You are an AI assistant for "${pn}".
${core}
## Rules
${coreRules}
## Cursor-Specific
- Use @workspace to reference project context
- Use @file to reference spec files (.spec/, docs/)
- Leverage multi-file editing for related changes
- Before editing, read relevant specs with @file`;
  const clineRules=`You are an AI assistant for "${pn}".
${core}
## Rules
${coreRules}
## Cline-Specific
- Follow Plan→Act loop for each task
- After task completion: run npm test
- Update docs/24_progress.md after completing tasks
- Log errors to docs/25_error_logs.md`;
  const windsurfRules=`You are an AI assistant for "${pn}".
${core}
## Rules
${coreRules}
## Windsurf-Specific
- Leverage Cascade for context-aware coding
- Create Flows for repetitive tasks
- Keep context focused: AI_BRIEF.md + current task only
- Use Flows to automate test generation`;
  const copilotRules=`You are an AI assistant for "${pn}".
${core}
## Rules
${coreRules}`;
  S.files['.cursor/rules']=cursorRules;
  S.files['.github/copilot-instructions.md']=`# GitHub Copilot Instructions\n${copilotRules}`;
  S.files['.windsurfrules']=windsurfRules;
  S.files['.clinerules']=clineRules;
  S.files['.kiro/spec.md']=`# Kiro Spec\n${core}\n\n## Spec Files\nSee .spec/ directory for full specifications.`;
  const domain=detectDomain(a.purpose)||'_default';
  const pb=DOMAIN_PLAYBOOK[domain]||DOMAIN_PLAYBOOK._default;
  let domainCtx='';
  if(pb&&pb.ctx_ja&&pb.ctx_ja.length>0&&pb.ctx_ja[0]!==''){
    domainCtx='\n\n## Domain Context Rotation\n| '+(G?'タスク種別':'Task Type')+' | '+(G?'参照ドキュメント':'Reference Docs')+' |\n|------|------|\n';
    const ctx=G?pb.ctx_ja:pb.ctx_en;
    ctx.forEach(c=>{
      const[task,docs]=c.split('→');
      domainCtx+='| '+task+' | '+docs+' |\n';
    });
  }
  S.files['CLAUDE.md']=`# CLAUDE.md — ${pn}\n${core}\n\n## Spec-Driven Development\nRead .spec/constitution.md first.\nAll changes must align with .spec/specification.md.\nUse .spec/tasks.md as the source of truth for work items.\n\n## Auth\n- Source of Truth: ${auth.sot}\n- Token: ${auth.tokenType}\n- Verification: ${auth.tokenVerify}\n${auth.social.length?'- Providers: '+auth.social.join(', '):''}\n\n## Code Style\n- TypeScript strict\n- ESLint + Prettier\n- Vitest for testing\n- ${orm} for ${db}\n\n## Forbidden\n${forbidden}\n\n## Workflow Cycle\n1. Read docs/ → Select needed context\n2. Plan → Outline approach before coding\n3. Implement → Code with tests\n4. Update docs/24_progress.md → Mark completed tasks\n5. Log errors to docs/25_error_logs.md → Prevent recurrence\n\n## Thinking Protocol\nBefore implementing any change:\n1. State the task in one sentence\n2. List files that will be modified\n3. Identify potential side effects\n4. Implement → Test → Verify\n\n## Context Management\n- Write: All specs live in docs/ — read before coding\n- Select: Only load files relevant to current task\n- Compress: If context is large, read AI_BRIEF.md (~3K tokens) instead\n- Isolate: Use subagents for research, keep main context clean${domainCtx}\n\n## Key Context Files\n| File | When to Read | Tokens |\n|------|-------------|--------|\n| AI_BRIEF.md | Always (start here) | ~3K |\n| .spec/constitution.md | Before any change | ~1K |\n| .spec/tasks.md | Before picking work | ~1K |\n| docs/24_progress.md | Before/after tasks | ~0.5K |\n| docs/25_error_logs.md | When debugging | ~0.5K |`;
  S.files['AGENTS.md']=`# AGENTS.md — ${pn}\n\n## Agent Guidelines\n${core}\n\n## Task Assignment\n- Frontend agent: UI components, pages, styling\n- Backend agent: ${arch.isBaaS?a.backend+' functions, RLS policies':arch.pattern==='bff'?'Next.js API Routes, middleware':'API routes, database, auth'}\n- Test agent: Unit tests, E2E tests\n- DevOps agent: CI/CD, deployment\n\n## Coordination\n- All agents must read .spec/ before starting\n- Use tasks.md for work coordination\n- Commit with conventional commits`;
  S.files['codex-instructions.md']=`# Codex Instructions (OpenAI)\n${copilotRules}\n\n## Codex Agent Mode\n- Use agentic mode for multi-file refactoring\n- Verify changes with npm test before committing\n- Respect .spec/ constraints`;
  S.files['skills/project.md']=`# ${pn} ${G?'— AIスキル':'— AI Skills'}\n${G?'工場テンプレート形式。詳細はskills/catalog.md参照':'Factory Template format. See skills/catalog.md for details'}\n\n${G?'## スキル':'## Skills'}\n\n### 1. spec-review\n- **${G?'役割':'Role'}**: ${G?'設計':'Design'}\n- **${G?'目的':'Purpose'}**: ${G?'.spec/検証':'Verify .spec/'}\n- **${G?'入力':'Input'}**: .spec/constitution.md, specification.md\n- **${G?'判断':'Judgment'}**: ${G?'矛盾0件':' 0 contradictions'}\n- **${G?'次':'Next'}**: code-gen\n\n### 2. code-gen\n- **${G?'役割':'Role'}**: ${G?'制作':'Production'}\n- **${G?'目的':'Purpose'}**: ${G?'コード生成':'Generate code'}\n- **${G?'入力':'Input'}**: .spec/technical-plan.md\n- **${G?'判断':'Judgment'}**: ${G?'エラー0':'0 errors'}\n- **${G?'次':'Next'}**: test-gen\n\n### 3. test-gen\n- **${G?'役割':'Role'}**: ${G?'制作':'Production'}\n- **${G?'目的':'Purpose'}**: ${G?'テスト生成':'Generate tests'}\n- **${G?'入力':'Input'}**: ${G?'新規コード':'New code'}\n- **${G?'判断':'Judgment'}**: ${G?'カバレッジ80%+':'Coverage ≥80%'}\n- **${G?'次':'Next'}**: deploy-check\n\n### 4. doc-gen\n- **${G?'役割':'Role'}**: ${G?'運用':'Operations'}\n- **${G?'目的':'Purpose'}**: ${G?'ドキュメント生成':'Generate docs'}\n- **${G?'判断':'Judgment'}**: ${G?'未文書化0':'0 undocumented'}\n- **${G?'次':'Next'}**: refactor\n\n### 5. refactor\n- **${G?'役割':'Role'}**: ${G?'設計':'Design'}\n- **${G?'目的':'Purpose'}**: ${G?'リファクタリング提案':'Suggest refactoring'}\n- **${G?'判断':'Judgment'}**: ${G?'重複10%↓':'Duplication ≤10%'}\n- **${G?'次':'Next'}**: spec-review\n\n${G?'## テンプレート':'## Template'}\n\`\`\`markdown\n### [skill-id]\n- **${G?'役割':'Role'}**: [Planning/Design/Production/Operations]\n- **${G?'目的':'Purpose'}**: [${G?'何をするか':'What it does'}]\n- **${G?'判断':'Judgment'}**: [${G?'成功条件':'Success criteria'}]\n- **${G?'次':'Next'}**: [${G?'次のスキル':'Next skill'}]\n\`\`\`\n`;
  S.files['.gemini/settings.json']=`{\n  "project": "${pn}",\n  "model": "gemini-3-pro",\n  "context": {\n    "spec_dir": ".spec/",\n    "include": ["src/", "package.json", "tsconfig.json"],\n    "exclude": ["node_modules/", "dist/"]\n  },\n  "safety": "balanced",\n  "tools": ["code_execution", "grounding"]\n}`;
  S.files['.ai/hooks.yml']=`# AI Hooks Configuration
hooks:
  pre-commit:
    - name: lint-check
      command: npm run lint
    - name: type-check
      command: npx tsc --noEmit
  pre-push:
    - name: test
      command: npm test
  post-generate:
    - name: format
      command: npx prettier --write .
`;
  const entities=(a.data_entities||'User').split(/[,、]\s*/).map(e=>e.trim()).filter(Boolean);
  const features=(a.mvp_features||'CRUD').split(', ').filter(Boolean);
  const screens=(a.screens||'Dashboard').split(', ').filter(Boolean);
  const fe=a.frontend||'React';
  const deploy=a.deploy||'Vercel';
  const dbSchema=entities.map(en=>{
    const cols=getEntityColumns(en,G,entities);
    const colList=cols.map(c=>{
      const fk=c.constraint.includes('FK')?` → ${c.constraint.match(/FK\((\w+)\)/)?.[1]||'?'}`:'';
      const req=c.constraint.includes('NOT NULL')?'!':'';
      return `${c.col}${req}:${c.type.replace('VARCHAR(255)','str').replace('VARCHAR(100)','str').replace('VARCHAR(50)','str').replace('VARCHAR(20)','enum').replace('DECIMAL(10,2)','decimal').replace('BOOLEAN','bool').replace('TIMESTAMP','ts').replace('BIGINT','bigint').replace('JSONB','json').replace('UUID','uuid').replace('TEXT','text').replace('DATE','date').replace('TIME','time').replace('INT','int')}${fk}`;
    }).join(', ');
    return `  ${en}: id:uuid(PK)${colList?', '+colList:''}, created_at:ts, updated_at:ts`;
  }).join('\n');
  const erData=inferER(a);
  const erCompact=erData.relationships.map(r=>r.replace(/\s+/g,' ')).join('; ');
  const featureCompact=features.map(f=>{
    const fd=getFeatureDetail(f);
    if(fd){
      const criteria=(G?fd.criteria_ja:fd.criteria_en).map(c=>c.replace(/\{auth\}/g,a.auth||'OAuth'));
      return `  ${f}: ${criteria.slice(0,4).join(' / ')}`;
    }
    return `  ${f}`;
  }).join('\n');
  const routes=genRoutes(a);
  const routeCompact=routes.map(r=>`${r.auth?'🔒':'🌐'} ${r.path} → ${r.name}`).join(', ');
  let rlsCompact='';
  if(arch.isBaaS&&be.includes('Supabase')){
    rlsCompact=entities.map(en=>{
      const cols=getEntityColumns(en,G,entities);
      const ownerCol=en.toLowerCase()==='user'?'id':cols.find(c=>c.col==='user_id'||c.col==='owner_id'||c.col==='instructor_id'||c.col==='provider_id')?.col;
      if(!ownerCol) return `  ${pluralize(en)}: authenticated=SELECT`;
      return `  ${pluralize(en)}: auth.uid()=${ownerCol} → SELECT/INSERT/UPDATE/DELETE`;
    }).join('\n');
  }
  let stripeCompact='';
  if(a.payment&&(a.payment||'').includes('Stripe')){
    stripeCompact=`
## Payment (Stripe)
Plans: Free(¥0) / Pro(¥980/mo) / Enterprise(¥9,800/mo)
Webhook: POST /api/webhook/stripe
  invoice.paid → subscription.status=active
  customer.subscription.deleted → status=canceled
Tables: subscriptions(user_id, stripe_subscription_id, stripe_customer_id, status, plan, current_period_end)
Keys: STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`;
  }
  let rbacCompact='';
  const hasAdminBrief=/管理者|admin/i.test(a.target||'');
  if(hasAdminBrief){
    rbacCompact=`
## RBAC
Roles: user(own data) / admin(all data, user mgmt)${/講師|instructor/i.test(a.target||'')?` / instructor(own content+students)`:''}
Column: profiles.role
Admin routes: /admin/ → role=admin check`;
  }
  S.files['AI_BRIEF.md']=`# ${pn} — AI Implementation Brief
> ${G?'このファイル1つで開発開始可能。':'Start coding with this single file.'} ~3K tokens.
## Stack
${fe} + ${be} + ${a.database||'PostgreSQL'} → ${deploy}
Auth: ${auth.sot} (${auth.tokenType})
ORM: ${orm}
Pattern: ${archNote}
## Context Protocol
1. Start: Read THIS file (AI_BRIEF.md)
2. Deep dive: .spec/{constitution,specification}.md
3. Current state: docs/24_progress.md
4. Before coding: Relevant docs/ file
5. After task: Update docs/24_progress.md
6. On error: Log to docs/25_error_logs.md
7. Context full: Keep AI_BRIEF.md + current task only
## DB Schema
\`\`\`
${dbSchema}
\`\`\`
## Relationships
${erCompact}
${rlsCompact?'\n## RLS Policies\n'+rlsCompact:''}
## Features (MVP)
${featureCompact}
## Routes
${routeCompact}
${stripeCompact}${rbacCompact}
## Dev Rules
- TypeScript strict, Vitest, Playwright
- ${(a.dev_methods||'TDD').split(', ')[0]} methodology
- ${orm} for DB access
- ${auth.sot} for all auth
- Forbidden: ${arch.isBaaS?'raw SQL, Express server, manual JWT':'any types, console.log in prod, hardcoded secrets'}
## File Structure
.spec/           → ${G?'仕様書':'Specifications'} (constitution, specification, technical-plan, tasks, verification)
docs/            → ${G?'設計ドキュメント':'Design documents'} (ER, API, screen, test cases, security, etc.)
.devcontainer/   → ${G?'開発環境':'Dev environment'}
CLAUDE.md        → ${G?'Claude Code用ルール':'Claude Code rules'}
.cursor/rules    → ${G?'Cursor用ルール':'Cursor rules'}
## Quick Start
1. \`npm install\` → setup dependencies
2. Read this file → understand full spec
3. Create DB schema (see DB Schema above)
4. Implement features top-to-bottom (see Features)
5. Run \`npm test\` after each feature
`;
  const aiAuto=a.ai_auto||'';
  if(aiAuto&&!isNone(aiAuto)){
    const domain=detectDomain(a.purpose);
    const coreSkills=['0:要件レビュー:Req Review:要件検証:Verify reqs:欠落0:0 gaps','1:設計検証:Arch Review:技術評価:Eval tech:P0リスク0:0 P0 risks','2:実装支援:Code Support:実装支援:Impl support:エラー0:0 errors','3:デプロイ検証:Deploy Check:デプロイ前チェック:Pre-deploy check:全PASS:All PASS'];
    const domainSkillsMap={
      education:['1:教材設計:Curriculum:教材設計:Design curriculum:説明可能:Explainable','2:問題生成:Quiz Gen:問題生成:Gen quiz:各3問:3 each'],
      ec:['1:商品検証:Catalog:商品検証:Verify catalog:必須100%:Req 100%','1:決済検証:Checkout:決済検証:Verify checkout:OWASP準拠:OWASP OK'],
      saas:['0:機能仕様:Feature Spec:機能仕様:Feature spec:AC3+:≥3 AC','1:API設計:API Design:API設計:API design:違反0:0 violations'],
      community:['1:モデレーション:Moderation:モデレーション:Moderation:違反1%↓:≤1% violations','3:分析:Analytics:行動分析:Behavior analysis:可視化:Visualized'],
      booking:['0:予約設計:Booking Logic:予約設計:Booking logic:重複0:0 duplicates','2:リマインダー:Reminder:通知最適化:Optimize notify:到達95%+:≥95% delivery'],
      health:['1:記録検証:Health Log:健康記録検証:Verify health logs:異常値0:0 anomalies','2:目標設定:Goal Setting:目標達成率計算:Calc goal achievement:達成率可視化:Visualized rate'],
      marketplace:['0:取引設計:Trade Design:取引フロー設計:Design trade flow:安全性確保:Safety ensured','1:レビュー検証:Review Check:レビュー信頼性検証:Verify review trust:偽装0:0 fake'],
      content:['2:配信最適化:Delivery Opt:コンテンツ配信最適化:Optimize content delivery:遅延100ms↓:≤100ms delay','3:分析:Analytics:閲覧分析:View analytics:エンゲージ可視化:Engagement vis'],
      analytics:['1:ダッシュボード設計:Dashboard:ダッシュボード設計:Design dashboard:KPI明確:Clear KPI','2:レポート生成:Report Gen:レポート自動生成:Auto-gen reports:正確性100%:100% accuracy'],
      business:['0:CRM設計:CRM Design:顧客管理設計:Design CRM:リード漏れ0:0 lead loss','1:営業フロー:Sales Flow:営業プロセス最適化:Optimize sales process:CVR向上:Improve CVR'],
      iot:['1:デバイス管理:Device Mgmt:デバイス管理:Device management:全台接続:All connected','2:センサー分析:Sensor Analysis:センサーデータ分析:Analyze sensor data:異常検知:Anomaly detected','3:アラート設計:Alert Design:アラート設計:Design alerts:誤報1%↓:≤1% false alarm'],
      realestate:['0:物件管理:Property Mgmt:物件データ管理:Manage property data:登録100%:100% listed','1:内見予約:Viewing:内見予約管理:Manage viewings:重複0:0 overlaps','2:契約検証:Contract:契約書検証:Verify contracts:必須項目100%:100% required'],
      legal:['0:契約レビュー:Contract Review:契約書レビュー:Review contracts:リスク条項0:0 risk clauses','1:コンプライアンス:Compliance:法令準拠チェック:Compliance check:違反0:0 violations','3:文書管理:Doc Mgmt:文書バージョン管理:Doc version control:最新版追跡:Latest tracked'],
      hr:['0:採用フロー:Hiring Flow:採用プロセス設計:Design hiring flow:漏れ0:0 gaps','1:評価設計:Eval Design:評価制度設計:Design evaluation:基準明確:Clear criteria','3:オンボーディング:Onboarding:入社手続き管理:Manage onboarding:完了率100%:100% completion'],
      fintech:['1:取引検証:Tx Validation:取引データ検証:Validate transactions:不正0:0 fraud','1:リスク分析:Risk Analysis:リスク評価:Risk assessment:P0対応済:P0 addressed','3:レポート生成:Report Gen:財務レポート:Financial reports:正確性100%:100% accuracy']
    };
    const domainSkills=domainSkillsMap[domain]||[];
    const allSkills=[...coreSkills,...domainSkills];
    const roleNames=G?['企画 (Planning)','設計 (Design)','制作 (Production)','運用 (Operations)']:['Planning','Design','Production','Operations'];
    const skillDetails={
      '教材設計':{input:'docs/03,04',process:G?'ER図→学習フロー抽出→難易度分類→構成生成':'ER→flow→difficulty→curriculum',output:G?'構成マップ(md)':'Curriculum (md)'},
      '機能仕様':{input:'.spec/constitution',process:G?'使命→ストーリー抽出→受入条件3つ→優先度付与':'Mission→stories→3 AC→priority',output:G?'仕様書(md)':'Spec (md)'},
      'API設計':{input:'docs/04,05',process:G?'ER→エンドポイント生成→REST命名チェック→標準化':'ER→endpoints→REST check→standardize',output:G?'API仕様(OpenAPI)':'API spec (OpenAPI)'},
      '決済検証':{input:'docs/08',process:G?'OWASP照合→Webhook検証→RLSチェック':'OWASP→webhook→RLS',output:G?'チェックリスト':'Checklist'},
      '要件レビュー':{input:'.spec/constitution,specification',process:G?'使命→KPI照合→機能網羅チェック→欠落列挙':'Mission→KPI check→feature coverage→list gaps',output:G?'矛盾リスト+修正案':'Gap list + fix proposal'},
      '設計検証':{input:'.spec/technical-plan',process:G?'スタック評価→依存関係チェック→リスク分析→代替案':'Stack eval→deps check→risk→alternatives',output:G?'リスク評価表':'Risk assessment'},
      '実装支援':{input:'.spec/specification,technical-plan',process:G?'仕様読込→型定義→CRUD実装→テスト生成':'Read spec→types→CRUD impl→gen tests',output:G?'実装コード+テスト':'Code + tests'},
      'デプロイ検証':{input:'docs/09,ci.yml',process:G?'環境変数チェック→ビルド検証→ヘルスチェック→ロールバック確認':'Env check→build verify→health→rollback',output:G?'デプロイレポート':'Deploy report'},
      '問題生成':{input:'docs/03,Lesson',process:G?'学習目標抽出→難易度設定→正常系3問+異常系3問→解説生成':'Goals→difficulty→3 normal+3 edge→explanations',output:G?'問題セット(JSON)':'Quiz set (JSON)'},
      '商品検証':{input:'Product,Category',process:G?'必須フィールド検査→SKU重複チェック→価格妥当性→画像存在確認':'Required fields→SKU dup→price valid→image check',output:G?'検証レポート':'Validation report'},
      'モデレーション':{input:'Post,Comment',process:G?'禁止語チェック→スパム判定→報告集計→対応優先度付与':'Banned words→spam detect→report aggregate→priority',output:G?'モデレーションキュー':'Moderation queue'},
      '予約設計':{input:'Service,TimeSlot',process:G?'空き枠計算→重複検出→バッファ設定→通知設計':'Availability calc→dup detect→buffer→notify design',output:G?'予約ロジック仕様':'Booking logic spec'},
      '記録検証':{input:'HealthLog,Goal',process:G?'入力値範囲チェック→異常値検出→トレンド分析→アラート条件設定':'Range check→anomaly detect→trend→alert config',output:G?'健康レポート':'Health report'},
      'CRM設計':{input:'User,Contact',process:G?'リード定義→ファネル設計→スコアリング→自動化ルール':'Lead def→funnel→scoring→automation rules',output:G?'CRM設計書':'CRM design doc'},
      'デバイス管理':{input:'Device,Sensor',process:G?'デバイス登録→接続状態監視→ファーム更新管理→ログ収集':'Register→monitor→firmware→logs',output:G?'デバイス管理画面':'Device dashboard'},
      '物件管理':{input:'Property,Category',process:G?'物件登録→写真管理→間取り設定→公開管理':'Register→photos→floor plan→publish',output:G?'物件データベース':'Property DB'},
      '契約レビュー':{input:'Contract,Template',process:G?'テンプレート照合→リスク条項検出→期限チェック→承認フロー':'Template match→risk detect→deadline→approval',output:G?'レビュー結果':'Review result'},
      '採用フロー':{input:'JobPosting,Applicant',process:G?'求人作成→応募管理→面接調整→評価集約→内定':'Post→apply→interview→eval→offer',output:G?'採用パイプライン':'Hiring pipeline'},
      '取引検証':{input:'Transaction,Account',process:G?'残高確認→二重支払チェック→限度額検証→監査ログ':'Balance→dup check→limit→audit log',output:G?'検証レポート':'Validation report'}
    };
    let catalogMd=`# ${pn} ${G?'— AIスキルカタログ':'— AI Skills Catalog'}\n${G?'ドメイン特化スキル + コア開発スキル':'Domain-specific skills + core development skills'}\n\n`;
    roleNames.forEach((role,idx)=>{
      const roleSkills=allSkills.filter(s=>parseInt(s.split(':')[0])===idx);
      if(roleSkills.length===0)return;
      catalogMd+=`## ${role}\n\n`;
      roleSkills.forEach(s=>{
        const[,nameJa,nameEn,purposeJa,purposeEn,judgmentJa,judgmentEn]=s.split(':');
        const name=G?nameJa:nameEn;
        const purpose=G?purposeJa:purposeEn;
        const judgment=G?judgmentJa:judgmentEn;
        const detail=skillDetails[nameJa]||skillDetails[nameEn];
        catalogMd+=`### ${name}\n- **${G?'目的':'Purpose'}**: ${purpose}\n- **${G?'判断基準':'Judgment'}**: ${judgment}\n`;
        if(detail){
          catalogMd+=`- **${G?'入力':'Input'}**: ${detail.input}\n- **${G?'処理':'Process'}**: ${detail.process}\n- **${G?'出力':'Output'}**: ${detail.output}\n`;
        }else{
          catalogMd+=`- **${G?'入力':'Input'}**: ${G?'関連ドキュメント':'Relevant documents'}\n- **${G?'出力':'Output'}**: ${G?'検証レポート/生成物':'Validation report / deliverables'}\n`;
        }
        catalogMd+='\n';
      });
    });
    const hasMultiAgent=aiAuto.includes('Multi')||aiAuto.includes('マルチ')||aiAuto.includes('Full')||aiAuto.includes('フル')||aiAuto.includes('Orch');
    const hasFullAuto=aiAuto.includes('Full')||aiAuto.includes('フル')||aiAuto.includes('Orch');
    if(hasMultiAgent){
      catalogMd+=`## ${G?'高度スキル':'Advanced'}\n`;
      catalogMd+=`### ${G?'並列レビュー':'Parallel Review'}\n- **${G?'目的':'Purpose'}**: ${G?'複数エージェントで同時レビュー':'Multi-agent simultaneous review'}\n- **${G?'判断':'Judgment'}**: ${G?'全合意':'All agree'}\n- **${G?'入力':'Input'}**: ${G?'対象コード':'Target code'}\n- **${G?'処理':'Process'}**: ${G?'分割→並列レビュー→結果マージ→合意形成':'Split→parallel review→merge→consensus'}\n- **${G?'出力':'Output'}**: ${G?'統合レビュー':'Unified review'}\n\n`;
      catalogMd+=`### ${G?'コードレビュー自動化':'Auto Code Review'}\n- **${G?'目的':'Purpose'}**: ${G?'PR単位で自動コードレビュー':'Auto review per PR'}\n- **${G?'判断':'Judgment'}**: ${G?'問題0件':'0 issues'}\n- **${G?'入力':'Input'}**: ${G?'PRの差分':'PR diff'}\n- **${G?'処理':'Process'}**: ${G?'差分解析→パターンチェック→セキュリティスキャン→提案生成':'Diff→pattern check→security scan→suggestions'}\n- **${G?'出力':'Output'}**: ${G?'レビューコメント':'Review comments'}\n\n`;
      catalogMd+=`### ${G?'ドキュメント自動更新':'Auto Doc Update'}\n- **${G?'目的':'Purpose'}**: ${G?'コード変更に連動してドキュメント更新':'Update docs on code changes'}\n- **${G?'判断':'Judgment'}**: ${G?'乖離0':'0 drift'}\n- **${G?'入力':'Input'}**: ${G?'変更コード+既存docs/':'Changed code + existing docs/'}\n- **${G?'処理':'Process'}**: ${G?'変更検出→影響ドキュメント特定→差分生成→反映':'Detect change→find affected docs→gen diff→apply'}\n- **${G?'出力':'Output'}**: ${G?'更新済ドキュメント':'Updated docs'}\n\n`;
      catalogMd+=`### ${G?'圧縮':'Compression'}\n- **${G?'判断':'Judgment'}**: ${G?'トークン80%削減':'80% token reduction'}\n\n`;
    }
    if(hasFullAuto){
      catalogMd+=`## ${G?'自律':'Autonomous'}\n### ${G?'統括':'Orchestration'}\n- **${G?'判断':'Judgment'}**: ${G?'全完了':'All done'}\n### ${G?'自己修復':'Self-Heal'}\n- **${G?'判断':'Judgment'}**: ${G?'リトライ成功':'Retry OK'}\n\n`;
    }
    const domainPb=DOMAIN_PLAYBOOK[domain]||DOMAIN_PLAYBOOK._default;
    if(domainPb&&domainPb.skill_ja&&domainPb.skill_ja!==''){
      const skillParts=(G?domainPb.skill_ja:domainPb.skill_en).split('|');
      if(skillParts.length>=5){
        catalogMd+=`## ${G?'業種特化スキル':'Domain-Specific'}\n### ${G?'業種カスタムスキル':'Custom Domain Skill'}\n`;
        catalogMd+=`- **${G?'役割':'Role'}**: ${skillParts[0]}\n`;
        catalogMd+=`- **${G?'目的':'Purpose'}**: ${skillParts[1]}\n`;
        catalogMd+=`- **${G?'入力':'Input'}**: ${skillParts[2]}\n`;
        catalogMd+=`- **${G?'判断基準':'Judgment'}**: ${skillParts[3]}\n`;
        catalogMd+=`- **${G?'出力':'Output'}**: ${skillParts[4]}\n\n`;
      }
    }
    catalogMd+=`${G?'## 工場テンプレート':'## Factory Template'}\n${G?'詳細はskills/project.mdを参照':'See skills/project.md for template details'}\n`;
    S.files['skills/catalog.md']=catalogMd;
    const aiLevel=aiAuto.includes('Vibe')||aiAuto.includes('入門')?'vibe':aiAuto.includes('Agentic')||aiAuto.includes('開発')?'agentic':aiAuto.includes('Multi')||aiAuto.includes('マルチ')?'multi':aiAuto.includes('Full')||aiAuto.includes('フル')?'full':'orch';
    const basePipe={n:'Feature Dev',t:'New task',s:['req-review','arch-validate','code-gen','test-gen','deploy-check'],g:aiLevel==='vibe'||aiLevel==='agentic'?'human':'auto'};
    const bugPipe={n:'Bug Fix',t:'Bug report',s:['reproduce','root-cause','fix','test','log'],g:aiLevel==='vibe'?'human':'auto'};
    const pipelines=[basePipe];
    if(aiLevel!=='vibe')pipelines.push(bugPipe);
    if(aiLevel==='full'||aiLevel==='orch')pipelines.push({n:'Release',t:'Version tag',s:['qa','staging','security','prod'],g:'staging'});
    let pipelineMd=`# ${pn} ${G?'— パイプライン':'— Pipelines'}\n\n`;
    pipelines.forEach(p=>{
      pipelineMd+=`## ${p.n}\n- **${G?'トリガー':'Trigger'}**: ${p.t}\n- **${G?'スキル':'Skills'}**: ${p.s.join(' → ')}\n- **${G?'ゲート':'Gate'}**: ${p.g}\n- **${G?'エラー':'Error'}**: ${G?'ログ → リトライ':'log → retry'}\n\n\`\`\`mermaid\ngraph LR\n  T[${G?'開始':'Start'}]`;
      p.s.forEach((s,i)=>pipelineMd+=` --> S${i+1}[${s}]`);
      pipelineMd+=` --> Done[${G?'完了':'Done'}]\n\`\`\`\n\n`;
    });
    pipelineMd+=`${G?'## 実行方法':'## Execution'}\n1. ${G?'トリガー':'Trigger'}\n2. ${G?'スキル実行':'Run skills'}\n3. ${G?'PASS → 次':'PASS → next'}\n`;
    S.files['skills/pipelines.md']=pipelineMd;
    S.files['AGENTS.md']+=`\n\n## Pipeline Coordination\n- Pipelines: skills/pipelines.md\n- Catalog: skills/catalog.md\n- Gates: ${aiLevel==='vibe'||aiLevel==='agentic'?'human':'auto'}\n- Error: docs/25 → retry → escalate\n- Context: AI_BRIEF.md only\n`;
  }
}
function genPillar7_Roadmap(a,pn){
  const T=k=>(GT[S.genLang]||GT.en)[k]||GT.en[k]||k;
  const level=a.skill_level||'Intermediate';const goal=a.learning_goal||(S.genLang==='ja'?'6ヶ月標準':'6-month standard');
  const fe=a.frontend||'React + Next.js';const be=a.backend||'Node.js + Express';
  const mob=a.mobile||T('none');const ai=a.ai_auto||T('none');const pay=a.payment||T('none');
  const noMob=mob===GT.ja.none||mob===GT.en.none;const noAI=ai===GT.ja.none||ai===GT.en.none;const noPay=pay===GT.ja.none||pay===GT.en.none;
  const isB=level.includes('Beginner');const isP=level.includes('Professional');
  const _auth=resolveAuth(a);const _arch=resolveArch(a);
  const _orm=_arch.isBaaS?(be.includes('Supabase')?'Supabase Client':be.includes('Firebase')?'Firebase SDK':'Convex'):(a.orm&&a.orm.includes('Drizzle')?'Drizzle ORM':'Prisma ORM');
  const months=goal.includes('3')?3:goal.includes('12')?12:6;
  const slug=pn.toLowerCase().replace(/[^a-z0-9]/g,'-');
  
  S.files['roadmap/LEARNING_PATH.md']=`# ${pn} — ${T('lp_title')}
> ${T('lp_skill')}: ${level} | ${T('lp_target')}: ${goal} | Generated by DevForge v9
## Layer 1: ${T('l1')} ${isB?'[Month 1-2]':'[Week 1-2]'}
${isB?`- [ ] ${T('html5b')}\n- [ ] ${T('css3b')}\n- [ ] ${T('jsb')}`:`- [ ] ${T('tsAdv')}\n- [ ] ${T('cssAdv')}`}
## Layer 2: ${T('l2')} [${isB?'Month 3-4':'Month 1-2'}]
- [ ] ${fe} ${T('setup')}
- [ ] Tailwind CSS + shadcn/ui
- [ ] ${T('stMgmt')} (Zustand/Redux)
- [ ] React Query (${T('dataFetch')})
- [ ] ${T('testing')} (Vitest + Playwright)
## Layer 3: ${T('l3')} [${isB?'Month 5-6':'Month 2-3'}]
- [ ] ${be} ${T('setup')}
- [ ] ${T('dbDesign')} + ${_orm}
- [ ] REST API / GraphQL
- [ ] ${T('auth')} (${_auth.sot})
${!noMob?`\n## Layer 3.5: ${T('l3m')} [Month ${isB?7:4}-${isB?8:5}]\n- [ ] ${mob} ${T('mobEnv')}\n- [ ] ${T('mobNav')}\n- [ ] ${T('mobNative')}\n- [ ] ${T('mobStore')}\n`:''}
## Layer 4: DevOps [${isB?'Month '+(noMob?7:9):'Month '+(noMob?4:6)}]
- [ ] Docker + DevContainer
- [ ] GitHub Actions CI/CD
- [ ] ${a.deploy||'Vercel'} ${T('deploy')}
- [ ] ${T('monitor')}
## Layer 5: ${T('l5')} [${isB?'Month '+(noMob?8:10):'Month '+(noMob?5:7)}]
- [ ] ${(a.ai_tools||'Cursor').split(', ')[0]} ${T('aiUse')}
- [ ] ${T('mcpCfg')}
- [ ] ${T('aiOpt')}
${!noAI?`- [ ] ${ai} ${T('practice')}\n`:''}${!noPay?`\n## Layer 6: ${T('l6')} [Month ${months-1}-${months}]\n- [ ] ${pay}\n- [ ] ${T('billing')}\n- [ ] ${T('opsScale')}\n`:''}
## Layer 7: ${T('l7')} [${T('l7span')}]
${(a.dev_methods||'TDD').split(', ').map(m=>'- [ ] '+m+' '+T('practice')).join('\n')}
`;
  
  const feR=fe.includes('Next')?T('nextR'):fe.includes('Vue')?T('vueR'):T('feGenR');
  const beR=be.includes('Supabase')?T('supaR'):be.includes('Express')?T('expR'):be.includes('NestJS')?T('nestR'):T('beGenR');
  const dbVal=a.database||'PostgreSQL';
  const dbR=dbVal.includes('Postgre')?T('pgR'):T('dbGenR');
  const dpVal=a.deploy||'Vercel';
  const dpR=dpVal.includes('Vercel')?T('vercelR'):T('deployGenR');
  S.files['roadmap/TECH_STACK_GUIDE.md']=`# ${pn} — ${T('ts_title')}
> Generated by DevForge v9
## ${T('ts_selected')}
| ${T('cat')} | ${T('tech')} | ${T('rationale')} |
|---------|------|------|
| ${T('feLabel')} | ${fe} | ${feR} |
| ${T('beLabel')} | ${be} | ${beR} |
| ${T('dbLabel')} | ${dbVal} | ${dbR} |
| ${T('deployLabel')} | ${dpVal} | ${dpR} |
${!noMob?`| ${T('mobileLabel')} | ${mob} | ${mob.includes('Expo')?T('expoR'):T('mobGenR')} |\n`:''}${!noPay?`| ${T('payLabel')} | ${pay} | ${T('payR')} |\n`:''}
## ${T('ts_deps')}
\`\`\`
${fe} ←→ ${be} ←→ ${dbVal}
  ↓           ↓
Tailwind    ${_orm}
  ↓           ↓
shadcn/ui   ${dpVal}
\`\`\`
## ${T('ts_versions')}
- Node.js: 22 LTS
- React: 19+
- Next.js: 15+
- TypeScript: 5.7+
- ${_orm}: ${_arch.isBaaS?"SDK latest":"6+"}
`;
  
  S.files['roadmap/MOBILE_GUIDE.md']=!noMob?`# ${pn} — ${T('mob_title')}
> ${mob} | Generated by DevForge v9
## ${T('mob_env')}
\`\`\`bash
npx create-expo-app ${slug}-mobile --template blank-typescript
cd ${slug}-mobile
npx expo install expo-router expo-camera expo-notifications
\`\`\`
## ${T('mob_dir')}
\`\`\`
app/
├── (tabs)/
│   ├── index.tsx       # ${T('mob_home')}
│   ├── explore.tsx     # ${T('mob_explore')}
│   └── profile.tsx     # ${T('mob_profile')}
├── _layout.tsx         # ${T('mob_root')}
└── +not-found.tsx      # 404
\`\`\`
## EAS Build${T('mob_eas')}
\`\`\`json
{ "build": { "production": { "distribution": "store" }, "preview": { "distribution": "internal" } } }
\`\`\`
## ${T('mob_libs')}
- NativeWind (Tailwind for RN)
- React Native Reanimated (${T('mob_anim')})
- FlashList (${T('mob_list')})
- Expo Image (${T('mob_img')})
`:`# ${T('mob_title')}\n\n${T('mob_none')}`;
  
  const aiTools=(a.ai_tools||'Cursor').split(', ');
  const toolLines=aiTools.map(t=>`- **${t}**: ${t==='Cursor'?'https://cursor.sh/':t.includes('Antigravity')?'https://antigravity.google/':t.includes('Claude')?'Claude Code CLI: npm install -g @anthropic-ai/claude-code':t.includes('Aider')?'pip install aider-chat (BYOK)':t.includes('Amazon Q')?T('tool_vsInst')+' / aws.amazon.com/q/developer/':t.includes('Augment')?T('tool_vsInst')+' / augmentcode.com':t.includes('Tabnine')?T('tool_vsInst')+' / tabnine.com':t.includes('OpenRouter')?'https://openrouter.ai/ (API key)':t.includes('Copilot')?T('tool_vsInst'):T('tool_official')}`).join('\n');
  S.files['roadmap/TOOLS_SETUP.md']=`# ${pn} — ${T('tool_title')}
> Generated by DevForge v9
## 1. ${T('tool_essential')}
\`\`\`bash
# Node.js (${T('tool_rec')}: v22 LTS)
# https://nodejs.org/
# ${T('tool_pkgmgr')}
npm install -g pnpm
# ${T('tool_init')}
pnpm create next-app ${slug} --typescript --tailwind --eslint
# ${T('tool_docker')}
docker compose up -d
\`\`\`
## 2. ${T('tool_ai')}
${toolLines}
## 3. VS Code ${T('tool_ext')}
- ESLint, Prettier, Tailwind CSS IntelliSense
- ${_arch.isBaaS?(be.includes("Supabase")?"supabase.supabase-vscode":"ms-azuretools.vscode-azurefunctions"):"prisma.prisma"}, GitLens, Error Lens
- GitHub Copilot (${T('tool_used')})
## 4. ${T('tool_env')} (.env.example)
\`\`\`
DATABASE_URL="postgresql://dev:devpass@localhost:5432/${slug.replace(/-/g,'_')}"
NEXTAUTH_SECRET="your-secret-here"
NEXTAUTH_URL="http://localhost:3000"
${pay.includes('Stripe')?'STRIPE_SECRET_KEY="sk_test_..."\nSTRIPE_PUBLISHABLE_KEY="pk_test_..."\nSTRIPE_WEBHOOK_SECRET="whsec_..."':''}
\`\`\`
`;
  
  S.files['roadmap/RESOURCES.md']=`# ${pn} — ${T('res_title')}
> Generated by DevForge v9
## ${T('res_official')}
${fe.includes('React')?'- [React](https://react.dev/)\n- [Next.js](https://nextjs.org/docs)':''}
${fe.includes('Vue')?'- [Vue 3](https://vuejs.org/)\n- [Nuxt](https://nuxt.com/)':''}
${be.includes('Node')?'- [Node.js](https://nodejs.org/docs/)':''}
${be.includes('Supabase')?'- [Supabase](https://supabase.com/docs)':''}
- [TypeScript](https://www.typescriptlang.org/docs/)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [${_orm}](${_arch.isBaaS?(be.includes("Supabase")?"https://supabase.com/docs":"https://firebase.google.com/docs"):"https://www.prisma.io/docs"})
## ${T('res_ai')}
- [CLAUDE.md ${T('res_bp')}](https://docs.anthropic.com/)
- [Cursor ${T('res_docs')}](https://docs.cursor.com/)
- [MCP ${T('res_proto')}](https://modelcontextprotocol.io/)
${!noAI?`- [Vibe Coding ${T('res_patterns')}](https://vibecoding.dev/)`:''}\
## ${T('res_books')}
- "${T('res_fullstack')}" (${isB?T('res_beg'):T('res_int')})
- "${T('res_tsPractice')}"
- "${(a.dev_methods||'TDD').split(', ')[0]}${T('res_design')}"
${!noPay?`- "${T('res_saas')}"\n- "${T('res_headless')}"`:''}\
`;
  
  const msLabels=T('ms_m');
  S.files['roadmap/MILESTONES.md']=`# ${pn} — ${T('ms_title')}
> ${T('ms_target')}: ${goal} | Generated by DevForge v9
${Array.from({length:months},(_,i)=>`## Month ${i+1}: ${(typeof msLabels==='object'?msLabels:GT.en.ms_m)[Math.min(i,6)]}
- [ ] ${T('ms_criteria')}
- [ ] ${T('ms_review')}
- [ ] ${T('ms_retro')}`).join('\n\n')}
`;
  
  S.files['roadmap/AI_WORKFLOW.md']=`# ${pn} — ${T('aiw_title')}
> Generated by DevForge v9
## ${T('aiw_flow')}
\`\`\`
1. ${T('aiw_s1')} → 2. ${T('aiw_s2')} → 3. ${T('aiw_s3')} → 4. ${T('aiw_s4')} → 5. ${T('aiw_s5')} → 6. ${T('aiw_s6')}
\`\`\`
## ${T('aiw_select')}
| ${T('aiw_task')} | ${T('aiw_rec')} | ${T('rationale')} |
|--------|-----------|------|
| ${T('aiw_newfile')} | ${aiTools[0]} | ${T('aiw_ctx')} |
| ${T('aiw_bugfix')} | Claude Code | ${T('aiw_term')} |
| ${T('aiw_testgen')} | GitHub Copilot | ${T('aiw_inline')} |
| ${T('aiw_refactor')} | Cursor | ${T('aiw_multi')} |
## ${T('aiw_mcp')}
1. **context7**: ${T('aiw_mcp1')}
2. **filesystem**: ${T('aiw_mcp2')}
3. **playwright**: ${T('aiw_mcp3')}
## ${T('aiw_prompt')}
### 1. ${T('aiw_addFeature')}
\`\`\`
${T('aiw_promptText')}
\`\`\`
### 2. ${T('aiw_bugfixPrompt')}
\`\`\`
${T('aiw_bugfixText')}
\`\`\`
### 3. ${T('aiw_refactorPrompt')}
\`\`\`
${T('aiw_refactorText')}
\`\`\`
`;
  
  const aiIsVibe=ai.includes('Vibe');const aiIsMulti=ai.includes('マルチ')||ai.includes('Multi');const aiIsFull=ai.includes('フル')||ai.includes('Full');
  S.files['roadmap/AI_AUTONOMOUS.md']=!noAI?`# ${pn} — ${T('aia_title')}
> ${T('aia_level')}: ${ai} | Generated by DevForge v9
## ${T('aia_vibe')}
${T('aia_vibeDesc')}
### ${T('aia_basic')}
1. **${T('aia_f1')}**: ${T('aia_f1ex')}
2. **${T('aia_f2')}**: ${T('aia_f2ex')}
3. **${T('aia_f3')}**: ${T('aia_f3ex')}
4. **${T('aia_f4')}**: ${T('aia_f4ex')}
### ${T('aia_tools')}
${aiIsVibe?`- ${T('aia_vibe1')}\n- ${T('aia_vibe2')}\n- ${T('aia_vibe3')}`:''}
${aiIsMulti?`- ${T('aia_multi1')}\n- ${T('aia_multi2')}\n- ${T('aia_multi3')}`:''}
${aiIsFull?`- ${T('aia_full1')}\n- ${T('aia_full2')}\n- ${T('aia_full3')}\n- ${T('aia_async1')}`:''}
### ${T('aia_bp')}
1. ${T('aia_bp1')}
2. ${T('aia_bp2')}
3. ${T('aia_bp3')}
4. ${T('aia_bp4')}
`:`# ${T('aia_title')}\n\n${T('aia_none')}${aiTools[0]}${T('aia_none2')}`;
  
  S.files['roadmap/SAAS_COMMERCE_GUIDE.md']=!noPay?`# ${pn} — ${T('sc_title')}
> ${T('sc_selected')}: ${pay} | Generated by DevForge v9
## ${T('sc_compare')}
| ${T('sc_platform')} | ${T('sc_rate')} | MoR | ${T('sc_feat')} |
|---------------|------|-----|------|
| Stripe | 2.9%+30¢ | Beta | ${T('sc_stripe')} |
| Paddle | 5%+50¢ | ✅ | ${T('sc_paddle')} |
| Lemon Squeezy (Stripe) | 5%+50¢ | ✅ | ${T('sc_lemon')} |
${pay.includes('Stripe')?`## ${T('sc_impl')}
\`\`\`bash
npm install stripe @stripe/stripe-js
\`\`\`
### Checkout Session
\`\`\`typescript
import Stripe from 'stripe';
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);
const session = await stripe.checkout.sessions.create({
  line_items: [{ price: 'price_xxx', quantity: 1 }],
  mode: 'subscription',
  success_url: '/success',
  cancel_url: '/cancel',
});
\`\`\`
### ${T('sc_webhook')}
\`\`\`typescript
const event = stripe.webhooks.constructEvent(body, sig, secret);
switch(event.type) {
  case 'checkout.session.completed': // ${T('sc_paid')}
  case 'invoice.paid': // ${T('sc_renew')}
  case 'customer.subscription.deleted': // ${T('sc_cancel')}
}
\`\`\`
`:''}${pay.includes('CMS')?`## ${T('sc_cms')} (microCMS)
\`\`\`bash
npm install microcms-js-sdk
\`\`\`
\`\`\`typescript
import { createClient } from 'microcms-js-sdk';
const client = createClient({
  serviceDomain: 'your-domain',
  apiKey: process.env.MICROCMS_API_KEY!,
});
const data = await client.getList({ endpoint: 'articles' });
\`\`\`
`:''}${pay.includes('EC')?`## ${T('sc_ec')} (Medusa)
\`\`\`bash
npx create-medusa-app@latest
\`\`\`
- ${T('sc_prodMgmt')}: Admin Dashboard
- ${T('sc_payment')}: Stripe Plugin
- ${T('sc_ship')}: ${T('sc_fulfill')}
`:''}
`:`# ${T('sc_title')}\n\n${T('sc_none')}`;
}
function genPillar9_DesignSystem(a,pn){
  const G=S.genLang==='ja';
  const fe=a.frontend||'React + Next.js';
  const be=a.backend||'Node.js + Express';
  const auth=resolveAuth(a);
  const arch=resolveArch(a);
  const hasPay=a.payment&&!/なし|None|none/.test(a.payment);
  const entities=(a.data_entities||'').split(/[,、]\s*/).map(s=>s.trim()).filter(Boolean);
  const screens=(a.screens||'').split(/[,、]/).map(s=>s.trim()).filter(Boolean);
  const isTailwind=fe.includes('Next')||fe.includes('Vite')||fe.includes('React');
  const isVuetify=fe.includes('Vue');
  const isMaterial=fe.includes('Angular');
  const colorSection=G?'## デザイントークン':'## Design Tokens';
  const colorPalette=G?'### カラーパレット':'### Color Palette';
  const typography=G?'### タイポグラフィ':'### Typography Scale';
  const spacing=G?'### スペーシング':'### Spacing Scale';
  const breakpoints=G?'### ブレークポイント':'### Breakpoints';
  const components=G?'## コンポーネントカタログ':'## Component Catalog';
  const darkMode=G?'## ダーク/ライトモード':'## Dark/Light Mode';
  const guidelines=G?'## AI実装ガイドライン':'## AI Implementation Guidelines';
  let designDoc='# '+(G?'デザインシステム':'Design System')+'\n\n';
  designDoc+=G?'**重要**: AIエージェントは、UI実装時に必ずこのデザインシステムを参照し、一貫性を保ってください。\n\n':'**IMPORTANT**: AI agents MUST reference this design system when implementing UI to maintain consistency.\n\n';
  designDoc+=colorSection+'\n\n'+colorPalette+'\n\n';
  if(isTailwind){
    designDoc+='```css\n\ntheme: {\n  extend: {\n    colors: {\n      primary: {\n        50: \'#f0f9ff\',\n        500: \'#0ea5e9\',\n        900: \'#0c4a6e\'\n      },\n      surface: {\n        light: \'#ffffff\',\n        dark: \'#1e293b\'\n      }\n    }\n  }\n}\n```\n';
  }else if(isVuetify){
    designDoc+='```js\n// Vuetify theme (vuetify.config.js)\ntheme: {\n  themes: {\n    light: {\n      primary: \'#1976D2\',\n      secondary: \'#424242\',\n      accent: \'#82B1FF\'\n    },\n    dark: {\n      primary: \'#2196F3\',\n      secondary: \'#424242\',\n      accent: \'#FF4081\'\n    }\n  }\n}\n```\n';
  }else{
    designDoc+='```css\n:root {\n  --color-primary: #0ea5e9;\n  --color-bg: #ffffff;\n  --color-surface: #f8fafc;\n  --color-text: #0f172a;\n  --color-success: #10b981;\n  --color-warning: #f59e0b;\n  --color-error: #ef4444;\n}\n[data-theme="dark"] {\n  --color-bg: #0f172a;\n  --color-surface: #1e293b;\n  --color-text: #f1f5f9;\n}\n```\n';
  }
  designDoc+='\n'+typography+'\n\n| '+(G?'要素':'Element')+' | '+(G?'サイズ':'Size')+' | '+(G?'ウェイト':'Weight')+' | '+(G?'行間':'Line Height')+' |\n|------|------|--------|-------------|\n';
  designDoc+='| h1 | 36px/2.25rem | 700 | 1.2 |\n| h2 | 30px/1.875rem | 600 | 1.3 |\n| h3 | 24px/1.5rem | 600 | 1.4 |\n| body | 16px/1rem | 400 | 1.5 |\n| small | 14px/0.875rem | 400 | 1.4 |\n| xs | 12px/0.75rem | 400 | 1.3 |\n\n';
  designDoc+=spacing+'\n\n| '+(G?'トークン':'Token')+' | '+(G?'値':'Value')+' | '+(G?'用途':'Usage')+' |\n|------|-------|-------|\n';
  designDoc+='| xs | 4px | '+(G?'アイコン間隔':'Icon gaps')+'|\n| sm | 8px | '+(G?'コンパクト間隔':'Compact spacing')+'|\n| md | 16px | '+(G?'標準間隔':'Standard spacing')+'|\n| lg | 24px | '+(G?'セクション間':'Section gaps')+'|\n| xl | 32px | '+(G?'カード間':'Card spacing')+'|\n| 2xl | 48px | '+(G?'大セクション間':'Large sections')+'|\n\n';
  designDoc+=breakpoints+'\n\n```css\n\n\n\n\n```\n\n';
  designDoc+=components+'\n\n';
  if(screens.length>0){
    screens.slice(0,5).forEach(scr=>{
      const comps=getScreenComponents(scr,G);
      if(comps){
        designDoc+='### '+(G?'画面：':'Screen: ')+scr+'\n';
        comps.forEach(c=>designDoc+='- '+c+'\n');
        designDoc+='\n';
      }
    });
  }
  if(isTailwind){
    designDoc+=(G?'**ライブラリ**: shadcn/ui または Headless UI を推奨\n':'**Library**: Recommend shadcn/ui or Headless UI\n')+'\n';
  }else if(isVuetify){
    designDoc+=(G?'**ライブラリ**: Vuetify 標準コンポーネント\n':'**Library**: Vuetify standard components\n')+'\n';
  }else if(isMaterial){
    designDoc+=(G?'**ライブラリ**: Angular Material\n':'**Library**: Angular Material\n')+'\n';
  }
  designDoc+=darkMode+'\n\n';
  if(isTailwind){
    designDoc+='```jsx\n// app/layout.tsx\nimport { ThemeProvider } from "next-themes"\n\nexport default function RootLayout({ children }) {\n  return (\n    <html suppressHydrationWarning>\n      <body>\n        <ThemeProvider attribute="class" defaultTheme="system" enableSystem>\n          {children}\n        </ThemeProvider>\n      </body>\n    </html>\n  )\n}\n```\n\n'+(G?'使用例: `className="bg-white dark:bg-gray-900"`':'Usage: `className="bg-white dark:bg-gray-900"`')+'\n\n';
  }else{
    designDoc+='```js\n// Toggle theme\nfunction toggleTheme() {\n  document.documentElement.dataset.theme = \n    document.documentElement.dataset.theme === "dark" ? "light" : "dark";\n}\n```\n\n';
  }
  designDoc+=guidelines+'\n\n';
  designDoc+=(G?'1. **色**: 必ず定義済みトークンを使用。直接カラーコード（#000 等）を記述しない\n2. **スペーシング**: 4px グリッドに従う (xs/sm/md/lg/xl/2xl)\n3. **タイポグラフィ**: 定義されたスケールのみ使用\n4. **コンポーネント**: 推奨ライブラリから選択（独自実装は最小限）\n5. **ダークモード**: すべてのUI要素でLight/Dark対応を実装\n6. **レスポンシブ**: モバイルファースト設計（最小→最大）\n7. **アクセシビリティ**: ARIA属性、キーボードナビゲーション、コントラスト比 4.5:1 以上\n':'1. **Colors**: Always use predefined tokens. Never hardcode colors (#000)\n2. **Spacing**: Follow 4px grid (xs/sm/md/lg/xl/2xl)\n3. **Typography**: Use defined scale only\n4. **Components**: Choose from recommended library (minimize custom)\n5. **Dark Mode**: Implement Light/Dark support for all UI elements\n6. **Responsive**: Mobile-first design (min → max)\n7. **Accessibility**: ARIA attributes, keyboard navigation, contrast ratio ≥ 4.5:1\n')+'\n';
  S.files['docs/26_design_system.md']=designDoc;
  let seqDoc='# '+(G?'シーケンス図':'Sequence Diagrams')+'\n\n';
  seqDoc+=G?'**重要**: AIエージェントは、複雑なフローを実装する前にこのシーケンス図を参照してください。\n\n':'**IMPORTANT**: AI agents MUST reference these sequence diagrams before implementing complex flows.\n\n';
  seqDoc+=(G?'## 認証フロー':'## Authentication Flow')+'\n\n```mermaid\nsequenceDiagram\n  participant U as User\n  participant C as Client\n  participant ';
  if(auth.provider==='supabase'){
    seqDoc+='S as Supabase Auth\n  U->>C: '+(G?'ログイン要求':'Login request')+'\n  C->>S: signInWithPassword(email, password)\n  S-->>C: {access_token, refresh_token}\n  C->>C: '+(G?'トークン保存':'Store tokens')+'\n  C->>S: getUser() with access_token\n  S-->>C: User object\n  C-->>U: '+(G?'ダッシュボード表示':'Show dashboard')+'\n```\n\n';
  }else if(auth.provider==='firebase'){
    seqDoc+='F as Firebase Auth\n  U->>C: '+(G?'ログイン要求':'Login request')+'\n  C->>F: signInWithEmailAndPassword()\n  F-->>C: User + ID Token\n  C->>C: '+(G?'トークン保存':'Store token')+'\n  C-->>U: '+(G?'ダッシュボード表示':'Show dashboard')+'\n```\n\n';
  }else if(auth.provider==='authjs'){
    seqDoc+='A as Auth.js\n  U->>C: '+(G?'ログイン要求':'Login request')+'\n  C->>A: signIn("credentials")\n  A->>A: '+(G?'認証情報検証':'Verify credentials')+'\n  A-->>C: Session cookie\n  C-->>U: '+(G?'ダッシュボード表示':'Show dashboard')+'\n```\n\n';
  }else{
    seqDoc+='API as Backend API\n  U->>C: '+(G?'ログイン要求':'Login request')+'\n  C->>API: POST /api/auth/login\n  API->>API: '+(G?'認証情報検証':'Verify credentials')+'\n  API-->>C: {token, user}\n  C->>C: '+(G?'トークン保存':'Store token')+'\n  C-->>U: '+(G?'ダッシュボード表示':'Show dashboard')+'\n```\n\n';
  }
  if(entities.length>0){
    const firstEntity=entities[0];
    seqDoc+=(G?'## CRUD操作（':'## CRUD Operation (')+firstEntity+(G?'）':')')+'\n\n```mermaid\nsequenceDiagram\n  participant U as User\n  participant C as Client\n  participant ';
    if(arch.isBaaS){
      const baasName=be.includes('Supabase')?'Supabase':be.includes('Firebase')?'Firebase':'Convex';
      seqDoc+=baasName[0]+' as '+baasName+'\n  U->>C: '+(G?'作成ボタンクリック':'Click create button')+'\n  C->>'+baasName[0]+': insert({...data})\n  '+baasName[0]+'-->>C: '+(G?'作成成功':'Created successfully')+'\n  C-->>U: '+(G?'成功通知':'Show success')+'\n  U->>C: '+(G?'一覧表示要求':'Request list')+'\n  C->>'+baasName[0]+': select().eq(...)\n  '+baasName[0]+'-->>C: '+firstEntity+' list\n  C-->>U: '+(G?'一覧表示':'Display list')+'\n```\n\n';
    }else{
      seqDoc+='API as Backend API\n  U->>C: '+(G?'作成ボタンクリック':'Click create button')+'\n  C->>API: POST /api/'+pluralize(firstEntity)+'\n  API->>API: '+(G?'バリデーション':'Validate')+'\n  API->>API: '+(G?'DB保存':'Save to DB')+'\n  API-->>C: '+(G?'作成成功':'201 Created')+'\n  C-->>U: '+(G?'成功通知':'Show success')+'\n```\n\n';
    }
  }
  if(hasPay&&(a.payment||'').includes('Stripe')){
    seqDoc+=(G?'## 決済フロー（Stripe）':'## Payment Flow (Stripe)')+'\n\n```mermaid\nsequenceDiagram\n  participant U as User\n  participant C as Client\n  participant API as Backend\n  participant S as Stripe\n  participant W as Webhook\n  U->>C: '+(G?'プラン選択':'Select plan')+'\n  C->>API: POST /api/checkout\n  API->>S: stripe.checkout.sessions.create()\n  S-->>API: session_id\n  API-->>C: {session_id}\n  C->>S: '+(G?'Checkoutページへリダイレクト':'Redirect to Checkout')+'\n  U->>S: '+(G?'カード情報入力':'Enter card info')+'\n  S->>W: webhook: checkout.session.completed\n  W->>W: '+(G?'DB更新（サブスク作成）':'Update DB (create subscription)')+'\n  W-->>S: 200 OK\n  S-->>U: '+(G?'完了ページへリダイレクト':'Redirect to success page')+'\n```\n\n';
  }
  seqDoc+=(G?'## エラーハンドリング':'## Error Handling')+'\n\n```mermaid\nsequenceDiagram\n  participant C as Client\n  participant API as Backend\n  C->>API: '+(G?'リクエスト':'Request')+'\n  API-->>C: 400/401/403/500\n  C->>C: '+(G?'エラーメッセージ抽出':'Parse error message')+'\n  C->>C: '+(G?'トースト表示':'Show toast notification')+'\n  alt '+(G?'401 認証エラー':'401 Unauthorized')+'\n    C->>C: '+(G?'ログイン画面へリダイレクト':'Redirect to login')+'\n  else '+(G?'5xx サーバーエラー':'5xx Server Error')+'\n    C->>C: '+(G?'リトライボタン表示':'Show retry button')+'\n  end\n```\n\n';
  S.files['docs/27_sequence_diagrams.md']=seqDoc;
}
const REVERSE_FLOW_MAP={
  education:{
    goal_ja:'学習成果の最大化',goal_en:'Maximize Learning Outcomes',
    flow_ja:['学習成果・修了率KPI定義','カリキュラム・コンテンツ設計','学習進捗測定機能','リマインド・通知自動化'],
    flow_en:['Define learning outcomes & completion KPIs','Design curriculum & content','Implement progress tracking','Automate reminders & notifications'],
    kpi_ja:['コース修了率 ≥70%','平均学習時間/週 ≥3h','課題提出率 ≥80%','受講者満足度 ≥4.2/5'],
    kpi_en:['Course completion rate ≥70%','Avg study time/week ≥3h','Assignment submission ≥80%','Learner satisfaction ≥4.2/5'],
    risks_ja:['コンテンツ制作遅延','学習者離脱率高','評価基準曖昧'],
    risks_en:['Content production delays','High learner dropout','Vague grading criteria']
  },
  ec:{
    goal_ja:'売上・CVR最大化',goal_en:'Maximize Revenue & CVR',
    flow_ja:['売上目標・CVR設定','商品戦略（価格・在庫）','UI/UX最適化（カート・決済）','集客施策（SEO・広告）'],
    flow_en:['Set revenue & CVR targets','Product strategy (pricing/inventory)','Optimize UI/UX (cart/checkout)','Marketing (SEO/ads)'],
    kpi_ja:['CVR ≥2.5%','平均注文額 ≥5,000円','カート放棄率 ≤60%','リピート率 ≥30%'],
    kpi_en:['CVR ≥2.5%','Avg order value ≥$50','Cart abandonment ≤60%','Repeat rate ≥30%'],
    risks_ja:['在庫切れ・欠品','決済エラー率高','物流遅延'],
    risks_en:['Stock-outs','High payment errors','Shipping delays']
  },
  saas:{
    goal_ja:'MRR成長・チャーン率低減',goal_en:'MRR Growth & Churn Reduction',
    flow_ja:['MRR・チャーン率目標設定','機能優先度決定（MVPコア機能）','オンボーディング最適化','リテンション施策'],
    flow_en:['Set MRR & churn targets','Prioritize features (MVP core)','Optimize onboarding','Retention strategies'],
    kpi_ja:['MRR成長率 ≥10%/月','チャーン率 ≤5%/月','アクティベーション率 ≥60%','NPS ≥40'],
    kpi_en:['MRR growth ≥10%/mo','Churn ≤5%/mo','Activation rate ≥60%','NPS ≥40'],
    risks_ja:['機能スコープ過多','オンボーディング離脱','競合参入'],
    risks_en:['Feature scope creep','Onboarding drop-offs','Competitor entry']
  },
  fintech:{
    goal_ja:'取引量・信頼性・規制準拠',goal_en:'Transaction Volume, Trust & Compliance',
    flow_ja:['規制準拠要件確認（金融庁・GDPR等）','セキュリティ基盤（暗号化・2FA）','取引フロー設計','監視・監査体制'],
    flow_en:['Verify compliance (FSA/GDPR)','Security foundation (encryption/2FA)','Design transaction flow','Monitoring & audit'],
    kpi_ja:['取引成功率 ≥99.5%','平均決済時間 ≤3秒','セキュリティインシデント 0件','監査合格率 100%'],
    kpi_en:['Transaction success ≥99.5%','Avg payment time ≤3s','Security incidents: 0','Audit pass rate: 100%'],
    risks_ja:['規制変更対応遅延','不正検知精度不足','システム障害時の資金保全'],
    risks_en:['Slow regulatory adaptation','Weak fraud detection','Fund security during outages']
  },
  health:{
    goal_ja:'患者満足度・診療効率向上',goal_en:'Patient Satisfaction & Efficiency',
    flow_ja:['診療目標・待ち時間KPI設定','予約システム最適化','電子カルテ連携','患者フィードバック収集'],
    flow_en:['Set care goals & wait time KPIs','Optimize booking system','EHR integration','Patient feedback collection'],
    kpi_ja:['予約充足率 ≥85%','平均待ち時間 ≤15分','診察時間 15分/人','患者満足度 ≥4.5/5'],
    kpi_en:['Booking rate ≥85%','Avg wait time ≤15min','Consult time: 15min/patient','Patient satisfaction ≥4.5/5'],
    risks_ja:['医療情報漏洩','予約重複・ダブルブッキング','システム障害時の診療継続'],
    risks_en:['Medical data breach','Booking conflicts','Service continuity during outages']
  },
  marketplace:{
    goal_ja:'取引量・GMV最大化',goal_en:'Maximize Transactions & GMV',
    flow_ja:['GMV目標設定','マッチング精度向上','エスクロー決済実装','評価システム信頼性'],
    flow_en:['Set GMV targets','Improve matching accuracy','Implement escrow','Rating system trust'],
    kpi_ja:['GMV成長率 ≥15%/月','マッチング成約率 ≥40%','平均評価 ≥4.3/5','紛争解決時間 ≤48h'],
    kpi_en:['GMV growth ≥15%/mo','Match conversion ≥40%','Avg rating ≥4.3/5','Dispute resolution ≤48h'],
    risks_ja:['不正出品・詐欺','決済トラブル','評価操作'],
    risks_en:['Fraud listings','Payment disputes','Rating manipulation']
  },
  community:{
    goal_ja:'ユーザーエンゲージメント向上',goal_en:'User Engagement Growth',
    flow_ja:['エンゲージメントKPI設定（DAU/MAU）','コンテンツ推薦アルゴリズム','モデレーション自動化','コミュニティガイドライン策定'],
    flow_en:['Set engagement KPIs (DAU/MAU)','Content recommendation algo','Automate moderation','Define community guidelines'],
    kpi_ja:['DAU/MAU比率 ≥30%','投稿数 ≥500/日','平均滞在時間 ≥20分','通報処理時間 ≤2h'],
    kpi_en:['DAU/MAU ratio ≥30%','Posts ≥500/day','Avg session ≥20min','Report handling ≤2h'],
    risks_ja:['荒らし・スパム増加','コンテンツ品質低下','ユーザー離脱'],
    risks_en:['Spam/trolling surge','Content quality decay','User churn']
  },
  content:{
    goal_ja:'コンテンツ配信・エンゲージメント',goal_en:'Content Delivery & Engagement',
    flow_ja:['配信KPI設定（PV・滞在時間）','コンテンツパイプライン構築','SEO最適化','収益化戦略'],
    flow_en:['Set delivery KPIs (PV/session time)','Build content pipeline','SEO optimization','Monetization strategy'],
    kpi_ja:['PV ≥10,000/日','平均滞在時間 ≥3分','直帰率 ≤60%','広告CTR ≥1.5%'],
    kpi_en:['PV ≥10,000/day','Avg time ≥3min','Bounce rate ≤60%','Ad CTR ≥1.5%'],
    risks_ja:['コンテンツ制作遅延','SEO順位下落','広告収益減'],
    risks_en:['Content production delays','SEO ranking drop','Ad revenue decline']
  },
  analytics:{
    goal_ja:'データ分析精度・レポート自動化',goal_en:'Analytics Accuracy & Automation',
    flow_ja:['分析KPI・ダッシュボード設計','データパイプライン構築','可視化ツール選定','自動レポート生成'],
    flow_en:['Design analytics KPIs & dashboards','Build data pipeline','Select viz tools','Auto report generation'],
    kpi_ja:['データ鮮度 ≤1時間','ダッシュボード応答時間 ≤2秒','レポート自動化率 ≥80%','データ精度 ≥99%'],
    kpi_en:['Data freshness ≤1h','Dashboard response ≤2s','Report automation ≥80%','Data accuracy ≥99%'],
    risks_ja:['データパイプライン障害','分析精度不足','レポート遅延'],
    risks_en:['Data pipeline failures','Poor analysis accuracy','Report delays']
  },
  booking:{
    goal_ja:'予約充足率・キャンセル率最適化',goal_en:'Booking Rate & Cancellation Optimization',
    flow_ja:['予約目標・キャンセルKPI設定','在庫管理システム構築','通知・リマインダー自動化','決済・キャンセルポリシー'],
    flow_en:['Set booking & cancellation KPIs','Build inventory system','Automate notifications','Payment & cancellation policy'],
    kpi_ja:['予約充足率 ≥75%','キャンセル率 ≤15%','平均予約単価 ≥8,000円','リピート率 ≥40%'],
    kpi_en:['Booking rate ≥75%','Cancellation ≤15%','Avg booking value ≥$80','Repeat rate ≥40%'],
    risks_ja:['ダブルブッキング','直前キャンセル','在庫更新遅延'],
    risks_en:['Double booking','Last-minute cancellations','Inventory sync delays']
  },
  iot:{
    goal_ja:'デバイス安定稼働・データ収集',goal_en:'Device Uptime & Data Collection',
    flow_ja:['稼働率・データ収集KPI設定','デバイス管理・認証基盤','データストリーミング構築','異常検知・アラート'],
    flow_en:['Set uptime & data KPIs','Device mgmt & auth','Build data streaming','Anomaly detection & alerts'],
    kpi_ja:['デバイス稼働率 ≥99%','データ取得頻度 ≥1回/分','異常検知精度 ≥95%','アラート応答時間 ≤5分'],
    kpi_en:['Device uptime ≥99%','Data frequency ≥1/min','Anomaly accuracy ≥95%','Alert response ≤5min'],
    risks_ja:['デバイス接続不安定','データ欠損','セキュリティ侵害'],
    risks_en:['Unstable connections','Data loss','Security breaches']
  },
  realestate:{
    goal_ja:'成約率・物件掲載数最大化',goal_en:'Conversion & Listing Maximization',
    flow_ja:['成約KPI・物件掲載目標設定','検索・フィルタ最適化','内見予約システム','契約書類デジタル化'],
    flow_en:['Set conversion & listing KPIs','Optimize search/filters','Viewing booking system','Digital contracts'],
    kpi_ja:['成約率 ≥15%','物件掲載数 ≥500件','内見予約率 ≥30%','契約処理時間 ≤7日'],
    kpi_en:['Conversion ≥15%','Listings ≥500','Viewing rate ≥30%','Contract time ≤7 days'],
    risks_ja:['物件情報更新遅延','内見日程調整トラブル','契約書類不備'],
    risks_en:['Listing update delays','Viewing schedule conflicts','Contract errors']
  },
  legal:{
    goal_ja:'案件処理効率・文書精度向上',goal_en:'Case Efficiency & Doc Accuracy',
    flow_ja:['案件処理時間・精度KPI設定','文書管理・検索システム','契約レビュー自動化','請求・タイムトラッキング'],
    flow_en:['Set case time & accuracy KPIs','Doc mgmt & search system','Auto contract review','Billing & time tracking'],
    kpi_ja:['案件処理時間 ≤14日/件','文書検索精度 ≥98%','契約レビュー時間 ≤24h','請求精度 100%'],
    kpi_en:['Case time ≤14 days','Doc search accuracy ≥98%','Contract review ≤24h','Billing accuracy 100%'],
    risks_ja:['文書紛失・漏洩','契約ミス・解釈齟齬','請求ミス'],
    risks_en:['Doc loss/leaks','Contract errors','Billing mistakes']
  },
  hr:{
    goal_ja:'採用効率・従業員満足度向上',goal_en:'Hiring Efficiency & Employee Satisfaction',
    flow_ja:['採用KPI・従業員満足度目標設定','ATS（採用管理）構築','オンボーディング自動化','パフォーマンス評価システム'],
    flow_en:['Set hiring & satisfaction KPIs','Build ATS','Automate onboarding','Performance review system'],
    kpi_ja:['採用充足率 ≥90%','Time to hire ≤30日','従業員満足度 ≥4.0/5','離職率 ≤10%/年'],
    kpi_en:['Hiring fill rate ≥90%','Time to hire ≤30 days','Employee satisfaction ≥4.0/5','Turnover ≤10%/yr'],
    risks_ja:['採用プロセス遅延','候補者離脱','従業員エンゲージメント低下'],
    risks_en:['Hiring delays','Candidate drop-offs','Low engagement']
  },
  portfolio:{
    goal_ja:'訪問者エンゲージメント・問い合わせ獲得',goal_en:'Visitor Engagement & Lead Generation',
    flow_ja:['訪問・問い合わせKPI設定','作品ポートフォリオ構築','SEO・SNS連携','問い合わせフォーム最適化'],
    flow_en:['Set visit & lead KPIs','Build project portfolio','SEO & social integration','Optimize contact form'],
    kpi_ja:['月間訪問者 ≥500人','平均滞在時間 ≥2分','問い合わせ率 ≥3%','SNS流入 ≥30%'],
    kpi_en:['Monthly visitors ≥500','Avg session ≥2min','Contact rate ≥3%','Social traffic ≥30%'],
    risks_ja:['作品更新停滞','SEO順位低下','問い合わせ減少'],
    risks_en:['Stale portfolio','SEO drop','Lead decline']
  },
  tool:{
    goal_ja:'ユーザー利用頻度・機能満足度',goal_en:'User Frequency & Feature Satisfaction',
    flow_ja:['利用KPI・機能満足度目標設定','コア機能実装優先','UI/UX最適化','ドキュメント・サポート'],
    flow_en:['Set usage & satisfaction KPIs','Prioritize core features','Optimize UI/UX','Docs & support'],
    kpi_ja:['週間利用頻度 ≥3回','機能満足度 ≥4.3/5','エラー率 ≤1%','問い合わせ応答時間 ≤24h'],
    kpi_en:['Weekly usage ≥3x','Feature satisfaction ≥4.3/5','Error rate ≤1%','Support response ≤24h'],
    risks_ja:['機能複雑化','使い方不明','競合ツール台頭'],
    risks_en:['Feature complexity','Unclear usage','Competitor tools']
  },
  _default:{
    goal_ja:'プロダクト完成・ローンチ',goal_en:'Product Completion & Launch',
    flow_ja:['ゴール・成功指標定義','要件分解・優先順位付け','技術スタック選定','実装計画・スケジュール'],
    flow_en:['Define goals & success metrics','Decompose requirements & prioritize','Select tech stack','Implementation plan & schedule'],
    kpi_ja:['MVP完成率 100%','テストカバレッジ ≥80%','バグ修正率 ≥95%','ローンチ予定通り'],
    kpi_en:['MVP completion 100%','Test coverage ≥80%','Bug fix rate ≥95%','Launch on schedule'],
    risks_ja:['スコープ拡大','技術負債蓄積','リソース不足'],
    risks_en:['Scope creep','Tech debt accumulation','Resource shortage']
  }
};
function genPillar10_ReverseEngineering(a,pn){
  const G=S.genLang==='ja';
  const domain=detectDomain(a.purpose)||'_default';
  const rf=REVERSE_FLOW_MAP[domain]||REVERSE_FLOW_MAP._default;
  const purpose=a.purpose||'';
  const mvp=a.mvp_features||'';
  const entities=(a.data_entities||'').split(/[,、]\s*/).map(s=>s.trim()).filter(Boolean);
  const features=mvp.split(/[,、\n]/).map(s=>s.trim()).filter(Boolean);
  const skill=S.skill||'intermediate';
  let doc29='# '+(G?'リバースエンジニアリング（ゴール逆算型プランニング）':'Reverse Engineering (Goal-Driven Planning)')+'\n\n';
  doc29+=G?'**重要**: このドキュメントは「ゴールから逆算して実装ステップを導出する」リバースエンジニアリング手法を提示します。AIエージェントは、実装前にこのフローを参照し、目標達成に向けた最適な順序でタスクを進めてください。\n\n':'**IMPORTANT**: This document presents reverse engineering methodology to derive implementation steps from goals. AI agents MUST reference this flow before implementation to proceed in optimal order for goal achievement.\n\n';
  doc29+=(G?'## ゴール定義':'## Goal Definition')+'\n\n';
  doc29+='**'+(G?'プロダクトの目的':'Product Purpose')+'**: '+purpose+'\n\n';
  doc29+='**'+(G?'中心ゴール':'Central Goal')+'**: '+(G?rf.goal_ja:rf.goal_en)+'\n\n';
  doc29+='**'+(G?'成功指標（KPI）':'Success Metrics (KPIs)')+'**:\n';
  const kpis=G?rf.kpi_ja:rf.kpi_en;
  kpis.forEach(k=>doc29+='- '+k+'\n');
  doc29+='\n';
  doc29+=(G?'## 逆算フロー（'+domain+'ドメイン特化）':'## Reverse Flow ('+domain+' Domain-Specific)')+'\n\n';
  doc29+=G?'ゴールから逆算して、以下の順序で実装を進めます：\n\n':'Working backward from the goal, implement in this order:\n\n';
  const flowSteps=G?rf.flow_ja:rf.flow_en;
  flowSteps.forEach((step,i)=>{
    doc29+=(i+1)+'. **'+step+'**\n';
    if(i===0){
      doc29+=(G?'   - 測定可能なKPIを定義（定量的目標）\n   - 目標達成の判断基準を明確化\n':'   - Define measurable KPIs (quantitative targets)\n   - Clarify success criteria\n')+'\n';
    }else if(i===1){
      doc29+=(G?'   - KPI達成に直結する機能・コンテンツを設計\n   - 優先順位付け（Impact × Effort マトリクス）\n':'   - Design features/content directly contributing to KPIs\n   - Prioritize (Impact × Effort matrix)\n')+'\n';
    }else if(i===2){
      doc29+=(G?'   - 実装スケジュール・タスク分解\n   - 依存関係チェーン整理\n':'   - Implementation schedule & task decomposition\n   - Dependency chain organization\n')+'\n';
    }else{
      doc29+=(G?'   - 自動化・効率化施策\n   - 継続的改善サイクル構築\n':'   - Automation & efficiency measures\n   - Continuous improvement cycle\n')+'\n';
    }
  });
  const pb=DOMAIN_PLAYBOOK[domain]||DOMAIN_PLAYBOOK._default;
  if(pb&&pb.impl_ja&&pb.impl_ja.length>0&&pb.impl_ja[0]!==''){
    doc29+=(G?'## 実装レベル・リバースフロー（業種特化パターン）':'## Implementation-Level Reverse Flow (Industry-Specific Patterns)')+'\n\n';
    doc29+=G?'具体的なデータフロー・ビジネスロジックの実装パターン:\n\n':'Concrete data flow & business logic implementation patterns:\n\n';
    const implPatterns=G?pb.impl_ja:pb.impl_en;
    implPatterns.forEach((pattern,i)=>{
      doc29+=(i+1)+'. '+pattern+'\n\n';
    });
  }
  doc29+=(G?'## マイルストーン逆算スケジュール':'## Milestone Reverse Schedule')+'\n\n```mermaid\ngantt\n    title '+(G?'ゴール達成までのマイルストーン':'Milestones to Goal Achievement')+'\n    dateFormat YYYY-MM-DD\n    section '+(G?'Phase 1: 基盤構築':'Phase 1: Foundation')+'\n';
  flowSteps.slice(0,2).forEach((step,i)=>{
    const start=i===0?'2026-03-01':'2026-03-15';
    const end=i===0?'2026-03-14':'2026-03-31';
    doc29+'    '+step.replace(/[:\-（）()]/g,' ')+' :'+start+', '+end+'\n';
  });
  doc29+='    section '+(G?'Phase 2: MVP実装':'Phase 2: MVP Implementation')+'\n';
  if(flowSteps.length>2){
    const step=flowSteps[2];
    doc29+'    '+step.replace(/[:\-（）()]/g,' ')+' :2026-04-01, 2026-04-21\n';
  }
  doc29+='    section '+(G?'Phase 3: 最適化':'Phase 3: Optimization')+'\n';
  if(flowSteps.length>3){
    const step=flowSteps[3];
    doc29+'    '+step.replace(/[:\-（）()]/g,' ')+' :2026-04-22, 2026-05-10\n';
  }
  doc29+='    section '+(G?'Phase 4: ローンチ':'Phase 4: Launch')+'\n';
  doc29+='    '+(G?'最終テスト・デプロイ':'Final testing & deploy')+' :milestone, 2026-05-11, 0d\n';
  doc29+='```\n\n';
  doc29+=(G?'## リスク・ブロッカー分析':'## Risk & Blocker Analysis')+'\n\n';
  doc29+='| '+(G?'リスク項目':'Risk Item')+' | '+(G?'影響度':'Impact')+' | '+(G?'発生確率':'Probability')+' | '+(G?'対策':'Mitigation')+' |\n|------|------|------|------|\n';
  const risks=G?rf.risks_ja:rf.risks_en;
  risks.forEach((risk,i)=>{
    const impact=i===0?'High':(i===1?'Medium':'Low');
    const prob=i===0?'Medium':(i===1?'High':'Low');
    const mitigation=G?(
      i===0?'早期プロトタイプ検証':'定期レビュー会'
    ):(
      i===0?'Early prototype validation':'Regular review meetings'
    );
    doc29+='| '+risk+' | '+impact+' | '+prob+' | '+mitigation+' |\n';
  });
  doc29+='\n';
  doc29+=(G?'## 進捗トラッキング':'## Progress Tracking')+'\n\n';
  doc29+=G?'**重要**: `docs/24_progress.md` を使用して実装進捗を記録してください。各マイルストーン完了時にステータスを更新し、ブロッカーがあれば即座に記録してください。\n\n':'**IMPORTANT**: Use `docs/24_progress.md` to track implementation progress. Update status upon milestone completion and log blockers immediately.\n\n';
  doc29+=(G?'**推奨ワークフロー**:':'**Recommended Workflow**:')+'\n';
  doc29+='1. '+(G?'各Phase開始時: 24_progress.md にスプリント目標を記載':'Phase start: Log sprint goal in 24_progress.md')+'\n';
  doc29+='2. '+(G?'実装中: タスク完了ごとにステータス更新':'During implementation: Update status per task completion')+'\n';
  doc29+='3. '+(G?'ブロッカー発生時: 25_error_logs.md に原因・対策を記録':'On blocker: Log cause & mitigation in 25_error_logs.md')+'\n';
  doc29+='4. '+(G?'Phase完了時: KPI達成度を確認・記録':'Phase complete: Verify & log KPI achievement')+'\n\n';
  S.files['docs/29_reverse_engineering.md']=doc29;
  let doc30='# '+(G?'ゴール分解・ギャップ分析':'Goal Decomposition & Gap Analysis')+'\n\n';
  doc30+=G?'**重要**: このドキュメントは、中心ゴールをサブゴール階層に分解し、現状とのギャップ・優先度を明確化します。AIエージェントは、実装順序を決定する際にこのマトリクスを参照してください。\n\n':'**IMPORTANT**: This document decomposes the central goal into sub-goal hierarchies and clarifies gaps & priorities. AI agents MUST reference this matrix when determining implementation order.\n\n';
  doc30+=(G?'## ゴールツリー':'## Goal Tree')+'\n\n```mermaid\nmindmap\n  root(('+(G?rf.goal_ja:rf.goal_en)+'))\n';
  flowSteps.slice(0,3).forEach((step,i)=>{
    doc30+'    '+step.replace(/[（）()]/g,'')+'\n';
    if(i===0&&kpis.length>0){
      doc30+'      '+kpis[0].split(' ')[0]+'\n';
      if(kpis.length>1)doc30+'      '+kpis[1].split(' ')[0]+'\n';
    }else if(i===1&&features.length>0){
      doc30+'      '+features[0]+'\n';
      if(features.length>1)doc30+'      '+features[1]+'\n';
    }else if(i===2&&entities.length>0){
      doc30+'      '+entities[0]+(G?' 実装':' implementation')+'\n';
      if(entities.length>1)doc30+'      '+entities[1]+(G?' 実装':' implementation')+'\n';
    }
  });
  doc30+'```\n\n';
  doc30+=(G?'## サブゴール分解（3-5階層）':'## Sub-Goal Decomposition (3-5 Levels)')+'\n\n';
  doc30+='### '+(G?'レベル1: 戦略目標':'Level 1: Strategic Goals')+'\n';
  flowSteps.slice(0,2).forEach((step,i)=>{
    doc30+=(i+1)+'. **'+step+'**\n';
  });
  doc30+='\n### '+(G?'レベル2: 戦術目標':'Level 2: Tactical Goals')+'\n';
  if(features.length>0){
    features.slice(0,4).forEach((f,i)=>{
      doc30+=(i+1)+'. '+f+'\n';
    });
  }else{
    doc30+='1. '+(G?'MVP機能実装':'MVP feature implementation')+'\n';
    doc30+='2. '+(G?'UI/UX最適化':'UI/UX optimization')+'\n';
  }
  doc30+='\n### '+(G?'レベル3: 実装タスク':'Level 3: Implementation Tasks')+'\n';
  if(entities.length>0){
    entities.slice(0,3).forEach((ent,i)=>{
      doc30+=(i+1)+'. '+ent+(G?' CRUD実装':' CRUD implementation')+'\n';
    });
  }else{
    doc30+='1. '+(G?'データベース設計':'Database design')+'\n';
    doc30+='2. '+(G?'API実装':'API implementation')+'\n';
  }
  doc30+='\n';
  doc30+=(G?'## ギャップ分析マトリクス':'## Gap Analysis Matrix')+'\n\n';
  doc30+='| '+(G?'サブゴール':'Sub-Goal')+' | '+(G?'現状':'Current State')+' | '+(G?'目標':'Target')+' | '+(G?'ギャップ':'Gap')+' | '+(G?'対策':'Action')+' |\n|------|------|------|------|------|\n';
  flowSteps.slice(0,3).forEach((step,i)=>{
    const current=G?(i===0?'未定義':'未実装'):(i===0?'Undefined':'Not implemented');
    const target=G?(i===0?'KPI定義完了':'MVP実装完了'):(i===0?'KPI defined':'MVP implemented');
    const gap=G?(i===0?'測定可能な指標が不明':'機能未開発'):(i===0?'Measurable metrics unclear':'Features not developed');
    const action=G?(i===0?'24_progress.mdに記載':'開発開始'):(i===0?'Log in 24_progress.md':'Start development');
    doc30+='| '+step+' | '+current+' | '+target+' | '+gap+' | '+action+' |\n';
  });
  doc30+='\n';
  doc30+=(G?'## 優先度マトリクス（Impact × Effort）':'## Priority Matrix (Impact × Effort)')+'\n\n';
  doc30+='```\n';
  doc30+='          '+(G?'大':'High')+'      |\n';
  doc30+='  Impact  '+(G?'中':'Med')+'  '+(G?'🟢P1':'🟢P1')+'  | '+(G?'🟡P2':'🟡P2')+'\n';
  doc30+='          '+(G?'小':'Low')+'  '+(G?'🟡P2':'🟡P2')+'  | '+(G?'⚪P3':'⚪P3')+'\n';
  doc30+='          ─────┼─────\n';
  doc30+='          '+(G?'低':'Low')+'  '+(G?'高':'High')+'\n';
  doc30+='             Effort\n';
  doc30+'```\n\n';
  doc30+='**'+(G?'優先順位':'Priority')+'**:\n';
  doc30+='- '+(G?'🟢 P1 (高Impact・低Effort): ':'🟢 P1 (High Impact, Low Effort): ')+(flowSteps[0]||'Core feature')+'\n';
  doc30+='- '+(G?'🟡 P2 (高Impact・高Effort または 中Impact): ':'🟡 P2 (High Impact & Effort or Med Impact): ')+(flowSteps[1]||'Secondary features')+'\n';
  doc30+='- '+(G?'⚪ P3 (低Impact): ':'⚪ P3 (Low Impact): ')+(G?'Nice-to-have機能':'Nice-to-have features')+'\n\n';
  doc30+=(G?'## 依存関係チェーン':'## Dependency Chain')+'\n\n```mermaid\nflowchart TD\n';
  const node1=G?'A[KPI定義]':'A[Define KPIs]';
  const node2=G?'B[機能設計]':'B[Design Features]';
  const node3=G?'C[DB設計]':'C[Design DB]';
  const node4=G?'D[API実装]':'D[Implement API]';
  const node5=G?'E[UI実装]':'E[Implement UI]';
  const node6=G?'F[テスト]':'F[Testing]';
  const node7=G?'G[デプロイ]':'G[Deploy]';
  doc30+'  '+node1+' --> '+node2+'\n';
  doc30+'  '+node2+' --> '+node3+'\n';
  doc30+'  '+node3+' --> '+node4+'\n';
  doc30+'  '+node4+' --> '+node5+'\n';
  doc30+'  '+node5+' --> '+node6+'\n';
  doc30+'  '+node6+' --> '+node7+'\n';
  doc30+='  style A fill:#4ade80\n';
  doc30+='  style B fill:#4ade80\n';
  doc30+='  style C fill:#fbbf24\n';
  doc30+='  style D fill:#fbbf24\n';
  doc30+='  style E fill:#fbbf24\n';
  doc30+='  style F fill:#f87171\n';
  doc30+='  style G fill:#f87171\n';
  doc30+='```\n\n';
  doc30+=G?'**凡例**: 🟢 完了 | 🟡 進行中 | 🔴 未着手\n\n':'**Legend**: 🟢 Complete | 🟡 In Progress | 🔴 Not Started\n\n';
  doc30+=(G?'## 実装チェックリスト':'## Implementation Checklist')+'\n\n';
  flowSteps.forEach((step,i)=>{
    doc30+='- [ ] **'+step+'**\n';
    if(i===0){
      doc30+='  - [ ] '+(G?'KPI指標を24_progress.mdに記載':'Log KPI metrics in 24_progress.md')+'\n';
      doc30+='  - [ ] '+(G?'測定方法確定（Analytics等）':'Define measurement method (Analytics, etc.)')+'\n';
    }else if(i===1){
      doc30+='  - [ ] '+(G?'機能要件定義':'Define feature requirements')+'\n';
      doc30+='  - [ ] '+(G?'優先度決定':'Determine priority')+'\n';
    }else if(i===2){
      doc30+='  - [ ] '+(G?'DB/API実装':'Implement DB/API')+'\n';
      doc30+='  - [ ] '+(G?'テストケース作成':'Create test cases')+'\n';
    }else{
      doc30+='  - [ ] '+(G?'自動化スクリプト作成':'Create automation scripts')+'\n';
      doc30+='  - [ ] '+(G?'継続的改善ループ構築':'Build continuous improvement loop')+'\n';
    }
  });
  doc30+='\n';
  S.files['docs/30_goal_decomposition.md']=doc30;
}
function genDocs21(a,pn){
  const G=S.genLang==='ja';
  const date=new Date().toISOString().split('T')[0];
  const ganttStart=new Date().toISOString().split('T')[0];
  const fe=a.frontend||'React';const be=a.backend||'Node.js';
  const auth=resolveAuth(a);
  const arch=resolveArch(a);
  const orm=arch.isBaaS?(be.includes('Supabase')?'Supabase Client':be.includes('Firebase')?'Firebase SDK':'Convex'):(a.orm&&a.orm.includes('Drizzle')?'Drizzle':'Prisma');
  const stripPri=s=>(s||'').replace(/\[P[0-2]\]\s*/g,'');
  const entities=(stripPri(a.data_entities)||'users, items').split(/[,、]\s*/).map(e=>e.trim()).filter(Boolean);
  const features=(stripPri(a.mvp_features)||(G?'CRUD操作':'CRUD')).split(', ').filter(Boolean);
  const screens=(stripPri(a.screens)||(G?'ダッシュボード, ログイン':'Dashboard, Login')).split(', ').filter(Boolean);
  const methods=(stripPri(a.dev_methods)||'TDD').split(', ').filter(Boolean);
  const target=(a.target||'').toLowerCase();
  const hasAdmin=/管理者|admin|管理/i.test(target)||features.some(f=>/管理ダッシュボード|admin/i.test(f));
  const hasInstructor=/講師|instructor|teacher/i.test(target);
  const hasPay=a.payment&&!/なし|None|none/.test(a.payment);
  S.files['docs/01_project_overview.md']=`# ${pn} — ${G?'プロジェクト概要書':'Project Overview'}\n> ${date}\n\n${G?'## 目的':'## Purpose'}\n${a.purpose||'N/A'}\n\n${G?'## ターゲット':'## Target'}\n${a.target||'N/A'}\n\n${G?'## 成功指標':'## Success Metrics'}\n${a.success||'N/A'}\n\n${G?'## スケジュール':'## Schedule'}\n${a.deadline||(G?'6ヶ月':'6 months')}\n\n## ${G?'技術スタック':'Tech Stack'}\n- Frontend: ${fe}\n- Backend: ${be}\n- DB: ${a.database||'PostgreSQL'}\n- Deploy: ${a.deploy||'Vercel'}`;
  S.files['docs/02_requirements.md']=`# ${pn} — ${G?'要件定義書':'Requirements'}\n> ${date}\n\n${G?'## 機能要件':'## Functional Requirements'}\n${features.map(f=>'- '+f).join('\n')}\n\n${G?'## 非機能要件':'## Non-functional'}\n- ${G?'レスポンス':'Response'}: ${S.skill==='pro'?'<200ms (p95)':S.skill==='intermediate'?'<500ms (p95)':'<1000ms (p95)'}\n- ${G?'可用性':'Availability'}: ${S.skill==='pro'?'99.9%':S.skill==='intermediate'?'99%':(G?'ベストエフォート':'Best effort')}\n- ${G?'セキュリティ':'Security'}: OWASP Top 10`;
  const archLabelD=G?{baas:'BaaS統合型',bff:'BFF（API Routes統合）',split:'FE/BE分離型',traditional:'従来型クライアント-サーバー'}[arch.pattern]:{baas:'BaaS Integration',bff:'BFF (API Routes)',split:'FE/BE Split',traditional:'Traditional Client-Server'}[arch.pattern];
  const layersD=arch.isBaaS?'1. Presentation Layer ('+fe+')\\n2. BaaS SDK Layer ('+be+')\\n3. Functions Layer (Edge/Cloud Functions)\\n4. Data Layer ('+(a.database||'PostgreSQL')+')':arch.pattern==='bff'?'1. Presentation Layer ('+fe+')\\n2. API Routes Layer (Next.js Route Handlers)\\n3. Domain Layer (Business Logic)\\n4. Data Layer ('+(a.database||'PostgreSQL')+')':'1. Presentation Layer ('+fe+')\\n2. Application Layer (API Routes)\\n3. Domain Layer (Business Logic)\\n4. Infrastructure Layer ('+(a.database||'PostgreSQL')+')';
  S.files['docs/03_architecture.md']=`# ${pn} — ${G?'アーキテクチャ設計書':'Architecture Design'}\n> ${date}\n\n${G?'## アーキテクチャパターン':'## Architecture Pattern'}\n${archLabelD}\n\n${G?'## システム構成図':'## System Diagram'}\n\n\`\`\`\n${arch.diagram}\n\`\`\`\n${arch.note?'\n> '+arch.note+'\n':''}\n${G?'## レイヤー構造':'## Layer Structure'}\n${layersD}`;
  const erLines=[];
  entities.forEach(e=>{
    const cols=getEntityColumns(e,G,entities);
    const colLines=['    uuid id PK'];
    cols.forEach(c=>{
      const mT=c.type.includes('VARCHAR')?'string':c.type.includes('INT')||c.type.includes('DECIMAL')?'int':c.type.includes('BOOLEAN')?'boolean':c.type.includes('TIMESTAMP')||c.type.includes('DATE')||c.type.includes('TIME')?'timestamp':c.type.includes('JSONB')?'json':'string';
      const mC=c.constraint.includes('FK')?'FK':c.constraint.includes('UNIQUE')?'UK':'';
      colLines.push(`    ${mT} ${c.col} ${mC}`.trimEnd());
    });
    if(!cols.length) colLines.push('    string name');
    colLines.push('    timestamp created_at','    timestamp updated_at');
    erLines.push(`  ${e.replace(/\s/g,'_')} {\n${colLines.join('\n')}\n  }`);
  });
  const erRels=[];
  const erInf=inferER(a);
  erInf.relationships.forEach(r=>{
    const clean=r.replace(/\s*\(.*\)\s*$/,'');
    const words=clean.split(/\s+/);
    if(words.length>=3){
      const from=words[0].replace(/\s/g,'_');
      const to=words[words.length-1].replace(/\s/g,'_');
      const mid=words.slice(1,-1).join(' ');
      if(mid.includes('N')&&mid.includes('M')) erRels.push(`  ${from} }o--o{ ${to} : "many-to-many"`);
      else if(mid.includes('0')) erRels.push(`  ${from} o|--o{ ${to} : "self-ref"`);
      else erRels.push(`  ${from} ||--o{ ${to} : "has"`);
    }
  });
  if(!erRels.length){
    const hasUser=entities.some(e=>e.toLowerCase()==='user');
    if(hasUser) entities.forEach(e=>{
      if(e.toLowerCase()!=='user') erRels.push(`  User ||--o{ ${e.replace(/\s/g,'_')} : "has"`);
    });
  }
  const fkMap={};
  erInf.relationships.forEach(r=>{
    const clean=r.replace(/\s*\(.*\)\s*$/,'');
    const words=clean.split(/\s+/);
    if(words.length>=3){
      const parent=words[0],to=words[words.length-1],mid=words.slice(1,-1).join(' ');
      if(!mid.includes('M')&&!mid.includes('0')){
        if(!fkMap[to])fkMap[to]=[];
        const fk=parent.toLowerCase()+'_id';
        if(!fkMap[to].includes(fk))fkMap[to].push(fk);
      }
    }
  });
  entities.forEach(e=>{
    getEntityColumns(e,G,entities).forEach(c=>{
      if(c.constraint.includes('FK')){if(!fkMap[e])fkMap[e]=[];if(!fkMap[e].includes(c.col))fkMap[e].push(c.col);}
    });
  });
  if(!Object.keys(fkMap).length) erRels.forEach(rel=>{
    const m2=rel.match(/(\w+)\s+\|\|--o\{\s+(\w+)/);
    if(m2){if(!fkMap[m2[2]])fkMap[m2[2]]=[];const fk=m2[1].toLowerCase()+'_id';if(!fkMap[m2[2]].includes(fk))fkMap[m2[2]].push(fk);}
  });
  S.files['docs/04_er_diagram.md']=`# ${pn} — ${G?'ER図':'ER Diagram'}\n> ${date}\n\n${G?'## エンティティ関連図':'## Entity Relationship Diagram'}\n\n\`\`\`mermaid\nerDiagram\n${erLines.join('\n')}\n${erRels.join('\n')}\n\`\`\`\n\n${G?'## エンティティ詳細':'## Entity Details'}\n${entities.map(e=>{
    const cols=getEntityColumns(e,G,entities);
    const colRows=cols.map(c=>`| ${c.col} | ${c.type} | ${c.constraint.includes('FK')?'FK':c.constraint||''} | ${c.desc} |`).join('\n');
    const nameRow=cols.length?'':(`| name | VARCHAR(255) | NOT NULL | ${e} ${G?'名':'name'} |\n`);
    return `\n### ${e}\n| ${G?'カラム':'Column'} | ${G?'型':'Type'} | ${G?'制約':'Constraint'} | ${G?'説明':'Desc'} |\n|--------|------|------|------|\n| id | UUID | PK | ${G?'一意識別子':'Unique ID'} |\n${colRows?colRows+'\n':''}${nameRow}| created_at | TIMESTAMP | DEFAULT NOW | ${G?'作成日時':'Created at'} |\n| updated_at | TIMESTAMP | DEFAULT NOW | ${G?'更新日時':'Updated at'} |`;
  }).join('\n')}`;
  let apiEndpoints;
  if(arch.isBaaS){
    const sdkName=be.includes('Supabase')?'Supabase Client SDK':be.includes('Firebase')?'Firebase SDK':'BaaS SDK';
    apiEndpoints=entities.map(e=>{
      const tbl=pluralize(e);
      const cols=getEntityColumns(e,G,entities);
      const insertFields=cols.filter(c=>!c.col.endsWith('_at')&&!c.constraint.includes('DEFAULT NOW')&&!c.constraint.includes('FK')).slice(0,4);
      const insertObj=insertFields.length?insertFields.map(c=>c.col+': '+(c.type.includes('INT')||c.type.includes('DECIMAL')?'0':c.type.includes('BOOLEAN')?'false':`'...'`)).join(', '):'name: \'...\'';
      const fkFields=cols.filter(c=>c.constraint.includes('FK'));
      const fkInsert=fkFields.map(c=>{
        const varName=c.col.replace(/_([a-z])/g,(_,l)=>l.toUpperCase()).replace(/Id$/,'Id');
        return c.col+': '+varName;
      }).join(', ');
      const allInsert=[fkInsert,insertObj].filter(Boolean).join(', ');
      if(be.includes('Supabase')){
        return `\n### ${e} (${G?'テーブル':'table'}: ${tbl})\n\n#### ${G?'一覧取得':'List'}\n\`\`\`ts\nconst { data } = await supabase.from('${tbl}').select('*').range(0, 19).order('created_at', { ascending: false })\n\`\`\`\n\n#### ${G?'詳細取得':'Get by ID'}\n\`\`\`ts\nconst { data } = await supabase.from('${tbl}').select('*').eq('id', id).single()\n\`\`\`\n\n#### ${G?'作成':'Create'}\n\`\`\`ts\nconst { data } = await supabase.from('${tbl}').insert({ ${allInsert} }).select()\n\`\`\`\n\n#### ${G?'更新':'Update'}\n\`\`\`ts\nconst { data } = await supabase.from('${tbl}').update({ ${insertObj} }).eq('id', id).select()\n\`\`\`\n\n#### ${G?'削除':'Delete'}\n\`\`\`ts\nawait supabase.from('${tbl}').delete().eq('id', id)\n\`\`\``;
      }
      return `\n### ${e}\n- SDK: \`${sdkName}\`\n- ${G?'CRUD操作はSDK経由で実行':'CRUD via SDK calls'}`;
    }).join('\n');
  } else {
    apiEndpoints=entities.map(e=>{
      const lower=e.toLowerCase().replace(/\s/g,'_');
      const cols=getEntityColumns(e,G,entities);
      const bodyFields=cols.filter(c=>!c.col.endsWith('_at')&&!c.constraint.includes('DEFAULT NOW')).slice(0,5);
      const bodyObj=bodyFields.length?bodyFields.map(c=>`"${c.col}": "${c.type.includes('INT')?'number':c.type.includes('BOOLEAN')?'boolean':'string'}"`).join(', '):`"name": "string"`;
      const methods=getEntityMethods(e);
      const parts=[`\n### /api/v1/${lower}`];
      if(methods.includes('GET')) parts.push(`\n#### GET /api/v1/${lower}\n- ${G?'説明':'Desc'}: ${G?e+'一覧取得 (ページネーション対応)':'List '+e+' (paginated)'}\n- クエリ: \`?page=1&limit=20&sort=created_at&order=desc\`\n- レスポンス:\n\`\`\`json\n{ "data": [{ "id": "uuid", ${bodyObj} }], "meta": { "total": 100, "page": 1 } }\n\`\`\`\n- ${G?'ステータス':'Status'}: 200 / 401 / 500`);
      if(methods.includes('GET/:id')) parts.push(`\n#### GET /api/v1/${lower}/:id\n- ${G?'説明':'Desc'}: ${G?e+'詳細取得':'Get '+e+' detail'}\n- ${G?'ステータス':'Status'}: 200 / 404`);
      if(methods.includes('POST')) parts.push(`\n#### POST /api/v1/${lower}\n- ${G?'リクエスト':'Request'}: \`{ ${bodyObj} }\`\n- ${G?'ステータス':'Status'}: 201 / 400 / 422`);
      if(methods.includes('PUT/:id')) parts.push(`\n#### PUT /api/v1/${lower}/:id\n- ${G?'リクエスト':'Request'}: \`{ ${bodyObj} }\`\n- ${G?'ステータス':'Status'}: 200 / 404 / 422`);
      if(methods.includes('PATCH/:id')||methods.includes('PATCH')) parts.push(`\n#### PATCH /api/v1/${lower}${methods.includes('PATCH/:id')?'/:id':''}\n- ${G?'リクエスト':'Request'}: \`{ ${bodyObj} }\`\n- ${G?'ステータス':'Status'}: 200 / 404 / 422`);
      if(methods.includes('DELETE/:id')) parts.push(`\n#### DELETE /api/v1/${lower}/:id\n- ${G?'ステータス':'Status'}: 204 / 404`);
      return parts.join('');
    }).join('\n');
  }
  const sNodes=screens.map((s,i)=>`  S${i}["${s}"]`).join('\n');
  const sLinks=[];
  const sIdx={};screens.forEach((s,i)=>sIdx[s]=i);
  const findScreen=(pattern)=>screens.findIndex(s=>new RegExp(pattern,'i').test(s));
  const landingIdx=findScreen('ランディング|landing|LP|トップ|home');
  const loginIdx=findScreen('ログイン|login|サインイン');
  const registerIdx=findScreen('新規登録|register|signup');
  const dashIdx=findScreen('ダッシュボード|dashboard');
  const settingsIdx=findScreen('設定|setting|プロフィール|profile');
  const adminIdx=findScreen('管理|admin');
  const paymentIdx=findScreen('決済|payment|billing|checkout|課金');
  const detailIdx=findScreen('詳細|detail|コース|course|商品|product');
  if(landingIdx>=0&&dashIdx>=0) sLinks.push(`  S${landingIdx} --> S${dashIdx}`);
  screens.forEach((s,i)=>{
    if(i===landingIdx||i===dashIdx) return;
    const isPublic=/ランディング|landing|LP|ログイン|login|register|登録|料金|pricing|about|概要|terms|利用規約|contact|お問い合わせ/i.test(s);
    const isAdmin=/管理|admin/i.test(s);
    if(!isPublic&&dashIdx>=0){
      if(isAdmin){
        sLinks.push(`  S${dashIdx} -->|${G?'管理者のみ':'admin only'}| S${i}`);
      } else {
        sLinks.push(`  S${dashIdx} --> S${i}`);
      }
      if(/設定|setting|プロフィール|profile|詳細|detail|コース|course/i.test(s)) sLinks.push(`  S${i} --> S${dashIdx}`);
    }
  });
  if(detailIdx>=0&&paymentIdx>=0) sLinks.push(`  S${detailIdx} --> S${paymentIdx}`);
  if(!sLinks.length){
    screens.forEach((s,i)=>{if(i<screens.length-1) sLinks.push(`  S${i} --> S${i+1}`);});
  }
  const testMatrix=features.map(f=>{
    const fd=getFeatureDetail(f);
    const header=`\n### ${f}\n| # | ${G?'ケース':'Case'} | ${G?'種別':'Type'} | ${G?'期待結果':'Expected'} | ${G?'優先度':'Priority'} |\n|---|--------|------|----------|--------|`;
    if(fd){
      const tests=G?fd.tests_ja:fd.tests_en;
      return header+'\n'+tests.map((t,i)=>{
        const isErr=t[0].includes('異常')||t[0].includes('Error');
        const type=isErr?'Error':'Normal';
        const pri=i<2?'P0':'P1';
        return `| ${i+1} | ${t[0]} | ${type} | ${t[1]} | ${pri} |`;
      }).join('\n');
    }
    return header+`\n| 1 | ${G?'正常系: 基本操作':'Normal: Basic op'} | Normal | 200/201 ${G?'成功':'OK'} | P0 |\n| 2 | ${G?'正常系: 境界値':'Normal: Boundary'} | Boundary | ${G?'正常処理':'OK'} | P1 |\n| 3 | ${G?'異常系: 必須項目欠落':'Error: Missing field'} | Error | 422 ${G?'バリデーションエラー':'Validation Error'} | P0 |\n| 4 | ${G?'異常系: 権限不足':'Error: No permission'} | Auth | 401/403 | P0 |\n| 5 | ${G?'異常系: 不正フォーマット':'Error: Bad format'} | Error | 400 Bad Request | P1 |\n| 6 | ${G?'異常系: 存在しないID':'Error: ID not found'} | Error | 404 Not Found | P1 |`;
  }).join('\n');
  const deployTarget=a.deploy||'Vercel';
  const dChecks=G?{'Vercel':['Vercel環境変数設定','プレビューデプロイ動作確認','カスタムドメインDNS設定','Edge Functions設定'],'AWS':['IAMロール・ポリシー確認','RDSセキュリティグループ設定','CloudFront設定','Route53 DNS設定'],'Railway':['Railway環境変数設定','PostgresDB接続確認','カスタムドメイン設定','自動デプロイ有効化'],'Netlify':['Netlify環境変数設定','ビルドコマンド確認','カスタムドメインDNS設定','Netlify Functions設定'],'Fly.io':['Fly.io環境変数(fly secrets)','fly.toml設定確認','ヘルスチェック設定','カスタムドメインCERT設定'],'Cloudflare':['Cloudflare環境変数設定','Pages/Workers設定','カスタムドメインDNS設定','KV/D1接続確認']}:{'Vercel':['Vercel env vars','Preview deploy check','Custom domain DNS','Edge Functions config'],'AWS':['IAM roles/policies','RDS security groups','CloudFront config','Route53 DNS'],'Railway':['Railway env vars','Postgres connection','Custom domain','Auto-deploy enabled'],'Netlify':['Netlify env vars','Build command check','Custom domain DNS','Netlify Functions config'],'Fly.io':['Fly.io secrets','fly.toml config','Health check setup','Custom domain CERT'],'Cloudflare':['Cloudflare env vars','Pages/Workers config','Custom domain DNS','KV/D1 connection']};
  const deployChecks=dChecks[deployTarget]||dChecks[Object.keys(dChecks).find(k=>deployTarget.includes(k))]||dChecks['Vercel'];
  const dbName=a.database||'PostgreSQL';
  const dbChecks=dbName.includes('Supa')?(G?['Supabase RLS有効化','API Key設定','接続プール設定']:['Supabase RLS enabled','API Key configured','Connection pool']):G?['マイグレーション実行確認','接続プール設定','バックアップ設定']:['Migration verified','Connection pool','Backup configured'];
  const ganttTasks=features.map((f,i)=>{
    const days=f.match(/Auth|認証/i)?5:f.match(/Admin|管理/i)?4:f.match(/Upload|ファイル/i)?3:3;
    return `  ${f.replace(/[^a-zA-Z0-9ぁ-んァ-ヶー一-龠\s]/g,'')} :s${i}, ${i===0?'after ci':('after s'+(i-1))}, ${days}d`;
  }).join('\n');
  const wbsTasks=features.map((f,i)=>{
    const h=f.match(/Auth|認証/i)?16:f.match(/Admin|管理/i)?12:f.match(/Upload|ファイル/i)?8:f.match(/CRUD|一覧/i)?6:8;
    return `### 2.${i+1} ${f} (${h}h)\n- 2.${i+1}.1 ${G?'データモデル定義':'Data model'} (${Math.ceil(h*0.2)}h)\n- 2.${i+1}.2 ${G?'API実装':'API implementation'} (${Math.ceil(h*0.3)}h)\n- 2.${i+1}.3 ${G?'UI実装':'UI implementation'} (${Math.ceil(h*0.3)}h)\n- 2.${i+1}.4 ${G?'テスト':'Testing'} (${Math.ceil(h*0.2)}h)`;
  }).join('\n\n');
  const totalH=features.reduce((s,f)=>{const h=f.match(/Auth|認証/i)?16:f.match(/Admin|管理/i)?12:f.match(/Upload|ファイル/i)?8:f.match(/CRUD|一覧/i)?6:8;return s+h;},0);
  S.files['docs/22_prompt_playbook.md']=`# ${pn} — ${G?'プロンプトプレイブック':'Prompt Playbook'}\n> ${date}\n\n${G?'## 使い方\n開発フェーズごとに、以下のプロンプトを順番にAI (Claude / Cursor) に投入してください。':'## Usage\nFeed these prompts to AI (Claude / Cursor) in order for each dev phase.'}\n\n## Phase 1: ${G?'プロジェクトセットアップ':'Project Setup'}\n\n### 1-1. ${G?'初期環境構築':'Initial Setup'}\n\`\`\`\n${G?'以下の技術スタックでプロジェクトの初期セットアップを行ってください。':'Set up the project with the following tech stack.'}\n- Frontend: ${fe}\n- Backend: ${be}\n
- DB: ${dbName}\n- Deploy: ${deployTarget}\n${G?'package.json, tsconfig.json, .env.example を生成してください。':'Generate package.json, tsconfig.json, .env.example.'}\n\`\`\`\n\n### 1-2. ${G?'データモデル定義':'Data Model'}\n\`\`\`\n${G?'以下のエンティティの'+orm+'スキーマを生成してください:':'Generate '+orm+' schema for these entities:'} ${entities.join(', ')}\n${entities.map(e=>{const cols=getEntityColumns(e,G,entities);if(!cols.length) return '';return e+': '+cols.map(c=>c.col+'('+c.type+')').join(', ');}).filter(Boolean).join('\n')}\n${G?'各エンティティにはid, created_at, updated_atを含め、リレーションも定義してください。':'Include id, created_at, updated_at for each entity with relations.'}\n
\`\`\`\n\n## Phase 2: ${G?'コア機能開発':'Core Development'}\n\n${features.map((f,i)=>{const fd=getFeatureDetail(f);const criteriaLines=fd?(G?fd.criteria_ja:fd.criteria_en).map(c=>'  - '+c.replace(/\{auth\}/g,a.auth||'OAuth')).join('\n'):'';return `### 2-${i+1}. ${f}\n\`\`\`\n**${G?'Role':'Role'}**: ${G?'フルスタック開発者 (Frontend + Backend)':'Full-stack developer (Frontend + Backend)'}\n\n${G?f+'機能を実装してください。':'Implement '+f+'.'}\n- ${arch.isBaaS?(G?'データアクセス: '+orm+'でCRUDを実装':'Data access: Implement CRUD with '+orm):(G?'APIエンドポイント: /api/v1/ にCRUDを作成':'API endpoint: Create CRUD at /api/v1/')}\n- ${G?'UIコンポーネント: '+fe+'で画面を実装':'UI component: Build screen with '+fe}\n- ${G?'バリデーション: zodスキーマで入力検証':'Validation: zod schema for input'}\n- ${G?'テスト: Vitestでユニットテスト作成':'Test: Write unit tests with Vitest'}${criteriaLines?'\n\n'+(G?'受入条件:':'Acceptance Criteria:')+'\n'+criteriaLines:''}\n\n**${G?'出力形式':'Output Format'}**: ${G?'ファイルパス付きコードブロック。テストを含めること。':'Code blocks with file paths. Include tests.'}\n\`\`\``}).join('\n\n')}\n\n
## Phase 3: ${G?'テスト・デプロイ':'Test & Deploy'}\n\n### 3-1. ${G?'E2Eテスト':'E2E Tests'}\n\`\`\`\n${G?'Playwrightで以下の画面のE2Eテストを作成してください:':'Create Playwright E2E tests for these screens:'} ${screens.join(', ')}\n${G?'正常系・異常系の両方をカバーしてください。':'Cover both happy and error paths.'}\n\`\`\`\n\n### 3-2. ${G?'デプロイ設定':'Deploy Config'}\n\`\`\`\n${G?deployTarget+'へのデプロイ設定を行ってください。':'Configure deployment to '+deployTarget+'.'}\n- CI/CD: GitHub Actions\n
- ${G?'環境変数: .env.exampleに基づいて設定':'Env vars: Based on .env.example'}\n- ${G?'プレビューデプロイの設定も含めてください。':'Include preview deploy config.'}\n\`\`\`\n\n## Phase 4: ${G?'イテレーション':'Iteration'}\n\n### 4-1. ${G?'バグ修正':'Bug Fix'}\n\`\`\`\n**${G?'Role':'Role'}**: ${G?'デバッガー兼フルスタック開発者':'Debugger & Full-stack developer'}\n\n${G?'以下のエラーを修正してください。':'Fix the following error.'}\n\n[${G?'エラー内容を貼り付け':'Paste error here'}]\n\n${G?'手順':'Steps'}:\n1. docs/25_error_logs.md ${G?'を参照し、既知の問題か確認':'to check if it is a known issue'}\n2. ${G?'根本原因を特定':'Identify root cause'}\n3. ${G?'修正とテストを実装':'Implement fix and tests'}\n4. docs/25_error_logs.md ${G?'にエラーを記録':'to log the error'}\n\n**${G?'出力形式':'Output Format'}**: ${G?'修正パッチ (diff形式) + テスト + ログエントリ':'Fix patch (diff) + tests + log entry'}\n\`\`\`\n\n### 4-2. ${G?'機能追加':'Feature Addition'}\n\`\`\`\n**${G?'Role':'Role'}**: ${G?'フルスタック開発者':'Full-stack developer'}\n\n${G?'以下の機能を追加してください。':'Add the following feature.'}\n\n[${G?'機能説明を記載':'Describe feature here'}]\n\n${G?'手順':'Steps'}:\n1. docs/23_tasks.md ${G?'を参照し、タスクを追加':'to add task'}\n2. .spec/constitution.md ${G?'の原則に準拠':'principles'}\n3. ${G?'コード + テストを実装':'Implement code + tests'}\n4. docs/24_progress.md ${G?'を更新':'to update progress'}\n\n**${G?'出力形式':'Output Format'}**: ${G?'ファイルパス付きコードブロック + タスクエントリ + 進捗更新':'Code blocks with file paths + task entry + progress update'}\n\`\`\``;
  const taskList=[];
  taskList.push({title:G?'環境構築':'Environment Setup',label:'setup',hours:3,desc:G?`${fe} + ${be} + ${dbName} のプロジェクト初期セットアップ`:`${fe} + ${be} + ${dbName} initial project setup`});
  taskList.push({title:G?'DevContainer設定':'DevContainer Config',label:'infra',hours:2,desc:G?'開発環境のコンテナ化':'Containerize dev environment'});
  features.forEach(f=>{
    const h=f.match(/Auth|認証/i)?16:f.match(/Admin|管理/i)?12:f.match(/Upload|ファイル/i)?8:f.match(/CRUD|一覧/i)?6:8;
    taskList.push({title:G?f+'の実装':f+' Implementation',label:'feature',hours:h,desc:G?`${f}のAPI・UI・テストを実装`:`Implement API, UI, and tests for ${f}`});
  });
  taskList.push({title:G?'E2Eテスト':'E2E Tests',label:'test',hours:6,desc:G?'Playwrightでの統合テスト':'Integration tests with Playwright'});
  taskList.push({title:G?'パフォーマンス最適化':'Performance Optimization',label:'perf',hours:4,desc:G?'Lighthouse 90+目標':'Lighthouse 90+ target'});
  taskList.push({title:G?'リリース準備':'Release Prep',label:'release',hours:3,desc:G?`${deployTarget}へのデプロイ・モニタリング設定`:`Deploy to ${deployTarget} & monitoring setup`});
  S.files['docs/23_tasks.md']=`# ${pn} — ${G?'タスク一覧 (GitHub Issues形式)':'Task List (GitHub Issues)'}\n> ${date}\n\n${taskList.map((t,i)=>{
    let acLines;
    if(t.label==='feature'){
      const featureName=t.title.replace(/(の実装| Implementation)/g,'');
      const fd=getFeatureDetail(featureName);
      if(fd){
        const criteria=(G?fd.criteria_ja:fd.criteria_en).map(c=>c.replace(/\{auth\}/g,a.auth||'OAuth'));
        acLines=criteria.map(c=>'  - [ ] '+c).join('\n');
      }
    }
    if(!acLines){
      acLines=`  - [ ] ${G?'実装完了':'Implementation done'}\n  - [ ] ${G?'テスト通過':'Tests passing'}\n  - [ ] ${G?'コードレビュー完了':'Code review done'}`;
    }
    return `## Issue #${i+1}: ${t.title}\n- **${G?'ラベル':'Label'}**: \`${t.label}\`\n- **${G?'見積り':'Estimate'}**: ${t.hours}h\n- **${G?'説明':'Description'}**: ${t.desc}\n- **Acceptance Criteria**:\n${acLines}`;
  }).join('\n\n')}\n\n---\n
**${G?'合計タスク数':'Total Tasks'}**: ${taskList.length} | **${G?'総見積り':'Total Est.'}**: ${taskList.reduce((s,t)=>s+t.hours,0)}h`;
  const docTemplates=[
    ['05_api_design',G?(arch.isBaaS?'データアクセス設計書 (SDK)':'API設計書 (OpenAPI準拠)'):(arch.isBaaS?'Data Access Design (SDK)':'API Design (OpenAPI)'),`${G?'## 認証':'## Authentication'}\n- ${G?'方式':'Method'}: ${auth.tokenType}\n- ${arch.isBaaS?(G?'アクセス方式: '+orm+' SDK':'Access: '+orm+' SDK'):'ヘッダー: \\`Authorization: Bearer <token>\\`'}\n\n${arch.isBaaS?'':(G?'## 共通レスポンス':'## Common Responses')+'\\n| '+(G?'ステータス':'Status')+' | '+(G?'意味':'Meaning')+' |\\n|-----------|------|\\n| 200 | OK |\\n| 201 | Created |\\n| 400 | Bad Request |\\n| 401 | Unauthorized |\\n| 403 | Forbidden |\\n| 404 | Not Found |\\n| 422 | Validation Error |\\n| 500 | Internal Error |\\n\\n'}\n${G?(arch.isBaaS?'## データアクセスパターン':'## エンドポイント一覧'):(arch.isBaaS?'## Data Access Patterns':'## Endpoints')}\n${apiEndpoints}`],
    ['06_screen_design',G?'画面設計書 & 画面遷移図':'Screen Design & Flow',`${G?'## 画面遷移図':'## Screen Flow'}\n\n\`\`\`mermaid\nflowchart LR\n${sNodes}\n${sLinks.join('\n')}\n\`\`\`\n\n${G?'## 画面一覧':'## Screen List'}\n${screens.map((s,i)=>{const isPublic=s.match(/ログイン|Login|Register|登録|ランディング|Landing|LP|トップ|Top|ホーム|Home|About|概要|利用規約|Terms|料金|Pricing|お問い合わせ|Contact/i);const comps=getScreenComponents(s,G);const compList=comps?'\n- '+(G?'主要コンポーネント':'Key Components')+':\n'+comps.map(c=>'  - '+c).join('\n'):'\n- '+(G?'コンポーネント':'Components')+': Header, '+(isPublic?'':'Sidebar, ')+'Content, Footer';return `\n### ${i+1}. ${s}\n- URL: \`${(genRoutes(a).find(r=>r.name===s.replace(/\(P[0-2]\)/gi,'').trim())||{path:'/'+(s.toLowerCase().replace(/[^a-z0-9]/g,'-'))}).path}\`\n- ${G?'認証':'Auth'}: ${isPublic?(G?'不要':'Not required'):(G?'必要':'Required')}${compList}`;}).join('\n')}`],
    ['07_test_cases',G?'テストケース定義書':'Test Cases',`${G?'## テスト戦略':'## Test Strategy'}\n- ${G?'ユニット':'Unit'}: Vitest (80%+)\n- E2E: Playwright\n- ${G?'コンポーネント':'Component'}: Testing Library\n\n${G?'## テストケースマトリクス':'## Test Case Matrix'}\n${testMatrix}\n\n${G?'## 実行コマンド':'## Run Commands'}\n\`\`\`bash\nnpm run test\nnpm run test:e2e\nnpm run test:coverage\n\`\`\``],
    ['08_security',G?'セキュリティ設計書':'Security Design',`${G?'## セキュリティ対策':'## Security Measures'}\n- ${G?'認証':'Auth'}: ${auth.sot}\n- HTTPS${G?'必須':' required'}\n- CSP (Content Security Policy)\n- Rate Limiting\n- Input Validation${hasAdmin?'\n\n'+(G?'## RBAC（ロールベースアクセス制御）':'## RBAC (Role-Based Access Control)')+'\n\n| '+(G?'ロール':'Role')+' | '+(G?'権限':'Permissions')+' |\n|--------|----------|\n| user | '+(G?'自分のデータの読取・更新':'Read/update own data')+' |\n'+(hasInstructor?'| instructor | '+(G?'コンテンツ作成・編集・自分の受講者管理':'Create/edit content, manage own students')+' |\n':'')+'| admin | '+(G?'全データの読取・更新・削除、ユーザー管理、システム設定':'Full CRUD, user management, system settings')+' |\n\n'+(G?'### RBACポリシー実装':'### RBAC Policy Implementation')+'\n- profiles.role '+(G?'カラムでロール管理':'column for role management')+'\n- '+(arch.isBaaS&&be.includes('Supabase')?'RLS: auth.uid() = user_id AND role check via profiles':'Middleware: role check before protected routes')+'\n- '+(G?'管理画面ルート':'Admin routes')+': /admin/ → role=admin '+(G?'チェック必須':'check required'):''}${hasPay&&(a.payment||'').includes('Stripe')?'\n\n'+(G?'## 決済セキュリティ':'## Payment Security')+'\n- Stripe Webhook '+(G?'署名検証':'signature verification')+' (STRIPE_WEBHOOK_SECRET)\n- '+(G?'冪等キーによる重複処理防止':'Idempotency key for duplicate prevention')+'\n- PCI DSS '+(G?'準拠':'compliance')+' (Stripe Elements '+(G?'使用で対応':'handles this')+')\n- '+(G?'サーバーサイドのみで':'Server-side only for')+' stripe.customers / stripe.subscriptions '+(G?'操作':'operations'):''}`],
    ['09_release_checklist',G?'リリースチェックリスト':'Release Checklist',`## ${G?'デプロイ先':'Deploy Target'}: ${deployTarget}\n\n### 1. ${G?'コード品質':'Code Quality'}\n${(G?['TypeScript 型エラー 0件','ESLint エラー 0件','全テストパス','カバレッジ 80%+']:['TypeScript: 0 type errors','ESLint: 0 errors','All tests pass','Coverage 80%+']).map(c=>'- [ ] '+c).join('\n')}\n\n### 2. ${G?'セキュリティ':'Security'}\n
${(G?['環境変数にシークレット未ハードコード','CORS設定','CSP設定','認証・認可テスト完了']:['No hardcoded secrets in env vars','CORS config','CSP config','Auth/authz tests done']).map(c=>'- [ ] '+c).join('\n')}\n\n### 3. ${G?'インフラ':'Infrastructure'} (${deployTarget})\n${deployChecks.map(c=>'- [ ] '+c).join('\n')}\n\n### 4. ${G?'データベース':'Database'} (${dbName})\n${dbChecks.map(c=>'- [ ] '+c).join('\n')}\n\n### 5. ${G?'パフォーマンス':'Performance'}\n
${(G?['Lighthouse 90+','LCP < 2.5s','画像最適化','バンドルサイズ確認']:['Lighthouse 90+','LCP < 2.5s','Image optimization','Bundle size check']).map(c=>'- [ ] '+c).join('\n')}\n\n### 6. ${G?'モニタリング':'Monitoring'}\n${(G?['Sentry設定','アクセスログ','アラート閾値']:['Sentry setup','Access logs','Alert thresholds']).map(c=>'- [ ] '+c).join('\n')}`],
    ['10_gantt',G?'ガントチャート':'Gantt Chart',`${G?'## プロジェクトスケジュール':'## Project Schedule'}\n\n\`\`\`mermaid\ngantt\n  title ${pn} ${G?'開発スケジュール':'Development Schedule'}\n  dateFormat YYYY-MM-DD\n  axisFormat %m/%d\n  section Sprint 0\n  ${G?'プロジェクトセットアップ':'Project Setup'} :env, ${ganttStart}, 2d\n  ${G?'DevContainer構築':'DevContainer Setup'} :dc, after env, 1d\n  ${G?'CI/CD設定':'CI/CD Setup'} :ci, after dc, 1d\n  section Sprint 1-2\n${ganttTasks}\n  section Sprint 3\n
  ${G?'E2Eテスト':'E2E Tests'} :test, after s${features.length-1}, 3d\n  ${G?'パフォーマンス最適化':'Perf Optimization'} :perf, after test, 2d\n  ${G?'リリース':'Release'} :rel, after perf, 1d\n\`\`\`\n\n${G?'## マイルストーン':'## Milestones'}\n| MS | ${G?'目標':'Goal'} | ${G?'成果物':'Deliverable'} |\n|----|------|--------|\n| Alpha | Sprint 1 ${G?'完了':'done'} | ${G?'コア機能動作':'Core features working'} |\n| Beta | Sprint 2 ${G?'完了':'done'} | ${G?'全機能実装':'All features implemented'} |\n
| RC | Sprint 3 ${G?'中盤':'mid'} | ${G?'テスト完了':'Tests complete'} |\n| GA | Sprint 3 ${G?'末':'end'} | ${G?'本番リリース':'Production release'} |`],
    ['11_wbs',G?'WBS (作業分解構造)':'WBS (Work Breakdown)',`${G?'## WBS — 総工数:':'## WBS — Total Hours:'} 約${totalH+26}h\n\n### 1. ${G?'プロジェクト管理':'Project Management'} (8h)\n- 1.1 ${G?'要件定義・SDD作成':'Requirements & SDD'} (3h)\n- 1.2 ${G?'技術選定・環境構築':'Tech selection & setup'} (3h)\n- 1.3 ${G?'進捗管理・レビュー':'Progress mgmt & review'} (2h)\n\n## 2. ${G?'機能開発':'Feature Development'} (${totalH}h)\n\n${wbsTasks}\n\n### 3. ${G?'テスト':'Testing'} (12h)\n- 3.1 ${G?'ユニットテスト':'Unit tests'} (4h)\n
- 3.2 ${G?'E2Eテスト':'E2E tests'} (4h)\n- 3.3 ${G?'バグ修正':'Bug fixes'} (4h)\n\n### 4. ${G?'デプロイ':'Deploy'} (6h)\n- 4.1 ${G?'ステージング構築':'Staging setup'} (2h)\n- 4.2 ${G?'本番デプロイ':'Production deploy'} (2h)\n- 4.3 ${G?'モニタリング設定':'Monitoring setup'} (2h)`],
    ['12_driven_dev',G?'駆動開発ガイド':'Dev Methods Guide',`${G?'## 採用手法':'## Methods Used'}\n${methods.map(m=>`\n### ${m}\n- ${G?'適用範囲: 全Sprint':'Scope: All sprints'}\n- ${G?'実践ルール: .spec/ に準拠':'Rule: Follow .spec/'}`).join('\n')}`],
    ['13_glossary',G?'用語集':'Glossary',`${G?'## 用語定義':'## Terms'}\n${entities.map(e=>`| ${e} | ${G?pn+'における'+e+'データ':e+' data in '+pn} |`).join('\n')}`],
    ['14_risk',G?'リスク管理表':'Risk Management',`${G?'## リスク一覧':'## Risk List'}\n| ${G?'リスク':'Risk'} | ${G?'影響度':'Impact'} | ${G?'対策':'Mitigation'} |\n|--------|--------|------|\n| ${G?'技術的負債':'Tech debt'} | ${G?'高':'High'} | ${G?'コードレビュー必須':'Mandatory code review'} |\n| ${G?'スケジュール遅延':'Schedule delay'} | ${G?'中':'Mid'} | ${G?'バッファ設定':'Buffer planning'} |\n| ${G?'セキュリティ':'Security'} | ${G?'高':'High'} | ${G?'定期監査':'Regular audit'} |`],
    ['15_meeting',G?'議事録テンプレート':'Meeting Notes Template',`${G?'## 議事録':'## Meeting Notes'}\n- ${G?'日時':'Date'}:\n- ${G?'参加者':'Attendees'}:\n- ${G?'アジェンダ':'Agenda'}:\n- ${G?'決定事項':'Decisions'}:\n- ${G?'次回アクション':'Next Actions'}:`],
    ['16_review',G?'コードレビューガイド':'Code Review Guide',`${G?'## レビュー基準':'## Review Criteria'}\n1. TypeScript strict ${G?'モード準拠':'mode'}\n2. ${G?'テスト付き':'With tests'}\n3. ${G?'.spec/ との整合性':'.spec/ alignment'}\n4. ${G?'パフォーマンス考慮':'Performance'}\n5. ${G?'セキュリティチェック':'Security check'}`],
    ['17_monitoring',G?'監視設計書':'Monitoring Design',`${G?'## 監視項目':'## Monitoring Items'}\n- ${G?'アプリケーションログ':'Application logs'}\n- ${G?'エラーレート':'Error rate'}\n- ${G?'レスポンスタイム':'Response time'}\n- CPU/${G?'メモリ使用率':'Memory usage'}\n\n${G?'## ツール':'## Tools'}\n- ${deployTarget.includes('Vercel')?'Vercel Analytics':deployTarget.includes('Netlify')?'Netlify Analytics':'PostHog / Plausible Analytics'}\n- Sentry (${G?'エラー追跡':'Error tracking'})${arch.isBaaS&&be.includes('Supabase')?'\n- Supabase Dashboard ('+( G?'DB監視・RLS監査':'DB monitoring & RLS audit')+')':''}`],
    ['18_data_migration',G?'データ移行計画書':'Data Migration Plan',`${G?'## 移行戦略':'## Migration Strategy'}\n- ${G?'段階的移行':'Phased migration'}\n- ${G?'ロールバック計画':'Rollback plan'}\n- ${G?'データ検証手順':'Data validation'}`],
    ['19_performance',G?'パフォーマンス設計書':'Performance Design',`${G?'## 目標値':'## Targets'}\n- LCP: < 2.5s\n- FID: < 100ms\n- CLS: < 0.1\n\n${G?'## 最適化施策':'## Optimizations'}\n- ${G?'画像最適化':'Image optimization'} (${fe.includes('Next')?'next/image':fe.includes('Vite')||fe.includes('SPA')?'vite-imagetools / sharp':'sharp / imagemin'})\n- Code Splitting${fe.includes('Vite')||fe.includes('SPA')?' (Vite dynamic import)':fe.includes('Next')?' (Next.js dynamic)':''}\n- ${deployTarget.includes('Vercel')||deployTarget.includes('Netlify')?'Edge Caching (CDN)':'CDN Caching'}`],
    ['20_a11y',G?'アクセシビリティ設計書':'Accessibility Design',`## WCAG 2.1 AA\n- ${G?'キーボードナビゲーション':'Keyboard navigation'}\n- ${G?'スクリーンリーダー対応':'Screen reader support'}\n- ${G?'カラーコントラスト比':'Color contrast ratio'} 4.5:1+\n- ${G?'フォーカス管理':'Focus management'}`],
    ['21_changelog',G?'変更履歴':'Changelog',`## v1.0.0 (${date})\n- ${G?'初期リリース':'Initial release'}\n- ${features.slice(0,3).join(', ')} 実装\n\n## ${G?'DevForge v9による自動生成':'Auto-generated by DevForge v9'}\n- ${G?'60+ファイル生成':'60+ files generated'}\n- ${G?'9つの柱対応':'9 pillars support'}\n- ${G?'Mermaid図・プロンプトプレイブック・タスク分解対応':'Mermaid diagrams, Prompt Playbook, Task decomposition'}`],
    ['24_progress',G?'進捗管理表':'Progress Tracker',
  `${G?'> AIエージェントはタスク完了後にこのファイルを更新してください。':
       '> AI agents should update this file after completing each task.'}
## ${G?'凡例':'Legend'}
- [ ] ${G?'未着手':'Not started'} / [x] ${G?'完了':'Done'}
## Sprint 0: ${G?'環境構築':'Setup'}
- [ ] ${G?'リポジトリ初期化':'Repo init'}
- [ ] DevContainer ${G?'構築':'setup'}
- [ ] CI/CD
- [ ] ${G?'DBスキーマ':'DB schema'}
- [ ] ${G?'認証基盤':'Auth'} (${auth.sot})
## Sprint 1-2: ${G?'機能開発':'Features'}
${features.map(f=>'- [ ] '+f).join('\n')}
## Sprint 3: ${G?'テスト・リリース':'Test & Release'}
- [ ] ${G?'テスト 80%+':'Tests 80%+'}
- [ ] E2E
- [ ] ${G?'パフォーマンス最適化':'Perf optimization'}
- [ ] ${G?'本番デプロイ':'Production deploy'}
## ${G?'サマリー':'Summary'}
| ${G?'フェーズ':'Phase'} | ${G?'完了':'Done'} | ${G?'合計':'Total'} |
|---|---|---|
| Sprint 0 | 0 | 5 |
| Sprint 1-2 | 0 | ${features.length} |
| Sprint 3 | 0 | 4 |
## ${G?'更新履歴':'Log'}
| ${G?'日付':'Date'} | ${G?'内容':'Update'} | ${G?'更新者':'By'} |
|---|---|---|
| ${date} | ${G?'初期生成':'Initial'} | DevForge |`],
    ['25_error_logs',G?'エラーログ':'Error Logs',
  `${G?'> 解決済みエラーをここに記録し、再発を防いでください。':
       '> Log resolved errors here to prevent recurrence.'}
## ${G?'記録フォーマット':'Format'}
### [${G?'日付':'Date'}] ${G?'エラー概要':'Summary'}
- **${G?'症状':'Symptom'}**:
- **${G?'原因':'Cause'}**:
- **${G?'解決策':'Fix'}**:
- **${G?'防止策':'Prevention'}**:
- **${G?'ファイル':'Files'}**: \`path/to/file\`
---
## ${G?'記録例':'Example'}
### [${date}] ${arch.isBaaS?(G?'RLSポリシーエラー':'RLS Policy Error'):(G?'API認証エラー':'API Auth Error')}
- **${G?'症状':'Symptom'}**: ${arch.isBaaS?(G?'INSERT時に403':'403 on INSERT'):(G?'401 Unauthorized':'401 Unauthorized')}
- **${G?'原因':'Cause'}**: ${arch.isBaaS?(G?'auth.uid()チェック不足':'Missing auth.uid() check'):(G?'トークン検証ミドルウェア未適用':'Missing auth middleware')}
- **${G?'解決策':'Fix'}**: ${arch.isBaaS?'\\`WITH CHECK (auth.uid() = user_id)\\`':'\\`app.use(authMiddleware)\\`'}
- **${G?'防止策':'Prevention'}**: ${arch.isBaaS?(G?'新テーブルには必ずRLSテンプレート適用':'Always apply RLS template for new tables'):(G?'新ルートには必ずauthMiddleware適用':'Always apply authMiddleware to new routes')}
---
## ${G?'パターン別':'By Pattern'}
### ${G?'認証・認可':'Auth'}
_(${G?'追記してください':'Add entries here'})_
### ${G?'データベース':'Database'}
_(${G?'追記してください':'Add entries here'})_
### ${G?'デプロイ':'Deploy'}
_(${G?'追記してください':'Add entries here'})_`],
    ['28_qa_strategy',G?'QA戦略・バグ検出ガイド':'QA Strategy & Bug Detection Guide',(()=>{
  const domain=detectDomain(a.purpose);
  const qa=domain?getDomainQA(domain,G):null;
  if(qa){
    const priObj={};qa.priority.split('|').forEach(p=>{const[k,v]=p.split(':');priObj[k]=v;});
    return `${G?'## 対象ドメイン':'## Target Domain'}\n**${domain}**\n\n${G?'## QA重点領域':'## QA Focus Areas'}\n${qa.focus.map((f,i)=>`${i+1}. ${f}`).join('\n')}\n\n${G?'## よくあるバグパターン':'## Common Bug Patterns'}\n${qa.bugs.map((b,i)=>`- **${G?'パターン':'Pattern'} ${i+1}**: ${b}`).join('\n')}\n\n${G?'## 業界横断チェックリスト':'## Cross-Cutting Checklist'}\n${qa.crossCutting.length>0?qa.crossCutting.map((c,i)=>`${i+1}. ${c}`).join('\n'):(G?'該当なし':'None applicable')}\n\n${G?'## 優先度マトリクス':'## Priority Matrix'}\n| ${G?'カテゴリ':'Category'} | ${G?'優先度':'Priority'} |\n|----------|----------|\n| ${G?'セキュリティ':'Security'} | ${priObj.Security||'MED'} |\n| ${G?'パフォーマンス':'Performance'} | ${priObj.Performance||'MED'} |\n| ${G?'データ整合性':'Data Integrity'} | ${priObj.DataIntegrity||'MED'} |\n| UX | ${priObj.UX||'MED'} |\n| ${G?'コンプライアンス':'Compliance'} | ${priObj.Compliance||'LOW'} |\n\n${G?'## テスト実行順序':'## Test Execution Order'}\n${G?'優先度に基づいた推奨実行順序:':'Recommended execution order by priority:'}\n1. ${priObj.Security==='CRITICAL'||priObj.DataIntegrity==='CRITICAL'?(G?'セキュリティ・データ整合性テスト':'Security & Data Integrity tests'):priObj.UX==='CRITICAL'?(G?'UXテスト':'UX tests'):(G?'パフォーマンステスト':'Performance tests')}\n2. ${priObj.Performance==='HIGH'||priObj.Security==='HIGH'?(G?'パフォーマンス・セキュリティテスト':'Performance & Security tests'):(G?'機能テスト':'Functional tests')}\n3. ${G?'統合テスト':'Integration tests'}\n4. ${G?'回帰テスト':'Regression tests'}\n\n${G?'## 参考リソース':'## References'}\n- OWASP Top 10: https://owasp.org/www-project-top-ten/\n- ${domain==='education'?'FERPA Compliance':domain==='health'?'HIPAA Compliance':domain==='fintech'?'PCI DSS Compliance':domain==='hr'?'GDPR/CCPA Compliance':domain==='saas'?'SOC 2 Compliance':'Industry Best Practices'}`;
  }
  return `${G?'## 汎用QAチェックリスト':'## Generic QA Checklist'}\n\n${G?'ドメイン未検出のため、汎用的なQA項目を記載します。':'Domain not detected. Generic QA items listed below.'}\n\n### ${G?'機能テスト':'Functional Testing'}\n- [ ] ${G?'全機能の正常系動作確認':'Verify all features work (happy path)'}\n- [ ] ${G?'エラーハンドリング検証':'Error handling validation'}\n- [ ] ${G?'境界値テスト':'Boundary value testing'}\n\n### ${G?'セキュリティ':'Security'}\n- [ ] ${G?'認証・認可テスト':'Auth/authz testing'}\n- [ ] ${G?'入力バリデーション':'Input validation'}\n- [ ] XSS/CSRF ${G?'対策確認':'prevention check'}\n- [ ] ${G?'機密情報の漏洩チェック':'Sensitive data leakage check'}\n\n### ${G?'パフォーマンス':'Performance'}\n- [ ] ${G?'レスポンスタイム測定':'Response time measurement'}\n- [ ] ${G?'高負荷テスト':'Load testing'}\n- [ ] ${G?'メモリリーク検出':'Memory leak detection'}\n\n### ${G?'互換性':'Compatibility'}\n- [ ] ${G?'ブラウザ別動作確認':'Cross-browser testing'}\n- [ ] ${G?'モバイル対応確認':'Mobile responsiveness'}\n- [ ] ${G?'アクセシビリティ (WCAG)':'Accessibility (WCAG)'}\n\n### ${G?'データ整合性':'Data Integrity'}\n- [ ] ${G?'トランザクション完全性':'Transaction integrity'}\n- [ ] ${G?'データ同期確認':'Data sync validation'}\n- [ ] ${G?'バックアップ・リストア検証':'Backup/restore verification'}`;
})()],
    ['31_industry_playbook',G?'業種別実装プレイブック':'Industry Implementation Playbook',(()=>{
  const domain=detectDomain(a.purpose)||'_default';
  const pb=DOMAIN_PLAYBOOK[domain]||DOMAIN_PLAYBOOK._default;
  const qa=domain!=='_default'?getDomainQA(domain,G):null;
  const rf=REVERSE_FLOW_MAP[domain]||REVERSE_FLOW_MAP._default;
  let s=`${G?'## 🎯 対象ドメイン':'## 🎯 Target Domain'}\n**${domain}**${domain==='_default'?(G?' (汎用)':' (generic)'):''}\n\n${G?'## 📐 実装レベル・リバースフロー':'## 📐 Implementation-Level Reverse Flow'}\n${G?'ゴールから逆算した具体的な実装パターン:':'Concrete implementation patterns reverse-engineered from goals:'}\n\n${(G?pb.impl_ja:pb.impl_en).map((p,i)=>`${i+1}. ${p}`).join('\n\n')}\n\n`;
  if(qa){
    const priObj={};qa.priority.split('|').forEach(p=>{const[k,v]=p.split(':');priObj[k]=v;});
    s+=`${G?'## 🧪 QA優先度マトリクス':'## 🧪 QA Priority Matrix'}\n| ${G?'カテゴリ':'Category'} | ${G?'優先度':'Priority'} |\n|----------|----------|\n| ${G?'セキュリティ':'Security'} | ${priObj.Security||'MED'} |\n| ${G?'パフォーマンス':'Performance'} | ${priObj.Performance||'MED'} |\n| ${G?'データ整合性':'Data Integrity'} | ${priObj.DataIntegrity||'MED'} |\n| UX | ${priObj.UX||'MED'} |\n| ${G?'コンプライアンス':'Compliance'} | ${priObj.Compliance||'LOW'} |\n\n${G?'**重点領域**:':'**Focus Areas**:'}\n${qa.focus.map((f,i)=>`- ${f}`).join('\n')}\n\n`;
  }
  s+=`${G?'## 🐛 予測バグTOP3と予防策':'## 🐛 Top 3 Predicted Bugs & Prevention'}\n${G?'この業種で最も発生しやすいバグと対策:':'Most common bugs in this industry and countermeasures:'}\n\n${(G?pb.prevent_ja:pb.prevent_en).map((p,i)=>{const[bug,fix]=p.split('|');return `### ${i+1}. ${bug}\n${fix}`;}).join('\n\n')}\n\n${G?'## 📜 コンプライアンス・チェックリスト':'## 📜 Compliance Checklist'}\n${(G?pb.compliance_ja:pb.compliance_en).map((c,i)=>`- [ ] ${c}`).join('\n')}\n\n${G?'## 🧠 コンテキスト・エンジニアリング・プロトコル':'## 🧠 Context Engineering Protocol'}\n${G?'タスクごとに読むべきドキュメント:':'Documents to read per task type:'}\n\n| ${G?'タスク種別':'Task Type'} | ${G?'参照ドキュメント':'Reference Documents'} |\n|----------|----------|\n${(G?pb.ctx_ja:pb.ctx_en).map(c=>{const[task,docs]=c.split('→');return `| ${task} | ${docs} |`;}).join('\n')}\n\n${G?'## 🎨 カスタムスキル設計図':'## 🎨 Custom Skill Blueprint'}\n${G?'この業種に特化したAIスキル定義:':'Domain-specific AI skill definition:'}\n\n`;
  const skillStr=G?pb.skill_ja:pb.skill_en;
  if(skillStr&&typeof skillStr==='string'&&skillStr!==''){
    const skill=skillStr.split('|');
    s+=`**${G?'役割':'Role'}**: ${skill[0]}\n\n**${G?'目的':'Purpose'}**: ${skill[1]}\n\n**${G?'入力':'Input'}**: ${skill[2]}\n\n**${G?'判断基準':'Judgment Criteria'}**: ${skill[3]}\n\n**${G?'出力':'Output'}**: ${skill[4]}\n\n`;
  }
  s+=`${G?'## 🔄 コンテキスト・ローテーション戦略':'## 🔄 Context Rotation Strategy'}\n\n${G?'**4原則** (コンテキストウィンドウを溢れさせない方法):':'**4 Principles** (how to prevent context window overflow):'}\n\n1. **Write (${G?'記述':'Documentation'})**: ${G?'脳内の仕様を `docs/` に書き出す。AIの外部記憶として機能。':'Write specifications from your mind into `docs/`. Functions as AI external memory.'}\n2. **Select (${G?'選択':'Selection'})**: ${G?'必要なファイルだけ読み込ませる。上記の「タスク別参照ドキュメント」を活用。':'Load only necessary files. Use "Documents per Task Type" table above.'}\n3. **Compress (${G?'圧縮':'Compression'})**: ${G?'履歴が肥大化したら要約し、エッセンスだけ残す。長い会話は定期的に圧縮。':'When history bloats, summarize and keep essence only. Compress long conversations periodically.'}\n4. **Isolate (${G?'分離':'Isolation'})**: ${G?'調査・実験はサブエージェント (Task tool) で実行。結論だけメインコンテキストに持ち帰る。':'Run research/experiments in sub-agents (Task tool). Bring back only conclusions to main context.'}\n\n${G?'## 📊 KPI参考値':'## 📊 KPI Reference Values'}\n${G?'この業種の典型的なKPI目標値:':'Typical KPI targets for this domain:'}\n\n${(G?rf.kpi_ja:rf.kpi_en).map((k,i)=>`- ${k}`).join('\n')}\n\n${G?'## 💡 推奨事項':'## 💡 Recommendations'}\n${G?'- 実装前に `docs/architecture.md` と `docs/design_system.md` を必ず読み、既存パターンに従う':'- Read `docs/architecture.md` and `docs/design_system.md` before implementation, follow existing patterns'}\n${G?'- バグ発生時は `docs/error_logs.md` に記録し、再発防止策を明記':'- When bugs occur, record in `docs/error_logs.md` with prevention strategies'}\n${G?'- 進捗は `docs/progress.md` を随時更新し、プロジェクトの現在地を明確化':'- Update `docs/progress.md` frequently to clarify project status'}\n${G?'- コンプライアンス要件は設計段階から考慮し、後付け対応を避ける':'- Consider compliance requirements from design phase, avoid retrofitting'}`;
  return s;
})()],
  ];
  docTemplates.forEach(([file,title,content])=>{
    S.files[`docs/${file}.md`]=`# ${pn} — ${title}\n> ${date}\n\n${content}`;
  });
  const buildCmd=fe.includes('Next')?'next build':fe.includes('Vite')||fe.includes('SPA')?'vite build':'npm run build';
  const buildPrefix=buildCmd.startsWith('npm')?'':'npx ';
  const nodeV='22';
  S.files['.github/workflows/ci.yml']=[
    'name: CI',
    'on:',
    '  push:',
    '    branches: [main, develop]',
    '  pull_request:',
    '    branches: [main]',
    '',
    'jobs:',
    '  ci:',
    '    runs-on: ubuntu-latest',
    '    steps:',
    '      - uses: actions/checkout@v4',
    '      - uses: actions/setup-node@v4',
    '        with:',
    '          node-version: '+nodeV,
    '          cache: npm',
    '      - run: npm ci',
    '      - run: npm run lint',
    '      - run: npm run test',
    '      - run: '+buildPrefix+buildCmd,
    ''
  ].join('\n');
}
function pluralize(name){
  const lower=name.toLowerCase();
  if(/^(progress|media|data|feedback|equipment|information|news|analytics|metadata|settings)$/i.test(name)) return lower;
  const irreg={person:'people',child:'children',quiz:'quizzes',status:'statuses',category:'categories',entry:'entries'};
  if(irreg[lower]) return irreg[lower];
  if(lower.endsWith('s')||lower.endsWith('x')||lower.endsWith('ch')||lower.endsWith('sh')) return lower+'es';
  if(lower.endsWith('y')&&!/[aeiou]y$/i.test(lower)) return lower.slice(0,-1)+'ies';
  return lower+'s';
}
function isNone(v){
  return !v||v==='none'||v==='None'||v==='なし';
}
const SCREEN_COMPONENTS={
  'ランディング|landing|LP|トップ|home':{
    components_ja:['ヒーローセクション(CTA)','特徴/メリット一覧','料金プラン比較表','ユーザーレビュー/実績','FAQ アコーディオン','フッター(リンク集)'],
    components_en:['Hero section with CTA','Features / benefits list','Pricing comparison table','Testimonials / social proof','FAQ accordion','Footer with links'],
  },
  'ダッシュボード|dashboard':{
    components_ja:['統計カード(KPI数値)','アクティビティグラフ(recharts)','最近のアクティビティ一覧','クイックアクションボタン','サイドバーナビゲーション'],
    components_en:['Stats cards (KPI metrics)','Activity chart (recharts)','Recent activity feed','Quick action buttons','Sidebar navigation'],
  },
  '設定|settings|プロフィール|profile':{
    components_ja:['プロフィール編集フォーム','パスワード変更','通知設定トグル','テーマ切替(ダーク/ライト)','アカウント削除'],
    components_en:['Profile edit form','Password change','Notification toggles','Theme switch (dark/light)','Account deletion'],
  },
  '管理|admin':{
    components_ja:['ユーザー管理テーブル(検索/フィルタ/ページネーション)','コンテンツ承認キュー','売上/統計グラフ','監査ログビューア','システム設定'],
    components_en:['User management table (search/filter/pagination)','Content approval queue','Revenue / stats charts','Audit log viewer','System settings'],
  },
  '一覧|list|検索|search|コース|course|商品|product':{
    components_ja:['検索バー + フィルタサイドバー','カード/リスト切替','ページネーション/無限スクロール','ソート(新着/人気/価格)','空状態メッセージ'],
    components_en:['Search bar + filter sidebar','Card / list toggle','Pagination / infinite scroll','Sort (newest/popular/price)','Empty state message'],
  },
  '詳細|detail':{
    components_ja:['メインコンテンツ表示','メタ情報サイドバー','関連コンテンツ','レビュー/コメントセクション','シェアボタン','CTAボタン(購入/受講開始)'],
    components_en:['Main content display','Meta info sidebar','Related content','Reviews / comments section','Share buttons','CTA button (buy/enroll)'],
  },
  '決済|payment|billing|checkout':{
    components_ja:['プラン比較カード','Stripe Elements決済フォーム','注文サマリー','クーポン入力','決済完了/エラー表示'],
    components_en:['Plan comparison cards','Stripe Elements payment form','Order summary','Coupon input','Payment success / error display'],
  },
  'ログイン|login|サインイン|signin':{
    components_ja:['メール/パスワードフォーム','ソーシャルログインボタン','パスワードリセットリンク','新規登録リンク','バリデーションメッセージ'],
    components_en:['Email / password form','Social login buttons','Password reset link','Register link','Validation messages'],
  },
  '新規登録|register|signup':{
    components_ja:['ステップフォーム(基本情報→確認)','利用規約同意チェック','ソーシャル登録ボタン','パスワード強度メーター','ログインリンク'],
    components_en:['Step form (info → confirm)','Terms agreement checkbox','Social signup buttons','Password strength meter','Login link'],
  },
};
function getScreenComponents(screenName,G){
  for(const[pattern,detail]of Object.entries(SCREEN_COMPONENTS)){
    if(new RegExp(pattern,'i').test(screenName)){return G?detail.components_ja:detail.components_en;}
  }
  return null;
}
function resolveAuth(a){
  const be=a.backend||'';const fe=a.frontend||'';const auth=a.auth||'';
  let sot,tokenType,tokenVerify,provider;
  if(be.includes('Supabase')){
    const isSPA=fe.includes('Vite')||fe.includes('SPA')||(!fe.includes('Next')&&!fe.includes('Nuxt')&&!fe.includes('Remix'));
    sot='Supabase Auth';tokenType='Supabase JWT (access_token)';
    tokenVerify=isSPA?'Supabase client library (client-side: supabase.auth.getUser()) + RLS':'Supabase client library (server-side: supabase.auth.getUser())';
    provider='supabase';
  } else if(be.includes('Firebase')){
    sot='Firebase Auth';tokenType='Firebase ID Token';
    tokenVerify='Firebase Admin SDK (admin.auth().verifyIdToken())';
    provider='firebase';
  } else if(fe.includes('Next.js')&&(auth.includes('NextAuth')||auth.includes('Auth.js'))){
    sot='Auth.js (NextAuth v5)';tokenType='Session Token (server-side session)';
    tokenVerify='Auth.js getServerSession() / auth() middleware';
    provider='authjs';
  } else if(auth.includes('Supabase Auth')){
    sot='Supabase Auth (standalone)';tokenType='Supabase JWT';
    tokenVerify='Supabase client library';
    provider='supabase';
  } else {
    sot=auth||'JWT + OAuth 2.0';tokenType='Bearer Token (JWT)';
    tokenVerify='jsonwebtoken verify() / jose jwtVerify()';
    provider='jwt';
  }
  const social=[];
  if(auth.includes('Google'))social.push('Google OAuth');
  if(auth.includes('GitHub'))social.push('GitHub OAuth');
  if(auth.includes('Apple'))social.push('Apple Sign In');
  if(auth.includes('メール')||auth.includes('Email'))social.push('Email/Password');
  if(auth.includes('Magic')||auth.includes('マジック'))social.push('Magic Link');
  return {sot,tokenType,tokenVerify,provider,social};
}
function resolveArch(a){
  const fe=a.frontend||'React + Next.js';const be=a.backend||'Node.js + Express';
  const db=a.database||'PostgreSQL';const deploy=a.deploy||'Vercel';
  const mob=a.mobile||'';
  const isBaaS=/Supabase|Firebase|Convex/.test(be);
  const isNextJS=fe.includes('Next.js');
  const isServerBE=/Express|Fastify|NestJS|Hono|Django|FastAPI|Spring|Go/.test(be);
  const isVercel=deploy.includes('Vercel');
  let pattern,diagram,note='';
  if(isBaaS){
    pattern='baas';
    const baasName=be.includes('Supabase')?'Supabase':be.includes('Firebase')?'Firebase':'Convex';
    diagram=`[Client] → [${fe}] → [${baasName} (Auth + DB + Functions)]`;
    if(mob&&!isNone(mob)&&!mob.includes('PWA'))
      diagram+=`\n[Mobile - ${mob}] → [${baasName} (Auth + DB + Functions)]`;
    note=`${baasName} handles auth, database, and serverless functions as a unified backend.`;
  } else if(isVercel&&isNextJS&&isServerBE){
    pattern='bff';
    diagram=`[Client] → [Next.js (SSR + API Routes)] → [${db}]`;
    if(mob&&!isNone(mob)&&!mob.includes('PWA'))
      diagram+=`\n[Mobile - ${mob}] → [Next.js API Routes] → [${db}]`;
    note=`Express logic is integrated into Next.js API Routes for Vercel deployment. No separate backend server needed.`;
  } else if(isVercel&&isServerBE&&!isNextJS){
    pattern='split';
    diagram=`[Client] → [${fe} (Vercel)]\n       → [${be} (Railway/Render)] → [${db}]`;
    if(mob&&!isNone(mob)&&!mob.includes('PWA'))
      diagram+=`\n[Mobile - ${mob}] → [${be} (Railway/Render)] → [${db}]`;
    note=`${be} requires a separate server host (Railway/Render/Fly.io). Vercel serves frontend only.`;
  } else {
    pattern='traditional';
    diagram=`[Client] → [${fe}] → [${be}] → [${db}]`;
    if(mob&&!isNone(mob)&&!mob.includes('PWA'))
      diagram+=`\n[Mobile - ${mob}] → [${be}] → [${db}]`;
  }
  return {pattern,diagram,note,isBaaS,isNextJS};
}
function buildSchedule(a){
  const hasMobile=a.mobile&&!isNone(a.mobile)&&!a.mobile.includes('PWA');
  const startDate=new Date().toISOString().split('T')[0];
  const sprints=[
    {name:'Sprint 0',weeks:'Week 1',focus_ja:'環境構築',focus_en:'Setup'},
    {name:'Sprint 1',weeks:'Week 2-3',focus_ja:'コア機能',focus_en:'Core Features'},
    {name:'Sprint 2',weeks:'Week 3-4',focus_ja:'UI/UX',focus_en:'UI/UX'},
    {name:'Sprint 3',weeks:'Week 4-5',focus_ja:'テスト・デプロイ',focus_en:'Test & Deploy'},
  ];
  if(hasMobile) sprints.push({name:'Sprint 4',weeks:'Week 5-6',focus_ja:'モバイル対応',focus_en:'Mobile'});
  const totalWeeks=hasMobile?6:5;
  return {startDate,totalWeeks,sprints,hasMobile};
}
function buildDeps(a){
  const fe=a.frontend||'';const be=a.backend||'';const db=a.database||'';
  const orm=a.orm||'';const deploy=a.deploy||'';const auth=resolveAuth(a);
  const deps={};const devDeps={};const scripts={};
  if(fe.includes('Next.js')){
    deps['next']='^15';deps['react']='^19';deps['react-dom']='^19';
    scripts.dev='next dev';scripts.build='next build';scripts.start='next start';scripts.lint='next lint';
  } else if(fe.includes('Vite')||fe.includes('Vue')||fe.includes('Svelte')){
    deps['vite']='^6';
    scripts.dev='vite';scripts.build='vite build';scripts.preview='vite preview';
  }
  if(fe.includes('Vue')){deps['vue']='^3';}
  if(fe.includes('Svelte')){deps['svelte']='^5';}
  if(fe.includes('Angular')){scripts.dev='ng serve';scripts.build='ng build';}
  if(be.includes('Express')){deps['express']='^5';}
  if(be.includes('Fastify')){deps['fastify']='^5';}
  if(be.includes('Hono')){deps['hono']='^4';}
  if(be.includes('Supabase')){deps['@supabase/supabase-js']='^2';deps['@supabase/ssr']='^0.5';}
  if(be.includes('Firebase')){deps['firebase']='^11';devDeps['firebase-tools']='^13';}
  if(be.includes('Convex')){deps['convex']='^1';}
  const isBaaS=/Supabase|Firebase|Convex/.test(be);
  if(!isBaaS){
    if(orm.includes('Prisma')){devDeps['prisma']='^6';deps['@prisma/client']='^6';
      scripts['db:push']='prisma db push';scripts['db:studio']='prisma studio';scripts['db:generate']='prisma generate';}
    if(orm.includes('Drizzle')){deps['drizzle-orm']='^0.38';devDeps['drizzle-kit']='^0.30';
      scripts['db:push']='drizzle-kit push';scripts['db:studio']='drizzle-kit studio';}
  }
  if(auth.provider==='authjs'){deps['next-auth']='^5';}
  const hasPay=a.payment&&!/なし|None|none/.test(a.payment);
  if(hasPay&&(a.payment||'').includes('Stripe')){deps['stripe']='^17';}
  devDeps['typescript']='^5.7';devDeps['@types/node']='^22';
  devDeps['vitest']='^3';devDeps['@playwright/test']='^1.50';
  devDeps['eslint']='^9';devDeps['prettier']='^3';
  scripts.test='vitest';scripts['test:e2e']='playwright test';
  scripts.lint=scripts.lint||'eslint .';
  return {deps,devDeps,scripts};
}
const DOMAIN_ENTITIES={
  education:{core:['User','Course','Lesson','Progress','Quiz','Enrollment'],warn:['Product','Order','Cart'],suggest:{Product:'Course',Order:'Enrollment',Cart:'Wishlist'}},
  ec:{core:['User','Product','Category','Order','Cart','Payment','Review'],warn:['Course','Lesson','Progress'],suggest:{}},
  marketplace:{core:['User','Listing','Order','Review','Message','Category'],warn:['Course','Lesson'],suggest:{}},
  community:{core:['User','Post','Comment','Tag','Like','Follow'],warn:['Product','Order','Cart','Payment'],suggest:{Product:'Resource',Order:'Invitation'}},
  content:{core:['User','Post','Category','Tag','Comment','Media'],warn:['Product','Order','Cart'],suggest:{Product:'Content',Order:'Subscription'}},
  analytics:{core:['User','Dashboard','DataSource','Widget','Report','Chart'],warn:['Post','Comment','Product'],suggest:{}},
  booking:{core:['User','Service','Booking','TimeSlot','Review','Payment'],warn:['Post','Cart','Lesson'],suggest:{Product:'Service',Order:'Booking'}},
  saas:{core:['User','Workspace','Project','Task','Subscription','Invoice'],warn:[],suggest:{Product:'Plan',Order:'Subscription'}},
  portfolio:{core:['User','Project','Skill','Experience','Contact'],warn:['Product','Order','Cart','Payment'],suggest:{}},
  tool:{core:['User','Workspace','Task','Setting','Log'],warn:['Product','Order','Cart'],suggest:{}},
  iot:{core:['User','Device','Sensor','SensorData','Alert','Dashboard'],warn:['Product','Order','Cart'],suggest:{}},
  realestate:{core:['User','Property','Category','Viewing','Contract','Agent'],warn:['Product','Order','Cart'],suggest:{Product:'Property',Order:'Viewing'}},
  legal:{core:['User','Contract','Template','Review','Client','Document'],warn:['Product','Order','Cart'],suggest:{}},
  hr:{core:['User','JobPosting','Applicant','Interview','Evaluation','Department'],warn:['Product','Order','Cart'],suggest:{}},
  fintech:{core:['User','Account','Transaction','Transfer','Card','Statement'],warn:['Post','Comment','Course'],suggest:{}},
  health:{core:['User','Patient','Doctor','Appointment','MedicalRecord','Prescription'],warn:['Product','Order','Cart'],suggest:{Product:'Service',Order:'Appointment'}},
};
const _U='user_id:UUID:FK(User) NOT NULL:ユーザーID:User ID';
const _SA="status:VARCHAR(20):DEFAULT 'active':ステータス:Status";
const _SD="status:VARCHAR(20):DEFAULT 'draft':ステータス:Status";
const _SP="status:VARCHAR(20):DEFAULT 'pending':ステータス:Status";
const _T='title:VARCHAR(255):NOT NULL:タイトル:Title';
const _D='description:TEXT::説明:Description';
const _CN='config:JSONB::設定:Config';
const _M='metadata:JSONB::メタデータ:Metadata';
const _B='body:TEXT::本文:Body';
const _BN='body:TEXT:NOT NULL:本文:Body';
const _TS='created_at:TIMESTAMP:DEFAULT NOW:作成日時:Created at';
const _SO='sort_order:INT:DEFAULT 0:表示順:Display order';
const _IA='is_active:BOOLEAN:DEFAULT true:有効:Active';
const _PR='price:DECIMAL(10,2):NOT NULL:価格:Price';
const _CAT='category:VARCHAR(100)::カテゴリ:Category';
const _DUR='duration_min:INT::所要時間(分):Duration(min)';
const _N='notes:TEXT::メモ:Notes';
const ENTITY_COLUMNS={
  User:['email:VARCHAR(255):UNIQUE NOT NULL:メールアドレス:Email','avatar_url:TEXT::アバターURL:Avatar URL','role:VARCHAR(20):DEFAULT \'user\':ユーザー権限:User role'],
  Course:['description:TEXT::コース説明:Course description','price:DECIMAL(10,2):DEFAULT 0:価格:Price','status:VARCHAR(20):DEFAULT \'draft\':公開状態:Publish status','thumbnail_url:TEXT::サムネイル:Thumbnail','instructor_id:UUID:FK(User):講師ID:Instructor ID'],
  Lesson:[_SO,'content_type:VARCHAR(20):DEFAULT \'text\':コンテンツ種別:Content type',_DUR,'video_url:TEXT::動画URL:Video URL','is_free:BOOLEAN:DEFAULT false:無料公開:Free access'],
  Progress:[_U,'lesson_id:UUID:FK(Lesson) NOT NULL:レッスンID:Lesson ID','status:VARCHAR(20):DEFAULT \'not_started\':進捗状態:Progress status','completed_at:TIMESTAMP::完了日時:Completed at','score:INT::スコア:Score'],
  Quiz:['lesson_id:UUID:FK(Lesson) NOT NULL:レッスンID:Lesson ID','question:TEXT:NOT NULL:問題文:Question text','options:JSONB::選択肢:Options','correct_answer:TEXT:NOT NULL:正解:Correct answer','order:INT:DEFAULT 0:表示順:Display order'],
  Enrollment:[_U,'course_id:UUID:FK(Course) NOT NULL:コースID:Course ID','enrolled_at:TIMESTAMP:DEFAULT NOW:受講開始日:Enrolled at','expires_at:TIMESTAMP::有効期限:Expires at',_SA],
  Certificate:[_U,'course_id:UUID:FK(Course) NOT NULL:コースID:Course ID','issued_at:TIMESTAMP:DEFAULT NOW:発行日:Issued at','certificate_url:TEXT::証明書URL:Certificate URL'],
  Product:[_D,_PR,'stock:INT:DEFAULT 0:在庫数:Stock','sku:VARCHAR(100):UNIQUE:SKU:SKU','image_url:TEXT::商品画像:Product image','category_id:UUID:FK(Category):カテゴリID:Category ID',_SA],
  Category:['slug:VARCHAR(100):UNIQUE:スラグ:Slug',_D,'parent_id:UUID:FK(Category):親カテゴリ:Parent category',_SO],
  Order:[_U,'total:DECIMAL(10,2):NOT NULL:合計金額:Total',_SP,'stripe_session_id:TEXT::Stripe Session ID:Stripe Session ID','shipping_address:JSONB::配送先:Shipping address'],
  Cart:[_U,'product_id:UUID:FK(Product) NOT NULL:商品ID:Product ID','quantity:INT:DEFAULT 1:数量:Quantity'],
  Review:[_U,'rating:INT:NOT NULL:評価(1-5):Rating(1-5)',_B],
  Post:[_U,_T,_B,_SD,'published_at:TIMESTAMP::公開日時:Published at','slug:VARCHAR(255):UNIQUE:スラグ:Slug'],
  Comment:[_U,'post_id:UUID:FK(Post) NOT NULL:投稿ID:Post ID',_BN],
  Tag:['slug:VARCHAR(100):UNIQUE NOT NULL:スラグ:Slug'],
  Media:[_U,'url:TEXT:NOT NULL:ファイルURL:File URL','mime_type:VARCHAR(50)::MIMEタイプ:MIME type','size_bytes:BIGINT::ファイルサイズ:File size'],
  Like:[_U,'post_id:UUID:FK(Post) NOT NULL:投稿ID:Post ID'],
  Follow:['follower_id:UUID:FK(User) NOT NULL:フォロワーID:Follower ID','following_id:UUID:FK(User) NOT NULL:フォロー対象ID:Following ID'],
  Message:['sender_id:UUID:FK(User) NOT NULL:送信者ID:Sender ID','receiver_id:UUID:FK(User) NOT NULL:受信者ID:Receiver ID',_BN,'read_at:TIMESTAMP::既読日時:Read at'],
  Listing:[_U,_T,_D,_PR,_SA,'category_id:UUID:FK(Category):カテゴリID:Category ID'],
  Service:['provider_id:UUID:FK(User) NOT NULL:提供者ID:Provider ID',_D,'price:DECIMAL(10,2)::料金:Price',_DUR],
  Booking:[_U,'service_id:UUID:FK(Service) NOT NULL:サービスID:Service ID','starts_at:TIMESTAMP:NOT NULL:開始日時:Starts at','ends_at:TIMESTAMP:NOT NULL:終了日時:Ends at',_SP],
  TimeSlot:['service_id:UUID:FK(Service) NOT NULL:サービスID:Service ID','day_of_week:INT:NOT NULL:曜日(0-6):Day of week','start_time:TIME:NOT NULL:開始時刻:Start time','end_time:TIME:NOT NULL:終了時刻:End time','is_available:BOOLEAN:DEFAULT true:利用可能:Available'],
  Workspace:['owner_id:UUID:FK(User) NOT NULL:オーナーID:Owner ID','slug:VARCHAR(100):UNIQUE:スラグ:Slug','plan:VARCHAR(20):DEFAULT \'free\':プラン:Plan'],
  Project:['workspace_id:UUID:FK(Workspace):ワークスペースID:Workspace ID',_SA,_D],
  Task:['project_id:UUID:FK(Project):プロジェクトID:Project ID','assignee_id:UUID:FK(User):担当者ID:Assignee ID','status:VARCHAR(20):DEFAULT \'todo\':タスク状態:Status','priority:INT:DEFAULT 0:優先度:Priority','due_date:DATE::期日:Due date'],
  Subscription:[_U,'stripe_subscription_id:TEXT:UNIQUE:StripeサブスクID:Stripe Sub ID','stripe_customer_id:TEXT::Stripe顧客ID:Stripe Customer ID',_SA,'plan:VARCHAR(20):NOT NULL:プラン名:Plan name','current_period_end:TIMESTAMP::現在期間終了:Current period end'],
  Invoice:[_U,'amount:DECIMAL(10,2):NOT NULL:金額:Amount',_SP,'stripe_invoice_id:TEXT::Stripe請求ID:Stripe Invoice ID','paid_at:TIMESTAMP::支払日:Paid at'],
  Payment:[_U,'amount:DECIMAL(10,2):NOT NULL:金額:Amount','method:VARCHAR(20)::支払方法:Payment method',_SP,'stripe_payment_id:TEXT::Stripe決済ID:Stripe Payment ID'],
  Dashboard:[_U,'layout:JSONB::レイアウト設定:Layout config'],
  Widget:['dashboard_id:UUID:FK(Dashboard) NOT NULL:ダッシュボードID:Dashboard ID','type:VARCHAR(50):NOT NULL:ウィジェット種別:Widget type',_CN,'position:INT:DEFAULT 0:表示位置:Position'],
  DataSource:['workspace_id:UUID:FK(Workspace):ワークスペースID:Workspace ID','type:VARCHAR(50):NOT NULL:データソース種別:Source type','connection_config:JSONB::接続設定:Connection config'],
  Device:[_U,'device_name:VARCHAR(255):NOT NULL:デバイス名:Device name','device_type:VARCHAR(50)::デバイス種別:Device type',_SA],
  Sensor:['device_id:UUID:FK(Device) NOT NULL:デバイスID:Device ID','sensor_type:VARCHAR(50):NOT NULL:センサー種別:Sensor type','unit:VARCHAR(20)::単位:Unit'],
  Alert:[_U,'severity:VARCHAR(20):DEFAULT \'info\':重要度:Severity','message:TEXT:NOT NULL:メッセージ:Message','acknowledged_at:TIMESTAMP::確認日時:Acknowledged at'],
  Notification:[_U,_T,_B,'read_at:TIMESTAMP::既読日時:Read at','type:VARCHAR(50):DEFAULT \'general\':通知種別:Type'],
  AuditLog:[_U,'action:VARCHAR(100):NOT NULL:操作:Action','resource_type:VARCHAR(50)::対象リソース:Resource type','resource_id:UUID::対象ID:Resource ID',_M],
  Skill:[_CAT,'level:INT:DEFAULT 0:レベル:Level'],
  Experience:['user_id:UUID:FK(User) NOT NULL:ユーザーID:User ID','company:VARCHAR(255)::企業名:Company','title:VARCHAR(255)::役職:Title','start_date:DATE::開始日:Start date','end_date:DATE::終了日:End date','description:TEXT::説明:Description'],
  Contact:['email:VARCHAR(255):NOT NULL:メールアドレス:Email','subject:VARCHAR(255)::件名:Subject','body:TEXT:NOT NULL:本文:Body','status:VARCHAR(20):DEFAULT \'unread\':対応状態:Status'],
  Team:['workspace_id:UUID:FK(Workspace) NOT NULL:ワークスペースID:Workspace ID','role:VARCHAR(20):DEFAULT \'member\':チーム権限:Team role'],
  Activity:[_U,'action:VARCHAR(100):NOT NULL:操作種別:Action type','resource_type:VARCHAR(50)::対象リソース:Resource type','resource_id:UUID::対象ID:Resource ID',_M],
  Conversation:[_U,_T,'model:VARCHAR(50)::使用モデル:Model used','token_count:INT:DEFAULT 0:トークン数:Token count',_SA],
  Prompt:[_U,_T,'content:TEXT:NOT NULL:プロンプト内容:Prompt content','category:VARCHAR(50)::カテゴリ:Category','is_public:BOOLEAN:DEFAULT false:公開設定:Public'],
  ApiUsage:[_U,'endpoint:VARCHAR(255):NOT NULL:エンドポイント:Endpoint','tokens_used:INT:NOT NULL:使用トークン:Tokens used','cost:DECIMAL(10,4)::コスト:Cost','request_at:TIMESTAMP:DEFAULT NOW:リクエスト日時:Request at'],
  Agent:[_U,'agent_name:VARCHAR(255):NOT NULL:エージェント名:Agent name','system_prompt:TEXT::システムプロンプト:System prompt','model:VARCHAR(50)::使用モデル:Model',_SA,_CN],
  Tool:['agent_id:UUID:FK(Agent) NOT NULL:エージェントID:Agent ID','tool_name:VARCHAR(100):NOT NULL:ツール名:Tool name','tool_type:VARCHAR(50)::ツール種別:Tool type',_CN,'is_enabled:BOOLEAN:DEFAULT true:有効:Enabled'],
  Template:[_U,_T,'content:TEXT:NOT NULL:テンプレート内容:Content','category:VARCHAR(50)::カテゴリ:Category','usage_count:INT:DEFAULT 0:使用回数:Usage count'],
  Generation:[_U,'template_id:UUID:FK(Template):テンプレートID:Template ID','input:TEXT::入力:Input','output:TEXT::出力:Output','model:VARCHAR(50)::使用モデル:Model','tokens_used:INT::使用トークン:Tokens used','status:VARCHAR(20):DEFAULT \'completed\':ステータス:Status'],
  Content:[_U,_T,_B,'content_type:VARCHAR(50)::コンテンツ種別:Content type',_SD,'published_at:TIMESTAMP::公開日時:Published at'],
  CreditUsage:[_U,'credits_used:INT:NOT NULL:使用クレジット:Credits used','action:VARCHAR(100)::操作:Action','balance_after:INT::残高:Balance after'],
  Workflow:[_U,_T,_D,_SD,'is_active:BOOLEAN:DEFAULT false:有効:Active',_CN],
  Trigger:['workflow_id:UUID:FK(Workflow) NOT NULL:ワークフローID:Workflow ID','trigger_type:VARCHAR(50):NOT NULL:トリガー種別:Trigger type',_CN,'is_enabled:BOOLEAN:DEFAULT true:有効:Enabled'],
  Action:['workflow_id:UUID:FK(Workflow) NOT NULL:ワークフローID:Workflow ID','action_type:VARCHAR(50):NOT NULL:アクション種別:Action type',_SO,_CN],
  Execution:['workflow_id:UUID:FK(Workflow) NOT NULL:ワークフローID:Workflow ID','status:VARCHAR(20):DEFAULT \'running\':実行状態:Status','started_at:TIMESTAMP:DEFAULT NOW:開始日時:Started at','completed_at:TIMESTAMP::完了日時:Completed at','error:TEXT::エラー:Error','output:JSONB::出力:Output'],
  Connection:[_U,'service:VARCHAR(100):NOT NULL:サービス名:Service','credentials:JSONB::認証情報:Credentials',_SA],
  Log:[_U,'level:VARCHAR(20):DEFAULT \'info\':レベル:Level','message:TEXT:NOT NULL:メッセージ:Message',_M],
  Transaction:['buyer_id:UUID:FK(User) NOT NULL:購入者ID:Buyer ID','seller_id:UUID:FK(User) NOT NULL:販売者ID:Seller ID','amount:DECIMAL(10,2):NOT NULL:金額:Amount','fee:DECIMAL(10,2):DEFAULT 0:手数料:Fee',_SP,'stripe_transfer_id:TEXT::Stripe送金ID:Stripe transfer ID'],
  Bot:[_U,'bot_name:VARCHAR(255):NOT NULL:ボット名:Bot name','welcome_message:TEXT::ウェルカムメッセージ:Welcome message','model:VARCHAR(50)::使用モデル:Model',_SA],
  Intent:['bot_id:UUID:FK(Bot) NOT NULL:ボットID:Bot ID','intent_name:VARCHAR(100):NOT NULL:インテント名:Intent name','examples:JSONB::例文:Examples','response_template:TEXT::応答テンプレート:Response template'],
  KnowledgeBase:['bot_id:UUID:FK(Bot) NOT NULL:ボットID:Bot ID',_T,'content:TEXT:NOT NULL:内容:Content','embedding:JSONB::埋め込みベクトル:Embedding vector','source_url:TEXT::ソースURL:Source URL'],
  Handoff:['conversation_id:UUID:FK(Conversation) NOT NULL:会話ID:Conversation ID','agent_id:UUID:FK(User):担当者ID:Agent ID','reason:TEXT::理由:Reason',_SP,'resolved_at:TIMESTAMP::解決日時:Resolved at'],
  Account:[_U,'account_name:VARCHAR(255):NOT NULL:口座名:Account name','account_type:VARCHAR(50)::口座種別:Account type','balance:DECIMAL(12,2):DEFAULT 0:残高:Balance','currency:VARCHAR(3):DEFAULT \'JPY\':通貨:Currency','institution:VARCHAR(255)::金融機関:Institution'],
  Budget:[_U,'category:VARCHAR(100):NOT NULL:カテゴリ:Category','amount:DECIMAL(10,2):NOT NULL:予算額:Budget amount','period:VARCHAR(20):DEFAULT \'monthly\':期間:Period','spent:DECIMAL(10,2):DEFAULT 0:使用額:Spent'],
  Report:[_U,_T,'report_type:VARCHAR(50)::レポート種別:Report type',_CN,'generated_at:TIMESTAMP::生成日時:Generated at','data:JSONB::データ:Data'],
  ApiKey:[_U,'key_prefix:VARCHAR(20):NOT NULL:キー接頭辞:Key prefix','key_hash:TEXT:NOT NULL:キーハッシュ:Key hash','label:VARCHAR(100)::ラベル:Label','permissions:JSONB::権限:Permissions','last_used_at:TIMESTAMP::最終使用日:Last used','expires_at:TIMESTAMP::有効期限:Expires at'],
  RequestLog:['api_key_id:UUID:FK(ApiKey):APIキーID:API Key ID','method:VARCHAR(10):NOT NULL:HTTPメソッド:HTTP method','path:VARCHAR(500):NOT NULL:パス:Path','status_code:INT::ステータスコード:Status code','latency_ms:INT::レイテンシ(ms):Latency(ms)','ip_address:VARCHAR(45)::IPアドレス:IP address'],
  Documentation:[_T,'slug:VARCHAR(255):UNIQUE:スラグ:Slug','content:TEXT:NOT NULL:内容:Content',_CAT,_SO,'version:VARCHAR(20)::バージョン:Version'],
  Tip:['sender_id:UUID:FK(User) NOT NULL:送信者ID:Sender ID','receiver_id:UUID:FK(User) NOT NULL:受信者ID:Receiver ID','amount:DECIMAL(10,2):NOT NULL:金額:Amount','message:TEXT::メッセージ:Message','status:VARCHAR(20):DEFAULT \'completed\':ステータス:Status'],
  Tier:[_U,'tier_name:VARCHAR(100):NOT NULL:ティア名:Tier name',_PR,_D,'benefits:JSONB::特典:Benefits'],
  Subscriber:['email:VARCHAR(255):UNIQUE NOT NULL:メールアドレス:Email',_U,_SA,'subscribed_at:TIMESTAMP:DEFAULT NOW:購読開始日:Subscribed at','tags:JSONB::タグ:Tags'],
  Campaign:[_U,_T,'subject:VARCHAR(255)::件名:Subject',_B,_SD,'scheduled_at:TIMESTAMP::配信予定:Scheduled at','sent_at:TIMESTAMP::配信日時:Sent at'],
  Analytics:['campaign_id:UUID:FK(Campaign):キャンペーンID:Campaign ID','metric:VARCHAR(50):NOT NULL:指標:Metric','value:DECIMAL(12,2):NOT NULL:値:Value','recorded_at:TIMESTAMP:DEFAULT NOW:記録日時:Recorded at'],
  Plan:['plan_name:VARCHAR(100):NOT NULL:プラン名:Plan name',_PR,'interval:VARCHAR(20):DEFAULT \'monthly\':課金間隔:Billing interval','features:JSONB::機能:Features','stripe_price_id:TEXT::Stripe価格ID:Stripe price ID',_IA],
  SyncQueue:[_U,'action:VARCHAR(50):NOT NULL:操作:Action','payload:JSONB:NOT NULL:データ:Payload',_SP,'retry_count:INT:DEFAULT 0:リトライ数:Retry count'],
  Setting:[_U,'key:VARCHAR(100):NOT NULL:設定キー:Setting key','value:JSONB::設定値:Value'],
  Staff:[_U,'specialty:VARCHAR(100)::専門分野:Specialty','is_available:BOOLEAN:DEFAULT true:利用可能:Available','calendar_config:JSONB::カレンダー設定:Calendar config'],
  Reminder:['booking_id:UUID:FK(Booking):予約ID:Booking ID','remind_at:TIMESTAMP:NOT NULL:リマインド日時:Remind at','method:VARCHAR(20):DEFAULT \'email\':通知方法:Method','sent:BOOLEAN:DEFAULT false:送信済:Sent'],
  Event:[_U,_T,_D,'venue_id:UUID:FK(Venue):会場ID:Venue ID','starts_at:TIMESTAMP:NOT NULL:開始日時:Starts at','ends_at:TIMESTAMP:NOT NULL:終了日時:Ends at','capacity:INT::定員:Capacity',_SD,'is_online:BOOLEAN:DEFAULT false:オンライン:Online'],
  Ticket:['event_id:UUID:FK(Event) NOT NULL:イベントID:Event ID','ticket_type:VARCHAR(50):NOT NULL:チケット種別:Ticket type','price:DECIMAL(10,2):DEFAULT 0:価格:Price','quantity:INT:NOT NULL:枚数:Quantity','sold:INT:DEFAULT 0:販売済:Sold'],
  Attendee:['event_id:UUID:FK(Event) NOT NULL:イベントID:Event ID',_U,'ticket_id:UUID:FK(Ticket):チケットID:Ticket ID','status:VARCHAR(20):DEFAULT \'registered\':参加状態:Status','checked_in_at:TIMESTAMP::チェックイン日時:Checked in at'],
  Venue:['venue_name:VARCHAR(255):NOT NULL:会場名:Venue name','address:TEXT::住所:Address','capacity:INT::収容人数:Capacity','latitude:DECIMAL(10,7)::緯度:Latitude','longitude:DECIMAL(10,7)::経度:Longitude'],
  Session:['event_id:UUID:FK(Event) NOT NULL:イベントID:Event ID',_T,'speaker:VARCHAR(255)::登壇者:Speaker','starts_at:TIMESTAMP:NOT NULL:開始:Starts at','ends_at:TIMESTAMP:NOT NULL:終了:Ends at','room:VARCHAR(100)::部屋:Room'],
  Survey:['event_id:UUID:FK(Event):イベントID:Event ID',_T,'questions:JSONB:NOT NULL:質問:Questions',_IA],
  HealthLog:[_U,'log_type:VARCHAR(50):NOT NULL:記録種別:Log type','value:DECIMAL(10,2):NOT NULL:値:Value','unit:VARCHAR(20)::単位:Unit','logged_at:TIMESTAMP:DEFAULT NOW:記録日時:Logged at',_N],
  Workout:[_U,'workout_type:VARCHAR(50):NOT NULL:運動種別:Workout type',_DUR,'calories:INT::消費カロリー:Calories','intensity:VARCHAR(20)::強度:Intensity',_N],
  Meal:[_U,'meal_type:VARCHAR(20):NOT NULL:食事種別:Meal type','food_items:JSONB::食品:Food items','calories:INT::カロリー:Calories','photo_url:TEXT::写真URL:Photo URL','logged_at:TIMESTAMP:DEFAULT NOW:記録日時:Logged at'],
  Goal:[_U,'goal_type:VARCHAR(50):NOT NULL:目標種別:Goal type','target_value:DECIMAL(10,2):NOT NULL:目標値:Target value','current_value:DECIMAL(10,2):DEFAULT 0:現在値:Current value','unit:VARCHAR(20)::単位:Unit','deadline:DATE::期限:Deadline',_SA],
  JobPosting:['department_id:UUID:FK(Department):部署ID:Department ID',_T,_D,'employment_type:VARCHAR(50)::雇用形態:Employment type','salary_range:VARCHAR(100)::給与レンジ:Salary range','status:VARCHAR(20):DEFAULT \'open\':募集状態:Status','closes_at:DATE::締切日:Closes at'],
  Applicant:['job_id:UUID:FK(JobPosting) NOT NULL:求人ID:Job ID',_U,'applicant_name:VARCHAR(255):NOT NULL:氏名:Name','email:VARCHAR(255):NOT NULL:メール:Email','resume_url:TEXT::履歴書URL:Resume URL','status:VARCHAR(20):DEFAULT \'applied\':選考状態:Status','applied_at:TIMESTAMP:DEFAULT NOW:応募日:Applied at'],
  Interview:['applicant_id:UUID:FK(Applicant) NOT NULL:応募者ID:Applicant ID','interviewer_id:UUID:FK(User) NOT NULL:面接官ID:Interviewer ID','scheduled_at:TIMESTAMP:NOT NULL:予定日時:Scheduled at','duration_min:INT:DEFAULT 60:所要時間(分):Duration(min)','interview_type:VARCHAR(50)::面接種別:Type','status:VARCHAR(20):DEFAULT \'scheduled\':ステータス:Status',_N],
  Evaluation:['applicant_id:UUID:FK(Applicant) NOT NULL:応募者ID:Applicant ID','evaluator_id:UUID:FK(User) NOT NULL:評価者ID:Evaluator ID','score:INT:NOT NULL:スコア:Score','criteria:JSONB::評価基準:Criteria','comments:TEXT::コメント:Comments'],
  Department:['department_name:VARCHAR(255):NOT NULL:部署名:Department name','parent_id:UUID:FK(Department):親部署ID:Parent ID','head_id:UUID:FK(User):部長ID:Head ID'],
  Onboarding:[_U,'checklist:JSONB::チェックリスト:Checklist','progress:INT:DEFAULT 0:進捗(%):Progress(%)','mentor_id:UUID:FK(User):メンターID:Mentor ID','start_date:DATE::開始日:Start date','status:VARCHAR(20):DEFAULT \'in_progress\':ステータス:Status'],
  Page:[_U,'slug:VARCHAR(100):UNIQUE NOT NULL:スラグ:Slug',_T,'bio:TEXT::自己紹介:Bio','theme_id:UUID:FK(Theme):テーマID:Theme ID','is_published:BOOLEAN:DEFAULT true:公開:Published'],
  Link:['page_id:UUID:FK(Page) NOT NULL:ページID:Page ID',_T,'url:TEXT:NOT NULL:URL:URL',_SO,_IA,'click_count:INT:DEFAULT 0:クリック数:Clicks'],
  Theme:['theme_name:VARCHAR(100):NOT NULL:テーマ名:Theme name','css_config:JSONB::CSSスタイル:CSS config','preview_url:TEXT::プレビューURL:Preview URL','is_premium:BOOLEAN:DEFAULT false:プレミアム:Premium'],
  ClickLog:['link_id:UUID:FK(Link) NOT NULL:リンクID:Link ID','referrer:TEXT::リファラー:Referrer','user_agent:TEXT::ユーザーエージェント:User agent','ip_hash:VARCHAR(64)::IPハッシュ:IP hash','country:VARCHAR(2)::国コード:Country code'],
  Integration:[_U,'service:VARCHAR(100):NOT NULL:サービス名:Service','access_token:TEXT::アクセストークン:Access token',_CN,_SA],
  Badge:['badge_name:VARCHAR(100):NOT NULL:バッジ名:Badge name',_D,'icon_url:TEXT::アイコンURL:Icon URL','criteria:JSONB::獲得条件:Criteria','points:INT:DEFAULT 0:ポイント:Points'],
  Challenge:[_T,_D,'challenge_type:VARCHAR(50)::種別:Type','reward_points:INT:DEFAULT 0:報酬ポイント:Reward points','starts_at:TIMESTAMP::開始日:Starts at','ends_at:TIMESTAMP::終了日:Ends at',_SA],
  Reward:['reward_name:VARCHAR(255):NOT NULL:報酬名:Reward name',_D,'cost_points:INT:NOT NULL:必要ポイント:Cost points','stock:INT:DEFAULT -1:在庫(-1=無制限):Stock','reward_type:VARCHAR(50)::報酬種別:Type'],
  Leaderboard:[_U,'score:INT:DEFAULT 0:スコア:Score','rank:INT::順位:Rank','period:VARCHAR(20):DEFAULT \'all_time\':期間:Period'],
  PointLog:[_U,'points:INT:NOT NULL:ポイント:Points','action:VARCHAR(100):NOT NULL:操作:Action','balance_after:INT::残高:Balance after'],
  Achievement:[_U,'badge_id:UUID:FK(Badge) NOT NULL:バッジID:Badge ID','earned_at:TIMESTAMP:DEFAULT NOW:獲得日時:Earned at'],
  Document:['workspace_id:UUID:FK(Workspace):ワークスペースID:Workspace ID','owner_id:UUID:FK(User) NOT NULL:オーナーID:Owner ID',_T,'content:TEXT::内容:Content','doc_type:VARCHAR(50):DEFAULT \'text\':ドキュメント種別:Document type','is_public:BOOLEAN:DEFAULT false:公開:Public'],
  Version:['document_id:UUID:FK(Document) NOT NULL:ドキュメントID:Document ID','author_id:UUID:FK(User) NOT NULL:著者ID:Author ID','content:TEXT:NOT NULL:内容:Content','version_number:INT:NOT NULL:バージョン:Version number','change_summary:TEXT::変更概要:Change summary'],
  Permission:['document_id:UUID:FK(Document) NOT NULL:ドキュメントID:Document ID',_U,'role:VARCHAR(20):DEFAULT \'viewer\':権限:Role','granted_at:TIMESTAMP:DEFAULT NOW:付与日時:Granted at'],
  SensorData:['sensor_id:UUID:FK(Sensor) NOT NULL:センサーID:Sensor ID','value:DECIMAL(15,5):NOT NULL:測定値:Value','recorded_at:TIMESTAMP:DEFAULT NOW:記録日時:Recorded at','quality:VARCHAR(20):DEFAULT \'good\':品質:Quality'],
  Command:['device_id:UUID:FK(Device) NOT NULL:デバイスID:Device ID','command_type:VARCHAR(50):NOT NULL:コマンド種別:Command type','payload:JSONB::ペイロード:Payload',_SP,'executed_at:TIMESTAMP::実行日時:Executed at'],
  DeviceGroup:['group_name:VARCHAR(255):NOT NULL:グループ名:Group name',_D,_U],
  Group:['owner_id:UUID:FK(User) NOT NULL:オーナーID:Owner ID','group_name:VARCHAR(255):NOT NULL:グループ名:Group name',_D,'is_private:BOOLEAN:DEFAULT false:非公開:Private','member_count:INT:DEFAULT 0:メンバー数:Member count'],
  Webhook:[_U,'url:TEXT:NOT NULL:Webhook URL:Webhook URL','events:JSONB:NOT NULL:イベント:Events','secret:TEXT::シークレット:Secret',_IA,'last_triggered_at:TIMESTAMP::最終実行:Last triggered'],
  Patient:[_U,'patient_name:VARCHAR(255):NOT NULL:患者名:Patient name','date_of_birth:DATE::生年月日:Date of birth','gender:VARCHAR(20)::性別:Gender','blood_type:VARCHAR(10)::血液型:Blood type','allergies:TEXT::アレルギー:Allergies','emergency_contact:VARCHAR(255)::緊急連絡先:Emergency contact'],
  Doctor:[_U,'doctor_name:VARCHAR(255):NOT NULL:医師名:Doctor name','specialty:VARCHAR(100)::専門分野:Specialty','license_number:VARCHAR(100)::医師免許番号:License number','is_available:BOOLEAN:DEFAULT true:対応可能:Available'],
  MedicalRecord:['patient_id:UUID:FK(Patient) NOT NULL:患者ID:Patient ID','doctor_id:UUID:FK(Doctor) NOT NULL:医師ID:Doctor ID','visit_date:TIMESTAMP:DEFAULT NOW:受診日:Visit date','diagnosis:TEXT::診断:Diagnosis','treatment:TEXT::治療:Treatment','symptoms:TEXT::症状:Symptoms',_N],
  Prescription:['medical_record_id:UUID:FK(MedicalRecord) NOT NULL:診療記録ID:Medical record ID','medication_name:VARCHAR(255):NOT NULL:薬剤名:Medication name','dosage:VARCHAR(100):NOT NULL:用量:Dosage','frequency:VARCHAR(100)::頻度:Frequency','duration_days:INT::処方日数:Duration(days)',_N],
  Appointment:['patient_id:UUID:FK(Patient) NOT NULL:患者ID:Patient ID','doctor_id:UUID:FK(Doctor) NOT NULL:医師ID:Doctor ID','scheduled_at:TIMESTAMP:NOT NULL:予約日時:Scheduled at',_DUR,'reason:TEXT::受診理由:Reason',_SP,_N],
  Pet:['owner_id:UUID:FK(User) NOT NULL:飼い主ID:Owner ID','pet_name:VARCHAR(255):NOT NULL:ペット名:Pet name','species:VARCHAR(50):NOT NULL:種別:Species','breed:VARCHAR(100)::品種:Breed','date_of_birth:DATE::生年月日:Date of birth','weight_kg:DECIMAL(5,2)::体重(kg):Weight(kg)','medical_notes:TEXT::医療メモ:Medical notes'],
  Vaccination:['pet_id:UUID:FK(Pet) NOT NULL:ペットID:Pet ID','vaccine_name:VARCHAR(255):NOT NULL:ワクチン名:Vaccine name','administered_at:TIMESTAMP:NOT NULL:接種日:Administered at','next_due:DATE::次回予定:Next due','veterinarian_id:UUID:FK(Doctor):獣医ID:Veterinarian ID',_N],
  Veterinarian:[_U,'vet_name:VARCHAR(255):NOT NULL:獣医名:Vet name','specialty:VARCHAR(100)::専門分野:Specialty','license_number:VARCHAR(100)::免許番号:License number','is_available:BOOLEAN:DEFAULT true:対応可能:Available'],
  Property:['owner_id:UUID:FK(User) NOT NULL:オーナーID:Owner ID','property_name:VARCHAR(255):NOT NULL:物件名:Property name','address:TEXT:NOT NULL:住所:Address','property_type:VARCHAR(50)::物件種別:Property type','units:INT:DEFAULT 1:ユニット数:Units',_SA],
  Unit:['property_id:UUID:FK(Property) NOT NULL:物件ID:Property ID','unit_number:VARCHAR(50):NOT NULL:ユニット番号:Unit number','bedrooms:INT::寝室数:Bedrooms','bathrooms:INT::浴室数:Bathrooms','area_sqm:DECIMAL(8,2)::面積(m²):Area(sqm)','monthly_rent:DECIMAL(10,2)::月額家賃:Monthly rent','status:VARCHAR(20):DEFAULT \'available\':状態:Status'],
  Tenant:[_U,'tenant_name:VARCHAR(255):NOT NULL:入居者名:Tenant name','email:VARCHAR(255)::メール:Email','phone:VARCHAR(50)::電話番号:Phone',_N],
  Lease:['unit_id:UUID:FK(Unit) NOT NULL:ユニットID:Unit ID','tenant_id:UUID:FK(Tenant) NOT NULL:入居者ID:Tenant ID','start_date:DATE:NOT NULL:開始日:Start date','end_date:DATE:NOT NULL:終了日:End date','monthly_rent:DECIMAL(10,2):NOT NULL:月額家賃:Monthly rent','deposit:DECIMAL(10,2)::敷金:Deposit','status:VARCHAR(20):DEFAULT \'active\':状態:Status'],
  MaintenanceRequest:['unit_id:UUID:FK(Unit) NOT NULL:ユニットID:Unit ID','tenant_id:UUID:FK(Tenant) NOT NULL:入居者ID:Tenant ID',_T,_D,'category:VARCHAR(50)::カテゴリ:Category',_SP,'assigned_to:UUID:FK(User):担当者ID:Assigned to','completed_at:TIMESTAMP::完了日時:Completed at'],
  Owner:[_U,'owner_name:VARCHAR(255):NOT NULL:オーナー名:Owner name','email:VARCHAR(255)::メール:Email','phone:VARCHAR(50)::電話番号:Phone','properties_count:INT:DEFAULT 0:所有物件数:Properties count'],
  Contract:['contract_name:VARCHAR(255):NOT NULL:契約名:Contract name','contract_type:VARCHAR(50)::契約種別:Contract type','start_date:DATE::開始日:Start date','end_date:DATE::終了日:End date','auto_renew:BOOLEAN:DEFAULT false:自動更新:Auto renew','status:VARCHAR(20):DEFAULT \'draft\':ステータス:Status','document_url:TEXT::契約書URL:Document URL','value:DECIMAL(12,2)::契約額:Contract value'],
  Party:['contract_id:UUID:FK(Contract) NOT NULL:契約ID:Contract ID','party_name:VARCHAR(255):NOT NULL:当事者名:Party name','party_type:VARCHAR(50):NOT NULL:当事者種別:Party type','contact_email:VARCHAR(255)::連絡先メール:Contact email','signatory:VARCHAR(255)::署名者:Signatory'],
  Approval:['contract_id:UUID:FK(Contract) NOT NULL:契約ID:Contract ID','approver_id:UUID:FK(User) NOT NULL:承認者ID:Approver ID','status:VARCHAR(20):DEFAULT \'pending\':ステータス:Status','approved_at:TIMESTAMP::承認日時:Approved at','comments:TEXT::コメント:Comments'],
  Signature:['contract_id:UUID:FK(Contract) NOT NULL:契約ID:Contract ID','signer_id:UUID:FK(User) NOT NULL:署名者ID:Signer ID','signed_at:TIMESTAMP:DEFAULT NOW:署名日時:Signed at','signature_hash:TEXT::署名ハッシュ:Signature hash','ip_address:VARCHAR(45)::IPアドレス:IP address'],
  Clause:['contract_id:UUID:FK(Contract) NOT NULL:契約ID:Contract ID','clause_number:VARCHAR(20)::条項番号:Clause number',_T,'content:TEXT:NOT NULL:内容:Content',_SO],
  KnowledgeArticle:[_T,'slug:VARCHAR(255):UNIQUE:スラグ:Slug','content:TEXT:NOT NULL:内容:Content',_CAT,_SA,'view_count:INT:DEFAULT 0:閲覧数:View count','helpful_count:INT:DEFAULT 0:役立った数:Helpful count'],
  Response:['ticket_id:UUID:FK(Task) NOT NULL:チケットID:Ticket ID','responder_id:UUID:FK(User) NOT NULL:回答者ID:Responder ID','content:TEXT:NOT NULL:内容:Content','is_public:BOOLEAN:DEFAULT true:公開:Public'],
  SLA:['name:VARCHAR(100):NOT NULL:SLA名:SLA name','priority:VARCHAR(20):NOT NULL:優先度:Priority','response_time_hours:INT:NOT NULL:応答時間(時):Response time(hours)','resolution_time_hours:INT:NOT NULL:解決時間(時):Resolution time(hours)',_IA],
  Priority:[_U,'priority_level:VARCHAR(20):NOT NULL:優先度:Priority level','color:VARCHAR(7)::色:Color',_SO],
  Tutor:[_U,'tutor_name:VARCHAR(255):NOT NULL:講師名:Tutor name','bio:TEXT::自己紹介:Bio','hourly_rate:DECIMAL(8,2)::時給:Hourly rate','is_verified:BOOLEAN:DEFAULT false:認証済:Verified','rating:DECIMAL(3,2)::評価:Rating'],
  Student:[_U,'student_name:VARCHAR(255):NOT NULL:生徒名:Student name','grade_level:VARCHAR(50)::学年:Grade level','parent_email:VARCHAR(255)::保護者メール:Parent email',_N],
  Subject:['subject_name:VARCHAR(100):NOT NULL:科目名:Subject name',_D,_CAT],
  Availability:['tutor_id:UUID:FK(Tutor) NOT NULL:講師ID:Tutor ID','day_of_week:INT:NOT NULL:曜日(0-6):Day of week','start_time:TIME:NOT NULL:開始時刻:Start time','end_time:TIME:NOT NULL:終了時刻:End time','is_available:BOOLEAN:DEFAULT true:利用可能:Available'],
  Table:['table_number:VARCHAR(20):NOT NULL:テーブル番号:Table number','capacity:INT:NOT NULL:定員:Capacity','location:VARCHAR(50)::場所:Location',_SA],
  Reservation:['table_id:UUID:FK(Table) NOT NULL:テーブルID:Table ID',_U,'guest_name:VARCHAR(255):NOT NULL:予約者名:Guest name','guest_count:INT:NOT NULL:人数:Guest count','reserved_at:TIMESTAMP:NOT NULL:予約日時:Reserved at',_SP,'special_requests:TEXT::特別リクエスト:Special requests'],
  MenuItem:[_T,_D,'category:VARCHAR(50)::カテゴリ:Category',_PR,'image_url:TEXT::画像URL:Image URL','is_available:BOOLEAN:DEFAULT true:提供可能:Available','allergens:JSONB::アレルゲン:Allergens'],
  Shift:['staff_id:UUID:FK(User) NOT NULL:スタッフID:Staff ID','shift_date:DATE:NOT NULL:勤務日:Shift date','start_time:TIME:NOT NULL:開始時刻:Start time','end_time:TIME:NOT NULL:終了時刻:End time','role:VARCHAR(50)::役割:Role',_SA],
  Contractor:['contractor_name:VARCHAR(255):NOT NULL:業者名:Contractor name','contact_person:VARCHAR(255)::担当者:Contact person','email:VARCHAR(255)::メール:Email','phone:VARCHAR(50)::電話番号:Phone','license_number:VARCHAR(100)::免許番号:License number',_SA],
  ProgressReport:['project_id:UUID:FK(Project) NOT NULL:プロジェクトID:Project ID','contractor_id:UUID:FK(Contractor) NOT NULL:業者ID:Contractor ID','report_date:DATE:NOT NULL:報告日:Report date','completion_percentage:INT:NOT NULL:完了率(%):Completion(%)','work_summary:TEXT::作業概要:Work summary','photo_urls:JSONB::写真URL:Photo URLs',_SP],
  Estimate:['project_id:UUID:FK(Project) NOT NULL:プロジェクトID:Project ID','contractor_id:UUID:FK(Contractor) NOT NULL:業者ID:Contractor ID','estimate_number:VARCHAR(50)::見積番号:Estimate number','total_amount:DECIMAL(12,2):NOT NULL:総額:Total amount','line_items:JSONB::明細:Line items',_SP,'valid_until:DATE::有効期限:Valid until'],
  Article:[_U,_T,'slug:VARCHAR(255):UNIQUE:スラグ:Slug','content:TEXT:NOT NULL:内容:Content',_CAT,_SD,'view_count:INT:DEFAULT 0:閲覧数:View count','version:INT:DEFAULT 1:バージョン:Version'],
  AccessControl:['article_id:UUID:FK(Article) NOT NULL:記事ID:Article ID',_U,'role:VARCHAR(20):DEFAULT \'viewer\':権限:Role','granted_at:TIMESTAMP:DEFAULT NOW:付与日時:Granted at'],
  SearchLog:['query:VARCHAR(500):NOT NULL:検索クエリ:Search query',_U,'results_count:INT::結果数:Results count','clicked_article_id:UUID:FK(Article):クリック記事ID:Clicked article ID','searched_at:TIMESTAMP:DEFAULT NOW:検索日時:Searched at'],
  WorkOrder:['customer_id:UUID:FK(User) NOT NULL:顧客ID:Customer ID','technician_id:UUID:FK(User):技術者ID:Technician ID',_T,_D,'location:TEXT:NOT NULL:場所:Location','scheduled_at:TIMESTAMP::予定日時:Scheduled at',_SP,'priority:VARCHAR(20):DEFAULT \'medium\':優先度:Priority','completed_at:TIMESTAMP::完了日時:Completed at'],
  Technician:[_U,'technician_name:VARCHAR(255):NOT NULL:技術者名:Technician name','skills:JSONB::スキル:Skills','certification:TEXT::資格:Certification','is_available:BOOLEAN:DEFAULT true:対応可能:Available','current_location:TEXT::現在地:Current location'],
  Location:['location_name:VARCHAR(255):NOT NULL:場所名:Location name','address:TEXT:NOT NULL:住所:Address','latitude:DECIMAL(10,7)::緯度:Latitude','longitude:DECIMAL(10,7)::経度:Longitude','contact_name:VARCHAR(255)::担当者名:Contact name','contact_phone:VARCHAR(50)::電話番号:Contact phone'],
  Customer:[_U,'customer_name:VARCHAR(255):NOT NULL:顧客名:Customer name','company:VARCHAR(255)::会社名:Company','email:VARCHAR(255)::メール:Email','phone:VARCHAR(50)::電話番号:Phone','billing_address:TEXT::請求先住所:Billing address',_N],
};
const ENTITY_METHODS={
  Payment:['GET','GET/:id','POST'],
  Transaction:['GET','GET/:id','POST'],
  Invoice:['GET','GET/:id','POST'],
  Log:['GET','GET/:id'],
  RequestLog:['GET','GET/:id'],
  Activity:['GET','GET/:id'],
  Execution:['GET','GET/:id'],
  Handoff:['GET','GET/:id'],
  Cart:['GET','POST','PATCH/:id','DELETE/:id'],
  Setting:['GET','PATCH'],
  User:['GET','GET/:id','POST','PATCH/:id'],
  Enrollment:['GET','GET/:id','POST','PATCH/:id'],
  Subscription:['GET','GET/:id','POST','PATCH/:id'],
  Attendee:['GET','GET/:id','POST','PATCH/:id','DELETE/:id'],
  Certificate:['GET','GET/:id','POST'],
  MedicalRecord:['GET','GET/:id','POST'],
  Vaccination:['GET','GET/:id','POST'],
  Prescription:['GET','GET/:id','POST'],
  SLA:['GET','GET/:id'],
  Lease:['GET','GET/:id','POST','PATCH/:id'],
  Contract:['GET','GET/:id','POST','PATCH/:id'],
};
function getEntityMethods(entityName){
  return ENTITY_METHODS[entityName]||['GET','GET/:id','POST','PUT/:id','DELETE/:id'];
}
function getEntityColumns(entityName,G,knownEntities){
  const cols=ENTITY_COLUMNS[entityName];
  if(!cols) return [];
  return cols.map(c=>{
    const [col,type,constraint,descJa,descEn]=c.split(':');
    return {col,type:type||'TEXT',constraint:constraint||'',desc:G?(descJa||col):(descEn||col)};
  }).filter(c=>{
    if(!knownEntities) return true;
    const fkMatch=c.constraint.match(/FK\((\w+)\)/);
    if(!fkMatch) return true;
    return knownEntities.includes(fkMatch[1]);
  });
}
function detectDomain(purpose){
  const p=(purpose||'').toLowerCase();
  const detect=[
    [/教育|学習|education|learning|lms|コース|course|tutoring|家庭教師/i,'education'],
    [/\bEC\b|eコマース|e-commerce|ショップ|\bshop\b|\bcommerce\b/i,'ec'],
    [/マーケットプレイス|marketplace/i,'marketplace'],
    [/コミュニティ|community|フォーラム|forum|gamification|gamify/i,'community'],
    [/コンテンツ|content|メディア|media|ブログ|blog|knowledge.?base|ナレッジベース/i,'content'],
    [/分析|analytics|可視化|ダッシュボード/i,'analytics'],
    [/予約|booking|スケジュール|restaurant|レストラン|飲食店|event|イベント/i,'booking'],
    [/saas|サブスク|subscription|helpdesk|ヘルプデスク|collab|collaboration/i,'saas'],
    [/IoT|デバイス|device|sensor|センサー|field.?service|フィールドサービス/i,'iot'],
    [/不動産|物件|real.?estate|property.?mgmt|property.?management/i,'realestate'],
    [/法務|契約|legal|contract.?mgmt|contract.?management|コンプライアンス/i,'legal'],
    [/人事|HR|採用|recruit|hiring/i,'hr'],
    [/金融|fintech|銀行|bank|決済管理|construction.?pay|工事代金/i,'fintech'],
    [/医療|ヘルスケア|health|medical|clinic|病院|patient|患者|veterinary|動物病院|ペット/i,'health'],
    [/ポートフォリオ|portfolio|link.?in.?bio|linkbio/i,'portfolio'],
    [/pwa|progressive.?web|オフライン|offline/i,'tool'],
    [/chatbot|チャットボット|ai.?agent|AIエージェント/i,'saas'],
    [/業務|business|効率化|ツール|tool/i,'tool'],
  ];
  for(const[rx,key]of detect){if(rx.test(p))return key;}
  return null;
}
function inferER(a){
  const G=S.genLang==='ja';
  const domain=detectDomain(a.purpose);
  const entities=(a.data_entities||'').split(/[,、]\s*/).map(e=>e.trim()).filter(Boolean);
  const warnings=[];
  const suggestions=[];
  if(domain&&DOMAIN_ENTITIES[domain]){
    const d=DOMAIN_ENTITIES[domain];
    entities.forEach(e=>{
      if(d.warn.includes(e)){
        const alt=d.suggest[e];
        if(alt){
          warnings.push(G?`⚠️ ${e} は${domain}ドメインでは ${alt} に置き換えることを推奨`:`⚠️ Consider replacing ${e} with ${alt} for ${domain} domain`);
          suggestions.push({from:e,to:alt});
        } else {
          warnings.push(G?`ℹ️ ${e} は${domain}ドメインでは一般的ではありません`:`ℹ️ ${e} is uncommon in ${domain} domain`);
        }
      }
    });
  }
  const rels=[];
  const has=(n)=>entities.some(e=>e.toLowerCase()===n.toLowerCase());
  if(has('User')&&has('Post')) rels.push('User 1 ──N Post');
  if(has('User')&&has('Comment')) rels.push('User 1 ──N Comment');
  if(has('User')&&has('Order')) rels.push('User 1 ──N Order');
  if(has('User')&&has('Booking')) rels.push('User 1 ──N Booking');
  if(has('User')&&has('Review')) rels.push('User 1 ──N Review');
  if(has('User')&&has('Progress')) rels.push('User 1 ──N Progress');
  if(has('User')&&has('Enrollment')) rels.push('User 1 ──N Enrollment');
  if(has('User')&&has('Message')) rels.push('User 1 ──N Message');
  if(has('User')&&has('Notification')) rels.push('User 1 ──N Notification');
  if(has('User')&&has('Subscription')) rels.push('User 1 ──N Subscription');
  if(has('User')&&has('Listing')) rels.push('User 1 ──N Listing');
  if(has('User')&&has('Workspace')) rels.push('User N ──M Workspace (via Member)');
  if(has('Post')&&has('Comment')) rels.push('Post 1 ──N Comment');
  if(has('Post')&&has('Tag')) rels.push('Post N ──M Tag');
  if(has('Post')&&has('Like')) rels.push('Post 1 ──N Like');
  if(has('Post')&&has('Media')) rels.push('Post 1 ──N Media');
  if(has('Product')&&has('Category')) rels.push('Product N ──1 Category');
  if(has('Product')&&has('Order')) rels.push('Order N ──M Product (via OrderItem)');
  if(has('Product')&&has('Review')) rels.push('Product 1 ──N Review');
  if(has('Product')&&has('Cart')) rels.push('Product 1 ──N Cart');
  if(has('Order')&&has('Payment')) rels.push('Order 1 ──1 Payment');
  if(has('Course')&&has('Lesson')) rels.push('Course 1 ──N Lesson');
  if(has('Course')&&has('Enrollment')) rels.push('Course 1 ──N Enrollment');
  if(has('Course')&&has('Review')) rels.push('Course 1 ──N Review');
  if(has('Course')&&has('Quiz')) rels.push('Course 1 ──N Quiz');
  if(has('Lesson')&&has('Quiz')) rels.push('Lesson 1 ──N Quiz');
  if(has('Lesson')&&has('Progress')) rels.push('Lesson 1 ──N Progress');
  if(has('Service')&&has('Booking')) rels.push('Service 1 ──N Booking');
  if(has('Service')&&has('TimeSlot')) rels.push('Service 1 ──N TimeSlot');
  if(has('Workspace')&&has('Project')) rels.push('Workspace 1 ──N Project');
  if(has('Project')&&has('Task')) rels.push('Project 1 ──N Task');
  if(has('Dashboard')&&has('Widget')) rels.push('Dashboard 1 ──N Widget');
  if(has('Listing')&&has('Category')) rels.push('Listing N ──1 Category');
  if(has('Device')&&has('Sensor')) rels.push('Device 1 ──N Sensor');
  if(has('Category')) rels.push('Category 0 ──N Category');
  if(has('Patient')&&has('MedicalRecord')) rels.push('Patient 1 ──N MedicalRecord');
  if(has('Doctor')&&has('MedicalRecord')) rels.push('Doctor 1 ──N MedicalRecord');
  if(has('MedicalRecord')&&has('Prescription')) rels.push('MedicalRecord 1 ──N Prescription');
  if(has('Patient')&&has('Appointment')) rels.push('Patient 1 ──N Appointment');
  if(has('Doctor')&&has('Appointment')) rels.push('Doctor 1 ──N Appointment');
  if(has('Pet')&&has('Vaccination')) rels.push('Pet 1 ──N Vaccination');
  if(has('Property')&&has('Unit')) rels.push('Property 1 ──N Unit');
  if(has('Unit')&&has('Lease')) rels.push('Unit 1 ──N Lease');
  if(has('Tenant')&&has('Lease')) rels.push('Tenant 1 ──N Lease');
  if(has('Unit')&&has('MaintenanceRequest')) rels.push('Unit 1 ──N MaintenanceRequest');
  if(has('Contract')&&has('Party')) rels.push('Contract 1 ──N Party');
  if(has('Contract')&&has('Approval')) rels.push('Contract 1 ──N Approval');
  if(has('Contract')&&has('Signature')) rels.push('Contract 1 ──N Signature');
  return {domain,warnings,suggestions,relationships:rels};
}
const FEATURE_DETAILS={
  'ユーザー認証|認証|Auth|ログイン|Login|SignUp':{
    criteria_ja:['メール+パスワードでの新規登録','ソーシャルログイン({auth})','パスワードリセットメール送信','セッション管理・自動トークンリフレッシュ','ログアウト後のトークン無効化','プロフィール表示・編集'],
    criteria_en:['Email + password registration','Social login ({auth})','Password reset email','Session management / auto token refresh','Token invalidation on logout','Profile view & edit'],
    tests_ja:[['正常系: メール+パスワードで登録','201, ユーザー作成・セッション開始'],['正常系: ソーシャルログイン','302, OAuth認証→コールバック→セッション'],['正常系: パスワードリセット','200, リセットメール送信'],['異常系: 重複メールで登録','409/422, メール重複エラー'],['異常系: 不正パスワード(8文字未満)','422, バリデーションエラー'],['異常系: 無効トークンでアクセス','401, Unauthorized']],
    tests_en:[['Normal: Register with email+password','201, user created + session start'],['Normal: Social login','302, OAuth → callback → session'],['Normal: Password reset','200, reset email sent'],['Error: Duplicate email','409/422, email already exists'],['Error: Weak password(<8 chars)','422, validation error'],['Error: Invalid token','401, Unauthorized']],
  },
  'コース管理|コース|Course|講座':{
    criteria_ja:['コース作成(タイトル/説明/サムネイル/価格)','コース一覧(検索/フィルタ/ページネーション)','コース詳細表示','下書き↔公開のステータス管理','講師のみ編集可能(RLS)','カテゴリ/タグによる分類'],
    criteria_en:['Create course (title/desc/thumbnail/price)','List courses (search/filter/pagination)','Course detail view','Draft ↔ published status toggle','Instructor-only edit (RLS)','Category/tag classification'],
    tests_ja:[['正常系: コース作成(全フィールド)','201, DBにコース保存'],['正常系: ステータス変更(draft→published)','200, 公開日時記録'],['正常系: 一覧検索+フィルタ','200, フィルタ結果返却'],['異常系: 未認証でコース作成','401'],['異常系: 他講師のコースを編集','403 (RLS拒否)'],['異常系: タイトル空で作成','422, バリデーション']],
    tests_en:[['Normal: Create course (all fields)','201, course saved'],['Normal: Status change (draft→published)','200, publish date recorded'],['Normal: List with search+filter','200, filtered results'],['Error: Create without auth','401'],['Error: Edit other instructor\'s course','403 (RLS denied)'],['Error: Create with empty title','422, validation']],
  },
  '進捗管理|進捗|Progress|学習進捗':{
    criteria_ja:['レッスン完了の記録','コース全体の進捗率算出','学習履歴の一覧表示','完了条件: レッスンページ閲覧完了','進捗ダッシュボード(統計/グラフ)'],
    criteria_en:['Record lesson completion','Calculate overall course progress','Learning history list','Completion: lesson page viewed','Progress dashboard (stats/charts)'],
    tests_ja:[['正常系: レッスン完了を記録','200, progress.status=completed'],['正常系: コース進捗率取得','200, {progress_pct: 60}'],['正常系: 全完了でコース修了','200, enrollment.status=completed'],['異常系: 未受講コースの進捗記録','403/404'],['異常系: 同レッスン二重完了','200, 冪等(既存更新)']],
    tests_en:[['Normal: Mark lesson complete','200, progress.status=completed'],['Normal: Get course progress','200, {progress_pct: 60}'],['Normal: All done = course complete','200, enrollment.status=completed'],['Error: Progress on unenrolled course','403/404'],['Error: Double complete same lesson','200, idempotent']],
  },
  'サブスクリプション|課金|Billing|Stripe|決済|Payment|サブスク':{
    criteria_ja:['プラン選択画面(Free/Pro/Enterprise)','Stripe Checkout セッション作成','Webhook処理(invoice.paid, customer.subscription.deleted)','課金状態表示(アクティブ/期限切れ/解約済)','プラン変更/解約フロー','無料トライアル期間設定'],
    criteria_en:['Plan selection (Free/Pro/Enterprise)','Create Stripe Checkout session','Webhook (invoice.paid, subscription.deleted)','Billing status display (active/expired/canceled)','Plan change / cancel flow','Free trial period config'],
    tests_ja:[['正常系: Checkout セッション作成','200, checkout URL返却'],['正常系: Webhook invoice.paid 受信','200, subscription.status=active'],['正常系: プラン変更(Pro→Enterprise)','200, 次期間から適用'],['正常系: サブスク解約','200, 期間末まで有効'],['異常系: 無効Webhook署名','400, 署名検証失敗'],['異常系: 未認証でCheckout作成','401']],
    tests_en:[['Normal: Create checkout session','200, checkout URL returned'],['Normal: Webhook invoice.paid','200, subscription.status=active'],['Normal: Plan change (Pro→Enterprise)','200, applied next period'],['Normal: Cancel subscription','200, valid until period end'],['Error: Invalid webhook signature','400, sig verification failed'],['Error: Checkout without auth','401']],
  },
  '管理(ダッシュボード|画面)|Admin|管理者|ダッシュボード管理':{
    criteria_ja:['管理者ログイン(role=adminチェック)','ユーザー一覧/検索/停止','コンテンツ管理(一覧/承認/削除)','売上/統計ダッシュボード','監査ログ閲覧'],
    criteria_en:['Admin login (role=admin check)','User list/search/suspend','Content management (list/approve/delete)','Revenue/stats dashboard','Audit log viewer'],
    tests_ja:[['正常系: 管理者でアクセス','200, 管理画面表示'],['正常系: ユーザー停止','200, user.status=suspended'],['正常系: コンテンツ承認','200, content.status=approved'],['異常系: 一般ユーザーで管理画面アクセス','403'],['異常系: 管理者が自分を停止','422/403']],
    tests_en:[['Normal: Admin access','200, admin panel displayed'],['Normal: Suspend user','200, user.status=suspended'],['Normal: Approve content','200, content.status=approved'],['Error: Non-admin access','403'],['Error: Admin suspend self','422/403']],
  },
  '商品管理|商品|Product|商品一覧':{
    criteria_ja:['商品登録(名前/説明/価格/画像/SKU)','商品一覧(検索/カテゴリフィルタ/ページネーション)','在庫管理(入荷/出荷)','商品詳細表示','カテゴリ管理(CRUD/階層構造)'],
    criteria_en:['Register product (name/desc/price/image/SKU)','Product list (search/filter/pagination)','Inventory management','Product detail view','Category management (CRUD/hierarchy)'],
    tests_ja:[['正常系: 商品登録','201, 商品DBに保存'],['正常系: 在庫更新','200, stock数更新'],['正常系: カテゴリフィルタ','200, フィルタ結果'],['異常系: 価格が負数','422'],['異常系: SKU重複','409/422'],['異常系: 在庫0で購入','422, 在庫不足']],
    tests_en:[['Normal: Register product','201, saved to DB'],['Normal: Update stock','200, stock updated'],['Normal: Category filter','200, filtered results'],['Error: Negative price','422'],['Error: Duplicate SKU','409/422'],['Error: Buy with 0 stock','422, out of stock']],
  },
  '注文|Order|カート|Cart|購入':{
    criteria_ja:['カートに商品追加/数量変更/削除','カートから注文作成','注文履歴一覧','注文ステータス管理(pending→paid→shipped→delivered)','注文キャンセル(条件付き)'],
    criteria_en:['Add/update/remove cart items','Create order from cart','Order history list','Order status flow (pending→paid→shipped→delivered)','Conditional order cancel'],
    tests_ja:[['正常系: カート追加→注文作成','201, order作成+cart空に'],['正常系: 注文ステータス更新','200, status遷移'],['正常系: 注文キャンセル(pending)','200, status=cancelled'],['異常系: 空カートで注文','422'],['異常系: shipped後キャンセル','422, キャンセル不可']],
    tests_en:[['Normal: Cart add → create order','201, order created + cart cleared'],['Normal: Update order status','200, status transition'],['Normal: Cancel (pending)','200, status=cancelled'],['Error: Order from empty cart','422'],['Error: Cancel after shipped','422, not cancellable']],
  },
  'コメント|Comment|レビュー|Review':{
    criteria_ja:['コメント/レビュー投稿(本文+評価)','一覧表示(ページネーション)','投稿者のみ編集/削除可能','不適切コンテンツの報告機能'],
    criteria_en:['Post comment/review (body+rating)','List with pagination','Author-only edit/delete','Report inappropriate content'],
    tests_ja:[['正常系: レビュー投稿(rating=5)','201, レビュー保存'],['正常系: 自分のレビュー削除','204'],['異常系: 未認証で投稿','401'],['異常系: 他人のレビュー削除','403'],['異常系: rating範囲外(0 or 6)','422']],
    tests_en:[['Normal: Post review (rating=5)','201, review saved'],['Normal: Delete own review','204'],['Error: Post without auth','401'],['Error: Delete other\'s review','403'],['Error: Rating out of range','422']],
  },
  '投稿|Post|記事|Article|ブログ|Blog|コンテンツ投稿':{
    criteria_ja:['記事作成(タイトル/本文/スラグ/サムネイル)','下書き↔公開のステータス管理','一覧表示(検索/タグフィルタ/ページネーション)','Markdown/リッチテキストエディタ','OGP/SEOメタデータ設定'],
    criteria_en:['Create post (title/body/slug/thumbnail)','Draft ↔ published status','List (search/tag filter/pagination)','Markdown/rich text editor','OGP/SEO metadata'],
    tests_ja:[['正常系: 記事作成(下書き)','201, status=draft'],['正常系: 公開','200, published_at記録'],['正常系: スラグ検索','200, 記事返却'],['異常系: スラグ重複','409/422'],['異常系: 未認証で作成','401']],
    tests_en:[['Normal: Create draft post','201, status=draft'],['Normal: Publish','200, published_at set'],['Normal: Slug search','200, post returned'],['Error: Duplicate slug','409/422'],['Error: Create without auth','401']],
  },
  '予約|Booking|スケジュール|Appointment':{
    criteria_ja:['空き枠表示(カレンダービュー)','予約作成(日時/サービス選択)','予約確認メール送信','予約キャンセル/変更','リマインダー通知'],
    criteria_en:['Available slots (calendar view)','Create booking (date/service)','Booking confirmation email','Cancel/reschedule booking','Reminder notification'],
    tests_ja:[['正常系: 空き枠から予約作成','201, booking作成'],['正常系: 予約キャンセル','200, status=cancelled'],['異常系: 過去日時で予約','422'],['異常系: 同時刻に二重予約','409, 枠なし'],['異常系: 未認証で予約','401']],
    tests_en:[['Normal: Book from available slot','201, booking created'],['Normal: Cancel booking','200, status=cancelled'],['Error: Book past datetime','422'],['Error: Double book same slot','409, no availability'],['Error: Book without auth','401']],
  },
  'タスク管理|タスク|Task|Todo|プロジェクト管理':{
    criteria_ja:['タスク作成(タイトル/担当者/期日/優先度)','カンバンボード表示(todo/in_progress/done)','ドラッグ&ドロップでステータス変更','フィルタ(担当者/優先度/期日)','期日リマインダー通知'],
    criteria_en:['Create task (title/assignee/due/priority)','Kanban board (todo/in_progress/done)','D&D status change','Filter (assignee/priority/due)','Due date reminder'],
    tests_ja:[['正常系: タスク作成','201, task保存'],['正常系: ステータス変更(todo→done)','200, status更新'],['正常系: 担当者フィルタ','200, フィルタ結果'],['異常系: 他ワークスペースのタスク編集','403'],['異常系: タイトル空で作成','422']],
    tests_en:[['Normal: Create task','201, task saved'],['Normal: Status change (todo→done)','200, status updated'],['Normal: Filter by assignee','200, filtered'],['Error: Edit other workspace task','403'],['Error: Create with empty title','422']],
  },
  'ファイルアップロード|Upload|メディア|Media|画像':{
    criteria_ja:['ファイルアップロード(ドラッグ&ドロップ対応)','アップロード制限(10MB/画像・PDF)','プレビュー表示','ストレージ管理(Supabase Storage/S3)'],
    criteria_en:['File upload (drag & drop)','Upload limit (10MB/image/PDF)','Preview display','Storage (Supabase Storage/S3)'],
    tests_ja:[['正常系: 画像アップロード','201, URL返却'],['正常系: プレビュー表示','200, 画像取得'],['異常系: 10MB超ファイル','413/422, サイズ制限'],['異常系: 非対応形式(.exe)','422, 形式エラー'],['異常系: 未認証アップロード','401']],
    tests_en:[['Normal: Image upload','201, URL returned'],['Normal: Preview','200, image fetched'],['Error: >10MB file','413/422, size limit'],['Error: Unsupported format(.exe)','422'],['Error: Upload without auth','401']],
  },
  '検索|フィルタ|Search|Filter|絞り込み':{
    criteria_ja:['全文検索(タイトル/本文)','複合フィルタ(カテゴリ/タグ/日付範囲)','ソート(新着/人気/価格)','ページネーション(無限スクロール対応)','検索履歴保存'],
    criteria_en:['Full-text search (title/body)','Multi-filter (category/tag/date range)','Sort (newest/popular/price)','Pagination (infinite scroll)','Search history'],
    tests_ja:[['正常系: キーワード検索','200, マッチ結果返却'],['正常系: フィルタ+ソート組合せ','200, 複合条件適用'],['正常系: ページネーション','200, offset/limit適用'],['異常系: 不正なソート値','422, バリデーション'],['異常系: 空クエリ','200, 全件返却']],
    tests_en:[['Normal: Keyword search','200, matched results'],['Normal: Filter + sort combo','200, multi-condition applied'],['Normal: Pagination','200, offset/limit applied'],['Error: Invalid sort value','422, validation'],['Error: Empty query','200, all results']],
  },
  '通知|リマインダー|Notification|Reminder|アラート':{
    criteria_ja:['プッシュ通知(ブラウザ/モバイル)','メール通知(Resend/SendGrid)','通知一覧表示','既読/未読管理','通知設定(ON/OFF切替)','リマインダー自動送信'],
    criteria_en:['Push notifications (browser/mobile)','Email notifications (Resend/SendGrid)','Notification list','Read/unread management','Notification settings toggle','Auto reminder send'],
    tests_ja:[['正常系: 通知作成+送信','201, 通知DB保存+送信'],['正常系: 既読更新','200, read_at記録'],['正常系: 通知設定OFF','200, 送信スキップ'],['異常系: 未認証で通知一覧','401'],['異常系: 他ユーザーの通知既読','403']],
    tests_en:[['Normal: Create + send notification','201, saved + sent'],['Normal: Mark as read','200, read_at set'],['Normal: Notifications OFF','200, sending skipped'],['Error: List without auth','401'],['Error: Mark other\'s notification','403']],
  },
  '分析|レポート|Analytics|Report|統計|集計':{
    criteria_ja:['KPI集計(日次/週次/月次)','グラフ表示(recharts/Chart.js)','CSV/PDFエクスポート','カスタムレポート作成','リアルタイム更新(WebSocket/SSE)'],
    criteria_en:['KPI aggregation (daily/weekly/monthly)','Chart display (recharts/Chart.js)','CSV/PDF export','Custom report builder','Real-time updates (WebSocket/SSE)'],
    tests_ja:[['正常系: 期間指定集計','200, 集計結果返却'],['正常系: CSVエクスポート','200, CSV生成'],['正常系: グラフデータ取得','200, データポイント配列'],['異常系: 未来日で集計','422, 日付バリデーション'],['異常系: 大量データでタイムアウト','503/504, クエリ最適化必要']],
    tests_en:[['Normal: Aggregate by period','200, aggregated results'],['Normal: CSV export','200, CSV generated'],['Normal: Get chart data','200, data points array'],['Error: Aggregate future dates','422, date validation'],['Error: Large data timeout','503/504, query optimization needed']],
  },
  'チーム|権限|Team|Permission|RBAC|招待':{
    criteria_ja:['チーム作成・メンバー招待','ロール管理(owner/admin/member/viewer)','招待メール送信','権限チェック(RLS/middleware)','チームメンバー一覧表示'],
    criteria_en:['Create team & invite members','Role management (owner/admin/member/viewer)','Send invitation email','Permission check (RLS/middleware)','Team member list'],
    tests_ja:[['正常系: メンバー招待','201, 招待メール送信'],['正常系: ロール変更(member→admin)','200, 権限更新'],['正常系: メンバー削除','204'],['異常系: viewer権限でメンバー招待','403, 権限不足'],['異常系: 重複招待','409, 既存メンバー']],
    tests_en:[['Normal: Invite member','201, invitation sent'],['Normal: Change role (member→admin)','200, permission updated'],['Normal: Remove member','204'],['Error: Viewer invites member','403, insufficient permissions'],['Error: Duplicate invitation','409, already member']],
  },
  'チャット|メッセージ|Chat|Message|DM|リアルタイム':{
    criteria_ja:['リアルタイムメッセージ送受信(WebSocket/Supabase Realtime)','メッセージ一覧(ページネーション)','未読件数表示','既読管理','ファイル添付','メッセージ削除(24時間以内)'],
    criteria_en:['Real-time messaging (WebSocket/Supabase Realtime)','Message list (pagination)','Unread count','Read receipts','File attachment','Delete message (within 24h)'],
    tests_ja:[['正常系: メッセージ送信','201, 送受信者に配信'],['正常系: 既読更新','200, read_at記録'],['正常系: 未読件数取得','200, {unread: 5}'],['異常系: 未認証で送信','401'],['異常系: 24時間後に削除','422, 削除不可']],
    tests_en:[['Normal: Send message','201, delivered to sender/receiver'],['Normal: Mark as read','200, read_at set'],['Normal: Get unread count','200, {unread: 5}'],['Error: Send without auth','401'],['Error: Delete after 24h','422, cannot delete']],
  },
  'エクスポート|Export|PDF|CSV|ダウンロード':{
    criteria_ja:['CSV一括エクスポート','PDF生成(請求書/契約書/レポート)','エクスポート履歴保存','バックグラウンド処理(大量データ)','ZIP圧縮(複数ファイル)'],
    criteria_en:['Bulk CSV export','PDF generation (invoices/contracts/reports)','Export history','Background processing (large data)','ZIP compression (multi-file)'],
    tests_ja:[['正常系: CSV一括エクスポート','200, CSV生成+ダウンロード'],['正常系: PDF請求書生成','200, PDF URL返却'],['正常系: 複数ファイルZIP','200, ZIP生成'],['異常系: 大量データでメモリ不足','500, バッチ処理推奨'],['異常系: 未認証でエクスポート','401']],
    tests_en:[['Normal: Bulk CSV export','200, CSV generated + download'],['Normal: Generate PDF invoice','200, PDF URL returned'],['Normal: Multi-file ZIP','200, ZIP created'],['Error: Large data OOM','500, recommend batch'],['Error: Export without auth','401']],
  },
  'カレンダー|スケジュール|Calendar|Schedule|日程調整':{
    criteria_ja:['カレンダー表示(日/週/月ビュー)','予定作成・編集・削除','ドラッグ&ドロップで日時変更','Googleカレンダー連携','定期予定設定(毎週/毎月)'],
    criteria_en:['Calendar view (day/week/month)','Create/edit/delete events','D&D reschedule','Google Calendar sync','Recurring events (weekly/monthly)'],
    tests_ja:[['正常系: 予定作成','201, カレンダーに表示'],['正常系: D&Dで日時変更','200, starts_at更新'],['正常系: 定期予定作成','201, 繰り返し設定保存'],['異常系: 過去日時で作成','422, 日付バリデーション'],['異常系: 重複予定作成','409, 枠なし']],
    tests_en:[['Normal: Create event','201, shown on calendar'],['Normal: D&D reschedule','200, starts_at updated'],['Normal: Create recurring event','201, recurrence saved'],['Error: Create in past','422, date validation'],['Error: Double-book slot','409, conflict']],
  },
  '在庫管理|Inventory|在庫|Stock|入出庫':{
    criteria_ja:['在庫数リアルタイム表示','入庫/出庫記録','在庫アラート(低在庫/過剰在庫)','ロット管理(賞味期限/シリアル番号)','棚卸し機能'],
    criteria_en:['Real-time stock display','Inbound/outbound records','Stock alerts (low/excess)','Lot management (expiry/serial)','Inventory count'],
    tests_ja:[['正常系: 入庫記録','201, 在庫数増加'],['正常系: 出庫記録','200, 在庫数減少'],['正常系: 低在庫アラート','200, stock<10で通知'],['異常系: 在庫0で出庫','422, 在庫不足'],['異常系: 負数で入庫','422, 数量バリデーション']],
    tests_en:[['Normal: Inbound record','201, stock increased'],['Normal: Outbound record','200, stock decreased'],['Normal: Low stock alert','200, notify when stock<10'],['Error: Outbound with 0 stock','422, out of stock'],['Error: Negative inbound','422, quantity validation']],
  },
};
function getFeatureDetail(featureName){
  for(const[pattern,detail]of Object.entries(FEATURE_DETAILS)){
    if(new RegExp(pattern,'i').test(featureName)) return detail;
  }
  return null;
}
const DOMAIN_QA_MAP={
  education:{
    focus_ja:['学習進捗のバックエンド同期','WCAG 2.1 AA準拠','未成年データ保護(FERPA)','コンテンツ配信安定性'],
    focus_en:['Backend sync for progress','WCAG 2.1 AA compliance','Minor data protection (FERPA)','Content delivery stability'],
    bugs_ja:['localStorage依存による進捗消失','クイズ正誤判定ミス','ブラウザ別音声再生不具合'],
    bugs_en:['Progress lost on localStorage clear','Quiz scoring errors','Audio playback failures per browser'],
    priority:'Security:HIGH|Performance:MED|DataIntegrity:HIGH|UX:CRITICAL|Compliance:HIGH'
  },
  ec:{
    focus_ja:['同時購入の在庫競合','決済フロー完全性','カート操作の冪等性','スパイクトラフィック耐性'],
    focus_en:['Concurrent inventory conflicts','Payment flow integrity','Cart operation idempotency','Spike traffic resilience'],
    bugs_ja:['同一商品を複数ユーザーが同時購入','カート追加ボタン連打で数量倍増','決済中断時の在庫戻し漏れ'],
    bugs_en:['Same item bought by multiple users simultaneously','Rapid cart add button clicks double quantity','Inventory not returned on payment cancellation'],
    priority:'Security:CRITICAL|Performance:HIGH|DataIntegrity:CRITICAL|UX:HIGH|Compliance:MED'
  },
  saas:{
    focus_ja:['マルチテナント分離(RLS)','プラン別機能制限','サブスク更新・解約処理','API rate limiting'],
    focus_en:['Multi-tenant isolation (RLS)','Plan-based feature restrictions','Subscription renewal/cancellation','API rate limiting'],
    bugs_ja:['テナント間データ漏洩','プラン変更時の機能アクセス制御不備','サブスク解約後も課金継続'],
    bugs_en:['Data leakage between tenants','Feature access control failure on plan change','Billing continues after cancellation'],
    priority:'Security:CRITICAL|Performance:HIGH|DataIntegrity:HIGH|UX:MED|Compliance:HIGH'
  },
  community:{
    focus_ja:['投稿フィルタリング(不適切コンテンツ)','通報・モデレーション','スパム対策','リアルタイム同期'],
    focus_en:['Content filtering (inappropriate)','Reporting & moderation','Spam prevention','Real-time sync'],
    bugs_ja:['XSS脆弱性(投稿にスクリプト注入)','通報機能の不正利用','スパムボットによる大量投稿'],
    bugs_en:['XSS vulnerability (script injection in posts)','Report feature abuse','Mass posting by spam bots'],
    priority:'Security:HIGH|Performance:MED|DataIntegrity:MED|UX:HIGH|Compliance:MED'
  },
  booking:{
    focus_ja:['同時予約競合','キャンセル・変更処理','タイムゾーン処理','外部カレンダー連携'],
    focus_en:['Concurrent booking conflicts','Cancellation/modification handling','Timezone handling','External calendar integration'],
    bugs_ja:['同一枠を複数ユーザーが予約','タイムゾーン計算ミスで時刻ずれ','キャンセル時の返金処理漏れ'],
    bugs_en:['Same slot booked by multiple users','Timezone calculation errors cause time mismatches','Refund process omitted on cancellation'],
    priority:'Security:MED|Performance:HIGH|DataIntegrity:CRITICAL|UX:CRITICAL|Compliance:MED'
  },
  fintech:{
    focus_ja:['トランザクション完全性(ACID)','二重処理防止','監査ログ完全性','PCI DSS準拠'],
    focus_en:['Transaction integrity (ACID)','Double-processing prevention','Audit log completeness','PCI DSS compliance'],
    bugs_ja:['送金ボタン連打で二重送金','残高計算の浮動小数点誤差','監査ログの欠損'],
    bugs_en:['Double transfer on rapid send button clicks','Floating-point errors in balance calculations','Missing audit log entries'],
    priority:'Security:CRITICAL|Performance:MED|DataIntegrity:CRITICAL|UX:MED|Compliance:CRITICAL'
  },
  iot:{
    focus_ja:['デバイス認証・認可','オフライン動作','ファームウェア更新','デバイス間同期'],
    focus_en:['Device authentication & authorization','Offline operation','Firmware updates','Device-to-device sync'],
    bugs_ja:['不正デバイスのAPI接続','オフライン時のデータ消失','ファームウェア更新失敗で文鎮化'],
    bugs_en:['Unauthorized device API access','Data loss in offline mode','Bricked devices from failed firmware updates'],
    priority:'Security:CRITICAL|Performance:MED|DataIntegrity:HIGH|UX:MED|Compliance:MED'
  },
  realestate:{
    focus_ja:['物件検索パフォーマンス','地図連携精度','内見予約管理','物件状態同期'],
    focus_en:['Property search performance','Map integration accuracy','Viewing appointment management','Property status sync'],
    bugs_ja:['成約済み物件が検索表示','地図ピン位置のずれ','内見予約の重複'],
    bugs_en:['Sold properties shown in search','Map pin location misalignment','Duplicate viewing appointments'],
    priority:'Security:MED|Performance:HIGH|DataIntegrity:HIGH|UX:CRITICAL|Compliance:MED'
  },
  content:{
    focus_ja:['CDN配信最適化','画像・動画エンコード','オフライン閲覧','コンテンツ推薦精度'],
    focus_en:['CDN delivery optimization','Image/video encoding','Offline viewing','Content recommendation accuracy'],
    bugs_ja:['高負荷時の動画再生停止','画像遅延読み込み失敗','オフラインキャッシュ容量超過'],
    bugs_en:['Video playback stops under high load','Image lazy loading failures','Offline cache quota exceeded'],
    priority:'Security:LOW|Performance:CRITICAL|DataIntegrity:MED|UX:CRITICAL|Compliance:LOW'
  },
  hr:{
    focus_ja:['個人情報保護(GDPR/CCPA)','採用プロセス公平性','評価データ整合性','権限管理'],
    focus_en:['Personal data protection (GDPR/CCPA)','Hiring process fairness','Evaluation data integrity','Permission management'],
    bugs_ja:['退職者のデータアクセス残存','評価スコア計算ミス','応募者情報の漏洩'],
    bugs_en:['Former employee retains data access','Evaluation score calculation errors','Applicant info leakage'],
    priority:'Security:CRITICAL|Performance:MED|DataIntegrity:HIGH|UX:MED|Compliance:CRITICAL'
  },
  analytics:{
    focus_ja:['集計パフォーマンス','データパイプライン信頼性','リアルタイム更新','可視化精度'],
    focus_en:['Aggregation performance','Data pipeline reliability','Real-time updates','Visualization accuracy'],
    bugs_ja:['大量データ集計でタイムアウト','ETL処理の部分失敗','グラフ表示の数値ずれ'],
    bugs_en:['Timeout on large data aggregation','Partial ETL process failures','Graph display value discrepancies'],
    priority:'Security:MED|Performance:CRITICAL|DataIntegrity:CRITICAL|UX:HIGH|Compliance:MED'
  },
  health:{
    focus_ja:['患者データ保護(HIPAA)','処方・診断記録の正確性','医療機器連携','緊急時可用性'],
    focus_en:['Patient data protection (HIPAA)','Prescription/diagnosis record accuracy','Medical device integration','Emergency availability'],
    bugs_ja:['患者間データ混在','処方箋の記録ミス','医療機器データ取得失敗'],
    bugs_en:['Patient data cross-contamination','Prescription record errors','Medical device data acquisition failures'],
    priority:'Security:CRITICAL|Performance:HIGH|DataIntegrity:CRITICAL|UX:CRITICAL|Compliance:CRITICAL'
  },
  marketplace:{
    focus_ja:['出品者・購入者間トラスト','エスクロー処理','レビュー信頼性','手数料計算'],
    focus_en:['Seller-buyer trust','Escrow processing','Review authenticity','Fee calculation'],
    bugs_ja:['評価の不正操作','エスクロー解放タイミングミス','手数料計算エラー'],
    bugs_en:['Review manipulation','Escrow release timing errors','Fee calculation mistakes'],
    priority:'Security:HIGH|Performance:MED|DataIntegrity:HIGH|UX:HIGH|Compliance:MED'
  },
  legal:{
    focus_ja:['契約ドキュメント完全性','電子署名有効性','バージョン管理','監査証跡'],
    focus_en:['Contract document integrity','Electronic signature validity','Version control','Audit trail'],
    bugs_ja:['契約書の改ざん','署名検証失敗','バージョン履歴消失'],
    bugs_en:['Contract document tampering','Signature verification failures','Version history loss'],
    priority:'Security:CRITICAL|Performance:MED|DataIntegrity:CRITICAL|UX:MED|Compliance:CRITICAL'
  },
  tool:{
    focus_ja:['操作レスポンス速度','データエクスポート完全性','ショートカット動作','エラー復旧'],
    focus_en:['Operation response speed','Data export completeness','Shortcut functionality','Error recovery'],
    bugs_ja:['大量データ操作で固まる','エクスポート時の文字化け','ショートカットキー競合'],
    bugs_en:['Freezes on large data operations','Character encoding issues in exports','Shortcut key conflicts'],
    priority:'Security:LOW|Performance:HIGH|DataIntegrity:MED|UX:CRITICAL|Compliance:LOW'
  },
  portfolio:{
    focus_ja:['SEO最適化','レスポンシブ対応','画像最適化(WebP)','表示速度(Core Web Vitals)'],
    focus_en:['SEO optimization','Responsive design','Image optimization (WebP)','Display speed (Core Web Vitals)'],
    bugs_ja:['モバイル表示崩れ','画像遅延読み込み失敗','SNS OGP未設定'],
    bugs_en:['Mobile layout breaks','Image lazy loading failures','Missing SNS OGP tags'],
    priority:'Security:LOW|Performance:HIGH|DataIntegrity:LOW|UX:CRITICAL|Compliance:LOW'
  }
};
const QA_CROSS_CUTTING={
  concurrency:{ja:'同時アクセス競合テスト',en:'Concurrent access race condition test',domains:['fintech','ec','booking','community','saas']},
  idempotency:{ja:'二重処理防止(冪等性)',en:'Double-processing prevention (idempotency)',domains:['fintech','ec','booking']},
  spike:{ja:'スパイクトラフィック耐性(通常の100倍)',en:'Spike traffic resilience (100x normal)',domains:['ec','content','community','booking']},
  offline:{ja:'オフライン/劣化ネットワーク動作',en:'Offline/degraded network operation',domains:['iot','content','community']},
  tenant:{ja:'マルチテナント分離(RLS)',en:'Multi-tenant isolation (RLS)',domains:['saas','analytics']},
  api_resilience:{ja:'外部API耐障害性(タイムアウト/リトライ/フォールバック)',en:'External API resilience (timeout/retry/fallback)',domains:['booking','saas','ec','analytics']},
  a11y:{ja:'アクセシビリティ(WCAG)',en:'Accessibility (WCAG)',domains:['education','content','hr']},
  audit:{ja:'監査ログ完全性',en:'Audit log completeness',domains:['fintech','saas','hr','legal']}
};
const _CF='FERPA';const _CP='PCI DSS';const _CH='HIPAA';const _CG='GDPR';
const _dpb=(i_ja,i_en,c_ja,c_en,p_ja,p_en,ctx_ja,ctx_en,sk_ja,sk_en)=>({impl_ja:i_ja,impl_en:i_en,compliance_ja:c_ja,compliance_en:c_en,prevent_ja:p_ja,prevent_en:p_en,ctx_ja:ctx_ja,ctx_en:ctx_en,skill_ja:sk_ja,skill_en:sk_en});
const DOMAIN_PLAYBOOK={
  education:_dpb(
    ['学習目標→知識体系→カリキュラム→評価基準(例:TOEIC 650→900=300h)','成績データ→パターン分析→弱点特定→個別最適化(正答率<60%優先)','理解度テスト→習熟判定→次単元解放(≥80%進む、<60%再履修)'],
    ['Goal→Knowledge map→Curriculum→Assessment (e.g. TOEIC 650→900=300hrs)','Grade data→Pattern analysis→Weakness ID→Personalization (prioritize <60%)','Test→Mastery→Unlock next (≥80% proceed, <60% retry)'],
    [_CF+':学生データ暗号化、保護者同意、保持5年','WCAG 2.1 AA、スクリーンリーダー対応',_CG+':Right to be forgotten'],
    [_CF+': student data encrypt, parental consent, 5yr retention','WCAG 2.1 AA, screen reader',_CG+': Right to be forgotten'],
    ['進捗消失|localStorage超過|対策:IndexedDB移行','カンニング検出漏れ|タブ監視のみ|対策:Proctorio+視線追跡','学習時間水増し|非アクティブカウント|対策:操作監視、5分で停止'],
    ['Progress loss|localStorage quota|Fix: IndexedDB','Cheating miss|Tab-only monitor|Fix: Proctorio+eye track','Time inflation|Counts inactive|Fix: Activity monitor, 5min pause'],
    ['新機能→requirements.md, design_system.md, error_logs.md','バグ→error_logs.md, test_cases/, architecture.md','分析→architecture.md(model), api_spec.md'],
    ['Feature→requirements.md, design_system.md, error_logs.md','Bug→error_logs.md, test_cases/, architecture.md','Analysis→architecture.md(model), api_spec.md'],
    '学習効果測定|カリキュラム最適化|入力:学習履歴JSON、目標|判断:<60%復習、60-79%補助、≥80%解放|出力:優先リスト、推定時間',
    'Learning Effectiveness|Optimize curriculum|Input: history JSON, target|Judgment: <60% review, 60-79% supplemental, ≥80% unlock|Output: priority list, estimate'
  ),
  ec:_dpb(
    ['購買→カート→決済完了→リピート(初回割30%→LTV 3.2x、カゴ落ち60%→回収18%)','在庫→需要予測→発注→欠品防止(90日平均+季節係数)','客単価→レコメンド→クロスセル→向上(3点提示でCTR 12%)'],
    ['Intent→Cart→Checkout→Repeat (30% discount→3.2x LTV, 60% abandon→18% recovery)','Inventory→Forecast→Reorder→Prevention (90d avg+seasonal)','Spending→Recommend→Cross-sell→Increase (3 items→12% CTR)'],
    [_CP+':トークン化、Stripe Radar、年次認証','特商法:運営者、返品、配送料','薬機法/景表法:誇大禁止'],
    [_CP+': tokenization, Stripe Radar, annual cert','Commercial Act: operator, return, shipping','Pharma/Ad Law: no exaggeration'],
    ['二重決済|冪等性未実装|対策:Stripe key、ボタン無効化','在庫切れ購入|race condition|対策:SELECT FOR UPDATE、3フェーズ','カゴ落ち60%|決済離脱|対策:住所補完、Apple Pay、ゲスト許可'],
    ['Double charge|No idempotency|Fix: Stripe key, disable button','Stockout purchase|Race condition|Fix: SELECT FOR UPDATE, 3-phase','60% abandon|Checkout friction|Fix: Address autocomplete, Apple Pay, guest'],
    ['決済→architecture.md(Stripe), security.md, error_logs.md','在庫→architecture.md(inventory), api_spec.md(stock)','レコメンド→stakeholders.md(ML), api_spec.md'],
    ['Payment→architecture.md(Stripe), security.md, error_logs.md','Inventory→architecture.md(inventory), api_spec.md(stock)','Recommend→stakeholders.md(ML), api_spec.md'],
    'カゴ落ち防止|決済完了率向上|入力:Analytics、Stripe、アンケート|判断:離脱>50%要改善、入力>3分補完、エラー>5%手段追加|出力:改善リスト、A/Bテスト、期待効果',
    'Cart Abandon Prevention|Improve completion|Input: Analytics, Stripe, survey|Judgment: abandon>50% improve, fill>3min autocomplete, error>5% add methods|Output: improvement list, A/B test, impact'
  ),
  saas:_dpb(
    ['MRR目標→顧客数→CAC→予算(MRR $50k、チャーン5%→+30顧客/月)','解約率→施策→改善→削減(オンボード<50%→ツアー+22%)','使用率→指標→アップセル→ARPU(週ログイン<2回リスク)'],
    ['MRR target→Customers→CAC→Budget (MRR $50k, 5% churn→+30/mo)','Churn→Tactics→Improve→Reduce (onboard<50%→tour+22%)','Usage→Metrics→Upsell→ARPU (weekly<2 risk)'],
    ['SOC 2 Type II:暗号化、検知、監査',_CG+':DPA、開示、ポータビリティ','利用規約:SLA 99.9%、削除30日'],
    ['SOC 2 Type II: encrypt, detect, audit',_CG+': DPA, disclose, portability','ToS: SLA 99.9%, delete 30d'],
    ['テナント分離漏れ|RLS未設定|対策:RLS必須、tenant_id必須','Rate limit突破|backoff未実装|対策:2^n待機、Circuit Breaker','オンボード離脱50%|設定複雑|対策:ツアー、プリセット、Aha!短縮'],
    ['Tenant isolation|Missing RLS|Fix: Enforce RLS, tenant_id required','Rate limit|No backoff|Fix: 2^n wait, Circuit Breaker','50% onboard drop|Complex setup|Fix: Tour, presets, shorten Aha!'],
    ['分離→architecture.md(RLS), security.md, test_cases/','解約→stakeholders.md(CS), progress.md, api_spec.md','機能→requirements.md, design_system.md'],
    ['Isolation→architecture.md(RLS), security.md, test_cases/','Churn→stakeholders.md(CS), progress.md, api_spec.md','Feature→requirements.md, design_system.md'],
    'チャーン予測|解約リスク検知|入力:行動ログ、契約情報|判断:ログイン<2かつ問合せ≥3高リスク、使用率<30%中リスク|出力:スコア、予測日、アクション',
    'Churn Prediction|Detect risk|Input: behavior logs, contract|Judgment: logins<2 AND tickets≥3 high risk, usage<30% medium|Output: score, date, actions'
  ),
  fintech:_dpb(
    ['投資目標→リターン→リスク→配分(60歳5,000万円→年利6.8%)','信用→与信→金利→管理(FICO 650-699→50万円、15%)','取引→異常検知→判定→ブロック(深夜高額→ML 92%→凍結)'],
    ['Goal→Return→Risk→Allocation (60yo ¥50M→6.8% return)','Credit→Limit→Rate→Manage (FICO 650-699→¥500k, 15%)','Transaction→Detect→Judge→Block (3AM high→ML 92%→freeze)'],
    ['金融庁:第二種、資金移動業',_CP+':600万件超、四半期スキャン','収益移転防止:eKYC、届出、7年保存'],
    ['FSA: Type II, Funds Transfer',_CP+': >6M/yr, quarterly scan','AML/KYC: eKYC, report, 7yr retention'],
    ['二重送金|残高チェック不足|対策:SELECT FOR UPDATE、冪等性','不正検出漏れ|ルールのみ|対策:LightGBM、行動学習','金利ズレ|浮動小数点誤差|対策:Decimal、整数演算'],
    ['Double transfer|Insufficient check|Fix: SELECT FOR UPDATE, idempotency','Fraud miss|Rule-only|Fix: LightGBM, behavior learning','Interest error|Float rounding|Fix: Decimal, integer math'],
    ['送金→architecture.md(transaction), security.md(PCI DSS)','検知→architecture.md(ML), api_spec.md(fraud)','計算→architecture.md(interest), test_cases/, error_logs.md'],
    ['Transfer→architecture.md(transaction), security.md(PCI DSS)','Fraud→architecture.md(ML), api_spec.md(fraud)','Interest→architecture.md(interest), test_cases/, error_logs.md'],
    '与信審査|融資判定|入力:スコア、年収、勤続、借入、延滞|判断:≥720承認30%8%、650-719承認20%15%、<650人間審査|出力:可否、限度額、金利、返済計画',
    'Credit Underwriting|Loan decision|Input: score, income, tenure, debt, delinquency|Judgment: ≥720 approve 30% 8%, 650-719 approve 20% 15%, <650 manual|Output: decision, limit, rate, repayment'
  ),
  health:_dpb(
    ['目標→リスク→改善プラン→予防(糖尿病35%→17.5%に体重-8kg)','症状→候補→検査→医療機関(頭痛+熱38.5℃+咳→インフルA 78%)','服薬→遵守率→効果→最適化(飲み忘れ30%→リマインダー85%)'],
    ['Goal→Risk→Plan→Prevention (diabetes 35%→17.5% via -8kg)','Symptom→Candidates→Tests→Facility (headache+fever 38.5℃+cough→Flu A 78%)','Medication→Adherence→Effect→Optimize (30% miss→reminder 85%)'],
    [_CH+':PHI暗号化、監査、BAA','医療機器:診断=クラスII、記録=非該当、届出','個情保護:匿名加工、オプトアウト'],
    [_CH+': PHI encrypt, audit, BAA','Medical device: diagnostic=Class II, records=non-device','Privacy: anonymize, opt-out'],
    ['診断ミス|データ不足|対策:必須入力増、禁忌チェック','通知されない|許可OFF|対策:ガイダンス、PWA、SMS','連携エラー|スコープ不足|対策:権限明示、再認証、リトライ'],
    ['Diagnostic error|Insufficient data|Fix: Increase inputs, contraindication check','No notification|Permission OFF|Fix: Guidance, PWA, SMS','Integration error|Scope insufficient|Fix: Specify permissions, re-auth, retry'],
    ['診断→architecture.md(ML), security.md(HIPAA), test_cases/','服薬→architecture.md(notification), api_spec.md, error_logs.md','連携→architecture.md(HealthKit), sequence_diagrams/'],
    ['Diagnostic→architecture.md(ML), security.md(HIPAA), test_cases/','Medication→architecture.md(notification), api_spec.md, error_logs.md','Integration→architecture.md(HealthKit), sequence_diagrams/'],
    '健康リスク予測|発症リスク予測|入力:健診データ、生活習慣、家族歴|判断:10年>30%高リスク、BMI≥25かつ血糖≥110糖尿病予備群|出力:スコア、目標、削減率、根拠',
    'Health Risk Prediction|Predict onset|Input: checkup data, lifestyle, family history|Judgment: 10yr>30% high risk, BMI≥25 AND sugar≥110 prediabetes|Output: scores, goals, reduction, evidence'
  ),
  booking:_dpb(
    ['可能枠→予測→動的価格→稼働率(19-20時満席→18時割20%)','空室→判定→制限→収益(週末2泊以上、直前50%オフ)','キャンセル率→前払い→防止→保護(15%→カード登録で3%)'],
    ['Slots→Forecast→Dynamic price→Occupancy (7-8PM full→6PM 20% off)','Vacancy→Detect→Restriction→Revenue (weekend 2-night min, last-min 50% off)','Cancel rate→Prepay→Prevent→Protect (15%→card reg 3%)'],
    ['旅行業法:第三種登録、管理、掲示','景表法:二重価格規制、おとり禁止','キャンセル:返金明示、手数料上限'],
    ['Travel Act: Type III reg, mgmt, display','Gift Act: dual price reg, bait prohibit','Cancel: refund disclose, fee cap'],
    ['ダブルブッキング|競合状態|対策:Lock、3段階、5分同期+バッファ','待ち通知されない|接続切断|対策:SSE fallback、SMS/Email、30秒以内','価格急変クレーム|更新頻度高|対策:30分固定、理由表示'],
    ['Double booking|Race condition|Fix: Lock, 3-phase, 5min sync+buffer','Waitlist no notify|Connection loss|Fix: SSE fallback, SMS/Email, within 30sec','Price change complaint|Too frequent|Fix: 30min hold, show reason'],
    ['予約→architecture.md(inventory), sequence_diagrams/(flow), security.md','価格→architecture.md(pricing), api_spec.md, stakeholders.md','キャンセル→architecture.md(policy), api_spec.md, error_logs.md'],
    ['Booking→architecture.md(inventory), sequence_diagrams/(flow), security.md','Pricing→architecture.md(pricing), api_spec.md, stakeholders.md','Cancel→architecture.md(policy), api_spec.md, error_logs.md'],
    '在庫最適化|稼働率収益最大化|入力:履歴、季節変動、イベント|判断:<60%割引、>90%値上げ、繁忙期制限、直前大幅割|出力:価格帯、制御ルール、期待値',
    'Inventory Optimization|Maximize occupancy revenue|Input: history, seasonal, events|Judgment: <60% discount, >90% increase, peak restrict, last-min deep discount|Output: price range, rules, expected'
  ),
  _default:_dpb(
    ['目標→KPI→機能→優先度(売上月100万円→CVR 2%→決済最優先)','ペイン→解決策→MVP→検証(情報過多→AIレコメンド→3パターン→A/B)','データ→ロジック→API→UI(User-Post-Comment→CRUD+検索→REST→画面)'],
    ['Goal→KPI→Features→Priority (sales ¥1M/mo→CVR 2%→payment first)','Pain→Solution→MVP→Validation (overload→AI recommend→3 patterns→A/B)','Data→Logic→API→UI (User-Post-Comment→CRUD+search→REST→screens)'],
    [_CG+':処理合法性、権利(アクセス・削除)、Cookie同意','OWASP Top 10、SQLi/XSS防止、パスワードハッシュ(bcrypt)','規約:必須記載、保持期限、第三者提供'],
    [_CG+': lawful processing, rights (access, delete), cookie consent','OWASP Top 10, SQLi/XSS prevent, password hash (bcrypt)','ToS: mandatory items, retention, third-party'],
    ['認証バイパス|JWT検証不足|対策:全ルートで検証、7日期限、リフレッシュ','N+1クエリ|個別取得|対策:JOIN、eager loading、監視>10アラート','遅延|全件取得、INDEX未設定|対策:ページネーション(limit 20)、INDEX、APM'],
    ['Auth bypass|Insufficient JWT validation|Fix: Enforce all routes, 7d expiry, refresh','N+1 query|Individual fetch|Fix: JOIN, eager loading, monitor>10 alert','Delay|Fetch all, no INDEX|Fix: Pagination (limit 20), INDEX, APM'],
    ['機能→requirements.md, architecture.md, design_system.md','バグ→error_logs.md, test_cases/, architecture.md','性能→architecture.md(optimize), sequence_diagrams/'],
    ['Feature→requirements.md, architecture.md, design_system.md','Bug→error_logs.md, test_cases/, architecture.md','Performance→architecture.md(optimize), sequence_diagrams/'],
    '要件整理|曖昧→構造化|入力:議事録、ストーリー、目標|判断:Must/Should/Won'+"'"+'t、Mustは数値目標、依存明示|出力:要件定義書、ER図、遷移図、選定理由',
    'Requirements Refinement|Ambiguous→Structured|Input: minutes, stories, goals|Judgment: Must/Should/Won'+"'"+'t, Must has numeric targets, dependencies explicit|Output: requirements doc, ER, transitions, rationale'
  ),
  marketplace:_dpb(
    ['出品→審査→マッチング→取引(手数料10%、エスクロー48h保護)','評価→信頼→プレミアム販売者(評価4.8+、100件→優先表示)','トラブル→仲裁→解決(通常7日、エスクロー解放延長)'],
    ['Listing→Review→Match→Transaction (10% fee, 48h escrow protection)','Rating→Trust→Premium seller (4.8+, 100 items→priority)','Dispute→Arbitrate→Resolve (7d standard, escrow hold extended)'],
    ['特商法:販売者開示、エスクロー、解決支援','景表法:おとり広告禁止、二重価格規制',_CG+':販売者・購入者情報保護'],
    [_CP+', Commercial Act: seller disclosure, escrow, dispute','Gift Act: prohibit bait ads, dual price reg',_CG+': seller/buyer info protection'],
    ['マッチング精度低|データ不足|ルール→100件でML','不正評価|サクラ|検知:短期間集中、IPクラスタ','手数料計算ミス|複雑割引|対策:事前見積、決済前確認'],
    ['Matching accuracy low|Insufficient data|Rules→ML after 100','Fake reviews|Shilling|Detect: burst period, IP cluster','Fee calc error|Complex discount|Fix: Pre-estimate, confirm before payment'],
    ['出品→requirements.md, api_spec.md(listing), test_cases/','評価→architecture.md(trust), api_spec.md, error_logs.md','仲裁→architecture.md(dispute), sequence_diagrams/, stakeholders.md'],
    ['Listing→requirements.md, api_spec.md(listing), test_cases/','Rating→architecture.md(trust), api_spec.md, error_logs.md','Arbitration→architecture.md(dispute), sequence_diagrams/, stakeholders.md'],
    'マッチング最適化|需給最適化|入力:履歴、評価、在庫、需要|判断:評価≥4.5優先、過去取引>10優遇、需要>供給値上げ推奨|出力:ランキング、価格提案、需給バランス',
    'Matching Optimization|Supply-demand optimization|Input: history, ratings, inventory, demand|Judgment: rating≥4.5 priority, past trades>10 favor, demand>supply suggest increase|Output: ranking, price suggestions, balance'
  ),
  community:_dpb(
    ['投稿→モデレーション→配信→エンゲージメント(自動検知+人間審査)','ユーザー→フォロー→フィード生成→ランキング(友達→興味→トレンド)','通報→審査→対応→再発防止(24h以内対応、3回で自動BAN)'],
    ['Post→Moderate→Distribute→Engage (auto-detect+human review)','User→Follow→Feed generation→Ranking (friends→interests→trending)','Report→Review→Action→Prevention (respond within 24h, 3 strikes auto-ban)'],
    ['投稿ガイド:誹謗中傷禁止、モデレーション、通報',_CG+':ユーザー生成コンテンツ責任、削除権','利用規約:著作権侵害即削除、荒らし対策'],
    [_CG+', Posting: prohibit defamation, moderation, report',_CG+': UGC liability, right to delete','ToS: copyright infringement immediate delete, anti-trolling'],
    ['スパム|reCAPTCHA未導入|対策:v3、5件/分制限','XSS脆弱性|サニタイズ不足|対策:DOMPurify、CSP','フィルターバブル|類似のみ|対策:多様性注入20%'],
    ['Spam|No reCAPTCHA|Fix: v3, 5/min limit','XSS vulnerability|Insufficient sanitize|Fix: DOMPurify, CSP','Filter bubble|Similarity only|Fix: Inject diversity 20%'],
    ['投稿→requirements.md, api_spec.md(post), security.md(XSS)','モデレーション→architecture.md(ML), stakeholders.md, error_logs.md','エンゲージメント→architecture.md(feed), api_spec.md, test_cases/'],
    ['Posting→requirements.md, api_spec.md(post), security.md(XSS)','Moderation→architecture.md(ML), stakeholders.md, error_logs.md','Engagement→architecture.md(feed), api_spec.md, test_cases/'],
    'コンテンツモデレーション|不適切投稿検知|入力:投稿テキスト、画像、通報履歴|判断:NGワード→即削除、グレー→人間審査、通報≥3緊急、過去違反者厳格|出力:判定、理由、対応、学習データ',
    'Content Moderation|Detect inappropriate posts|Input: post text, images, report history|Judgment: banned words→immediate delete, gray→human review, reports≥3 urgent, past violators strict|Output: decision, reason, action, training data'
  ),
  content:_dpb(
    ['制作→公開→配信→分析(CDN、画像最適化、SEO)','SEO→キーワード→ランク→流入(タイトル60字、メタ160字、構造化データ)','著作権→ライセンス→保護→収益化(CC BY-SA、DMCA対応)'],
    ['Create→Publish→Distribute→Analyze (CDN, image optimization, SEO)','SEO→Keywords→Rank→Traffic (title 60 chars, meta 160, structured data)','Copyright→License→Protect→Monetize (CC BY-SA, DMCA response)'],
    ['著作権:DMCA対応、コンテンツID、ライセンス(CC BY-SA)','肖像権:モデルリリース、ぼかし処理',_CG+':Cookie同意、アクセス解析匿名化'],
    [_CG+', Copyright: DMCA, content ID, license (CC BY-SA)','Portrait rights: model release, blur processing',_CG+': cookie consent, analytics anonymization'],
    ['再生エラー|非対応コーデック|HLS、複数解像度','画像遅延|最適化不足|WebP、srcset、CDN','SEO順位低|構造化データ不足|JSON-LD、sitemap、robots.txt'],
    ['Playback error|Unsupported codec|HLS, multiple resolutions','Image lag|Insufficient optimization|WebP, srcset, CDN','Low SEO rank|Missing structured data|JSON-LD, sitemap, robots.txt'],
    ['配信→architecture.md(CDN), api_spec.md, design_system.md','SEO→requirements.md, api_spec.md(sitemap), test_cases/','著作権→architecture.md(DMCA), stakeholders.md, error_logs.md'],
    ['Distribution→architecture.md(CDN), api_spec.md, design_system.md','SEO→requirements.md, api_spec.md(sitemap), test_cases/','Copyright→architecture.md(DMCA), stakeholders.md, error_logs.md'],
    'SEO最適化|検索順位向上|入力:ページ、キーワード、競合|判断:タイトル≤60字、h1-h6階層、内部リンク≥3、表示速度≤2.5s|出力:最適化案、期待順位、修正箇所',
    'SEO Optimization|Improve search rank|Input: pages, keywords, competitors|Judgment: title≤60 chars, h1-h6 hierarchy, internal links≥3, load time≤2.5s|Output: optimization plan, expected rank, fixes'
  ),
  analytics:_dpb(
    ['データ収集→集計→可視化→洞察(イベント追跡、セッション分析)','異常検知→アラート→調査→対応(閾値監視、パターン学習)','レポート→ダッシュボード→共有→意思決定(KPI、トレンド、予測)'],
    ['Collect→Aggregate→Visualize→Insight (event tracking, session analysis)','Anomaly detect→Alert→Investigate→Respond (threshold monitor, pattern learning)','Report→Dashboard→Share→Decide (KPI, trends, forecasts)'],
    [_CG+':匿名化、集計のみ、個人特定不可','アクセス解析:Cookie同意、オプトアウト','データ保持:分析用1年、ログ3ヶ月'],
    [_CG+': anonymize, aggregated only, no personal ID','Analytics: cookie consent, opt-out','Data retention: analytics 1yr, logs 3mo'],
    ['表示遅延|リアルタイム集計重い|事前集計、Redis、materialized view','精度低|サンプリング不足|最低1000件、季節調整','ダッシュボード遅延|N+1クエリ|集計テーブル、キャッシュ5分'],
    ['Display delay|Heavy real-time aggregation|Pre-aggregate, Redis, materialized view','Low accuracy|Insufficient sampling|Minimum 1000 records, seasonal adjustment','Dashboard lag|N+1 queries|Aggregation tables, cache 5min'],
    ['収集→architecture.md(pipeline), api_spec.md, sequence_diagrams/','集計→architecture.md(aggregation), test_cases/, error_logs.md','可視化→design_system.md, api_spec.md(dashboard), requirements.md'],
    ['Collection→architecture.md(pipeline), api_spec.md, sequence_diagrams/','Aggregation→architecture.md(aggregation), test_cases/, error_logs.md','Visualization→design_system.md, api_spec.md(dashboard), requirements.md'],
    '異常検知|パターン異常検出|入力:時系列データ、閾値、履歴|判断:3σ超→アラート、前日比>50%注意、週次トレンド乖離|出力:異常スコア、原因候補、推奨対応',
    'Anomaly Detection|Pattern anomaly detection|Input: time-series, thresholds, history|Judgment: >3σ→alert, day-over-day>50% caution, weekly trend deviation|Output: anomaly score, cause candidates, recommended actions'
  ),
  iot:_dpb(
    ['デバイス登録→認証→データ収集→制御(MQTT、CoAP、証明書認証)','センサーデータ→処理→アラート→対応(閾値監視、異常検知)','ファームウェア更新→配信→適用→確認(OTA、ロールバック)'],
    ['Device registration→Auth→Data collection→Control (MQTT, CoAP, cert auth)','Sensor data→Process→Alert→Respond (threshold monitor, anomaly detection)','Firmware update→Distribute→Apply→Verify (OTA, rollback)'],
    ['電波法:技適、周波数遵守','製造物責任法:欠陥損害賠償',_CG+':デバイスデータ収集同意、匿名化'],
    [_CG+', Radio Act: tech conformity, frequency','Product Liability: defect liability',_CG+': device data collection consent, anonymization'],
    ['切断|不安定ネットワーク|オフライン動作、ローカルキュー、指数バックオフ','ファームウェア失敗|文鎮化|A/Bパーティション、ロールバック、チェックサム','バッテリー消耗|ポーリング頻度高|間引き、差分送信、スリープモード'],
    ['Disconnect|Unstable network|Offline operation, local queue, exponential backoff','Firmware failure|Bricked device|A/B partition, rollback, checksum','Battery drain|High polling frequency|Throttling, delta transmission, sleep mode'],
    ['デバイス→architecture.md(MQTT), security.md(auth), api_spec.md','データ→architecture.md(pipeline), sequence_diagrams/, test_cases/','更新→architecture.md(OTA), error_logs.md, stakeholders.md'],
    ['Device→architecture.md(MQTT), security.md(auth), api_spec.md','Data→architecture.md(pipeline), sequence_diagrams/, test_cases/','Update→architecture.md(OTA), error_logs.md, stakeholders.md'],
    'デバイス管理|接続状態監視制御|入力:デバイスID、センサー値、接続履歴|判断:切断>5分アラート、異常値→再送要求、バッテリー<10%省電力|出力:ステータス、コマンド、予測寿命',
    'Device Management|Monitor connection & control|Input: device ID, sensor values, connection history|Judgment: disconnect>5min alert, anomalous values→resend request, battery<10% power save|Output: status, commands, predicted lifespan'
  ),
  realestate:_dpb(
    ['物件登録→審査→公開→検索(画像、間取り、地図連携)','内見予約→確認→実施→フィードバック(カレンダー、リマインダー)','契約→重要事項説明→署名→完了(電子契約、クーリングオフ8日)'],
    ['Property registration→Review→Publish→Search (images, floor plan, map integration)','Viewing→Confirm→Conduct→Feedback (calendar, reminders)','Contract→Important matters→Sign→Complete (e-contract, 8d cooling-off)'],
    ['宅建業法:重要事項説明、契約書交付、クーリングオフ','表示規約:徒歩80m/分、築年数、面積正確',_CG+':個人情報保護、物件情報管理'],
    [_CG+', Real Estate Act: important matters, contract, cooling-off','Display Standards: walking 80m/min, age, area accurate',_CG+': personal info protection, property info mgmt'],
    ['情報不整合|外部連携遅延|1時間同期、差分検知、成約済み非表示','地図ずれ|ジオコーディング精度|Google Maps API、緯度経度検証','内見重複|空き枠管理不足|Lock、3段階確認、バッファ30分'],
    ['Info inconsistency|External sync delay|Hourly sync, detect diff, hide sold','Map misalignment|Geocoding accuracy|Google Maps API, lat/long validation','Viewing conflict|Insufficient slot mgmt|Lock, 3-phase confirm, 30min buffer'],
    ['物件→architecture.md(search), api_spec.md(property), design_system.md','内見→architecture.md(booking), sequence_diagrams/, test_cases/','契約→architecture.md(e-contract), security.md, stakeholders.md'],
    ['Property→architecture.md(search), api_spec.md(property), design_system.md','Viewing→architecture.md(booking), sequence_diagrams/, test_cases/','Contract→architecture.md(e-contract), security.md, stakeholders.md'],
    '物件管理|検索最適化推奨|入力:物件DB、検索履歴、成約データ|判断:検索上位≤10件、成約率<3%価格見直し、問合せ≥5未成約要改善|出力:ランキング、価格提案、改善点',
    'Property Management|Search optimization & recommendations|Input: property DB, search history, contract data|Judgment: top search results≤10, contract rate<3% revise price, inquiries≥5 without contract→improve|Output: ranking, price suggestions, improvements'
  ),
  legal:_dpb(
    ['契約作成→レビュー→承認→署名(テンプレート、バージョン管理)','案件管理→期日→アラート→対応(タスク、カレンダー、通知)','ドキュメント管理→検索→共有→監査証跡(暗号化、アクセス制御)'],
    ['Contract creation→Review→Approve→Sign (templates, versioning)','Case management→Deadline→Alert→Respond (tasks, calendar, notifications)','Document mgmt→Search→Share→Audit trail (encryption, access control)'],
    ['弁護士法:非弁禁止、法律相談は有資格者','個情保護:守秘義務、報告義務','電子署名法:電子署名の有効性、タイムスタンプ'],
    [_CG+', Attorney Act: prohibit unauthorized, licensed only','Privacy: confidentiality, reporting obligation','E-Signature Act: e-signature validity, timestamp'],
    ['契約生成ミス|変数置換漏れ|必須チェックリスト、プレビュー必須、レビューフロー','バージョン混在|履歴管理不足|Git-like管理、diff表示、ロック','期日漏れ|通知設定不足|3段階リマインダー(7日前、3日前、当日)'],
    ['Contract error|Missing variable substitution|Mandatory checklist, preview required, review flow','Version confusion|Insufficient history|Git-like management, diff display, locking','Deadline miss|Insufficient notifications|3-tier reminders (7d, 3d, same-day)'],
    ['契約→architecture.md(template), api_spec.md, sequence_diagrams/','レビュー→architecture.md(approval), stakeholders.md, test_cases/','監査→architecture.md(audit), security.md, error_logs.md'],
    ['Contract→architecture.md(template), api_spec.md, sequence_diagrams/','Review→architecture.md(approval), stakeholders.md, test_cases/','Audit→architecture.md(audit), security.md, error_logs.md'],
    '契約レビュー|リスク条項検出|入力:契約書テキスト、テンプレート、チェックリスト|判断:必須条項欠落→警告、リスク用語検出(無制限責任、排他的)、期限≤7日注意|出力:検出リスト、重要度、修正案',
    'Contract Review|Detect risk clauses|Input: contract text, templates, checklist|Judgment: missing mandatory clauses→warn, detect risk terms (unlimited liability, exclusive), deadline≤7d caution|Output: detected list, severity, revision suggestions'
  ),
  hr:_dpb(
    ['求人作成→公開→応募→選考(ATS、スクリーニング、面接)','評価→フィードバック→育成→昇進(1on1、目標管理、360度評価)','勤怠→集計→給与→支払(打刻、残業、有休管理)'],
    ['Job posting→Publish→Apply→Screen (ATS, screening, interviews)','Evaluation→Feedback→Develop→Promote (1-on-1, goal mgmt, 360 review)','Attendance→Aggregate→Payroll→Pay (clock-in, overtime, leave mgmt)'],
    ['労働基準法:勤怠記録3年、残業45h上限','個情保護:不適切質問禁止、候補者情報管理','雇用機会均等法:差別禁止、公平な選考'],
    [_CG+', Labor Standards: attendance 3yr, overtime 45h max','Privacy: prohibit inappropriate questions, candidate info mgmt','Equal Opportunity: prohibit discrimination, fair screening'],
    ['勤怠ミス|TZ未考慮、深夜日跨ぎ|UTC統一、深夜割増22-5時、月次突合','評価バイアス|主観のみ|360度評価、定量指標、校正会議','応募者漏れ|手動管理|ATS、自動ステータス更新、リマインダー'],
    ['Attendance error|TZ not considered, midnight crossing|Unify UTC, late-night premium 10PM-5AM, monthly reconcile','Evaluation bias|Subjective only|360 review, quantitative metrics, calibration meeting','Applicant miss|Manual mgmt|ATS, auto-status update, reminders'],
    ['勤怠→architecture.md(attendance), api_spec.md, test_cases/','評価→architecture.md(evaluation), stakeholders.md, requirements.md','採用→architecture.md(ATS), sequence_diagrams/, error_logs.md'],
    ['Attendance→architecture.md(attendance), api_spec.md, test_cases/','Evaluation→architecture.md(evaluation), stakeholders.md, requirements.md','Hiring→architecture.md(ATS), sequence_diagrams/, error_logs.md'],
    '採用フロー|選考最適化|入力:応募者データ、履歴書、面接記録|判断:必須スキル不足→不合格、経験≥3年優遇、カルチャーフィット評価|出力:合否判定、スコア、次ステップ',
    'Hiring Flow|Optimize screening|Input: applicant data, resumes, interview records|Judgment: missing required skills→reject, experience≥3yrs favor, culture fit assessment|Output: pass/fail, score, next steps'
  ),
  portfolio:_dpb(
    ['制作→公開→SEO→集客(レスポンシブ、画像最適化、Core Web Vitals)','プロジェクト→カテゴリ→フィルタ→表示(ポートフォリオサイト)','問合せ→フォーム→通知→対応(スパム対策、自動返信)'],
    ['Create→Publish→SEO→Attract (responsive, image optimization, Core Web Vitals)','Project→Category→Filter→Display (portfolio site)','Contact→Form→Notify→Respond (spam protection, auto-reply)'],
    [_CG+':Cookie同意、アクセス解析','著作権:作品ライセンス明示、転載禁止','肖像権:モデルリリース、ぼかし'],
    [_CG+': cookie consent, analytics','Copyright: specify work license, prohibit repost','Portrait rights: model release, blur'],
    ['画像未最適化|元サイズ配信|WebP、srcset、lazy loading','モバイル崩れ|レスポンシブ不足|Tailwind、ブレークポイント検証','SEO低順位|メタ不足|OGP、構造化データ、sitemap'],
    ['Image unoptimized|Serve original size|WebP, srcset, lazy loading','Mobile layout breaks|Insufficient responsive|Tailwind, breakpoint validation','Low SEO rank|Missing meta|OGP, structured data, sitemap'],
    ['制作→design_system.md, requirements.md, api_spec.md','SEO→architecture.md(SEO), test_cases/, stakeholders.md','問合せ→architecture.md(contact), security.md, error_logs.md'],
    ['Creation→design_system.md, requirements.md, api_spec.md','SEO→architecture.md(SEO), test_cases/, stakeholders.md','Contact→architecture.md(contact), security.md, error_logs.md'],
    'SEO最適化|表示速度改善|入力:ページHTML、画像、CSS|判断:LCP≤2.5s、FID≤100ms、CLS≤0.1、画像WebP化、CSS圧縮|出力:スコア、改善リスト、期待順位',
    'SEO Optimization|Improve page speed|Input: page HTML, images, CSS|Judgment: LCP≤2.5s, FID≤100ms, CLS≤0.1, image→WebP, CSS minify|Output: score, improvement list, expected rank'
  ),
  tool:_dpb(
    ['タスク→自動化→効率化→測定(ショートカット、マクロ、スクリプト)','データ→エクスポート→変換→活用(CSV、JSON、API連携)','設定→カスタマイズ→共有→同期(テーマ、プリセット、クラウド)'],
    ['Task→Automate→Streamline→Measure (shortcuts, macros, scripts)','Data→Export→Transform→Utilize (CSV, JSON, API integration)','Settings→Customize→Share→Sync (themes, presets, cloud)'],
    [_CG+':データ処理同意、エクスポート権','利用規約:使用制限、データ保持期間','セキュリティ:API認証、暗号化通信'],
    [_CG+': data processing consent, export rights','ToS: usage limits, data retention','Security: API auth, encrypted communication'],
    ['互換性|最新API(Safari未対応)|Polyfill、Can I Use、クロスブラウザテスト','エクスポート失敗|文字コード|UTF-8 BOM、CSV区切り文字検証','ショートカット競合|他ツール衝突|設定可能化、デフォルト変更、ガイド'],
    ['Compatibility|Latest API (Safari unsupported)|Polyfill, Can I Use, cross-browser test','Export failure|Character encoding|UTF-8 BOM, CSV delimiter validation','Shortcut conflict|Collision with other tools|Make configurable, change defaults, guide'],
    ['自動化→architecture.md(automation), api_spec.md, test_cases/','エクスポート→architecture.md(export), error_logs.md, stakeholders.md','設定→design_system.md, requirements.md, api_spec.md'],
    ['Automation→architecture.md(automation), api_spec.md, test_cases/','Export→architecture.md(export), error_logs.md, stakeholders.md','Settings→design_system.md, requirements.md, api_spec.md'],
    'ワークフロー自動化|反復作業削減|入力:タスクログ、操作履歴、頻度|判断:週≥3回→自動化候補、手順≥5ステップ優先、エラー率>10%要改善|出力:自動化案、期待削減時間、実装難易度',
    'Workflow Automation|Reduce repetitive tasks|Input: task logs, operation history, frequency|Judgment: weekly≥3 times→automation candidate, steps≥5 prioritize, error rate>10% improve|Output: automation plan, expected time savings, implementation difficulty'
  )
};
function getDomainQA(domain,G){
  const qa=DOMAIN_QA_MAP[domain];
  if(!qa)return null;
  const cross=Object.values(QA_CROSS_CUTTING).filter(c=>c.domains.includes(domain));
  return {focus:G?qa.focus_ja:qa.focus_en,bugs:G?qa.bugs_ja:qa.bugs_en,priority:qa.priority,crossCutting:cross.map(c=>G?c.ja:c.en)};
}
function genRoutes(a){
  const G=S.genLang==='ja';
  const routes=[
    {path:'/',name:G?'ランディング':'Landing',auth:false},
    {path:'/login',name:G?'ログイン':'Login',auth:false},
    {path:'/register',name:G?'新規登録':'Register',auth:false},
  ];
  const MAP=[
    [/ランディング|landing|LP|トップ|top|ホーム|home/i,'/',false],
    [/ログイン|login|サインイン|signin/i,'/login',false],
    [/新規登録|register|signup|サインアップ/i,'/register',false],
    [/ダッシュボード|dashboard/i,'/dashboard',true],
    [/設定|setting/i,'/settings',true],
    [/プロフィール|profile|マイページ/i,'/profile',true],
    [/管理|admin/i,'/admin',true],
    [/検索|search/i,'/search',false],
    [/通知|notification/i,'/notifications',true],
    [/メッセージ|message|チャット|chat/i,'/messages',true],
    [/一覧|list|リスト/i,'/list',true],
    [/詳細|detail/i,'/[id]',true],
    [/作成|create|新規作成/i,'/create',true],
    [/編集|edit/i,'/[id]/edit',true],
    [/課金|billing|サブスク|subscription|料金|pricing/i,'/pricing',false],
    [/お問い合わせ|contact/i,'/contact',false],
    [/利用規約|terms/i,'/terms',false],
    [/about|概要/i,'/about',false],
  ];
  const screens=(a.screens||'').split(', ').filter(Boolean);
  screens.forEach(s=>{
    const raw=s.replace(/\(P[0-2]\)/gi,'').trim();
    const matched=MAP.find(([rx])=>rx.test(raw));
    if(matched){routes.push({path:matched[1],name:raw,auth:matched[2]});}
    else{
      const slug=raw.replace(/[ぁ-んァ-ヶ一-龥々〇〻\u3400-\u9FFF\uF900-\uFAFF]/g,'')
        .toLowerCase().replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
      routes.push({path:'/'+(slug||'page'),name:raw,auth:true});
    }
  });
  const seen=new Set();
  return routes.filter(r=>{if(seen.has(r.path))return false;seen.add(r.path);return true;});
}
function postGenerationAudit(files,a){
  const findings=[];
  const G=S.genLang==='ja';
  const constitution=files['.spec/constitution.md']||'';
  const spec=files['.spec/specification.md']||'';
  const techPlan=files['.spec/technical-plan.md']||'';
  const tasks=files['.spec/tasks.md']||'';
  const verify=files['.spec/verification.md']||'';
  const auth=resolveAuth(a);
  const authInConst=constitution.includes(auth.sot);
  const authInSpec=spec.includes(auth.sot);
  const authInTP=techPlan.includes(auth.sot);
  if(!authInConst||!authInSpec||!authInTP){
    findings.push({level:'error',msg:G?'認証SoTが全文書で一致していません':'Auth SoT inconsistent across documents'});
  }
  const arch=resolveArch(a);
  if(arch.pattern==='baas'&&techPlan.includes('API Gateway')){
    findings.push({level:'error',msg:G?'BaaS構成なのにAPI Gatewayが記載されています':'API Gateway present in BaaS architecture'});
  }
  if(arch.pattern==='bff'&&techPlan.includes('api/')){
    if(techPlan.includes('├── api/')){
      findings.push({level:'warn',msg:G?'BFF構成では api/ ディレクトリは不要です（app/api/ を使用）':'BFF pattern should not have separate api/ directory (use app/api/)'});
    }
  }
  const scopeOut=(a.scope_out||'').toLowerCase();
  if(scopeOut.includes('ネイティブ')&&spec.includes('Expo')&&!constitution.includes('Expo Web UI')){
    findings.push({level:'error',msg:G?'スコープ外「ネイティブ」と仕様のExpo記述が矛盾':'Scope excludes native but spec includes Expo'});
  }
  const er=inferER(a);
  er.warnings.forEach(w=>findings.push({level:'warn',msg:w}));
  if(tasks&&!tasks.includes(new Date().toISOString().split('T')[0].slice(0,7))){
    findings.push({level:'info',msg:G?'タスクの開始日が今月と異なります':'Task start date differs from current month'});
  }
  const compose=files['.devcontainer/docker-compose.yml']||'';
  const be=a.backend||'';
  if(be.includes('Supabase')&&compose.includes('postgres:16')){
    findings.push({level:'error',msg:G?'Supabase構成なのにDevContainerが素PostgreSQLです':'Supabase stack but DevContainer uses raw PostgreSQL'});
  }
  if(be.includes('Firebase')&&compose.includes('postgres:16')){
    findings.push({level:'error',msg:G?'Firebase構成なのにDevContainerにPostgreSQLがあります':'Firebase stack but DevContainer includes PostgreSQL'});
  }
  const pkg=files['package.json']?JSON.parse(files['package.json']):{};
  const deps=pkg.dependencies||{};
  if(be.includes('Supabase')&&!deps['@supabase/supabase-js']){
    findings.push({level:'warn',msg:G?'Supabase使用なのにpackage.jsonに@supabase/supabase-jsがありません':'Supabase stack but @supabase/supabase-js missing from package.json'});
  }
  if(be.includes('Express')&&!deps['express']){
    findings.push({level:'warn',msg:G?'Express使用なのにpackage.jsonにexpressがありません':'Express stack but express missing from package.json'});
  }
  const envFile=files['.env.example']||'';
  const feRaw=a.frontend||'';
  if(feRaw.includes('Vite')&&envFile.includes('NEXT_PUBLIC_')){
    findings.push({level:'error',msg:G?'Vite SPAなのに.envにNEXT_PUBLIC_があります':'Vite SPA but .env uses NEXT_PUBLIC_ prefix'});
  }
  if(feRaw.includes('Next')&&envFile.includes('VITE_')){
    findings.push({level:'error',msg:G?'Next.jsなのに.envにVITE_があります':'Next.js but .env uses VITE_ prefix'});
  }
  const monDoc=files['docs/17_monitoring.md']||'';
  const deploy=a.deploy||'';
  if(!deploy.includes('Vercel')&&monDoc.includes('Vercel Analytics')){
    findings.push({level:'warn',msg:G?'デプロイ先がVercelではないのにVercel Analyticsが記載されています':'Non-Vercel deploy but Vercel Analytics in monitoring doc'});
  }
  if(arch.isBaaS&&((pkg.devDependencies||{})['prisma']||deps['@prisma/client'])){
    findings.push({level:'warn',msg:G?'BaaS構成なのにPrisma依存があります':'BaaS stack but Prisma dependencies present'});
  }
  return findings;
}
function genCommonFiles(a,pn){
  const G=S.genLang==='ja';
  S.files['README.md']=`# ${pn}
> Generated by [DevForge v9](https://github.com/) — ${G?'AI駆動開発統合プラットフォーム':'AI-driven Development Platform'}
## ${G?'概要':'Overview'}
${a.purpose||'N/A'}
## ${G?'技術スタック':'Tech Stack'}
- Frontend: ${a.frontend||'React + Next.js'}
- Backend: ${a.backend||'Node.js'}
- Database: ${a.database||'PostgreSQL'}
- Deploy: ${a.deploy||'Vercel'}
${!isNone(a.mobile)?`- Mobile: ${a.mobile}\n`:''}
## ${G?'セットアップ':'Setup'}
\`\`\`bash
git clone https://github.com/YOUR_USERNAME/${pn.toLowerCase().replace(/[^a-z0-9]/g,'-')}.git
cd ${pn.toLowerCase().replace(/[^a-z0-9]/g,'-')}
npm install
cp .env.example .env.local
npm run dev
\`\`\`
## ${G?'プロジェクト構造':'Project Structure'}
- \`.spec/\` — ${G?'SDD仕様書（柱①）':'SDD specs (Pillar 1)'}
- \`.devcontainer/\` — ${G?'開発環境（柱②）':'Dev environment (Pillar 2)'}
- \`.mcp/\` — ${G?'MCP設定（柱③）':'MCP config (Pillar 3)'}
- \`CLAUDE.md\` etc. — ${G?'AIルール（柱④）':'AI rules (Pillar 4)'}
- \`roadmap/\` — ${G?'学習ロードマップ（柱⑦）':'Learning roadmap (Pillar 7)'}
- \`docs/\` — ${G?'開発ドキュメント（21ファイル）':'Dev documents (21 files)'}
## ${G?'駆動開発手法':'Dev Methods'}
${(a.dev_methods||'TDD').split(', ').join(' / ')}
## ${G?'ライセンス':'License'}
MIT
---
${G?'© 2026 エンジニアリングのタネ制作委員会 ｜ 作成者：にしあん':'© 2026 Engineering no Tane Committee | by にしあん'}
`;
  const isNextFE=(a.frontend||'').includes('Next');
  const gitIgnoreLines=['node_modules/',isNextFE?'.next/':'dist/','build/','.env','.env.local','*.log','.DS_Store','coverage/','.turbo/'];
  if((a.backend||'').includes('Supabase')) gitIgnoreLines.push('.supabase/');
  S.files['.gitignore']=gitIgnoreLines.join('\n')+'\n';
  const pkgDeps=buildDeps(a);
  S.files['package.json']=JSON.stringify({
    name:pn.toLowerCase().replace(/[^a-z0-9]/g,'-'),
    version:'0.1.0',
    private:true,
    scripts:pkgDeps.scripts,
    dependencies:pkgDeps.deps,devDependencies:pkgDeps.devDeps
  },null,2);
  S.files['LICENSE']=`MIT License\n\nCopyright (c) ${new Date().getFullYear()} ${pn}\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the "Software"), to deal\nin the Software without restriction, including without limitation the rights\n
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n
\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.`;
}
function openEditor(path){
  const content=S.files[path];
  if(!content)return;
  const _ja=S.lang==='ja';
  const isEdited=S.editedFiles&&S.editedFiles[path];
  const prevBody=$('prevBody');
  prevBody.innerHTML=`
    <div class="editor-toolbar">
      <div class="title">📝 ${esc(path)}</div>
      <div class="actions">
        <button class="btn btn-s" onclick="saveEdited('${esc(path)}')">💾 ${_ja?'保存':'Save'}</button>
        <button class="btn btn-s" onclick="revertFile('${esc(path)}')"${isEdited?'':'disabled'}>↩️ ${_ja?'元に戻す':'Revert'}</button>
        <button class="btn btn-s" onclick="previewFile('${esc(path)}')">👁 ${_ja?'プレビュー':'Preview'}</button>
      </div>
    </div>
    <textarea id="editorArea" spellcheck="false" class="editor-area">${esc(content)}</textarea>`;
  const ta=$('editorArea');
  if(ta){
    ta.addEventListener('keydown',e=>{
      if(e.key==='Tab'){e.preventDefault();const s=ta.selectionStart,end=ta.selectionEnd;ta.value=ta.value.substring(0,s)+'  '+ta.value.substring(end);ta.selectionStart=ta.selectionEnd=s+2;}
      if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveEdited(path);}
    });
  }
}
function saveEdited(path){
  const _ja=S.lang==='ja';
  const ta=$('editorArea');
  if(!ta)return;
  const newContent=ta.value;
  if(newContent===S.files[path])return toast(_ja?'変更なし':'No changes');
  if(!S.editedFiles[path])S.editedFiles[path]=S.files[path];
  S.files[path]=newContent;
  save();
  toast(_ja?'✅ 保存しました':'✅ Saved');
  showFileTree();
}
function revertFile(path){
  const _ja=S.lang==='ja';
  if(!S.editedFiles||!S.editedFiles[path])return;
  S.files[path]=S.editedFiles[path];
  delete S.editedFiles[path];
  save();
  toast(_ja?'↩️ 元に戻しました':'↩️ Reverted');
  openEditor(path);
}
function lineDiff(oldText,newText){
  const oldL=oldText.split('\n'),newL=newText.split('\n');
  const result=[];
  const m=oldL.length,n=newL.length;
  const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=1;i<=m;i++)for(let j=1;j<=n;j++){
    dp[i][j]=oldL[i-1]===newL[j-1]?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1]);
  }
  let i=m,j=n;
  const ops=[];
  while(i>0||j>0){
    if(i>0&&j>0&&oldL[i-1]===newL[j-1]){ops.unshift({type:'same',line:oldL[i-1]});i--;j--;}
    else if(j>0&&(i===0||dp[i][j-1]>=dp[i-1][j])){ops.unshift({type:'add',line:newL[j-1]});j--;}
    else{ops.unshift({type:'del',line:oldL[i-1]});i--;}
  }
  return ops;
}
function showDiff(path){
  const _ja=S.lang==='ja';
  const oldContent=S.prevFiles[path]||S.editedFiles[path];
  const newContent=S.files[path];
  if(!oldContent||!newContent||oldContent===newContent){
    toast(_ja?'差分なし':'No differences');return;
  }
  const diff=lineDiff(oldContent,newContent);
  const adds=diff.filter(d=>d.type==='add').length;
  const dels=diff.filter(d=>d.type==='del').length;
  const same=diff.filter(d=>d.type==='same').length;
  let h=`<div class="diff-header">
    <div class="diff-title">🔀 ${esc(path)}</div>
    <div class="diff-stats">
      <span class="add">+${adds}</span>
      <span class="del">-${dels}</span>
      <span>~${same}</span>
      <button class="btn btn-s" onclick="previewFile('${esc(path)}')">✕ ${_ja?'閉じる':'Close'}</button>
    </div>
  </div>`;
  h+='<div class="diff-body">';
  let lineNum=0;
  diff.forEach(d=>{
    if(d.type==='same'){lineNum++;h+=`<div class="diff-same"><span class="diff-ln">${lineNum}</span>${esc(d.line)}</div>`;}
    else if(d.type==='add'){lineNum++;h+=`<div class="diff-add"><span class="diff-ln">+${lineNum}</span>${esc(d.line)}</div>`;}
    else{h+=`<div class="diff-del"><span class="diff-ln">-</span>${esc(d.line)}</div>`;}
  });
  h+='</div>';
  $('prevBody').innerHTML=h;
}
function snapshotFiles(){
  S.prevFiles=JSON.parse(JSON.stringify(S.files));
}
async function exportZIP(){
  const _ja=S.lang==='ja';
  if(window._noZip||typeof JSZip==='undefined'){toast(_ja?'⚠️ オフライン環境ではZIPエクスポートを利用できません':'⚠️ ZIP export unavailable offline');return;}
  const zip=new JSZip();
  const root=fileSlug(S.projectName);
  Object.entries(S.files).forEach(([path,content])=>{
    zip.file(root+'/'+path,content);
  });
  const blob=await zip.generateAsync({type:'blob'});
  const url=URL.createObjectURL(blob);
  const link=document.createElement('a');link.href=url;link.download=root+'.zip';link.click();
  URL.revokeObjectURL(url);
  addMsg('bot',_ja?`📦 ${root}.zip (${Object.keys(S.files).length}ファイル) をダウンロードしました！`:`📦 Downloaded ${root}.zip (${Object.keys(S.files).length} files)!`);
  _lsSet('devforge-last-export',new Date().toISOString());
}
function exportPDF(){
  const _ja=S.lang==='ja';
  const G=S.genLang==='ja'||(!S.genLang&&_ja);
  let content='';
  Object.entries(S.files).forEach(([path,text])=>{
    if(path.endsWith('.md')){
      content+=`<h1 style="page-break-before:always;border-bottom:2px solid #3b82f6;padding-bottom:8px;margin-top:40px;">${path}</h1>`;
      content+=safeMD(text);
    }
  });
  const pdfCss='body{font-family:-apple-system,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#1e222d;}'
    +'pre{background:#f5f5f5;padding:16px;border-radius:8px;overflow-x:auto;}'
    +'h1{margin-top:40px;}h1:first-child{page-break-before:avoid;}'
    +'table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#f0f0f0;}'
    +'@media print{body{padding:20px;}h1{page-break-before:always;}h1:first-child{page-break-before:avoid;}}';
  const html=`<!DOCTYPE html><html><head><title>${S.projectName} - DevForge v9</title><style>${pdfCss}
</style></head><body><div style="text-align:center;margin-bottom:40px;"><h1 style="page-break-before:avoid;border:none;font-size:24px;">${S.projectName}</h1><p style="color:#666;">Generated by DevForge v9 — ${new Date().toLocaleDateString(G?'ja-JP':'en-US')}</p><p style="color:#999;font-size:12px;">${G?'© 2026 エンジニアリングのタネ制作委員会 ｜ 作成者：にしあん':'© 2026 Engineering no Tane Committee | by にしあん'}</p></div>${content}</body></html>`;
  const win=window.open('','_blank');
  if(win){
    win.document.write(html);
    win.document.close();
    addMsg('bot',_ja?'📄 PDFプレビューを新しいタブで開きました。Ctrl+P で印刷/PDF保存できます。':'📄 PDF preview opened in new tab. Use Ctrl+P to print/save as PDF.');
  } else {
    const blob=new Blob([html],{type:'text/html'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=fileSlug(S.projectName)+'-docs.html';a.click();URL.revokeObjectURL(a.href);
    addMsg('bot',_ja?'📄 ポップアップがブロックされたため、HTMLファイルとしてダウンロードしました。ブラウザで開いてCtrl+Pで印刷できます。':'📄 Popup blocked. Downloaded as HTML. Open in browser and use Ctrl+P to print.');
  }
}
function copyAllFiles(){
  const _ja=S.lang==='ja';
  const sep='\n\n'+'='.repeat(60)+'\n';
  const all=Object.entries(S.files).map(([path,content])=>`${sep}📄 ${path}${sep}${content}`).join('\n');
  const header=`# ${S.projectName} — ${_ja?'全ファイル結合':'All Files Combined'}\n# Generated by DevForge v9\n# Files: ${Object.keys(S.files).length}\n# Date: ${new Date().toISOString().split('T')[0]}`;
  const fullText=header+'\n'+all;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(fullText).then(()=>{
      toast(_ja?`📋 全${Object.keys(S.files).length}ファイルをコピーしました`:`📋 Copied all ${Object.keys(S.files).length} files`);
      addMsg('bot',_ja?`📋 全${Object.keys(S.files).length}ファイルをクリップボードにコピーしました。AIへの一括投入にご利用ください。`:`📋 Copied all ${Object.keys(S.files).length} files to clipboard.`);
    }).catch(()=>{_fallbackCopy(fullText);toast(_ja?'📋 コピーしました':'📋 Copied');});
  } else {_fallbackCopy(fullText);toast(_ja?'📋 コピーしました':'📋 Copied');}
}
function copyForAI(){
  const _ja=S.lang==='ja';
  const files=Object.entries(S.files);
  const tokens=Math.round(files.reduce((s,[,c])=>s+c.length,0)/4);
  let md=`# ${S.projectName}\n\n`;
  md+=`> ${_ja?'DevForge v9 で生成':'Generated by DevForge v9'} | ${files.length} ${_ja?'ファイル':'files'} | ~${tokens.toLocaleString()} tokens\n\n`;
  md+='## Table of Contents\n\n';
  files.forEach(([p],i)=>{md+=`${i+1}. \`${p}\`\n`;});
  md+='\n---\n\n';
  files.forEach(([path,content])=>{
    md+=`## ${path}\n\n\`\`\`${path.split('.').pop()}\n${content}\n\`\`\`\n\n`;
  });
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(md).then(()=>{
      toast(_ja?`🤖 AI向けMarkdown (${files.length}ファイル) をコピー`:`🤖 Copied AI Markdown (${files.length} files)`);
    }).catch(()=>{_fallbackCopy(md);toast(_ja?'📋 コピーしました':'📋 Copied');});
  } else {_fallbackCopy(md);toast(_ja?'📋 コピーしました':'📋 Copied');}
}
function showExplorer(){
  const body=$('prevBody');const _ja=S.lang==='ja';
  const stacks={
    'Next.js + Supabase':{fe:'React + Next.js',be:'Supabase',db:'PostgreSQL',deploy:'Vercel',cost:'$0–$25',speed:5,scale:3,learn:4,eco:5,best:_ja?'MVP・SaaS':'MVP / SaaS',tags:['saas','mvp','stripe','auth']},
    'Next.js + Express + PG':{fe:'React + Next.js',be:'Express',db:'PostgreSQL',deploy:'Vercel+Railway',cost:'$0–$20',speed:4,scale:4,learn:3,eco:5,best:_ja?'フルスタック学習':'Full-stack learning',tags:['fullstack','api','stripe']},
    'Next.js + NestJS + PG':{fe:'React + Next.js',be:'NestJS',db:'PostgreSQL',deploy:'AWS',cost:'$10–$50',speed:3,scale:5,learn:2,eco:4,best:_ja?'エンタープライズ':'Enterprise',tags:['enterprise','rbac','team','ddd']},
    'Nuxt + Supabase':{fe:'Vue 3 + Nuxt',be:'Supabase',db:'PostgreSQL',deploy:'Vercel',cost:'$0–$25',speed:5,scale:3,learn:5,eco:3,best:_ja?'Vue好き':'Vue fans',tags:['vue','mvp','saas']},
    'SvelteKit + Supabase':{fe:'SvelteKit',be:'Supabase',db:'PostgreSQL',deploy:'Vercel',cost:'$0–$25',speed:5,scale:3,learn:4,eco:2,best:_ja?'軽量・高速':'Lightweight & fast',tags:['perf','mvp','lightweight']},
    'Next.js + FastAPI + Mongo':{fe:'React + Next.js',be:'FastAPI',db:'MongoDB',deploy:'Vercel+Railway',cost:'$0–$30',speed:4,scale:4,learn:3,eco:4,best:_ja?'AI/ML統合':'AI/ML integration',tags:['ai','ml','python','data']},
    'Expo + Supabase':{fe:'Expo (RN)',be:'Supabase',db:'PostgreSQL',deploy:'EAS Build',cost:'$0–$30',speed:4,scale:3,learn:3,eco:3,best:_ja?'モバイルアプリ':'Mobile app',tags:['mobile','expo','native']},
  };
  const names=Object.keys(stacks);const a=S.answers;
  const bar=v=>'⚡'.repeat(v)+'<span class="exp-dim">'+'⚡'.repeat(5-v)+'</span>';
  const metrics=_ja
    ?[['開発速度','speed'],['スケーラビリティ','scale'],['学習容易性','learn'],['エコシステム','eco']]
    :[['Dev Speed','speed'],['Scalability','scale'],['Learnability','learn'],['Ecosystem','eco']];
  
  function scoreStack(name,stack){
    let score=0;const reasons=[];
    const skill=S.skill||'intermediate';
    const feAns=(a.frontend||'').toLowerCase();
    const beAns=(a.backend||'').toLowerCase();
    const mob=(a.mobile||'').toLowerCase();
    const pay=(a.payment||'').toLowerCase();
    const aiAuto=(a.ai_auto||'').toLowerCase();
    if(skill==='beginner'&&stack.learn>=4){score+=25;reasons.push(_ja?'初心者に学びやすい':'Beginner-friendly');}
    else if(skill==='beginner'&&stack.learn>=3){score+=15;}
    else if(skill==='intermediate'&&stack.learn>=3&&stack.eco>=4){score+=20;reasons.push(_ja?'中級者に最適なバランス':'Good balance for intermediates');}
    else if(skill==='pro'&&stack.scale>=4){score+=20;reasons.push(_ja?'プロ向けスケーラビリティ':'Pro-grade scalability');}
    if(feAns.includes('react')&&stack.fe.includes('React')){score+=20;reasons.push(_ja?'フロントエンド一致':'Frontend match');}
    else if(feAns.includes('vue')&&stack.fe.includes('Vue')){score+=20;reasons.push(_ja?'Vue選択に一致':'Vue selection match');}
    else if(feAns.includes('svelte')&&stack.fe.includes('Svelte')){score+=20;reasons.push(_ja?'Svelte選択に一致':'Svelte selection match');}
    if(beAns.includes('supabase')&&stack.be==='Supabase'){score+=15;reasons.push(_ja?'Supabase選択に一致':'Supabase match');}
    else if(beAns.includes('express')&&stack.be==='Express'){score+=15;reasons.push(_ja?'Express選択に一致':'Express match');}
    else if(beAns.includes('nest')&&stack.be==='NestJS'){score+=15;reasons.push(_ja?'NestJS選択に一致':'NestJS match');}
    else if(beAns.includes('fastapi')&&stack.be==='FastAPI'){score+=15;reasons.push(_ja?'FastAPI選択に一致':'FastAPI match');}
    if(mob&&mob!=='none'&&stack.tags.includes('mobile')){score+=15;reasons.push(_ja?'モバイル対応':'Mobile support');}
    if(pay&&pay!=='none'&&stack.tags.includes('stripe')){score+=10;reasons.push(_ja?'決済連携可能':'Payment integration');}
    if(aiAuto&&aiAuto!=='none'&&stack.tags.includes('ai')){score+=10;reasons.push(_ja?'AI/ML統合に最適':'AI/ML integration fit');}
    score+=stack.speed;
    return {name,score,reasons,stack};
  }
  
  const ranked=names.map(n=>scoreStack(n,stacks[n])).sort((a,b)=>b.score-a.score);
  const medals=['🥇','🥈','🥉'];
  const hasAnswers=Object.keys(a).length>2;
  
  let h=`<div class="exp-header"><h3>⚡ ${_ja?'並列実装探索 — スタック比較':'Parallel Explorer — Stack Comparison'}</h3>
  <p>${_ja?'現在の選択':'Current'}: <strong class="exp-current">${a.frontend||'React + Next.js'} + ${a.backend||'Express'}</strong> — ${_ja?'2つのスタックを比較':'Compare 2 stacks'}</p></div>`;
  
  if(hasAnswers){
    h+=`<div class="exp-ranking"><h4>📊 ${_ja?'あなたへのおすすめ（回答に基づくスコア）':'Recommended for You (Score based on your answers)'}</h4>`;
    ranked.forEach((r,i)=>{
      const medal=i<3?medals[i]:'';
      const isTop=i===0;
      const w=Math.max(8,Math.round(r.score/ranked[0].score*100));
      h+=`<div class="exp-rank-row${isTop?' exp-rank-top':''}" onclick="autoSelectStack('${r.name}')">
        <div class="exp-rank-left">
          <span class="exp-rank-medal">${medal||`#${i+1}`}</span>
          <span class="exp-rank-name">${r.name}</span>
        </div>
        <div class="exp-rank-right">
          <div class="exp-rank-bar"><div class="exp-rank-bar-fill" style="width:${w}%"></div></div>
          <span class="exp-rank-score">${r.score}${_ja?'点':'pt'}</span>
        </div>
      </div>`;
      if(r.reasons.length>0&&i<3){
        h+=`<div class="exp-rank-reasons">${r.reasons.map(r=>`<span class="exp-rank-tag">${r}</span>`).join('')}</div>`;
      }
    });
    h+=`</div>`;
  }
  
  h+=`<div class="exp-select"><h4>${_ja?'🔀 比較':'🔀 Compare'}</h4><select id="expA" onchange="renderExpCompare()">${names.map((n,i)=>`<option value="${i}" ${n===ranked[0].name?'selected':''}>${n}</option>`).join('')}</select>`;
  h+=`<select id="expB" onchange="renderExpCompare()">${names.map((n,i)=>`<option value="${i}" ${n===(ranked[1]||ranked[0]).name?'selected':''}>${n}</option>`).join('')}</select></div>`;
  h+='<div id="expCompare"></div>';
  body.innerHTML=h;
  const rowLabels=_ja
    ?{fe:'フロント',be:'バック',db:'DB',deploy:'デプロイ',cost:'月額目安'}
    :{fe:'Frontend',be:'Backend',db:'DB',deploy:'Deploy',cost:'Est. Cost'};
  const renderComp=()=>{
    const iA=parseInt($('expA').value);const iB=parseInt($('expB').value);
    const sA=stacks[names[iA]];const sB=stacks[names[iB]];
    let c='<div class="exp-compare">';
    [['A',names[iA],sA],['B',names[iB],sB]].forEach(([label,name,s])=>{
      c+=`<div class="exp-col"><h3>${label}: ${name}</h3>`;
      ['fe','be','db','deploy','cost'].forEach(k=>{
        c+=`<div class="exp-row"><span class="label">${rowLabels[k]}</span><span class="val">${s[k]}</span></div>`;
      });
      c+='<div class="exp-metrics-sep">';
      metrics.forEach(([label,key])=>{c+=`<div class="exp-row"><span class="label">${label}</span><span class="val">${bar(s[key])}</span></div>`;});
      c+=`</div><div class="exp-verdict"><h4>${_ja?'最適用途':'Best For'}</h4><p>${s.best}</p></div></div>`;
    });
    c+='</div>';
    const scoreA=metrics.reduce((s,m)=>s+sA[m[1]],0);const scoreB=metrics.reduce((s,m)=>s+sB[m[1]],0);
    c+=`<div class="road-summary">
      <strong>${_ja?'総合スコア':'Total Score'}:</strong> ${names[iA]} = ${scoreA}/20 vs ${names[iB]} = ${scoreB}/20
      ${scoreA>scoreB?`<br><span class="exp-win">→ ${names[iA]} ${_ja?'が総合的に優位':'wins overall'}</span>`:scoreB>scoreA?`<br><span class="exp-win">→ ${names[iB]} ${_ja?'が総合的に優位':'wins overall'}</span>`:`<br><span class="exp-tie">→ ${_ja?'ほぼ同等、用途で選択':'Nearly equal — choose by use case'}</span>`}
    </div>`;
    $('expCompare').innerHTML=c;
  };
  window.renderExpCompare=renderComp;
  renderComp();
}
function autoSelectStack(name){
  const sel=$('expA');if(!sel)return;
  for(let i=0;i<sel.options.length;i++){
    if(sel.options[i].text===name){sel.value=i;break;}
  }
  renderExpCompare();
  $('expCompare').scrollIntoView({behavior:'smooth',block:'nearest'});
}
function showAILauncher(){
  const body=$('prevBody');const _ja=S.lang==='ja';
  const files=S.files;const fKeys=Object.keys(files);
  const hasFiles=fKeys.length>0;
  
  const folders={};
  fKeys.forEach(k=>{
    const dir=k.includes('/')?k.split('/')[0]:'root';
    if(!folders[dir])folders[dir]={files:[],chars:0,tokens:0};
    folders[dir].files.push(k);
    const c=files[k].length;
    folders[dir].chars+=c;
    folders[dir].tokens+=Math.round(c/4);
  });
  const totalTokens=Object.values(folders).reduce((s,f)=>s+f.tokens,0);
  
  const PT=_ja?{
    review:{icon:'🔍',label:'仕様レビュー',desc:'矛盾・不足・改善点を指摘',
      sys:'あなたは経験豊富なテックリード兼SDDアーキテクトです。',
      prompt:'以下の仕様書群を4ステップでレビューしてください:\n1. constitution.mdの使命とKPIを確認\n2. specification.mdの要件網羅性をチェック\n3. technical-plan.mdのアーキテクチャ妥当性を評価\n4. 全体の整合性と不足事項を指摘\n\n各指摘には優先度(P0=致命的/P1=重要/P2=推奨)を付与してください。',
      fmt:'Markdown表:\n| # | ファイル | 指摘 | 優先度 | 推奨アクション |\n|---|---------|------|--------|----------------|\n| 1 | .spec/xxx.md | ... | P0 | ... |'},
    implement:{icon:'🚀',label:'MVP実装',desc:'仕様書からMVP開発開始',
      sys:'あなたはフルスタック開発者です。SDD仕様書に忠実に実装します。',
      prompt:'docs/23_tasks.mdから最優先タスク(P0またはIssue #1)を1つ選んで実装してください。\n\n実装手順:\n1. 型定義を作成 (TypeScript interface/type)\n2. データアクセス層を実装 (ORM/SDK)\n3. ビジネスロジックを実装\n4. UIコンポーネントを実装\n5. Vitestユニットテストを作成\n\nconstitution.mdの設計原則に従い、technical-plan.mdのアーキテクチャに沿ってください。',
      fmt:'ファイルパス付きコードブロック:\n```typescript:path/to/file.ts\n// code\n```\n必ずテストを含めてください。'},
    test:{icon:'🧪',label:'テスト生成',desc:'テストケース自動作成',
      sys:'あなたはQAエンジニアです。仕様書からテストケースを網羅的に作成します。',
      prompt:'docs/07_test_cases.mdを参照し、以下の順序でテストケースを生成してください:\n1. 正常系(Happy Path): 基本的なCRUD操作\n2. 異常系(Error Cases): バリデーションエラー、権限エラー\n3. 境界値(Boundary): 空文字列、最大長、NULL\n\n各テストケースには期待結果を明記してください。',
      fmt:'Vitestテストファイル:\n```typescript:tests/xxx.test.ts\nimport { describe, it, expect } from \'vitest\';\n// tests\n```'},
    refactor:{icon:'♻️',label:'リファクタ提案',desc:'構造改善と技術的負債の解消',
      sys:'あなたはコードレビュアーです。アーキテクチャの改善提案を行います。',
      prompt:'以下の仕様書の技術設計を分析し、リファクタリング提案をしてください。各指摘に工数見積り(S=1-2h/M=3-8h/L=1-2日)を付与してください。\n\nチェック項目:\n- SOLID原則の違反\n- 責務の分離不足(Fat Controller等)\n- スケーラビリティの問題\n- パフォーマンスボトルネック\n- 技術的負債',
      fmt:'Markdown表:\n| 問題 | 違反している原則 | 改善案 | 工数 | 優先度 |\n|------|------------------|--------|------|--------|\n| ... | SRP | ... | M | P1 |'},
    security:{icon:'🔒',label:'セキュリティ監査',desc:'脆弱性とベストプラクティス',
      sys:'あなたはセキュリティエンジニアです。OWASP Top 10を基準に監査します。',
      prompt:'以下の仕様書のセキュリティ面をOWASP Top 10の各項目別にチェックしてください:\n\n1. A01:2021 – Broken Access Control\n2. A02:2021 – Cryptographic Failures\n3. A03:2021 – Injection\n4. A04:2021 – Insecure Design\n5. A05:2021 – Security Misconfiguration\n6. A06:2021 – Vulnerable Components\n7. A07:2021 – Authentication Failures\n8. A08:2021 – Data Integrity Failures\n9. A09:2021 – Logging Failures\n10. A10:2021 – SSRF\n\n各項目の状態を✅(OK)/⚠️(注意)/❌(脆弱)で評価してください。',
      fmt:'Markdown表:\n| OWASP# | 項目 | 状態 | 詳細 | 推奨対策 |\n|--------|------|------|------|----------|\n| A01 | Access Control | ⚠️ | ... | ... |'},
    docs:{icon:'📝',label:'ドキュメント補完',desc:'不足文書の特定と生成',
      sys:'あなたはテクニカルライターです。開発ドキュメントの品質を高めます。',
      prompt:'以下の仕様書群を分析し、2パート構成で出力してください:\n\n**Part 1: ギャップ分析**\n既存ドキュメントと理想状態の差分を表形式で列挙\n\n**Part 2: 最重要ドキュメント生成**\nギャップ分析で最も優先度が高いドキュメント1つを全文生成してください。\n\n候補:\n- API仕様の詳細化(OpenAPI YAML)\n- シーケンス図(Mermaid)\n- デプロイ手順書(Step-by-step)\n- エラーハンドリング設計',
      fmt:'Part 1: Markdown表\nPart 2: 完全なドキュメント(Markdown)'},
  }:{
    review:{icon:'🔍',label:'Spec Review',desc:'Find contradictions, gaps & improvements',
      sys:'You are an experienced tech lead and SDD architect.',
      prompt:'Review the following specs in 4 steps:\n1. Verify mission and KPIs in constitution.md\n2. Check requirement coverage in specification.md\n3. Evaluate architecture validity in technical-plan.md\n4. Identify overall consistency and gaps\n\nAssign priority to each finding (P0=critical/P1=important/P2=recommended).',
      fmt:'Markdown table:\n| # | File | Finding | Priority | Recommended Action |\n|---|------|---------|----------|--------------------|\n| 1 | .spec/xxx.md | ... | P0 | ... |'},
    implement:{icon:'🚀',label:'MVP Build',desc:'Start implementation from specs',
      sys:'You are a full-stack developer. You implement faithfully according to SDD specs.',
      prompt:'Select the highest priority task (P0 or Issue #1) from docs/23_tasks.md and implement it.\n\nImplementation steps:\n1. Create type definitions (TypeScript interface/type)\n2. Implement data access layer (ORM/SDK)\n3. Implement business logic\n4. Implement UI components\n5. Create Vitest unit tests\n\nFollow design principles in constitution.md and architecture in technical-plan.md.',
      fmt:'Code blocks with file paths:\n```typescript:path/to/file.ts\n// code\n```\nMust include tests.'},
    test:{icon:'🧪',label:'Test Generation',desc:'Auto-generate test cases',
      sys:'You are a QA engineer. You create comprehensive test cases from specifications.',
      prompt:'Reference docs/07_test_cases.md and generate test cases in this order:\n1. Happy Path: Basic CRUD operations\n2. Error Cases: Validation errors, permission errors\n3. Boundary: Empty strings, max length, NULL\n\nSpecify expected results for each test case.',
      fmt:'Vitest test file:\n```typescript:tests/xxx.test.ts\nimport { describe, it, expect } from \'vitest\';\n// tests\n```'},
    refactor:{icon:'♻️',label:'Refactor Proposal',desc:'Architecture improvements & tech debt',
      sys:'You are a code reviewer focused on architecture improvements.',
      prompt:'Analyze the technical design in these specs and propose refactoring. Assign effort estimates (S=1-2h/M=3-8h/L=1-2d) to each finding.\n\nCheck items:\n- SOLID principle violations\n- Separation of concerns issues (Fat Controllers, etc.)\n- Scalability problems\n- Performance bottlenecks\n- Technical debt',
      fmt:'Markdown table:\n| Issue | Violated Principle | Improvement | Effort | Priority |\n|-------|-------------------|-------------|--------|----------|\n| ... | SRP | ... | M | P1 |'},
    security:{icon:'🔒',label:'Security Audit',desc:'Vulnerabilities & best practices',
      sys:'You are a security engineer. You audit against OWASP Top 10.',
      prompt:'Check security aspects of these specs against each OWASP Top 10 item:\n\n1. A01:2021 – Broken Access Control\n2. A02:2021 – Cryptographic Failures\n3. A03:2021 – Injection\n4. A04:2021 – Insecure Design\n5. A05:2021 – Security Misconfiguration\n6. A06:2021 – Vulnerable Components\n7. A07:2021 – Authentication Failures\n8. A08:2021 – Data Integrity Failures\n9. A09:2021 – Logging Failures\n10. A10:2021 – SSRF\n\nEvaluate each item as ✅(OK)/⚠️(Warning)/❌(Vulnerable).',
      fmt:'Markdown table:\n| OWASP# | Item | Status | Details | Recommended Fix |\n|--------|------|--------|---------|------------------|\n| A01 | Access Control | ⚠️ | ... | ... |'},
    docs:{icon:'📝',label:'Doc Completion',desc:'Identify missing docs & generate them',
      sys:'You are a technical writer focused on development documentation quality.',
      prompt:'Analyze these specs and output in 2 parts:\n\n**Part 1: Gap Analysis**\nList gaps between existing docs and ideal state in table format\n\n**Part 2: Generate Critical Document**\nGenerate ONE highest-priority document from gap analysis in full.\n\nCandidates:\n- API spec details (OpenAPI YAML)\n- Sequence diagrams (Mermaid)\n- Deployment guide (step-by-step)\n- Error handling design',
      fmt:'Part 1: Markdown table\nPart 2: Complete document (Markdown)'},
    qa:{icon:'🐛',label:_ja?'QA・バグ検出':'QA & Bug Detection',desc:_ja?'ドメイン別バグパターンとQA戦略を基にテスト計画を生成':'Generate test plan based on domain-specific bug patterns and QA strategy',
      sys:_ja?'あなたはQAエンジニアです。docs/28_qa_strategy.mdのドメイン別バグパターンを参照し、具体的なテストシナリオを設計してください。':'You are a QA engineer. Reference docs/28_qa_strategy.md domain-specific bug patterns to design concrete test scenarios.',
      prompt:_ja?'以下の手順で実行:\n1. docs/28_qa_strategy.mdの重点領域を確認\n2. 各重点領域に対し具体的テストケースを3つ以上作成\n3. よくあるバグパターンに対する回帰テストを設計\n4. 業界横断チェックリストの該当項目を検証\n5. 優先度マトリクスに基づきテスト実行順序を決定':'Follow these steps:\n1. Review focus areas from docs/28_qa_strategy.md\n2. Create 3+ concrete test cases per focus area\n3. Design regression tests for common bug patterns\n4. Verify applicable cross-cutting checklist items\n5. Determine test execution order based on priority matrix',
      fmt:_ja?'Markdown表形式: テストID|カテゴリ|シナリオ|期待結果|優先度(CRITICAL/HIGH/MED/LOW)':'Markdown table: TestID|Category|Scenario|Expected Result|Priority(CRITICAL/HIGH/MED/LOW)'},
  };
  
  let h=`<div class="exp-header"><h3>🤖 ${_ja?'AI プロンプトランチャー':'AI Prompt Launcher'}</h3>
  <p>${_ja
    ?'生成した仕様書をAIツールに一括投入。テンプレートを選んでコピー'
    :'Feed generated specs to AI tools. Pick a template and copy'}</p></div>`;
  
  if(hasFiles){
    h+=`<div class="launch-stats">
      <div class="launch-stat"><span class="launch-num">${fKeys.length}</span><span class="launch-lbl">${_ja?'ファイル':'Files'}</span></div>
      <div class="launch-stat"><span class="launch-num">${totalTokens.toLocaleString()}</span><span class="launch-lbl">${_ja?'推定トークン':'Est. Tokens'}</span></div>
      <div class="launch-stat"><span class="launch-num">${Object.keys(folders).length}</span><span class="launch-lbl">${_ja?'フォルダ':'Folders'}</span></div>
    </div>`;
    
    h+=`<div class="launch-folders"><h4>${_ja?'📂 フォルダ別トークン':'📂 Tokens by Folder'}</h4>`;
    const sortedDirs=Object.entries(folders).sort((a,b)=>b[1].tokens-a[1].tokens);
    sortedDirs.forEach(([dir,info])=>{
      const pct=Math.round(info.tokens/totalTokens*100);
      h+=`<div class="launch-folder-row">
        <label><input type="checkbox" checked data-dir="${dir}" onchange="updateLaunchPreview()"> <strong>${dir}/</strong></label>
        <span>${info.files.length} ${_ja?'ファイル':'files'} · ${info.tokens.toLocaleString()} tok (${pct}%)</span>
        <div class="launch-bar"><div class="launch-bar-fill" style="width:${pct}%"></div></div>
      </div>`;
    });
    h+=`</div>`;
    
    const models=[
      {name:'Claude Opus 4.6',ctx:1000000,icon:'🟣'},
      {name:'Claude Sonnet 4.5',ctx:200000,icon:'🔵'},
      {name:'GPT-5.2',ctx:400000,icon:'🟢'},
      {name:'Gemini 2.5 Pro',ctx:1000000,icon:'🟡'},
      {name:'Claude Haiku 4.5',ctx:200000,icon:'🟣'},
      {name:'Gemini 3 Flash',ctx:200000,icon:'🟡'},
    ];
    h+=`<div class="launch-models"><h4>${_ja?'🤖 モデル適合':'🤖 Model Fit'}</h4>`;
    models.forEach(m=>{
      const pct=Math.min(100,Math.round(totalTokens/m.ctx*100));
      const ok=pct<80;
      h+=`<div class="launch-model-row">${m.icon} ${m.name} <span class="launch-model-pct ${ok?'launch-ok':'launch-warn'}">${pct}% ${ok?(_ja?'余裕':'OK'):(pct<100?(_ja?'注意':'tight'):(_ja?'超過':'over'))}</span></div>`;
    });
    h+=`</div>`;
  } else {
    h+=`<div class="empty-preview-sm">${_ja?'⚠️ まず質問に回答してファイルを生成してください':'⚠️ Answer questions first to generate files'}</div>`;
  }
  
  h+=`<div class="launch-templates"><h4>${_ja?'📋 プロンプトテンプレート':'📋 Prompt Templates'}</h4>`;
  Object.entries(PT).forEach(([key,t])=>{
    h+=`<div class="launch-tpl" onclick="selectLaunchTemplate('${key}')">
      <div class="launch-tpl-icon">${t.icon}</div>
      <div class="launch-tpl-info"><strong>${t.label}</strong><span>${t.desc}</span></div>
    </div>`;
  });
  h+=`</div>`;
  
  h+=`<div class="launch-output" id="launchOutput">
    <div class="launch-output-head">
      <h4 id="launchOutputTitle"></h4>
      <div class="prev-toolbar-r">
        <button class="btn btn-xs btn-p" onclick="copyLaunchPrompt()">📋 ${_ja?'コピー':'Copy'}</button>
        <button class="btn btn-xs btn-g" onclick="$('launchOutput').style.display='none'">✕</button>
      </div>
    </div>
    <div class="launch-output-meta" id="launchOutputMeta"></div>
    <pre class="launch-output-pre" id="launchOutputPre"></pre>
  </div>`;
  body.innerHTML=h;
  
  window._launchPT=PT;
  window._launchFolders=folders;
  window._launchFiles=files;
}
function selectLaunchTemplate(key){
  const _ja=S.lang==='ja';
  const PT=window._launchPT;
  const t=PT[key];if(!t)return;
  const selectedFiles=getSelectedLaunchFiles();
  const content=selectedFiles.map(([k,v])=>`--- ${k} ---\n${v}`).join('\n\n');
  const selTokens=Math.round(content.length/4);
  const a=S.answers;const pn=S.projectName||'Project';
  const ctx='Project: '+pn+'\nStack: '+(a.frontend||'React')+' + '+(a.backend||'Node.js')+' + '+(a.database||'PostgreSQL')+'\nAuth: '+(a.auth||'N/A')+'\nEntities: '+(a.data_entities||'N/A');
  const full='# System\n'+t.sys+'\n\n# Context\n'+ctx+'\n\n# Task\n'+t.prompt+'\n\n# Output Format\n'+t.fmt+'\n\n---\n\n'+content;
  const out=$('launchOutput');out.style.display='block';
  $('launchOutputTitle').textContent=`${t.icon} ${t.label}`;
  $('launchOutputMeta').textContent=`${selectedFiles.length} ${_ja?'ファイル':'files'} · ~${selTokens.toLocaleString()} tokens`;
  $('launchOutputPre').textContent=full.slice(0,2000)+(full.length>2000?`\n\n... (${_ja?'残り':'remaining'} ${(full.length-2000).toLocaleString()} chars)`:'');
  window._launchFullPrompt=full;
  out.scrollIntoView({behavior:'smooth',block:'nearest'});
}
function getSelectedLaunchFiles(){
  const checks=document.querySelectorAll('.launch-folder-row input[type=checkbox]');
  const selectedDirs=new Set();
  checks.forEach(c=>{if(c.checked)selectedDirs.add(c.dataset.dir);});
  const files=window._launchFiles||S.files;
  return Object.entries(files).filter(([k])=>{
    const dir=k.includes('/')?k.split('/')[0]:'root';
    return selectedDirs.has(dir);
  });
}
function updateLaunchPreview(){
  const sel=getSelectedLaunchFiles();
  const tokens=sel.reduce((s,e)=>s+Math.round(e[1].length/4),0);
  const meta=$('launchOutputMeta');
  if(meta&&$('launchOutput').style.display!=='none'){
    const _ja=S.lang==='ja';
    meta.textContent=`${sel.length} ${_ja?'ファイル':'files'} · ~${tokens.toLocaleString()} tokens`;
  }
}
function copyLaunchPrompt(){
  const _ja=S.lang==='ja';
  const text=window._launchFullPrompt;
  if(!text)return;
  navigator.clipboard.writeText(text).then(()=>{
    toast(_ja?'📋 プロンプトをコピーしました':'📋 Prompt copied to clipboard');
  }).catch(()=>{
    const ta=document.createElement('textarea');ta.value=text;
    document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();
    toast(_ja?'📋 コピー完了':'📋 Copied');
  });
}
function showDashboard(){
  const body=$('prevBody');
  const _ja=S.lang==='ja';
  const a=S.answers;
  const fileCount=Object.keys(S.files).length||0;
  const totalChars=Object.values(S.files).reduce((s,f)=>s+f.length,0);
  const tokens=Math.round(totalChars/4);
  const answered=Object.keys(a).length;
  
  let h=`<div class="dash-head"><h3>📊 Context Dashboard</h3><p>${_ja?'プロジェクトのコンテキスト情報を一覧':'Project context overview'}</p></div>`;
  const lastExp=_lsGet('devforge-last-export');
  const daysSince=lastExp?Math.floor((Date.now()-new Date(lastExp).getTime())/86400000):-1;
  if(daysSince<0){
    h+=`<div class="dash-backup dash-backup-red"><span>⚠️ ${_ja?'まだエクスポートしていません — データはブラウザのみに保存されています':'No exports yet — data only exists in this browser'}</span><button class="btn btn-xs btn-p" onclick="exportProject();_lsSet('devforge-last-export',new Date().toISOString());">📤 ${_ja?'今すぐ保存':'Export Now'}</button></div>`;
  } else if(daysSince>=3){
    h+=`<div class="dash-backup dash-backup-yellow"><span>💾 ${_ja?'最終エクスポート: '+daysSince+'日前':'Last export: '+daysSince+' days ago'}</span><button class="btn btn-xs btn-s" onclick="exportProject();_lsSet('devforge-last-export',new Date().toISOString());">📤 ${_ja?'バックアップ':'Backup'}</button></div>`;
  }
  if(!_lsGet('devforge-guide-dismiss')){
    h+=`<div class="dash-backup dash-guide"><span>🚀 ${_ja?'生成ファイルの活用ガイドを確認しましょう':'Check the generated files usage guide'}</span><button class="btn btn-xs btn-p" onclick="showPostGenGuide(true)">${_ja?'ガイドを見る':'View Guide'}</button><button class="btn btn-xs btn-g" onclick="this.closest('.dash-backup').remove();_lsSet('devforge-guide-dismiss','1')">✕</button></div>`;
  }
  h+=`<div class="ctx-summary">
    <div class="ctx-stat"><div class="num">${fileCount}</div><div class="lbl">${_ja?'生成ファイル':'Files'}</div></div>
    <div class="ctx-stat"><div class="num">${Math.round(tokens).toLocaleString()}</div><div class="lbl">${_ja?'推定トークン':'Est. Tokens'}</div></div>
    <div class="ctx-stat"><div class="num">${answered}</div><div class="lbl">${_ja?'回答済み質問':'Answered'}</div></div>
    <div class="ctx-stat"><div class="num">${TECH_DB.length}</div><div class="lbl">${_ja?'技術DB':'Tech DB'}</div></div>
  </div>`;
  const models=[
    {name:'Claude Opus 4.6',ctx:1000000,color:'var(--accent)'},
    {name:'Claude Sonnet 4.5',ctx:200000,color:'var(--accent-2)'},
    {name:'GPT-5.2',ctx:400000,color:'var(--success)'},
    {name:'Gemini 2.5 Pro',ctx:1000000,color:'var(--warn)'},
    {name:'Claude Haiku 4.5',ctx:200000,color:'var(--accent)'},
    {name:'Gemini 3 Flash',ctx:200000,color:'var(--warn)'},
  ];
  h+='<h4 class="dash-h4">🤖 '+(_ja?'モデル適合度':'Model Fit')+'</h4><div class="model-grid">';
  models.forEach(m=>{
    const pct=Math.min(100,Math.round(tokens/m.ctx*100));
    const fit=pct<80?'high':pct<95?'mid':'low';
    const fitClass=fit==='high'?'fit-high':fit==='mid'?'fit-mid':'fit-low';
    h+=`<div class="model-card"><h4>${m.name}</h4><div class="fit ${fitClass}">${fit==='high'?(_ja?'\u2705 適合':'\u2705 Fit'):fit==='mid'?(_ja?'\u26A0\uFE0F 注意':'\u26A0\uFE0F Caution'):(_ja?'\u274C 超過':'\u274C Over')}</div>
    <div class="dash-model-ctx">${_ja?'コンテキスト':'Context'}: ${(m.ctx/1000).toFixed(0)}K tokens</div>
    <div class="ctx-bar"><div class="ctx-bar-fill" style="width:${pct}%;background:${m.color}"></div></div>
    <div class="dash-model-pct">${pct}% ${_ja?'使用':'used'}</div></div>`;
  });
  h+='</div>';
  if(fileCount>0){
    h+='<h4 class="dash-h4-mt">📂 '+(_ja?'ファイルサイズ分布':'File Size Distribution')+'</h4>';
    const cats=_ja?{'SDD (.spec/)':0,'DevContainer':0,'MCP':0,'AIルール':0,'Roadmap':0,'Docs':0,'Common':0}:{'SDD (.spec/)':0,'DevContainer':0,'MCP':0,'AI Rules':0,'Roadmap':0,'Docs':0,'Common':0};
    Object.entries(S.files).forEach(([p,c])=>{
      const len=c.length;
      if(p.startsWith('.spec/'))cats['SDD (.spec/)']+=len;
      else if(p.startsWith('.devcontainer/'))cats['DevContainer']+=len;
      else if(p.includes('mcp'))cats['MCP']+=len;
      else if(p.startsWith('roadmap/'))cats['Roadmap']+=len;
      else if(p.startsWith('docs/'))cats['Docs']+=len;
      else if(['.cursor/rules','.windsurfrules','.clinerules','CLAUDE.md','AGENTS.md'].some(x=>p.includes(x)))cats[_ja?'AIルール':'AI Rules']+=len;
      else cats['Common']+=len;
    });
    const maxLen=Math.max(...Object.values(cats),1);
    Object.entries(cats).forEach(([name,len])=>{
      const pct=Math.round(len/maxLen*100);
      h+=`<div class="dash-fbar-row">
        <span class="dash-fbar-name">${name}</span>
        <div class="dash-fbar"><div class="dash-fbar-fill" style="width:${pct}%"></div></div>
        <span class="dash-fbar-size">${(len/1024).toFixed(1)}KB</span>
      </div>`;
    });
  }
  h+='<h4 class="dash-h4-mt">📊 '+(_ja?'技術マスターテーブル統計':'Tech DB Statistics')+'</h4>';
  const catLabels=_ja?{lang:'言語',front:'FE',mobile:'モバイル',back:'BE',baas:'BaaS',payment:'決済/CMS',devops:'DevOps',ai:'AIツール',ai_auto:'AI自律',method:'手法',test:'テスト',api:'API',build:'ビルド',data:'データ',security:'セキュリティ'}:{lang:'Lang',front:'FE',mobile:'Mobile',back:'BE',baas:'BaaS',payment:'Payment/CMS',devops:'DevOps',ai:'AI Tools',ai_auto:'AI Auto',method:'Methods',test:'Testing',api:'API',build:'Build',data:'Data',security:'Security'};
  const catCounts=TECH_DB.reduce((acc,t)=>{acc[t.cat]=(acc[t.cat]||0)+1;return acc;},{});
  const dbMax=Math.max(...Object.values(catCounts));
  const domGrps=_ja?[
    {n:'🖥 コア開発',c:['lang','front','back','mobile'],cl:'dg-core'},
    {n:'🤖 AI & 自動化',c:['ai','ai_auto'],cl:'dg-ai'},
    {n:'☁️ インフラ & サービス',c:['baas','devops','payment'],cl:'dg-infra'},
    {n:'🛡 品質 & 設計',c:['method','test','api','build','data','security'],cl:'dg-qa'}
  ]:[
    {n:'🖥 Core Dev',c:['lang','front','back','mobile'],cl:'dg-core'},
    {n:'🤖 AI & Automation',c:['ai','ai_auto'],cl:'dg-ai'},
    {n:'☁️ Infra & Services',c:['baas','devops','payment'],cl:'dg-infra'},
    {n:'🛡 Quality & Design',c:['method','test','api','build','data','security'],cl:'dg-qa'}
  ];
  domGrps.forEach(g=>{
    const items=g.c.filter(c=>catCounts[c]).map(c=>({l:catLabels[c]||c,v:catCounts[c]})).sort((a,b)=>b.v-a.v);
    const sub=items.reduce((s,i)=>s+i.v,0);
    h+=`<div class="dg ${g.cl}"><div class="dg-hd"><span class="dg-nm">${g.n}</span><span class="dg-sub">${sub}</span></div>`;
    items.forEach(i=>{
      const pct=Math.round(i.v/dbMax*100);
      h+=`<div class="dg-bar"><span class="dg-lbl">${i.l}</span><div class="dg-track"><div class="dg-fill" style="width:${pct}%"></div></div><span class="dg-cnt">${i.v}</span></div>`;
    });
    h+='</div>';
  });
  h+=`<div class="dg-total"><span>📊 ${_ja?'技術マスターテーブル':'Tech Master Table'}</span><strong>${TECH_DB.length}</strong></div>`;
  h+=`<h4 class="dash-h4-mt">📋 ${_ja?'プロジェクト情報':'Project Info'}</h4><div class="dash-info">`;
  const info=_ja?[['プロジェクト名',S.projectName],['フロント',a.frontend],['バック',a.backend],['DB',a.database],['デプロイ',a.deploy],['モバイル',a.mobile],['AI自律',a.ai_auto],['決済/CMS',a.payment],['駆動開発',a.dev_methods],['スキル',a.skill_level]]:[['Project',S.projectName],['Frontend',a.frontend],['Backend',a.backend],['DB',a.database],['Deploy',a.deploy],['Mobile',a.mobile],['AI Auto',a.ai_auto],['Payment/CMS',a.payment],['Dev Methods',a.dev_methods],['Skill',a.skill_level]];
  info.forEach(([k,v])=>{if(v&&v!==(_ja?'（未指定）':'(Unset)')&&v!=='(Unset)')h+=`<div class="exp-row"><span class="label">${k}</span><span class="val">${v}</span></div>`;});
  h+='</div>';
  const compat=checkCompat(a);
  const errs=compat.filter(c=>c.level==='error');
  const warns=compat.filter(c=>c.level==='warn');
  const infos=compat.filter(c=>c.level==='info');
  const ok=8-(errs.length>0?1:0)-(warns.length>0?1:0);
  h+=`<h4 class="dash-h4-mt">🔍 ${_ja?'スタック相性 & 整合性チェック':'Stack Compatibility & Consistency'}</h4>`;
  if(compat.length===0){
    h+=`<div class="compat-ok">✅ ${_ja?`スタック相性・意味的整合ともに問題なし（${COMPAT_RULES.length}ルール検証済）`:`No issues found (${COMPAT_RULES.length} rules verified)`}</div>`;
  } else {
    h+=`<div class="compat-summary"><span class="compat-s-ok">✅ ${_ja?'問題なし':'OK'}: ${COMPAT_RULES.length-compat.length}</span>`;
    if(warns.length)h+=`<span class="compat-s-warn">⚠️ ${_ja?'注意':'Warn'}: ${warns.length}</span>`;
    if(errs.length)h+=`<span class="compat-s-err">❌ ${_ja?'要修正':'Fix'}: ${errs.length}</span>`;
    if(infos.length)h+=`<span class="compat-s-info">ℹ️ ${_ja?'参考':'Info'}: ${infos.length}</span>`;
    h+='</div>';
    compat.forEach(c=>{
      const icon=c.level==='error'?'❌':c.level==='warn'?'⚠️':'ℹ️';
      const cls=c.level==='error'?'compat-error':c.level==='warn'?'compat-warn':'compat-info';
      const pair=c.pair.map(p=>{const n={frontend:'FE',backend:'BE',database:'DB',deploy:'Deploy',mobile:'Mobile',orm:'ORM',ai_auto:'AI',skill_level:'Skill',payment:'Pay',dev_methods:'DevMethod',auth:'Auth',scope_out:'Scope',data_entities:'Entity',purpose:'Purpose',mvp_features:'MVP'};return n[p]||p;}).join(' ↔ ');
      h+=`<div class="${cls}"><span class="compat-pair">${pair}</span><span class="compat-msg">${c.msg}</span>`;
      if(c.fix)h+=`<button class="btn btn-xs btn-s compat-fix" onclick="S.answers['${c.fix.f}']='${c.fix.s}';save();showDashboard();">→ ${c.fix.s}</button>`;
      h+='</div>';
    });
  }
  h+='<h4 class="dash-h4-mt">'+(_ja?'📐 プロジェクト複雑度':'📐 Project Complexity')+'</h4>';
  h+=getComplexityHTML();
  h+=getHealthHTML(_ja,fileCount,answered);
  if(Object.keys(S.files).length>0){
    const pillarMap={'.spec/':'P1 SDD','.devcontainer/':'P2 DevContainer','mcp-config':'P3 MCP','.cursor/':'P4 AI Rules','.clinerules':'P4','.windsurfrules':'P4','.gemini/':'P4','.github/':'P4','CLAUDE.md':'P4','AGENTS.md':'P4','codex-instructions':'P4','.kiro/':'P4','skills/':'P4','roadmap/':'P7 Roadmap','docs/':'Docs','README.md':'Common','.gitignore':'Common','LICENSE':'Common','package.json':'Common','.ai/':'Common','.mcp/':'P3 MCP'};
    const pillarSizes={};
    Object.entries(S.files).forEach(([p,c])=>{
      let pil='Other';
      for(const[k,v]of Object.entries(pillarMap)){if(p.startsWith(k)||p.includes(k)){pil=v;break;}}
      pillarSizes[pil]=(pillarSizes[pil]||0)+c.length;
    });
    const sorted=Object.entries(pillarSizes).sort((a,b)=>b[1]-a[1]);
    const max=sorted[0]?sorted[0][1]:1;
    const pillarColors={'P1 SDD':'var(--accent)','P2 DevContainer':'var(--accent-2)','P3 MCP':'var(--success)','P4 AI Rules':'var(--warn)','P7 Roadmap':'var(--danger)','P9 Design System':'var(--accent)','P10 Reverse Eng':'var(--success)','Docs':'var(--layer-5)','Common':'var(--text-3)'};
    h+='<h4 class="dash-h4-mt">'+(_ja?'📦 ファイルサイズ分布':'📦 File Size Distribution')+'</h4>';
    h+='<div class="fsize-chart">';
    sorted.forEach(([pil,sz])=>{
      const pct=Math.round(sz/max*100);
      const kb=(sz/1024).toFixed(1);
      const col=pillarColors[pil]||'var(--text-3)';
      h+=`<div class="fsize-row"><span class="fsize-lbl">${pil}</span><div class="fsize-bar-wrap"><div class="fsize-bar" style="width:${pct}%;background:${col}"></div></div><span class="fsize-val">${kb}KB</span></div>`;
    });
    h+='</div>';
  }
  h+=`<div class="dash-center"><button class="btn btn-s" onclick="renderTechDB()">📊 ${_ja?'技術マスターテーブル':'Tech Master Table'} (${TECH_DB.length} ${_ja?'エントリ':'entries'})</button></div>`;
  
  body.innerHTML=h;
}
function getHealthHTML(_ja,fileCount,answered){
  const qs=getQ();
  let totalQ=0;
  for(let p=1;p<=3;p++){if(qs[p])totalQ+=qs[p].questions.length;}
  const answerPct=totalQ?Math.round(answered/totalQ*100):0;
  const pillarChecks=[
    {key:'.spec/',label:_ja?'①SDD':'①SDD'},
    {key:'.devcontainer/',label:_ja?'②DevContainer':'②DevContainer'},
    {key:'mcp',label:_ja?'③MCP':'③MCP'},
    {key:'CLAUDE.md',label:_ja?'④AIルール':'④AI Rules'},
    {key:'roadmap/',label:_ja?'⑦ロードマップ':'⑦Roadmap'},
    {key:'docs/26_',label:_ja?'⑨デザインシステム':'⑨Design System'},
    {key:'docs/29_',label:_ja?'⑩リバースEng':'⑩Reverse Eng'},
  ];
  const fileKeys=Object.keys(S.files);
  let pillarOK=0;
  const pillarResults=pillarChecks.map(pc=>{
    const ok=fileKeys.some(f=>f.includes(pc.key));
    if(ok)pillarOK++;
    return {label:pc.label,ok};
  });
  const pillarPct=pillarChecks.length?Math.round(pillarOK/pillarChecks.length*100):0;
  const requiredFiles=['constitution.md','tasks.md','CLAUDE.md'];
  let reqOK=0;
  const reqResults=requiredFiles.map(rf=>{
    const ok=fileKeys.some(f=>f.endsWith(rf));
    if(ok)reqOK++;
    return {name:rf,ok};
  });
  const reqPct=requiredFiles.length?Math.round(reqOK/requiredFiles.length*100):0;
  const score=Math.round(answerPct*0.3+pillarPct*0.4+reqPct*0.3);
  const color=score>=80?'var(--success)':score>=50?'var(--warn)':'var(--danger)';
  const label=score>=80?(_ja?'✅ 良好':'✅ Healthy'):score>=50?(_ja?'⚠️ 部分的':'⚠️ Partial'):(_ja?'🔴 不完全':'🔴 Incomplete');
  let h=`<h4 class="dash-h4-mt">🏥 ${_ja?'プロジェクト健全性':'Project Health'}</h4>`;
  h+=`<div class="complexity-card"><div class="complexity-header"><div><div class="dash-total complexity-label">${label}</div></div><div class="complexity-score" style="background:${color}20;color:${color};">${score}</div></div>`;
  h+=`<div class="complexity-bar"><div class="complexity-fill" style="width:${score}%;background:${color};"></div></div>`;
  h+=`<div class="complexity-grid">`;
  h+=`<div class="complexity-item"><span>${_ja?'回答完了率':'Answers'}</span><span>${answerPct}%</span></div>`;
  h+=`<div class="complexity-item"><span>${_ja?'Pillarカバー':'Pillar Coverage'}</span><span>${pillarOK}/${pillarChecks.length}</span></div>`;
  h+=`<div class="complexity-item"><span>${_ja?'必須ファイル':'Required Files'}</span><span>${reqOK}/${requiredFiles.length}</span></div>`;
  h+=`<div class="complexity-item"><span>${_ja?'生成ファイル数':'Total Files'}</span><span>${fileCount}</span></div>`;
  h+=`</div>`;
  if(score<100){
    h+=`<div class="dash-total dash-total-mt">`;
    pillarResults.filter(r=>!r.ok).forEach(r=>{h+=`<span>❌ ${r.label} </span>`;});
    reqResults.filter(r=>!r.ok).forEach(r=>{h+=`<span>❌ ${r.name} </span>`;});
    if(answerPct<100)h+=`<span>⚠️ ${totalQ-answered} ${_ja?'件未回答':'unanswered'}</span>`;
    h+=`</div>`;
  }
  h+=`</div>`;
  return h;
}
function renderTechDB(){
  const body=$('prevBody');
  const _ja=S.lang==='ja';const cats=_ja?{lang:'言語',front:'フロント',mobile:'モバイル',back:'バックエンド',baas:'BaaS',payment:'決済/CMS/EC',devops:'DevOps',ai:'AIツール',ai_auto:'AI自律',method:'手法',test:'テスト',api:'API',build:'ビルド',data:'データ',security:'セキュリティ'}:{lang:'Language',front:'Frontend',mobile:'Mobile',back:'Backend',baas:'BaaS',payment:'Payment/CMS/EC',devops:'DevOps',ai:'AI Tools',ai_auto:'AI Autonomous',method:'Methods',test:'Testing',api:'API',build:'Build',data:'Data',security:'Security'};
  
  let h=`<div class="dash-head"><h3>📊 ${_ja?'技術マスターテーブル':'Tech Master Table'}</h3><p>${TECH_DB.length}${_ja?'エントリ — フィルタで絞り込み':'entries — use filters to narrow down'}</p></div>`;
  h+=`<div class="tech-filter">
    <select id="tfCat" onchange="filterTechDB()"><option value="">${_ja?'全カテゴリ':'All Categories'}</option>${Object.entries(cats).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}</select>
    <select id="tfReq" onchange="filterTechDB()"><option value="">${_ja?'全必須度':'All Levels'}</option><option value="required">${_ja?'必須':'Required'}</option><option value="recommended">${_ja?'推奨':'Recommended'}</option><option value="optional">${_ja?'選択':'Optional'}</option></select>
    <input id="tfSearch" placeholder="${_ja?'検索...':'Search...'}" oninput="filterTechDB()">
    <span id="tfCount" class="dash-tfcount">${TECH_DB.length}${_ja?'件':' items'}</span>
  </div>`;
  h+=`<div class="dash-tbl-wrap"><table class="tech-table"><thead><tr><th>${_ja?'技術名':'Tech'}</th><th>${_ja?'カテゴリ':'Category'}</th><th>${_ja?'種別':'Type'}</th><th>${_ja?'必須度':'Required'}</th><th>${_ja?'レベル':'Level'}</th></tr></thead><tbody id="techTbody">`;
  TECH_DB.forEach(t=>{
    const reqClass='req-'+t.req.replace(/\d$/,'');
    h+=`<tr data-cat="${t.cat}" data-req="${t.req}" data-name="${t.name.toLowerCase()}"><td><strong>${t.name}</strong>${t.price?' <span class="dash-price">'+priceLabel(t.price)+'</span>':''}</td><td>${cats[t.cat]||t.cat}</td><td>${t.sub}</td><td><span class="req-badge ${reqClass}">${reqLabel(t.req)}</span></td><td>${t.level}</td></tr>`;
  });
  h+='</tbody></table></div>';
  h+=`<div class="dash-back"><button class="btn btn-s" onclick="showDashboard()">← ${_ja?'ダッシュボード':'Dashboard'}</button></div>`;
  body.innerHTML=h;
}
function filterTechDB(){
  const _ja=S.lang==='ja';
  const cat=$('tfCat').value;const req=$('tfReq').value;const search=$('tfSearch').value.toLowerCase();
  const rows=document.querySelectorAll('#techTbody tr');let count=0;
  rows.forEach(r=>{
    const show=(!cat||r.dataset.cat===cat)&&(!req||r.dataset.req.includes(req))&&(!search||r.dataset.name.includes(search));
    r.style.display=show?'':'none';if(show)count++;
  });
  $('tfCount').textContent=count+(_ja?'件':' items');
}
function showRoadmapUI(){
  const _ja=S.lang==='ja';
  const body=$('prevBody');
  if(!S.files['roadmap/LEARNING_PATH.md']){
    body.innerHTML='<p class="dash-empty">'+(_ja?'ファイル生成後に利用可能です':'Available after file generation')+'</p>';return;
  }
  const a=S.answers;
  const level=a.skill_level||'Intermediate';
  const isB=level.includes('Beginner');const isP=level.includes('Professional');
  const timeMul=isB?2.0:isP?0.5:1.0;
  const mob=a.mobile||(_ja?'なし':'None');const ai=a.ai_auto||(_ja?'なし':'None');const pay=a.payment||(_ja?'なし':'None');const noMob=mob==='なし'||mob==='None';const noAI=ai==='なし'||ai==='None';const noPay=pay==='なし'||pay==='None';
  const fe=a.frontend||'React + Next.js';const be=a.backend||'Node.js + Express';const dep=a.deploy||'Vercel';
  
  function res(key){return RESOURCES[key]||null;}
  function feRes(){if(fe.includes('Vue'))return res('vue');if(fe.includes('Svelte'))return res('svelte');if(fe.includes('Astro'))return res('astro');if(fe.includes('Vite'))return res('react');return res('nextjs');}
  function beRes(){if(be.includes('Fastify'))return res('fastify');if(be.includes('NestJS'))return res('nestjs');if(be.includes('FastAPI'))return res('fastapi');if(be.includes('Django'))return res('django');if(be.includes('Spring'))return res('spring');if(be.includes('Go'))return res('go');if(be.includes('Hono'))return res('hono');if(be.includes('Firebase'))return res('firebase');if(be.includes('Supabase'))return res('supabase');return res('express');}
  function depRes(){if(dep.includes('Cloudflare'))return res('cloudflare');if(dep.includes('Railway'))return res('railway');return res('vercel');}
  function authRes(){const au=a.auth||'';if(au.includes('Clerk'))return res('clerk');if(au.includes('Supabase'))return res('supabase');return res('nextauth');}
  function methRes(m){if(m.includes('BDD'))return res('bdd');if(m.includes('DDD'))return res('ddd');return res('tdd');}
  
  const layers=[
    {name:_ja?'Layer 1: Web基盤':'Layer 1: Web Fundamentals',color:'var(--layer-1)',items:[
      {text:_ja?'HTML5 / CSS3基礎':'HTML5 / CSS3 Basics',wk:isB?'Week 1-4':'Week 1',hrs:isB?40:8,res:res('html')},
      {text:'Tailwind CSS',wk:isB?'Week 3-8':'Week 1-2',hrs:isB?20:6,res:res('tailwind')},
      {text:'JavaScript ES6+ / TypeScript',wk:isB?'Week 5-12':'Week 1-2',hrs:isB?60:8,res:res('js')},
    ]},
    {name:_ja?'Layer 2: フロントエンド':'Layer 2: Frontend',color:'var(--layer-2)',items:[
      {text:fe+(_ja?' セットアップ':' Setup'),hrs:8,res:feRes()},
      {text:_ja?'shadcn/ui + コンポーネント設計':'shadcn/ui + Component Design',hrs:12,res:res('shadcn')},
      {text:_ja?'状態管理 (Zustand/Redux)':'State Management (Zustand/Redux)',hrs:10,res:res('zustand')},
      {text:'React Query / SWR',hrs:6,res:res('rquery')},
      {text:_ja?'テスト (Vitest + Playwright)':'Testing (Vitest + Playwright)',hrs:12,res:res('vitest')},
    ]},
    {name:_ja?'Layer 3: バックエンド':'Layer 3: Backend',color:'var(--layer-3)',items:[
      {text:be+(_ja?' セットアップ':' Setup'),hrs:8,res:beRes()},
      {text:_ja?'データベース設計 + ORM':'Database Design + ORM',hrs:16,res:res('prisma')},
      {text:_ja?'REST API / tRPC 実装':'REST API / tRPC Implementation',hrs:16,res:beRes()},
      {text:(_ja?'認証・認可':'Auth & Authorization')+' ('+(a.auth||'NextAuth')+')',hrs:12,res:authRes()},
    ]},
  ];
  if(!noMob) layers.push({name:_ja?'Layer 3.5: モバイル':'Layer 3.5: Mobile',color:'var(--layer-3h)',items:[
    {text:mob+(_ja?' 環境構築':' Setup'),hrs:10,res:mob.includes('Flutter')?res('flutter'):mob.includes('bare')?res('rn'):res('expo')},
    {text:_ja?'ナビゲーション・画面設計':'Navigation & Screen Design',hrs:12,res:mob.includes('Flutter')?res('flutter'):res('expo')},
    {text:_ja?'ネイティブ機能':'Native Features',hrs:10,res:mob.includes('Flutter')?res('flutter'):res('expo')},
    {text:_ja?'EASビルド・ストア提出':'EAS Build & Store Submit',hrs:8,res:res('expo')},
  ]});
  layers.push({name:'Layer 4: DevOps',color:'var(--layer-4)',items:[
    {text:'Docker + DevContainer',hrs:8,res:res('docker')},
    {text:'GitHub Actions CI/CD',hrs:8,res:res('ghactions')},
    {text:dep+(_ja?' デプロイ':' Deploy'),hrs:4,res:depRes()},
  ]});
  layers.push({name:_ja?'Layer 5: AI駆動開発':'Layer 5: AI-Driven Dev',color:'var(--layer-5)',items:[
    {text:_ja?'AI IDEセットアップ ('+((a.ai_tools||'Cursor').split(', ').slice(0,3).join(' / '))+')':'AI IDE Setup ('+((a.ai_tools||'Cursor').split(', ').slice(0,3).join(' / '))+')',hrs:4,res:res((a.ai_tools||'').includes('Antigravity')?'antigravity':'cursor')},
    {text:_ja?'MCP設定・活用':'MCP Configuration',hrs:6,res:res('mcp')},
    {text:_ja?'AI Agent Rules最適化':'AI Agent Rules Optimization',hrs:4,res:res('claudecode')},
    ...(!noAI?[{text:ai+(_ja?' 実践':' Practice'),hrs:8,res:res('cursor')}]:[]),
  ]});
  if(!noPay) layers.push({name:_ja?'Layer 6: 収益化':'Layer 6: Monetization',color:'var(--layer-6)',items:[
    {text:pay+(_ja?' 実装':' Implementation'),hrs:12,res:res('stripe')},
    {text:_ja?'課金フロー構築':'Billing Flow',hrs:10,res:res('stripe')},
  ]});
  layers.push({name:_ja?'Layer 7: 駆動開発手法':'Layer 7: Dev Methodologies',color:'var(--layer-7)',items:(a.dev_methods||'TDD').split(', ').map(m=>({text:m+(_ja?' 実践':' Practice'),hrs:8,res:methRes(m)}))});
  
  layers.forEach(l=>l.items.forEach(it=>{if(!it.wk)it.hrs=Math.round((it.hrs||8)*timeMul);}));
  
  const roadState=JSON.parse((_lsGet('devforge-road-'+S.projectName))||'{}');
  const collapseState=JSON.parse((_lsGet('devforge-road-col-'+S.projectName))||'{}');
  layers.forEach((l,li)=>l.items.forEach((item,ii)=>{item.done=!!roadState[li+'_'+ii];}));
  const totalItems=layers.reduce((s,l)=>s+l.items.length,0);
  const doneItems=layers.reduce((s,l)=>s+l.items.filter(i=>i.done).length,0);
  const pct=totalItems?Math.round(doneItems/totalItems*100):0;
  const totalHrs=layers.reduce((s,l)=>s+l.items.reduce((a,i)=>a+(i.hrs||0),0),0);
  const doneHrs=layers.reduce((s,l)=>s+l.items.filter(i=>i.done).reduce((a,i)=>a+(i.hrs||0),0),0);
  const remainHrs=totalHrs-doneHrs;
  
  const milestones=[
    {at:25,icon:'🌱',ja:'学習開始！基盤を構築中',en:'Journey started! Building foundations'},
    {at:50,icon:'🔥',ja:'半分達成！勢いに乗っています',en:'Halfway there! Great momentum'},
    {at:75,icon:'⚡',ja:'あと少し！ゴールが見えてきました',en:'Almost there! The finish line is in sight'},
    {at:100,icon:'🏆',ja:'全完了！おめでとうございます！',en:'All complete! Congratulations!'},
  ];
  const activeMilestone=milestones.filter(m=>pct>=m.at).pop();
  
  let h=`<div class="dash-head"><h3>${_ja?'🗺️ インタラクティブロードマップ':'🗺️ Interactive Roadmap'}</h3><p>${_ja?'チェックして進捗管理':'Track progress by checking items'} — ${level}</p></div>`;
  
  h+=`<div class="road-progress"><h4>${_ja?'📈 全体進捗':'📈 Overall Progress'}</h4>
    <div class="road-progress-bar"><div class="road-progress-fill" style="width:${pct}%"></div></div>
    <div class="road-pct">${pct}% <span class="road-pct-sub">(${doneItems}/${totalItems})</span></div>
    <div class="road-time">⏱️ ${_ja?'残り推定':'Est. remaining'}: <strong>${remainHrs}h</strong> / ${totalHrs}h ${_ja?'(×'+timeMul+' '+level+')':''}</div>
    ${activeMilestone?`<div class="road-milestone">${activeMilestone.icon} ${_ja?activeMilestone.ja:activeMilestone.en}</div>`:''}
  </div>`;
  
  layers.forEach((l,li)=>{
    const layerDone=l.items.filter(i=>i.done).length;
    const layerPct=l.items.length?Math.round(layerDone/l.items.length*100):0;
    const layerHrsLeft=l.items.filter(i=>!i.done).reduce((a,i)=>a+(i.hrs||0),0);
    
    const prevPct=li>0?(()=>{const pl=layers[li-1];const pd=pl.items.filter(i=>i.done).length;return pl.items.length?Math.round(pd/pl.items.length*100):100;})():100;
    const locked=prevPct<80;
    
    const collapsed=!!collapseState[li]||(layerPct===100&&!collapseState['_open_'+li]);
    h+=`<div class="road-layer${locked?' road-locked':''}" data-li="${li}">`;
    h+=`<h3 style="background:${l.color}20;color:${l.color};" class="road-layer-head" onclick="toggleRoadCollapse(${li})">`;
    h+=`<span class="road-collapse-icon">${collapsed?'▶':'▼'}</span> `;
    h+=locked?'🔒 ':'';
    h+=`${l.name} <span class="road-layer-pct">${layerPct}%</span>`;
    if(layerPct===100)h+=' 🏆';
    h+=`<span class="road-layer-hrs">${layerHrsLeft>0?(layerHrsLeft+'h'):(_ja?'完了':'Done')}</span>`;
    h+=`</h3>`;
    if(locked){
      h+=`<div class="road-lock-msg">${_ja?'🔒 前レイヤーを80%以上完了すると解放されます':'🔒 Complete previous layer to 80%+ to unlock'} (${prevPct}%)</div>`;
    }
    h+=`<div class="road-items${collapsed?' road-collapsed':''}" id="roadItems${li}">`;
    l.items.forEach((item,ii)=>{
      const id=li+'_'+ii;
      const disabled=locked?' disabled':'';
      h+=`<div class="road-task ${item.done?'checked':''}${locked?' road-task-locked':''}" ${locked?'':'onclick="toggleRoadItem2(\''+id+'\',this)"'}>`;
      h+=`<input type="checkbox" ${item.done?'checked':''}${disabled} ${locked?'':'onclick="event.stopPropagation();toggleRoadItem2(\''+id+'\',this.parentElement)"'}>`;
      h+=`<span>${item.text}</span>`;
      if(item.hrs)h+=`<span class="road-hrs-badge">${item.hrs}h</span>`;
      if(item.wk)h+=`<span class="road-week-badge">${item.wk}</span>`;
      if(item.res)h+=`<a class="road-res-btn" href="${item.res.u}" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="${item.res.n}">📖</a>`;
      h+=`</div>`;
    });
    h+=`</div></div>`;
  });
  h+=`<div class="road-actions">
    <button class="btn btn-s" onclick="resetRoadmap2()">${_ja?'🔄 リセット':'🔄 Reset'}</button>
    <button class="btn btn-s" onclick="expandAllRoadLayers()">${_ja?'📂 全展開':'📂 Expand All'}</button>
    <button class="btn btn-s" onclick="exportRoadmapMD()">${_ja?'📋 Markdownコピー':'📋 Copy Markdown'}</button>
  </div>`;
  body.innerHTML=h;
  
  window._roadLayers=layers;
}
function toggleRoadItem2(id,el){
  el.classList.toggle('checked');
  const cb=el.querySelector('input[type="checkbox"]');
  if(cb)cb.checked=el.classList.contains('checked');
  const roadState=JSON.parse((_lsGet('devforge-road-'+S.projectName))||'{}');
  roadState[id]=el.classList.contains('checked');
  _lsSet('devforge-road-'+S.projectName,JSON.stringify(roadState));
  
  const tasks=document.querySelectorAll('.road-task:not(.road-task-locked)');
  const done=document.querySelectorAll('.road-task.checked:not(.road-task-locked)');
  const pct=tasks.length?Math.round(done.length/tasks.length*100):0;
  const bar=document.querySelector('.road-progress-fill');if(bar)bar.style.width=pct+'%';
  const pctEl=document.querySelector('.road-pct');if(pctEl)pctEl.innerHTML=`${pct}% <span class="road-pct-sub">(${done.length}/${tasks.length})</span>`;
  
  const li=id.split('_')[0];
  const layer=document.querySelector('.road-layer[data-li="'+li+'"]');
  if(layer){
    const lt=layer.querySelectorAll('.road-task');const ld=layer.querySelectorAll('.road-task.checked');
    const lp=lt.length?Math.round(ld.length/lt.length*100):0;
    const hdr=layer.querySelector('.road-layer-pct');if(hdr)hdr.textContent=lp+'%';
    
    if(lp===100&&!layer.querySelector('.road-badge-anim')){
      const badge=document.createElement('span');badge.className='road-badge-anim';badge.textContent='🏆';
      const h3=layer.querySelector('h3');if(h3)h3.appendChild(badge);
    }
  }
  
  const _ja=S.lang==='ja';
  const ms=[{at:25,icon:'🌱',t:_ja?'25% 達成！':'25% reached!'},{at:50,icon:'🔥',t:_ja?'50% 達成！':'50% reached!'},{at:75,icon:'⚡',t:_ja?'75% 達成！':'75% reached!'},{at:100,icon:'🏆',t:_ja?'全完了！🎉':'All complete! 🎉'}];
  const prev=parseInt(roadState._lastPct||'0');
  ms.forEach(m=>{if(pct>=m.at&&prev<m.at)toast(m.icon+' '+m.t);});
  roadState._lastPct=pct;
  _lsSet('devforge-road-'+S.projectName,JSON.stringify(roadState));
  
  clearTimeout(window._roadDebounce);
  window._roadDebounce=setTimeout(()=>showRoadmapUI(),300);
}
function toggleRoadCollapse(li){
  const colState=JSON.parse((_lsGet('devforge-road-col-'+S.projectName))||'{}');
  const items=$('roadItems'+li);
  if(!items)return;
  const isCollapsed=items.classList.contains('road-collapsed');
  items.classList.toggle('road-collapsed');
  const icon=items.parentElement.querySelector('.road-collapse-icon');
  if(icon)icon.textContent=isCollapsed?'▼':'▶';
  if(isCollapsed){colState['_open_'+li]=true;delete colState[li];}
  else{colState[li]=true;delete colState['_open_'+li];}
  _lsSet('devforge-road-col-'+S.projectName,JSON.stringify(colState));
}
function expandAllRoadLayers(){
  _lsRm('devforge-road-col-'+S.projectName);
  showRoadmapUI();
}
function exportRoadmapMD(){
  const _ja=S.lang==='ja';
  const layers=window._roadLayers;if(!layers)return;
  let md='# '+(_ja?'ロードマップ':'Roadmap')+' — '+S.projectName+'\n\n';
  layers.forEach(l=>{
    const done=l.items.filter(i=>i.done).length;
    md+='## '+l.name+' ('+done+'/'+l.items.length+')\n';
    l.items.forEach(it=>{
      md+='- ['+(it.done?'x':' ')+'] '+it.text+(it.hrs?' ('+it.hrs+'h)':'')+(it.wk?' — '+it.wk:'')+'\n';
    });
    md+='\n';
  });
  navigator.clipboard.writeText(md).then(()=>toast(_ja?'✅ Markdownをコピーしました':'✅ Markdown copied')).catch(()=>toast(_ja?'❌ コピー失敗':'❌ Copy failed'));
}
function resetRoadmap2(){
  _lsRm('devforge-road-'+S.projectName);
  _lsRm('devforge-road-col-'+S.projectName);
  showRoadmapUI();
}
function saveTemplate(){
  const _ja=S.lang==='ja';
  const templates=JSON.parse(_lsGet('devforge-templates')||'[]');
  const tpl={name:S.projectName,answers:{...S.answers},preset:S.preset,date:new Date().toISOString()};
  templates.push(tpl);
  _lsSet('devforge-templates',JSON.stringify(templates));
  addMsg('bot',_ja?`💾 テンプレート「${S.projectName}」を保存しました。次回起動時に読み込めます。`:`💾 Template "${S.projectName}" saved. Load it next time.`);
}
function loadTemplateList(){
  const templates=JSON.parse(_lsGet('devforge-templates')||'[]');
  if(templates.length===0)return;
  const row=$('presetRow');
  templates.forEach((tpl,i)=>{
    const c=document.createElement('div');c.className='prchip';
    c.textContent='💾 '+tpl.name;
    c.onclick=()=>{
      S.preset='custom';S.answers={...tpl.answers};
      $('nameIn').value=tpl.name;
      document.querySelectorAll('.prchip').forEach(x=>x.classList.remove('on'));c.classList.add('on');
    };
    row.appendChild(c);
  });
}
function shareURL(){
  const _ja=S.lang==='ja';
  const data={p:S.projectName,a:S.answers,pr:S.preset};
  const encoded=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  const url=location.origin+location.pathname+'#df='+encoded;
  navigator.clipboard.writeText(url).then(()=>{
    addMsg('bot',_ja?`🔗 URLをクリップボードにコピーしました。このURLを共有すると同じ設定で開けます。`:`🔗 URL copied to clipboard. Share it to open with the same settings.`);
  }).catch(()=>{
    addMsg('bot',`🔗 ${_ja?'共有URL':'Share URL'}:\n${url}`);
  });
}
function showManual(sec){
  const o=$('helpOverlay');o.classList.add('show');
  pushModal(o,()=>{o.classList.remove('show');releaseFocus(o);});
  const _ja=S.lang==='ja';
  const MANUAL=[
    {id:'overview',title:_ja?'概要':'Overview',body:_ja?'<h2>DevForge v9.0 とは</h2><p>質問に答えるだけで、プロジェクトに必要な68+ファイルを自動生成するAI駆動開発プラットフォームです。'+_TECH_COUNT+'テクノロジー対応。</p>'+
      '<h3>10の柱</h3><table><tr><th>柱</th><th>内容</th><th>ファイル数</th></tr><tr><td>①SDD統合</td><td>Spec Kit互換の仕様書</td><td>5</td></tr><tr><td>②DevContainer</td><td>Docker開発環境</td><td>4</td></tr><tr><td>③MCP設定</td><td>Model Context Protocol</td><td>3</td></tr><tr><td>④AIルール</td><td>10+ツール設定+スキル</td><td>10+</td></tr>'+
      '<tr><td>⑤並列探索</td><td>スタック比較+おすすめランキング</td><td>UI</td></tr><tr><td>⑥Dashboard</td><td>コンテキスト可視化+技術DB</td><td>UI</td></tr><tr><td>⑦ロードマップ</td><td>学習パス（インタラクティブ）</td><td>9+UI</td></tr><tr><td>⑧AIランチャー</td><td>プロンプトテンプレート+トークン推定</td><td>UI</td></tr><tr><td>⑨デザインシステム</td><td>デザイントークン+シーケンス図</td><td>2</td></tr><tr><td>⑩リバースEng</td><td>ゴール逆算型プランニング</td><td>2</td></tr></table>'+
      '<p>+ docs（31仕様書）+ 共通ファイル（4）= <strong>69+ファイル</strong></p>':'<h2>What is DevForge v9.0?</h2><p>An AI-driven dev platform that auto-generates 69+ project files just by answering questions. Supports '+_TECH_COUNT+' technologies.</p>'+
      '<h3>10 Pillars</h3><table><tr><th>Pillar</th><th>Content</th><th>Files</th></tr><tr><td>①SDD</td><td>Spec Kit compatible specs</td><td>5</td></tr><tr><td>②DevContainer</td><td>Docker dev environment</td><td>4</td></tr><tr><td>③MCP</td><td>Model Context Protocol</td><td>3</td></tr><tr><td>④AI Rules</td><td>10+ tool configs + skills</td><td>10+</td></tr>'+
      ''+
      '<tr><td>⑤Explorer</td><td>Stack comparison + recommendation</td><td>UI</td></tr><tr><td>⑥Dashboard</td><td>Context visualization + Tech DB</td><td>UI</td></tr><tr><td>⑦Roadmap</td><td>Learning path (interactive)</td><td>9+UI</td></tr><tr><td>⑧AI Launcher</td><td>Prompt templates + token estimation</td><td>UI</td></tr><tr><td>⑨Design System</td><td>Design tokens + Sequence diagrams</td><td>2</td></tr><tr><td>⑩Reverse Eng</td><td>Goal-driven reverse planning</td><td>2</td></tr></table>'+
      '<p>+ docs (31 specs) + common (4) = <strong>69+ files</strong></p>'},
    {id:'start',title:_ja?'はじめ方':'Getting Started',body:_ja?
      '<h2>はじめ方</h2><p>1. スキルレベルを選択（Beginner/Intermediate/Pro）<br>2. プロジェクト名を入力<br>3. テンプレート選択（任意・36種類）<br>4. Phase 1-3の質問に回答（スキップ＆後で回答可）<br>5. 生成ボタンで67+ファイル作成<br>6. ZIPダウンロードまたはPDF印刷</p>'+
      '<h3>UX機能</h3>'+
      '<p>• 🌱⚡🔥 スキルレベルで質問の選択肢が動的変化<br>• 🎯 36プリセットテンプレート<br>• ✎ 回答の編集（✎ボタン）<br>• ⏭️ スキップ＆後で回答<br>• 📊 複雑度分析（0-100スコア）<br>• 📁 プロジェクト管理（Ctrl+M）<br>• 🎙️ 音声入力<br>• ? 質問ごとのヘルプアイコン<br>• 🔀 ドラッグ&ドロップ優先度ソート</p>'+
      '<h3>V8 新機能</h3>'+
      '<p>• 📱 モバイル開発パス (Expo/React Native)<br>• 🤖 AI自律開発ガイド (Vibe Coding/マルチAgent)<br>• 💳 決済・CMS・EC統合ガイド<br>• ⚡ 並列スタック比較 (7パターン)<br>• 📊 技術マスターテーブル / Tech Master Table ('+_TECH_COUNT+' entries)<br>• 🗺️ インタラクティブロードマップ (進捗管理)</p>'+
      '<h3>V8.3 新機能</h3>'+
      '<p>• 📊 Mermaid図ライブレンダリング (ER図・画面遷移・ガント)<br>• 📝 OpenAPI準拠API仕様書<br>• ✅ テストケースマトリクス (機能×正常/異常)<br>• 📋 リリースチェックリスト (デプロイ先別動的生成)<br>• 🔨 WBS 3階層+工数見積り<br>• 🎯 プロンプトプレイブック (フェーズ別AI投入プロンプト集)<br>• 📎 GitHub Issues風タスク分解<br>• 📋 全ファイル結合コピー (AI一括投入用)</p>'
      :
      '<h2>Getting Started</h2><p>1. Select your skill level (Beginner/Intermediate/Pro)<br>2. Enter project name<br>3. Choose a template (optional, 36 types)<br>4. Answer Phase 1-3 questions (skip & answer later OK)<br>5. Click Generate for 66+ files<br>6. Download ZIP or print PDF</p>'+
      '<h3>UX Features</h3>'+
      '<p>• 🌱⚡🔥 Dynamic options by skill level<br>• 🎯 36 preset templates<br>• ✎ Edit answers (✎ button)<br>• ⏭️ Skip & answer later<br>• 📊 Complexity analysis (0-100 score)<br>• 📁 Project manager (Ctrl+M)<br>• 🎙️ Voice input<br>• ? Help icon per question<br>• 🔀 Drag & drop priority sort</p>'+
      '<h3>V8 Features</h3>'+
      '<p>• 📱 Mobile dev path (Expo/React Native)<br>• 🤖 AI autonomous guide (Vibe Coding/Multi-Agent)<br>• 💳 Payment/CMS/EC integration<br>• ⚡ Parallel stack comparison (7 patterns)<br>• 📊 Tech Master Table ('+_TECH_COUNT+' entries)<br>• 🗺️ Interactive roadmap (progress tracking)</p>'+
      '<h3>V8.3 Features</h3>'+
      '<p>• 📊 Mermaid diagram live rendering (ER/screen flow/Gantt)<br>• 📝 OpenAPI-compliant API specs<br>• ✅ Test case matrix (feature × normal/abnormal)<br>• 📋 Release checklist (per deploy target)<br>• 🔨 WBS 3-level + effort estimation<br>• 🎯 Prompt playbook (phase-specific AI prompts)<br>• 📎 GitHub Issues-style task breakdown<br>• 📋 Copy all files combined (for bulk AI input)</p>'
    },
    {id:'pillars',title:_ja?'10の柱':'10 Pillars',body:_ja?
      '<h2>10の柱の詳細</h2><h3>① SDD統合 (5ファイル)</h3>'+
      '<p>constitution.md / specification.md / technical-plan.md / tasks.md / verification.md</p>'+
      '<h3>② DevContainer (4ファイル)</h3>'+
      '<p>devcontainer.json / Dockerfile / docker-compose.yml / post-create.sh — VSCode/Cursorで開くだけ。</p>'+
      '<h3>③ MCP設定 (3ファイル)</h3>'+
      '<p>project-context.md / tools-manifest.json / mcp-config.json</p>'+
      '<h3>④ AIルール (12+ファイル)</h3>'+
      '<p>Cursor / Antigravity / Claude Code (CLAUDE.md, AGENTS.md) / Copilot / Windsurf / Cline / Kiro / Codex / Skills (project/catalog/pipelines) / Hooks</p>'+
      '<h3>⑤ 並列実装探索 (UI)</h3>'+
      '<p>7パターンのスタックを2つ選んで比較。開発速度・スケーラビリティ・学習容易性・エコシステムで評価。</p>'+
      '<h3>⑥ Context Dashboard (UI)</h3>'+
      '<p>トークン数・モデル適合度・ファイルサイズ分布・技術マスターテーブル('+_TECH_COUNT+')を一覧表示。</p>'+
      '<h3>⑦ ロードマップ (9ファイル+UI)</h3>'+
      '<p>LEARNING_PATH / TECH_STACK_GUIDE / MOBILE_GUIDE / TOOLS_SETUP / RESOURCES / MILESTONES / AI_WORKFLOW / AI_AUTONOMOUS / SAAS_COMMERCE_GUIDE — インタラクティブUIで進捗管理可能。</p>'+
      '<h3>⑧ AIプロンプトランチャー (UI)</h3>'+
      '<p>生成した仕様書をAIツールに一括投入。6つのプロンプトテンプレート（レビュー・実装・テスト・リファクタ・セキュリティ・ドキュメント）。フォルダ別トークン推定・モデル適合度表示。</p>'+
      '<h3>⑨ デザインシステム (2ファイル)</h3>'+
      '<p>design_system.md (デザイントークン・色・タイポ・コンポーネントカタログ) / sequence_diagrams.md (認証・CRUD・決済フローのMermaidシーケンス図) — フレームワーク別実装ガイド。</p>'+
      '<h3>⑩ リバースエンジニアリング (2ファイル)</h3>'+
      '<p>reverse_engineering.md (ゴール定義→逆算フロー・マイルストーンGantt・リスク分析) / goal_decomposition.md (ゴールツリー・サブゴール分解・ギャップ分析・優先度マトリクス・依存関係チェーン) — 15ドメイン対応の逆算型プランニング。</p>'
      :
      '<h2>10 Pillars in Detail</h2><h3>① SDD Integration (5 files)</h3>'+
      '<p>constitution.md / specification.md / technical-plan.md / tasks.md / verification.md</p>'+
      '<h3>② DevContainer (4 files)</h3>'+
      '<p>devcontainer.json / Dockerfile / docker-compose.yml / post-create.sh — Just open in VS Code/Cursor.</p>'+
      '<h3>③ MCP Config (3 files)</h3>'+
      '<p>project-context.md / tools-manifest.json / mcp-config.json</p>'+
      '<h3>④ AI Rules (12+ files)</h3>'+
      '<p>Cursor / Antigravity / Claude Code (CLAUDE.md, AGENTS.md) / Copilot / Windsurf / Cline / Kiro / Codex / Skills (project/catalog/pipelines) / Hooks</p>'+
      '<h3>⑤ Parallel Explorer (UI)</h3>'+
      '<p>Compare 2 of 7 stack patterns. Scored by dev speed, scalability, learning curve, and ecosystem.</p>'+
      '<h3>⑥ Context Dashboard (UI)</h3>'+
      '<p>Token counts, model fit, file size distribution, and Tech Master Table ('+_TECH_COUNT+') at a glance.</p>'+
      '<h3>⑦ Roadmap (9 files + UI)</h3>'+
      '<p>LEARNING_PATH / TECH_STACK_GUIDE / MOBILE_GUIDE / TOOLS_SETUP / RESOURCES / MILESTONES / AI_WORKFLOW / AI_AUTONOMOUS / SAAS_COMMERCE_GUIDE — Interactive UI for progress tracking.</p>'+
      '<h3>⑧ AI Prompt Launcher (UI)</h3>'+
      '<p>Bulk-feed generated specs to AI tools. 6 prompt templates (Review, Implement, Test, Refactor, Security, Docs). Per-folder token estimation and model fit display.</p>'+
      '<h3>⑨ Design System (2 files)</h3>'+
      '<p>design_system.md (design tokens, colors, typography, component catalog) / sequence_diagrams.md (auth, CRUD, payment Mermaid sequence diagrams) — Framework-specific guides.</p>'+
      '<h3>⑩ Reverse Engineering (2 files)</h3>'+
      '<p>reverse_engineering.md (goal definition → reverse flow, milestone Gantt, risk analysis) / goal_decomposition.md (goal tree, sub-goal breakdown, gap analysis, priority matrix, dependency chain) — 15 domain-specific reverse planning.</p>'
    },
    {id:'export',title:_ja?'エクスポート':'Export',body:_ja?
      '<h2>エクスポート方法</h2><p><strong>ZIP</strong>: 全68+ファイルをフォルダ構造付きでZIP圧縮ダウンロード。<br><strong>PDF</strong>: Markdownファイルを整形してブラウザのPDF印刷で出力。<br><strong>URL共有</strong>: プロジェクト設定をBase64エンコードしてURL共有。<br><strong>全ファイルコピー</strong>: 全ドキュメントを1テキストに結合してクリップボードにコピー（Ctrl+Shift+C）。AIへの一括投入に最適。</p><h3>テンプレート保存</h3><p>プロジェクト設定をlocalStorageに保存し、次回起動時に読み込み可能。</p>'
      :
      '<h2>Export Methods</h2><p><strong>ZIP</strong>: Download all 68+ files as a ZIP with folder structure.<br><strong>PDF</strong>: Format Markdown files and print via browser PDF.<br><strong>URL Sharing</strong>: Base64-encode project settings and share via URL.<br><strong>Copy All Files</strong>: Combine all documents into one text and copy to clipboard (Ctrl+Shift+C). Ideal for bulk AI input.</p><h3>Template Save</h3><p>Save project settings to localStorage and load them on next launch.</p>'
    },
    {id:'guide',title:_ja?'🚀 活用ガイド':'🚀 Usage Guide',body:_ja?
      '<h2>🚀 生成ファイル活用ガイド</h2>'+
      '<p>DevForge v9 は世界で唯一の<strong>仕様駆動AIプロジェクトジェネレーター</strong>です。他のツールが「コード」を生成するのに対し、DevForge は「開発の知性」── 設計・環境・ルール・学習計画を68+ファイルで生成します。</p>'+
      '<h3>🌱 Beginner — まず動かす</h3>'+
      '<p><strong>Step 1: ロードマップに従う</strong><br>ダッシュボード（柱⑦）のロードマップUIがそのまま学習計画。Layer 1から順にチェック。📖ボタンで公式ドキュメントに直接ジャンプ。</p>'+
      '<p><strong>Step 2: 3つだけ覚える</strong><br>• <code>README.md</code> — GitHubにそのまま公開OK<br>• <code>.devcontainer/</code> — VS Code/Cursorで開くだけで環境完成<br>• <code>CLAUDE.md</code> — AIに「これ読んで」で全仕様を理解</p>'+
      '<p><strong>Step 3: AIに丸ごと渡す</strong><br>「全ファイルコピー」(Ctrl+Shift+C) → AI に貼り付け → 仕様を把握した状態で開発スタート。</p>'+
      '<div class="hg-flow"><span class="hg-n hg-b">DevForge<br>生成</span><span class="hg-a">→</span><span class="hg-n hg-c">Ctrl+Shift+C<br>コピー</span><span class="hg-a">→</span><span class="hg-n hg-p">AI貼付<br>Cursor等</span><span class="hg-a">→</span><span class="hg-n hg-g">開発<br>スタート</span></div>'+
      '<h3>🔥 Intermediate — 効率を極める</h3>'+
      '<p><strong>SDD仕様駆動開発:</strong> <code>.spec/</code> がプロジェクトのSSoT（信頼できる唯一の情報源）。constitution.md(憲法) → specification.md(要件) → tasks.md(タスク) → verification.md(完了基準)。AIへの指示は「tasks.mdの○○を実装して」の一文で完結。</p>'+
      '<div class="hg-flow"><span class="hg-n hg-b">constitution<br>原則</span><span class="hg-a">→</span><span class="hg-n hg-c">specification<br>要件</span><span class="hg-a">→</span><span class="hg-n hg-p">tasks<br>タスク</span><span class="hg-a">→</span><span class="hg-n hg-g">verification<br>完了基準</span></div>'+
      '<p><strong>マルチAIツール統一:</strong> 柱④で生成される10ファイルがCursor/.cursor/rules、Claude Code/CLAUDE.md、Copilot/.github/copilot-instructions.md、Windsurf/.windsurfrules、Cline/.clinerules、Gemini/.gemini/settings.json等を同時カバー。どのツールに乗り換えても同じルール。</p>'+
      '<p><strong>MCP拡張:</strong> mcp-config.jsonをプロジェクトルートに配置 → context7(最新ドキュメント)、filesystem(構造把握)、playwright(E2Eテスト)等をAIが即利用。</p>'+
      '<h3>⚡ Professional — 自動化を支配する</h3>'+
      '<p><strong>Agent Teams並列開発:</strong> AGENTS.mdでエージェント役割を定義 → Claude Code Subagents / Antigravity Manager View で並列実行。tasks.mdがタスクキューとして機能。</p>'+
      '<p><strong>CI/CDゲート化:</strong> .ai/hooks.yml → GitHub Actions変換。docs/09_release_checklist.mdをデプロイゲートに。verification.mdを品質基準に。</p>'+
      '<p><strong>6工程自動パイプライン:</strong> 柱⑧の6テンプレートを順番実行 → 📋仕様レビュー → 🔨実装 → 🧪テスト → ♻️リファクタ → 🔒セキュリティ → 📝ドキュメント更新。仕様書が全工程の入力。</p>'+
      '<h3>⚔️ 他ツールとの比較</h3>'+
      '<table><tr><th>機能</th><th>DevForge v9</th><th>create-next-app</th><th>AI直接依頼</th></tr>'+
      '<tr><td>SDD仕様書5点</td><td>✅ 自動</td><td>✗</td><td>△ 手動</td></tr>'+
      '<tr><td>10ツールAIルール</td><td>✅ 自動</td><td>✗</td><td>✗</td></tr>'+
      '<tr><td>互換性チェック</td><td>✅ 自動</td><td>✗</td><td>✗</td></tr>'+
      '<tr><td>ロードマップ</td><td>✅ 自動</td><td>✗</td><td>△ 手動</td></tr>'+
      '<tr><td>DevContainer</td><td>✅ 自動</td><td>✗</td><td>△ 手動</td></tr>'+
      '<tr><td>MCP+Agent設定</td><td>✅ 自動</td><td>✗</td><td>✗</td></tr>'+
      '<tr><td>'+_TECH_COUNT+' Tech DB</td><td>✅ 内蔵</td><td>✗</td><td>✗</td></tr>'+
      '<tr><td>オフライン動作</td><td>✅</td><td>✅</td><td>✗</td></tr></table>'+
      '<h3>📋 ファイル活用マップ</h3>'+
      '<table><tr><th>ファイル</th><th>🌱初心者</th><th>🔥中級者</th><th>⚡上級者</th></tr>'+
      '<tr><td><code>CLAUDE.md</code></td><td>そのまま</td><td>カスタマイズ</td><td>Agent共有設定</td></tr>'+
      '<tr><td><code>.spec/</code></td><td>読むだけ</td><td>AIに1つずつ</td><td>タスクキュー化</td></tr>'+
      '<tr><td><code>.devcontainer/</code></td><td>そのまま</td><td>カスタマイズ</td><td>チーム標準化</td></tr>'+
      '<tr><td><code>roadmap/</code></td><td>学習ガイド</td><td>進捗管理</td><td>オンボーディング</td></tr>'+
      '<tr><td><code>docs/</code> 30ファイル</td><td>後で参照</td><td>レビュー素材</td><td>CI/CDゲート</td></tr>'+
      '<tr><td><code>docs/29_reverse_engineering</code></td><td>読むだけ</td><td>逆算計画</td><td>マイルストーン管理</td></tr>'+
      '<tr><td><code>docs/30_goal_decomposition</code></td><td>後で参照</td><td>優先順位付け</td><td>タスク依存分析</td></tr>'+
      '<tr><td>柱④ AIルール</td><td>触らない</td><td>ルール追加</td><td>全ツール統一</td></tr>'+
      '<tr><td>柱⑧ ランチャー</td><td>使わない</td><td>部分利用</td><td>全工程自動化</td></tr>'+
      '<tr><td><code>.mcp/ + config</code></td><td>後で</td><td>そのまま</td><td>カスタムMCP</td></tr>'+
      '<tr><td><code>AGENTS.md</code></td><td>不要</td><td>参照</td><td>並列Agent</td></tr>'+
      '<tr><td><code>.ai/hooks.yml</code></td><td>不要</td><td>参照</td><td>CI/CD統合</td></tr></table>'+
      '<p class="guide-action-p"><button class="btn btn-p btn-sm" onclick="closeManual();showPostGenGuide(true)">🚀 レベル別ガイドを表示</button></p>'
      :
      '<h2>🚀 Generated Files Usage Guide</h2>'+
      '<p>DevForge v9 is the world\'s only <strong>spec-driven AI project generator</strong>. While other tools generate code, DevForge generates "development intelligence" — design, environment, rules, and learning plans through 69+ files.</p>'+
      '<h3>🌱 Beginner — Get Started</h3>'+
      '<p><strong>Step 1: Follow the Roadmap</strong><br>The Dashboard (Pillar ⑦) roadmap UI is your learning plan. Check off from Layer 1. Hit 📖 to jump to official docs.</p>'+
      '<p><strong>Step 2: Remember Just 3 Files</strong><br>• <code>README.md</code> — Publish directly to GitHub<br>• <code>.devcontainer/</code> — Open in VS Code/Cursor and dev env is ready<br>• <code>CLAUDE.md</code> — Tell AI "read this" and it understands your entire project</p>'+
      '<p><strong>Step 3: Feed Everything to AI</strong><br>"Copy All Files" (Ctrl+Shift+C) → Paste into AI → Start coding with full project context.</p>'+
      '<div class="hg-flow"><span class="hg-n hg-b">DevForge<br>Generate</span><span class="hg-a">→</span><span class="hg-n hg-c">Ctrl+Shift+C<br>Copy</span><span class="hg-a">→</span><span class="hg-n hg-p">Paste to<br>AI Tool</span><span class="hg-a">→</span><span class="hg-n hg-g">Start<br>Coding</span></div>'+
      '<h3>🔥 Intermediate — Maximize Efficiency</h3>'+
      '<p><strong>SDD Workflow:</strong> <code>.spec/</code> is your SSoT. constitution.md(principles) → specification.md(requirements) → tasks.md(tasks) → verification.md(acceptance criteria). Tell AI: "implement task X from tasks.md following specification.md".</p>'+
      '<p><strong>Multi-AI Tool Unity:</strong> Pillar ④ generates 10 files covering Cursor, Claude Code, Copilot, Windsurf, Cline, Gemini etc. Same rules regardless of which tool you use.</p>'+
      '<p><strong>MCP Extension:</strong> Place mcp-config.json in project root → AI instantly uses context7, filesystem, playwright MCPs.</p>'+
      '<h3>⚡ Professional — Master Automation</h3>'+
      '<p><strong>Agent Teams:</strong> AGENTS.md defines agent roles → Run with Claude Code Subagents / Antigravity Manager View. tasks.md serves as task queue.</p>'+
      '<p><strong>CI/CD Gates:</strong> .ai/hooks.yml → GitHub Actions. docs/09_release_checklist.md as deploy gate. verification.md as quality baseline.</p>'+
      '<p><strong>6-Stage Pipeline:</strong> Pillar ⑧ templates in sequence → 📋Review → 🔨Implement → 🧪Test → ♻️Refactor → 🔒Security → 📝Docs update.</p>'+
      '<h3>⚔️ Comparison with Other Tools</h3>'+
      '<table><tr><th>Feature</th><th>DevForge v9</th><th>create-next-app</th><th>AI Direct</th></tr>'+
      '<tr><td>SDD 5 Spec Docs</td><td>✅ Auto</td><td>✗</td><td>△ Manual</td></tr>'+
      '<tr><td>10-Tool AI Rules</td><td>✅ Auto</td><td>✗</td><td>✗</td></tr>'+
      '<tr><td>Compat Check</td><td>✅ Auto</td><td>✗</td><td>✗</td></tr>'+
      '<tr><td>Roadmap</td><td>✅ Auto</td><td>✗</td><td>△ Manual</td></tr>'+
      '<tr><td>DevContainer</td><td>✅ Auto</td><td>✗</td><td>△ Manual</td></tr>'+
      '<tr><td>MCP+Agent Setup</td><td>✅ Auto</td><td>✗</td><td>✗</td></tr>'+
      '<tr><td>'+_TECH_COUNT+' Tech DB</td><td>✅ Built-in</td><td>✗</td><td>✗</td></tr>'+
      '<tr><td>Offline</td><td>✅</td><td>✅</td><td>✗</td></tr></table>'+
      '<h3>📋 File Usage Map</h3>'+
      '<table><tr><th>File</th><th>🌱Beginner</th><th>🔥Intermediate</th><th>⚡Pro</th></tr>'+
      '<tr><td><code>CLAUDE.md</code></td><td>As-is</td><td>Customize</td><td>Agent config</td></tr>'+
      '<tr><td><code>.spec/</code></td><td>Read only</td><td>Feed AI one by one</td><td>Task queue</td></tr>'+
      '<tr><td><code>.devcontainer/</code></td><td>As-is</td><td>Customize</td><td>Team standard</td></tr>'+
      '<tr><td><code>roadmap/</code></td><td>Learning</td><td>Progress</td><td>Onboarding</td></tr>'+
      '<tr><td><code>docs/</code> 28 files</td><td>Later</td><td>Review material</td><td>CI/CD gates</td></tr>'+
      '<tr><td>Pillar ④ AI Rules</td><td>Don\'t touch</td><td>Add rules</td><td>Unified ops</td></tr>'+
      '<tr><td>Pillar ⑧ Launcher</td><td>Skip</td><td>Partial use</td><td>Full pipeline</td></tr>'+
      '<tr><td><code>.mcp/ + config</code></td><td>Later</td><td>As-is</td><td>Custom MCP</td></tr>'+
      '<tr><td><code>AGENTS.md</code></td><td>Skip</td><td>Reference</td><td>Multi-Agent</td></tr>'+
      '<tr><td><code>.ai/hooks.yml</code></td><td>Skip</td><td>Reference</td><td>CI/CD Integration</td></tr></table>'+
      '<p class="guide-action-p"><button class="btn btn-p btn-sm" onclick="closeManual();showPostGenGuide(true)">🚀 Show Level Guide</button></p>'
    },
    {id:'techdb',title:_ja?'技術DB':'Tech DB',body:_ja?
      '<h2>技術マスターテーブル</h2><p>'+_TECH_COUNT+'テクノロジーを16カテゴリに分類。Context Dashboardから閲覧可能。</p><h3>カテゴリ一覧</h3><p>言語 / フロントエンド / モバイル / バックエンド / BaaS / 決済・CMS・EC / DevOps / AIツール / AI自律 / 手法 / テスト / API / ビルド / データ / セキュリティ</p><h3>フィルタ機能</h3><p>カテゴリ / 必須度 / キーワード検索で絞り込み可能。</p>'
      :
      '<h2>Tech Master Table</h2><p>'+_TECH_COUNT+' technologies classified into 16 categories. Browse from Context Dashboard.</p><h3>Categories</h3><p>Languages / Frontend / Mobile / Backend / BaaS / Payment・CMS・EC / DevOps / AI Tools / AI Autonomous / Methodologies / Testing / API / Build / Data / Security</p><h3>Filter</h3><p>Filter by category, requirement level, or keyword search.</p>'
    },
    {id:'keys',title:_ja?'ショートカット':'Shortcuts',body:_ja?
      '<h2>キーボードショートカット</h2><table><tr><td><code>F1</code> / <code>Ctrl+H</code></td><td>ヘルプ表示</td></tr><tr><td><code>Ctrl+K</code></td><td>ショートカット一覧</td></tr><tr><td><code>Ctrl+T</code></td><td>テーマ切替</td></tr><tr><td><code>Ctrl+L</code></td><td>言語切替</td></tr><tr><td><code>Ctrl+E</code></td><td>エクスポート</td></tr><tr><td><code>Ctrl+Shift+C</code></td><td>全ファイルコピー</td></tr><tr><td><code>Ctrl+M</code></td><td>プロジェクト管理</td></tr><tr><td><code>Escape</code></td><td>モーダルを閉じる</td></tr></table>'
      :
      '<h2>Keyboard Shortcuts</h2><table><tr><td><code>F1</code> / <code>Ctrl+H</code></td><td>Open help</td></tr><tr><td><code>Ctrl+K</code></td><td>Shortcut list</td></tr><tr><td><code>Ctrl+T</code></td><td>Toggle theme</td></tr><tr><td><code>Ctrl+L</code></td><td>Toggle language</td></tr><tr><td><code>Ctrl+E</code></td><td>Export</td></tr><tr><td><code>Ctrl+Shift+C</code></td><td>Copy all files</td></tr><tr><td><code>Ctrl+M</code></td><td>Project manager</td></tr><tr><td><code>Escape</code></td><td>Close modal</td></tr></table>'
    },
    {id:'caution',title:_ja?'⚠️ 注意事項':'⚠️ Cautions',body:_ja?
      '<h2>使用上の注意・留意点</h2>'+
      '<h3>🔴 データ保存について</h3>'+
      '<p>全データはブラウザの<strong>localStorage</strong>に保存されます。以下の操作で<strong>全データが消失</strong>します:</p>'+
      '<p>・ブラウザの「閲覧履歴を消去」→「Cookieとサイトデータ」を削除<br>・シークレット/プライベートモードでの使用<br>・ブラウザや端末の変更</p>'+
      '<p>→ 対策: 作業後は必ず<strong>📤 JSONエクスポート</strong>と<strong>📦 ZIPダウンロード</strong>で保存してください。</p>'+
      '<h3>🔴 ストレージ上限</h3>'+
      '<p>localStorageの上限は約5MBです。20〜30プロジェクトで上限に達する可能性があります。古いプロジェクトはエクスポート後に削除してください。</p>'+
      '<h3>🟡 生成ファイルについて</h3>'+
      '<p>生成される66+ファイルは<strong>設計ドキュメント</strong>（SDD仕様書・DevContainer設定・AIルール等）です。npm installで即座に動くアプリケーションコードではありません。Claude Code / Cursor等のAIツールに入力して実コードを生成する運用が前提です。</p>'+
      '<h3>🟡 スキルレベル</h3>'+
      '<p>スキルレベルにより表示される選択肢が変わります。途中変更すると既回答との不整合が起きうるため、<strong>最初に正しく設定</strong>してください。</p>'+
      '<h3>🟡 言語切り替え</h3>'+
      '<p>UIの日英切り替えは即座に反映されますが、<strong>生成済みファイルの内容は切り替わりません</strong>。英語ドキュメントが必要な場合は生成時の言語選択で明示的に選んでください。</p>'+
      '<h3>🔵 その他</h3>'+
      '<p>・ZIPエクスポートはCDN経由のJSZipに依存します（オフライン時は「全ファイルコピー」Ctrl+Shift+Cで代替）<br>・PDF出力時はライトモード推奨（ダーク背景がそのまま印刷されます）<br>・URL共有は回答が多いとURLが長くなりSNS等で切れる場合があります</p>'
      :
      '<h2>Usage Cautions & Notes</h2>'+
      '<h3>🔴 Data Storage</h3>'+
      '<p>All data is stored in <strong>localStorage</strong>. Data will be <strong>lost</strong> if you:</p>'+
      '<p>・Clear browser data (cookies & site data)<br>・Use incognito/private mode<br>・Switch browsers or devices</p>'+
      '<p>→ Always <strong>📤 Export JSON</strong> and <strong>📦 Download ZIP</strong> after work.</p>'+
      '<h3>🔴 Storage Limit</h3>'+
      '<p>localStorage limit is ~5MB. You may reach the limit with 20-30 projects. Export and delete old projects.</p>'+
      '<h3>🟡 Generated Files</h3>'+
      '<p>66+ generated files are <strong>design documents</strong> (SDD specs, DevContainer configs, AI rules). They are not runnable app code. Feed them to AI tools like Claude Code / Cursor to generate actual code.</p>'+
      '<h3>🟡 Skill Level</h3>'+
      '<p>Changing skill level mid-project may cause inconsistencies with existing answers. <strong>Set it correctly at the start.</strong></p>'+
      '<h3>🟡 Language Switch</h3>'+
      '<p>UI language switches instantly, but <strong>generated file contents do not change</strong>. Choose the language explicitly during generation.</p>'+
      '<h3>🔵 Other</h3>'+
      '<p>・ZIP export requires JSZip via CDN (use "Copy All" Ctrl+Shift+C offline)<br>・Switch to light mode before PDF export<br>・URL sharing may truncate on SNS for complex projects</p>'
    },
    {id:'about',title:'About',body:'<h2>DevForge v9.0</h2><p>'+(_ja?'AI駆動開発 統合プラットフォーム':'AI-Driven Dev Platform')+'</p><p>Version 9.0.0 — 2026 Edition (Modular Architecture)</p><p>'+(_ja?''+_TECH_COUNT+'テクノロジー ・ 66+ファイル ・ 9つの柱 ・ 36テンプレート ・ Mermaid図 ・ プロンプトプレイブック':''+_TECH_COUNT+' technologies ・ 66+ files ・ 9 pillars ・ 36 templates ・ Mermaid diagrams ・ Prompt playbook')+'</p><p>© 2026 エンジニアリングのタネ制作委員会<br>by にしあん</p>'},
  ];
  const nav=$('helpNav');
  const searchEl=$('helpSearch');
  while(nav.lastChild&&nav.lastChild!==searchEl)nav.removeChild(nav.lastChild);
  if(searchEl)searchEl.value='';
  window._manual=MANUAL;
  MANUAL.forEach(s=>{
    const a=document.createElement('a');a.textContent=s.title;a.href='#';a.dataset.id=s.id;
    a.onclick=e=>{e.preventDefault();$('helpBody').innerHTML=s.body;document.querySelectorAll('.help-nav a').forEach(x=>x.classList.remove('on'));a.classList.add('on');};
    if(s.id===(sec||'overview'))a.classList.add('on');
    nav.appendChild(a);
  });
  $('helpBody').innerHTML=MANUAL.find(s=>s.id===(sec||'overview')).body;
  trapFocus(o);
}
function filterManual(q){
  if(!window._manual)return;
  const links=document.querySelectorAll('#helpNav a');
  const term=q.toLowerCase().trim();
  if(!term){
    links.forEach(a=>a.classList.remove('dim'));
    const active=document.querySelector('#helpNav a.on');
    if(active){const s=window._manual.find(m=>m.id===active.dataset.id);if(s)$('helpBody').innerHTML=s.body;}
    return;
  }
  let firstMatch=null;
  links.forEach(a=>{
    const s=window._manual.find(m=>m.id===a.dataset.id);
    if(!s)return;
    const text=(s.title+' '+s.body.replace(/<[^>]*>/g,'')).toLowerCase();
    const match=text.includes(term);
    a.classList.toggle('dim',!match);
    if(match&&!firstMatch)firstMatch=s;
  });
  if(firstMatch){
    const re=new RegExp('('+term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
    const highlighted=firstMatch.body.replace(/>([^<]+)</g,(m,txt)=>'>'+txt.replace(re,'<mark>$1</mark>')+'<');
    $('helpBody').innerHTML=highlighted;
    links.forEach(a=>{a.classList.remove('on');if(a.dataset.id===firstMatch.id)a.classList.add('on');});
  }
}
function closeManual(){const o=$('helpOverlay');o.classList.remove('show');releaseFocus(o);removeModal(o);}
function showKB(){const el=$('kbOverlay');el.classList.add('show');trapFocus(el);pushModal(el,()=>{el.classList.remove('show');releaseFocus(el);});}
function closeKB(){const el=$('kbOverlay');el.classList.remove('show');releaseFocus(el);removeModal(el);}
function mobSw(t){
  document.querySelectorAll('.mobtab').forEach(m=>m.classList.remove('on'));
  if(t==='c'){$('panC').classList.remove('hide');$('panP').classList.remove('show');document.querySelectorAll('.mobtab')[0].classList.add('on');}
  else{$('panC').classList.add('hide');$('panP').classList.add('show');document.querySelectorAll('.mobtab')[1].classList.add('on');}
}
function trapFocus(modalEl){
  const focusable=modalEl.querySelectorAll('button,input,select,textarea,a[href],[tabindex]:not([tabindex="-1"])');
  if(!focusable.length)return;
  const first=focusable[0];const last=focusable[focusable.length-1];
  function handler(e){
    if(e.key!=='Tab')return;
    if(e.shiftKey){if(document.activeElement===first){e.preventDefault();last.focus();}}
    else{if(document.activeElement===last){e.preventDefault();first.focus();}}
  }
  modalEl._trapHandler=handler;
  modalEl.addEventListener('keydown',handler);
  first.focus();
}
function releaseFocus(modalEl){
  if(modalEl._trapHandler){modalEl.removeEventListener('keydown',modalEl._trapHandler);delete modalEl._trapHandler;}
}
function announce(msg){
  let el=$('srAnnounce');
  if(!el){el=document.createElement('div');el.id='srAnnounce';el.setAttribute('role','status');el.setAttribute('aria-live','assertive');el.className='sr-only';document.body.appendChild(el);}
  el.textContent='';setTimeout(()=>{el.textContent=msg;},50);
}
const _modalStack=[];
function pushModal(el,closeFn){_modalStack.push({el,closeFn});}
function popModal(){
  const top=_modalStack.pop();
  if(top&&top.closeFn)top.closeFn();
  return !!top;
}
function removeModal(el){
  const idx=_modalStack.findIndex(m=>m.el===el);
  if(idx>=0)_modalStack.splice(idx,1);
}
document.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(k==='f1'||(e.ctrlKey&&k==='h')){e.preventDefault();showManual();}
  if(e.ctrlKey&&k==='k'){e.preventDefault();showKB();}
  if(e.ctrlKey&&k==='t'){e.preventDefault();toggleTheme();}
  if(e.ctrlKey&&k==='l'){e.preventDefault();toggleLang();}
  if(e.ctrlKey&&k==='e'){e.preventDefault();exportZIP();}
  if(e.ctrlKey&&e.shiftKey&&k==='c'){e.preventDefault();copyAllFiles();}
  if(e.ctrlKey&&k==='m'){e.preventDefault();showPM();}
  if(e.key==='Escape'){
    if(!popModal()){
      closeManual();closeHelpPopup();
      const co=$('confirmOverlay');if(co)co.style.display='none';
      const pm=$('pmOverlay');if(pm){pm.style.display='none';releaseFocus(pm);}
      const kb=$('kbOverlay');if(kb){kb.classList.remove('show');releaseFocus(kb);}
    }
  }
});
function _getTourSteps(){
  const _ja=S.lang==='ja';
  return [
  {title:_ja?'🌱 スキルレベル':'🌱 Skill Level',desc:_ja?'Beginner / Intermediate / Pro を選ぶと、質問の選択肢が自動調整されます。':'Choose Beginner / Intermediate / Pro to auto-adjust question options.'},
  {title:_ja?'📝 テンプレート':'📝 Templates',desc:_ja?'36種類のプリセットから選ぶと、回答が自動入力されます。':'Pick from 36 presets to auto-fill answers.'},
  {title:_ja?'💬 質問フロー':'💬 Q&A Flow',desc:_ja?'Phase 1-3 の質問に答えるだけ。スキップも後で回答も可能です。':'Just answer Phase 1-3 questions. Skip and answer later anytime.'},
  {title:_ja?'✎ 回答編集':'✎ Edit Answers',desc:_ja?'送信済みの回答に表示される ✎ ボタンで修正できます。':'Click the ✎ button on submitted answers to edit them.'},
  {title:_ja?'📦 60+ファイル生成':'📦 60+ File Generation',desc:_ja?'全質問回答後、9つの柱で60+ファイルが自動生成されます。':'After all questions, 60+ files auto-generate across 9 pillars.'},
  {title:_ja?'⚡ 並列探索':'⚡ Parallel Explorer',desc:_ja?'Pillar ⑤ で7スタックを比較。回答に基づくおすすめランキング付き。':'Compare 7 stacks in Pillar ⑤ with recommendation ranking based on your answers.'},
  {title:'📊 Dashboard',desc:_ja?'Pillar ⑥ でコンテキスト可視化＋'+_TECH_COUNT+'技術DBを閲覧。':'Visualize context + browse '+_TECH_COUNT+' tech DB in Pillar ⑥.'},
  {title:_ja?'🤖 AIランチャー':'🤖 AI Launcher',desc:_ja?'Pillar ⑧ で仕様書をAIツールにワンクリック投入。6テンプレート＋トークン推定。':'Feed specs to AI tools in one click from Pillar ⑧. 6 templates + token estimation.'},
  {title:_ja?'💾 データ保存の注意':'💾 Save Your Work',desc:_ja?'全データはブラウザのlocalStorageに保存されます。閲覧履歴の消去やブラウザ変更でデータが消失します。作業後は必ず📤 JSONエクスポートと📦 ZIPダウンロードで保存してください。':'All data is stored in browser localStorage. Clearing browser data or switching browsers will erase everything. Always export JSON 📤 and download ZIP 📦 after work.'},
  {title:_ja?'⚠️ 注意事項を確認':'⚠️ Read Cautions',desc:_ja?'ヘルプ（F1）の「⚠️ 注意事項」タブにスキルレベル設定・言語切替・ストレージ上限などの重要な注意点をまとめています。':'Check the "⚠️ Cautions" tab in Help (F1) for important notes on skill level, language switching, storage limits, and more.'},
  ];
}
let tourStep=-1;
function startTour(){
  const steps=_getTourSteps();
  if(steps.length===0)return;
  tourStep=0;showTourStep();
}
function showTourStep(){
  const tc=$('tourContainer');
  const steps=_getTourSteps();
  if(tourStep<0||tourStep>=steps.length){closeTour();return;}
  const step=steps[tourStep];
  const dots=steps.map((_,i)=>'<div class="tour-dot'+(i===tourStep?' on':'')+'"></div>').join('');
  tc.innerHTML='<div class="tour-card"><h4 class="tour-title">'+step.title+'</h4><p class="tour-desc">'+step.desc+'</p><div class="tour-dots">'+dots+'</div><div class="tour-acts" id="tourActs"></div></div>';
  const acts=$('tourActs');
  if(tourStep>0){const pb=document.createElement('button');pb.className='btn btn-g btn-xs';pb.textContent=t('tourPrev');pb.onclick=()=>{tourStep--;showTourStep();};acts.appendChild(pb);}
  const nb=document.createElement('button');nb.className='btn btn-p btn-xs';nb.textContent=tourStep===steps.length-1?t('tourDone'):t('tourNext');
  nb.onclick=()=>{tourStep++;showTourStep();};acts.appendChild(nb);
}
function closeTour(){tourStep=-1;$('tourContainer').innerHTML='';_lsSet('devforge-tour-done','1');}
window.onerror=(msg,src,line)=>{console.error('DevForge error:',{msg,src,line});toast('⚠️ '+msg);};
window.onunhandledrejection=e=>{console.error('Unhandled:',e.reason);toast('⚠️ '+(e.reason?.message||e.reason));};
let _mermaidReady=false;let _mermaidLoading=false;
let theme=_lsGet('devforge-theme')||'dark';
function _initMermaidTheme(){try{mermaid.initialize({startOnLoad:false,theme:theme==='light'?'default':'dark',securityLevel:'loose'});}catch(e){}}
function loadMermaid(cb){
  if(_mermaidReady){cb();return;}
  if(_mermaidLoading){setTimeout(()=>loadMermaid(cb),200);return;}
  _mermaidLoading=true;
  const s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js';
  s.onload=()=>{
    _initMermaidTheme();
    _mermaidReady=true;_mermaidLoading=false;cb();
  };
  s.onerror=()=>{_mermaidLoading=false;console.warn('Mermaid CDN load failed');cb();};
  document.head.appendChild(s);
}
function applyTheme(){document.documentElement.setAttribute('data-theme',theme);const btn=$('themeBtn');if(btn)btn.textContent=theme==='light'?'☀️':'🌙';if(_mermaidReady)_initMermaidTheme();}
function toggleTheme(){theme=theme==='light'?'dark':'light';_lsSet('devforge-theme',theme);applyTheme();}
function toggleLang(){S.lang=S.lang==='ja'?'en':'ja';save();applyLang();if(voiceRec)voiceRec.lang=S.lang==='ja'?'ja-JP':'en-US';}
function applyLang(){
  const l=S.lang;
  const ja=l==='ja';
  if($('heroTitle'))$('heroTitle').textContent=t('heroTitle');
  if($('heroDesc'))$('heroDesc').textContent=t('heroDesc');
  if($('startBtn'))$('startBtn').textContent=t('startBtn');
  ['statFiles','statTech','statPillars','statAI'].forEach(k=>{if($(k))$(k).textContent=t(k);});
  if($('statTechNum'))$('statTechNum').textContent=_TECH_COUNT;
  if($('skillAsk'))$('skillAsk').textContent=t('skillAsk');
  document.querySelectorAll('.sk-title').forEach((el,i)=>{el.textContent=t(['skBeginner','skIntermediate','skPro'][i]);});
  document.querySelectorAll('.sk-desc').forEach((el,i)=>{el.textContent=t(['skBeginnerDesc','skIntermediateDesc','skProDesc'][i]);});
  const lb=$('langBtn');if(lb)lb.textContent=ja?'🌐 EN':'🌐 JA';
  if($('helpBtn'))$('helpBtn').title=ja?'ヘルプ':'Help';
  if($('kbBtn'))$('kbBtn').title=ja?'ショートカット':'Shortcuts';
  if($('pmBtn'))$('pmBtn').title=ja?'プロジェクト管理':'Projects';
  const statLbls=document.querySelectorAll('.stat-item .lbl');
  const slJa=['生成ファイル','技術エントリ','柱 (Pillars)','AIツール対応'];
  const slEn=['Generated Files','Tech Entries','Pillars','AI Tools'];
  statLbls.forEach((el,i)=>{if(i<4)el.textContent=ja?slJa[i]:slEn[i];});
  const icards=document.querySelectorAll('.icard');
  const icJa=[['📝 69+ファイル生成','SDD仕様書・Docker・MCP・AIルール10種・ロードマップ9種・仕様書23種'],['🧪 10の柱','SDD・DevContainer・MCP・AIルール・並列探索・Dashboard・ロードマップ・AIランチャー・デザインシステム・リバースEng'],['📱 モバイル対応','Expo / React Native 開発パス・EAS Build・OTA更新'],['🤖 AI自律開発','Vibe Coding・マルチAgent・Claude Code Subagents'],['💳 決済・CMS・EC','Stripe・microCMS・Medusa・Shopify Hydrogen'],['📦 フルエクスポート','ZIP・PDF・全ファイル結合コピー・URLシェア']];
  const icEn=[['📝 69+ File Generation','SDD specs, Docker, MCP, 10 AI rules, 9 roadmaps, 23 specs'],['🧪 10 Pillars','SDD, DevContainer, MCP, AI Rules, Explorer, Dashboard, Roadmap, AI Launcher, Design System, Reverse Eng'],['📱 Mobile Support','Expo / React Native dev path, EAS Build, OTA updates'],['🤖 AI Autonomous Dev','Vibe Coding, Multi-Agent, Claude Code Subagents'],['💳 Payment/CMS/EC','Stripe, microCMS, Medusa, Shopify Hydrogen'],['📦 Full Export','ZIP, PDF, Copy All Files, URL Share']];
  icards.forEach((el,i)=>{if(i<6){const d=ja?icJa[i]:icEn[i];const h4=el.querySelector('h4');const p=el.querySelector('p');if(h4)h4.textContent=d[0];if(p)p.textContent=d[1];}});
  const pbadges=document.querySelectorAll('.pbadge');
  const pbJa=['①SDD統合','②DevContainer','③MCP設定','④AIエージェント×10','⑤並列探索','⑥Context Dashboard','⑦技術ロードマップ','⑧AIランチャー','⑨デザインシステム','⑩リバースEng'];
  const pbEn=['①SDD','②DevContainer','③MCP Config','④AI Agent×10','⑤Explorer','⑥Context Dashboard','⑦Tech Roadmap','⑧AI Launcher','⑨Design System','⑩Reverse Eng'];
  pbadges.forEach((el,i)=>{if(i<10)el.textContent=ja?pbJa[i]:pbEn[i];});
  const kbT=$('kbTitle');if(kbT)kbT.textContent=t('kbTitle');
  const kbLabels=document.querySelectorAll('.kblbl');
  const kbArr=t('kb');
  kbLabels.forEach((el,i)=>{if(i<kbArr.length)el.textContent=kbArr[i];});
  const ni=$('nameIn');if(ni)ni.placeholder=ja?'プロジェクト名を入力...':'Enter project name...';
  const panPT=$('panPTitle');if(panPT)panPT.textContent=ja?'📁 生成ファイル':'📁 Generated Files';
  if($('prevTabs')&&$('prevTabs').children.length>0){
    const tabs=$('prevTabs').children;
    if(tabs[0])tabs[0].textContent=ja?'ツリー':'Tree';
    if(tabs[1])tabs[1].textContent=ja?'プレビュー':'Preview';
  }
  if($('pillarTabs')&&$('pillarTabs').children.length>0){
    const names=t('pillar');
    if(Array.isArray(names)){Array.from($('pillarTabs').children).forEach((b,i)=>{if(names[i])b.textContent=names[i];});}
  }
  const kbRows=document.querySelectorAll('.kb-row span:first-child');
  const kbJa=['ヘルプ・マニュアル','ショートカット一覧','テーマ切替','言語切替','エクスポート','全ファイルコピー','プロジェクト管理'];
  const kbEn=['Help / Manual','Shortcut List','Toggle Theme','Toggle Language','Export','Copy All Files','Project Manager'];
  kbRows.forEach((el,i)=>{if(i<7)el.textContent=ja?kbJa[i]:kbEn[i];});
  const mobtabs=document.querySelectorAll('.mobtab');
  if(mobtabs.length>=2){mobtabs[0].textContent=ja?'💬 チャット':'💬 Chat';mobtabs[1].textContent=ja?'📄 プレビュー':'📄 Preview';}
  const footer=document.querySelector('.app-footer');if(footer)footer.textContent=ja?'© 2026 エンジニアリングのタネ制作委員会 ｜ 作成者：にしあん':'© 2026 Engineering no Tane Committee | Created by にしあん';
  const prevP=$('prevBody');if(prevP&&prevP.querySelector('p')&&!Object.keys(S.files||{}).length){
    const p=prevP.querySelector('p');if(p&&!S.previewFile)p.textContent=ja?'質問に回答するとリアルタイムでプレビューが更新されます':'Preview updates in real-time as you answer questions';
  }
  initPills();
  if($('presetRow'))initPresets();
}
load();
applyTheme();
initPresets();
initVoice();
applyLang();
(function loadFromURL(){
  try{
    const h=location.hash;if(!h||!h.startsWith('#df='))return;
    const data=JSON.parse(atob(h.slice(4)));
    if(data.projectName){data.projectName=sanitizeName(data.projectName);Object.assign(S,data);save();location.hash='';location.reload();}
  }catch(e){}
})();
if(S.projectName&&S.phase>0){
  $('onboard').style.display='none';
  $('ws').style.display='flex';
  initPills();updProgress();
  if(Object.keys(S.files).length>0){initPrevTabs();initPillarTabs();showFileTree();}
  findNext();
}
if(!_lsGet('devforge-tour-done')){setTimeout(()=>startTour(),1000);}
</script>
</body>
</html>